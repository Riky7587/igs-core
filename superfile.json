{"autorun/l_ingameshop.lua":"--[[-------------------------------------------------------------------------\n\tВеб загрузчик IGS 13.03.2021\n\thttps://blog.amd-nick.me/github-workshop-garrysmod/\n\tИзначально эта задача представлялась в 3 строки\n---------------------------------------------------------------------------]]\nIGS = IGS or {}\n\nlocal function log(patt, ...)\n\tif cookie.GetNumber(\"igsverbose\", 0) == 1 then\n\t\tprint(string.format(\"[IGS] \" .. patt, ...))\n\tend\nend\n\nconcommand.Add(\"igsverbose\", function(pl)\n\tif SERVER and IsValid(pl) then return end\n\n\tlocal enable = cookie.GetNumber(\"igsverbose\", 0) == 0\n\tcookie.Set(\"igsverbose\", enable and 1 or 0)\n\tprint(\"IGS Logging \" .. (enable and \"enabled\" or \"disabled\"))\nend)\n\nlocal i = {} -- lua files only\ni.sv = SERVER and include or function() end\ni.cl = SERVER and AddCSLuaFile or include\ni.sh = function(f) return i.cl(f) or i.sv(f) end\n\n\nlocal function include_mount(sRealm, sAbsolutePath)\n\tif (sRealm == \"sh\")\n\tor (sRealm == \"sv\" and SERVER)\n\tor (sRealm == \"cl\" and CLIENT) then\n\t\t-- Чистый RunString не воспринимает return внутри файлов\n\t\t-- Но CompileString 9 апреля 2021 теоретически был причиной ошибок\n\t\t-- Пока пусть будет RunString без ретурна\n\t\t-- Заметки: https://t.me/c/1353676159/55852\n\n\t\t-- local executer = CompileString(content, sAbsolutePath)\n\t\t-- return executer()\n\n\t\tlocal content  = IGS_MOUNT[sAbsolutePath]\n\t\tRunString(content, sAbsolutePath)\n\tend\nend\n\n-- \"Костыль\" для работы IGS.sh/sv/cl изнутри модульных _main.lua файлов и энтити\n-- с указанием относительного пути\n-- не работает с ../file (наверн. Не чекал)\nlocal iam_inside\n\nlocal function incl(sRealm, sPath)\n\t-- Не сработает, если например в лаунчере в sh() для файлов убрать приставку \"igs/\"\n\tlocal isRelativePath = iam_inside and not sPath:StartWith(iam_inside)\n\tlocal sAbsolutePath  = isRelativePath and iam_inside .. \"/\" .. sPath or sPath\n\t-- /\\ Мб внутри модуля уже указан full путь, а не относительный\n\t-- (обычно путь к _main.lua)\n\n\t-- print(sAbsolutePath)\n\n\tif IGS_MOUNT and IGS_MOUNT[sAbsolutePath] then -- 1st check for lua load (not web)\n\t\tlog(\"%s Иклюд с MOUNT. Путь: %s\", sRealm, sAbsolutePath)\n\t\treturn include_mount(sRealm, sAbsolutePath)\n\telse\n\t\tlog(\"%s Иклюд с LUA. Путь: %s\", sRealm, sAbsolutePath)\n\t\tlocal fIncluder = i[sRealm]\n\t\treturn fIncluder(sAbsolutePath)\n\tend\nend\n\nfunction IGS.sh(sPath) return incl(\"sh\", sPath) end\nfunction IGS.sv(sPath) return incl(\"sv\", sPath) end\nfunction IGS.cl(sPath) return incl(\"cl\", sPath) end\n\nlocal function findKeys(arr, patt)\n\tlocal found = {}\n\tfor key,val in pairs(arr) do\n\t\tlocal match = key:match(patt)\n\t\tif match then\n\t\t\ttable.insert(found, match)\n\t\tend\n\tend\n\treturn found\nend\n\n-- Тяжелая, но пока в оптимизации не нуждается\n-- При выборке модулей и энтити элементы повторяются\nlocal function unique(arr)\n\tlocal ret = {}\n\tfor _,v in ipairs(arr) do\n\t\tif not table.HasValue(ret, v) then\n\t\t\ttable.insert(ret, v)\n\t\tend\n\tend\n\treturn ret\nend\n\nlocal function findInMount(patt)\n\treturn IGS_MOUNT and findKeys(IGS_MOUNT, patt) or {}\nend\n\nfunction IGS.include_files(sPath, fIncluder) -- igs/extensions\n\tlocal data_files = findInMount(\"^\" .. sPath:PatternSafe() .. \"/(.*%.lua)$\")\n\tlocal lua_files  = file.Find(sPath .. \"/*.lua\",\"LUA\")\n\ttable.Add(data_files, lua_files)\n\n\tfor _,fileName in ipairs(data_files) do\n\t\tfIncluder(sPath .. \"/\" .. fileName)\n\tend\nend\n\nfunction IGS.load_modules(sBasePath) -- igs/modules\n\tlocal data_modules  = findInMount(\"^\" .. sBasePath .. \"/([^/]*)/_main%.lua$\")\n\tdata_modules = unique(data_modules)\n\tlocal _,lua_modules = file.Find(sBasePath .. \"/*\",\"LUA\")\n\ttable.Add(data_modules, lua_modules)\n\n\tfor _,mod in ipairs(data_modules) do\n\t\tlocal sModPath = sBasePath .. \"/\" .. mod\n\t\tiam_inside = sModPath\n\t\tIGS.sh(sModPath .. \"/_main.lua\") -- igs/modules/inv_log/_main.lua\n\tend\n\tiam_inside = nil\nend\n\nfunction IGS.load_entities()\n\tlog(\"Загрузка энтити\")\n\tlocal entities = findInMount(\"^entities/([^/]*)/(.*%.lua)$\")\n\tentities = unique(entities) -- {ent_igs, npc_igs}\n\n\tfor _,ent_class in ipairs(entities) do\n\t\tiam_inside = \"entities/\" .. ent_class\n\t\tENT = {}\n\t\tENT.Folder = iam_inside\n\n\t\tif SERVER then IGS.sv(\"init.lua\")\n\t\telse IGS.cl(\"cl_init.lua\") end\n\t\tscripted_ents.Register(ENT, ent_class)\n\n\t\tiam_inside = nil\n\t\tENT = nil\n\tend\nend\n\n\nconcommand.Add(\"igs_flushversion\", function(pl)\n\tif IsValid(pl) then print(\"console only\") return end\n\tcookie.Set(\"igs_version\", nil)\n\tprint(\"OK. После перезагрузки сервер скачает новую версию\")\nend)\n\n-- мб ему место в launcher?\nlocal igs_version = CreateConVar(\"igs_version\", \"\", {FCVAR_NOTIFY, FCVAR_REPLICATED, FCVAR_SERVER_CAN_EXECUTE})\n\nif SERVER and igs_version:GetString() == \"\" then\n\tlocal version = cookie.GetString(\"igs_version\")\n\tigs_version:SetString(version or \"777\") -- \"or\" for case when igsmod isn't ran (core hosted locally)\nend\n\nIGS.sh(\"igs/launcher.lua\")\nIGS.load_entities()\n","entities/ent_igs/cl_init.lua":"IGS.sh(\"shared.lua\")\n\nlocal UPPER_TEXT = Color(255,255,255)\nlocal LOWER_TEXT = Color(20, 150, 200)\nlocal OUTLINE    = Color(0,0,0)\n\nlocal font = \"Fated.40\"\nlocal function drawSide(pos,ang,t1,t2)\n\tcam.Start3D2D(pos, ang, .1)\n\t\tdraw.SimpleTextOutlined(t1, font, 0, -385, UPPER_TEXT, TEXT_ALIGN_CENTER, nil, 1, OUTLINE)\n\t\tdraw.SimpleTextOutlined(t2, font, 0, -350, LOWER_TEXT, TEXT_ALIGN_CENTER, nil, 1, OUTLINE)\n\tcam.End3D2D()\nend\n\n\n\n-- в Draw изменять осторожно\n-- (может быть куча итемов, которые ускоряют анимацию при неправильном коде)\nlocal ang = Angle(0,0,90)\nfunction ENT:Draw()\n\tang.y = -180 * math.Remap(CurTime() % 3, 0,3, 0,1) -- минус крутить в другую сторону\n\n\tself:DrawModel()\n\n\tlocal pos = self:GetPos()\n\n\tlocal ITEM = IGS.GetItemByUID(self:GetUID())\n\tlocal t1 = ITEM:Name()\n\tlocal t2 = \"Действует \" .. IGS.TermToStr(ITEM:Term())\n\n\tdrawSide(pos,ang,t1,t2)\n\tang:RotateAroundAxis(ang:Right(), 180)\n\tdrawSide(pos,ang,t1,t2)\nend\n","entities/ent_igs/init.lua":"IGS.sh(\"shared.lua\")\nIGS.cl(\"cl_init.lua\")\n\nfunction ENT:Initialize()\n\t-- self:SetModel(\"models/props_junk/Shoe001a.mdl\") -- ботинок\n\t-- self:SetModel(\"models/christmas_gift2/christmas_gift2.mdl\") -- подарок\n\n\tself:SetModel(\"models/dav0r/hoverball.mdl\")\n\tself:SetModelScale(1.5)\n\tself:SetAngles(Angle(90, 0, 0))\n\n\tself:PhysicsInit(SOLID_VPHYSICS)\n\tself:SetMoveType(MOVETYPE_VPHYSICS)\n\tself:SetSolid(SOLID_VPHYSICS)\n\tself:SetUseType(SIMPLE_USE)\n\tself:PhysWake()\nend\n\n-- Чтобы нельзя было убить NPC\nfunction ENT:OnTakeDamage()\n\treturn 0\nend\n\nfunction ENT:Use(_, caller)\n\tif caller:IsPlayer() then\n\t\tself:PlayerUse(caller)\n\tend\nend\n\nfunction ENT:PlayerUse(pl)\n\tif IGS.IsInventoryOverloaded(pl) then\n\t\tIGS.Notify(pl, \"У вас слишком много предметов в инвентаре\")\n\t\treturn\n\tend\n\n\tif self.Busy or self.Removed then -- хз нужно ли именно здесь, но я добавил\n\t\t-- https://vk.com/gim143836547?sel=383010676&msgid=90338\n\t\tif CurTime() - self.Busy > 5 then\n\t\t\tIGS.Notify(pl, \"Предмет в процессе перемещения в инвентарь\")\n\t\t\tIGS.Notify(pl, \"Если процесс бесконечный, то поскорее сделайте доказательства и сообщите администратору\")\n\t\tend\n\t\treturn\n\tend\n\tself.Busy = CurTime()\n\n\tlocal UID = self:GetUID()\n\tIGS.AddToInventory(pl, UID, function(invDbID)\n\t\tself.Removed = true\n\t\tself:Remove()\n\n\t\tIGS.Notify(pl, \"Предмет помещен в /donate инвентарь\")\n\n\t\t-- вставлять новый ID не совсем корректно\n\t\t-- Думаю, надо кешировать тот ИД, что был при покупке\n\t\thook.Run(\"IGS.PlayerPickedGift\", self:Getowning_ent(), UID, invDbID, pl)\n\tend)\nend\n\nfunction IGS.CreateGift(sUid, plOwner, vPos)\n\tassert(sUid, \"Item UID expected\")\n\n\tlocal ent = ents.Create(\"ent_igs\")\n\n\tif vPos then\n\t\tent:SetPos(vPos)\n\tend\n\n\tent:SetUID(sUid)\n\tent:Setowning_ent(plOwner)\n\n\tif vPos then\n\t\tent:Spawn()\n\tend\n\n\treturn ent\nend\n","entities/ent_igs/shared.lua":"ENT.Type      = \"anim\"\nENT.Base      = \"base_anim\"\nENT.PrintName = \"Донат итем\"\nENT.Author    = \"gm-donate.ru\"\nENT.Category  = \"IGS\"\n\nENT.RenderGroup = RENDERGROUP_TRANSLUCENT\n\nfunction ENT:SetupDataTables()\n\tself:NetworkVar(\"Entity\", 0, \"owning_ent\")\n\tself:NetworkVar(\"String\", 0, \"UID\")\nend\n","entities/npc_igs/cl_init.lua":"IGS.sh(\"shared.lua\")\n\n-- #todo сделать такое же для подарка?\n\nlocal COL_TEXT = Color(255,255,255)\nlocal COL_BG   = Color(0,0,0,150)\nlocal FONT     = \"Fated.40\"\n\nlocal function textPlate(text,y)\n\tsurface.SetFont(FONT)\n\tlocal tw,th = surface.GetTextSize(text)\n\tlocal bx,by = -tw / 2 - 10, y - 5\n\tlocal bw,bh = tw + 10 + 10, th + 10 + 10\n\n\t-- Background\n\tsurface.SetDrawColor(COL_BG)\n\tsurface.DrawRect(bx,by, bw,bh)\n\tsurface.SetDrawColor(COL_TEXT)\n\tsurface.DrawRect(bx, by + bh - 4, bw, 4)\n\n\t-- text\n\tsurface.SetTextColor(COL_TEXT)\n\tsurface.SetTextPos(-tw / 2,y)\n\tsurface.DrawText(text)\nend\n\nlocal function drawInfo(ent, text, dist)\n\tdist = dist or EyePos():DistToSqr(ent:GetPos())\n\n\tif dist < 60000 then\n\t\tsurface.SetAlphaMultiplier( math.Clamp(3 - (dist / 20000), 0, 1) )\n\n\t\tlocal _,max = ent:GetRotatedAABB(ent:OBBMins(), ent:OBBMaxs() )\n\t\tlocal rot = (ent:GetPos() - EyePos()):Angle().yaw - 90\n\t\tlocal sin = math.sin(CurTime() + ent:EntIndex()) / 3 + .5 -- EntIndex дает разницу в движении\n\t\tlocal center = ent:LocalToWorld(ent:OBBCenter())\n\n\t\tcam.Start3D2D(center + Vector(0, 0, math.abs(max.z / 2) + 12 + sin), Angle(0, rot, 90), 0.13)\n\t\t\ttextPlate(text,15)\n\t\tcam.End3D2D()\n\n\t\tsurface.SetAlphaMultiplier(1)\n\tend\nend\n\n-- https://vk.com/gim143836547?msgid=46147&q=рендер&sel=88943099\nIGS_NPC_HIDE_ON_DISTANCE = nil -- 100000\nfunction ENT:Draw()\n\tlocal dist = EyePos():DistToSqr(self:GetPos())\n\tif IGS_NPC_HIDE_ON_DISTANCE and dist > IGS_NPC_HIDE_ON_DISTANCE then return end -- не отрисовывать\n\n\tself:DrawModel()\n\tdrawInfo(self, \"Донат услуги\", dist)\nend\n","entities/npc_igs/init.lua":"IGS.sh(\"shared.lua\")\nIGS.cl(\"cl_init.lua\")\n\nfunction ENT:Initialize()\n\tself:SetModel(IGS_NPC_MODEL or \"models/gman_high.mdl\")\n\tself:SetHullType( HULL_HUMAN )\n\tself:SetHullSizeNormal()\n\tself:SetSolid( SOLID_BBOX )\n\tself:CapabilitiesAdd( CAP_ANIMATEDFACE )\n\tself:CapabilitiesAdd( CAP_TURN_HEAD )\n\tself:DropToFloor()\n\tself:SetMoveType( MOVETYPE_NONE )\n\tself:SetCollisionGroup( COLLISION_GROUP_PLAYER )\n\tself:SetUseType( SIMPLE_USE )\n\n\tlocal phys = self:GetPhysicsObject()\n\tif IsValid(phys) then\n\t\tphys:EnableMotion(false)\n\tend\nend\n\nfunction ENT:PlayerUse(pl)\n\tIGS.UI(pl)\nend\n\nfunction ENT:AcceptInput(name, activator, pl, data)\n\tif name == \"Use\" then\n\t\tself:PlayerUse(pl)\n\tend\nend\n","entities/npc_igs/shared.lua":"ENT.Base      = \"base_ai\"\nENT.Type      = \"ai\"\nENT.PrintName = \"Донат NPC\"\nENT.Author    = \"gm-donate.ru\"\nENT.Category  = \"IGS\"\nENT.Spawnable = true\n\nENT.RenderGroup = RENDERGROUP_TRANSLUCENT\n","igs/apinator.lua":"if CLIENT then return end\n\nIGS.DB = IGS.DB or {}\nlocal DB = IGS.DB\n\nlocal function cfg()\n\tlocal c = IGS.C.DB or {}\n\tlocal ykd = rawget(_G, \"YKD\") or {}\n\treturn {\n\t\tHOST    = c.HOST or ykd.MYSQL_HOST or \"127.0.0.1\",\n\t\tPORT    = tonumber(c.PORT or ykd.MYSQL_PORT) or 3306,\n\t\tUSER    = c.USER or ykd.MYSQL_USER or \"root\",\n\t\tPASS    = c.PASS or ykd.MYSQL_PASS or \"\",\n\t\tNAME    = c.NAME or ykd.MYSQL_DB   or \"gmod_donate\",\n\t\tCHARSET = c.CHARSET or \"utf8mb4\",\n\t}\nend\n\nlocal function esc(v)\n\tif v == nil then return \"NULL\" end\n\tlocal s = tostring(v)\n\tif DB.conn then\n\t\ts = DB.conn:escape(s)\n\telse\n\t\ts = s:gsub(\"\\\\\", \"\\\\\\\\\"):gsub(\"'\", \"\\\\'\")\n\tend\n\treturn \"'\" .. s .. \"'\"\nend\n\nlocal function num(v, fallback)\n\tif type(v) == \"boolean\" then\n\t\treturn v and \"1\" or \"0\"\n\tend\n\tlocal n = tonumber(v)\n\tif n == nil then n = tonumber(fallback) or 0 end\n\treturn tostring(n)\nend\n\nfunction DB:Query(sql, onSuccess, onError)\n\tif not self.connected or not self.conn then\n\t\tif onError then onError(\"db_not_connected\") end\n\t\treturn\n\tend\n\n\tlocal q = self.conn:query(sql)\n\tfunction q:onSuccess(data)\n\t\tif onSuccess then onSuccess(data, self:lastInsert()) end\n\tend\n\tfunction q:onError(err)\n\t\tif onError then onError(err) end\n\tend\n\tq:start()\nend\n\nfunction DB:EnsureSchema()\n\tlocal queries = {\n\t\t[[\n\t\t\tCREATE TABLE IF NOT EXISTS gmod_users (\n\t\t\t\tsteamid64 VARCHAR(32) PRIMARY KEY,\n\t\t\t\tname VARCHAR(128) NULL,\n\t\t\t\tbalance DECIMAL(12,2) NOT NULL DEFAULT 0,\n\t\t\t\tupdated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n\t\t\t) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\t\t]],\n\t\t[[\n\t\t\tCREATE TABLE IF NOT EXISTS gmod_payments (\n\t\t\t\tid BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,\n\t\t\t\tpayment_id VARCHAR(64) NOT NULL,\n\t\t\t\tsteamid64 VARCHAR(32) NOT NULL,\n\t\t\t\trub_amount DECIMAL(10,2) NOT NULL,\n\t\t\t\tcoin_amount BIGINT NOT NULL,\n\t\t\t\tstatus VARCHAR(32) NOT NULL,\n\t\t\t\tcreated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n\t\t\t\tupdated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n\t\t\t\tUNIQUE KEY uq_payment_id (payment_id),\n\t\t\t\tKEY idx_steamid64 (steamid64),\n\t\t\t\tKEY idx_status (status)\n\t\t\t) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\t\t]],\n\t\t[[\n\t\t\tCREATE TABLE IF NOT EXISTS igs_transactions (\n\t\t\t\tid BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,\n\t\t\t\tsteamid64 VARCHAR(32) NOT NULL,\n\t\t\t\tsum DECIMAL(12,2) NOT NULL,\n\t\t\t\tnote VARCHAR(80) NULL,\n\t\t\t\tserver_id INT NULL,\n\t\t\t\ttime INT UNSIGNED NOT NULL,\n\t\t\t\tKEY idx_steamid64 (steamid64),\n\t\t\t\tKEY idx_time (time)\n\t\t\t) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\t\t]],\n\t\t[[\n\t\t\tCREATE TABLE IF NOT EXISTS igs_purchases (\n\t\t\t\tid BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,\n\t\t\t\tsteamid64 VARCHAR(32) NOT NULL,\n\t\t\t\titem_uid VARCHAR(128) NOT NULL,\n\t\t\t\tserver_id INT NULL,\n\t\t\t\tpurchase_ts INT UNSIGNED NOT NULL,\n\t\t\t\texpire_ts INT UNSIGNED NULL,\n\t\t\t\tactive TINYINT(1) NOT NULL DEFAULT 1,\n\t\t\t\tKEY idx_steamid64 (steamid64),\n\t\t\t\tKEY idx_item_uid (item_uid),\n\t\t\t\tKEY idx_active (active)\n\t\t\t) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\t\t]],\n\t\t[[\n\t\t\tCREATE TABLE IF NOT EXISTS igs_inventory (\n\t\t\t\tid BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,\n\t\t\t\tsteamid64 VARCHAR(32) NOT NULL,\n\t\t\t\titem_uid VARCHAR(128) NOT NULL,\n\t\t\t\tcreated_ts INT UNSIGNED NOT NULL,\n\t\t\t\tKEY idx_steamid64 (steamid64)\n\t\t\t) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\t\t]],\n\t\t[[\n\t\t\tCREATE TABLE IF NOT EXISTS igs_coupons (\n\t\t\t\tcode VARCHAR(64) PRIMARY KEY,\n\t\t\t\tvalue DECIMAL(12,2) NOT NULL,\n\t\t\t\tnote VARCHAR(50) NULL,\n\t\t\t\texpire_ts INT UNSIGNED NULL,\n\t\t\t\tused_by VARCHAR(32) NULL,\n\t\t\t\tused_ts INT UNSIGNED NULL,\n\t\t\t\tcreated_ts INT UNSIGNED NOT NULL\n\t\t\t) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\t\t]],\n\t\t[[\n\t\t\tCREATE TABLE IF NOT EXISTS igs_servers (\n\t\t\t\tid INT NOT NULL AUTO_INCREMENT PRIMARY KEY,\n\t\t\t\tname VARCHAR(64) NOT NULL,\n\t\t\t\tip VARCHAR(45) NOT NULL,\n\t\t\t\tport INT NOT NULL,\n\t\t\t\tsocket_port INT NULL,\n\t\t\t\tdisabled TINYINT(1) NOT NULL DEFAULT 0,\n\t\t\t\tversion INT NULL,\n\t\t\t\tcreated_ts INT UNSIGNED NOT NULL,\n\t\t\t\tupdated_ts INT UNSIGNED NOT NULL,\n\t\t\t\tKEY idx_ip_port (ip, port)\n\t\t\t) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;\n\t\t]],\n\t}\n\n\tfor _,sql in ipairs(queries) do\n\t\tself:Query(sql, nil, function(err)\n\t\t\tIGS.print(Color(255,0,0), \"IGS DB schema error: \" .. tostring(err))\n\t\tend)\n\tend\n\n\t-- MySQL < 8 does not support IF NOT EXISTS for columns, ignore errors\n\tself:Query(\"ALTER TABLE gmod_users ADD COLUMN name VARCHAR(128) NULL\", nil, function() end)\nend\n\nfunction DB:Connect()\n\tif not mysqloo then\n\t\tIGS.print(Color(255,0,0), \"[IGS] mysqloo module not found. Install MySQLOO.\")\n\t\treturn\n\tend\n\n\tlocal c = cfg()\n\tself.conn = mysqloo.connect(c.HOST, c.USER, c.PASS, c.NAME, c.PORT)\n\n\t-- Настройка SSL если требуется\n\tif c.USE_SSL then\n\t\t-- Проверяем доступные методы для SSL\n\t\tif type(self.conn.setSSL) == \"function\" then\n\t\t\t-- mysqloo с поддержкой SSL (новые версии)\n\t\t\tself.conn:setSSL(true)\n\t\telseif type(self.conn.setOption) == \"function\" then\n\t\t\t-- Альтернативный способ через опции\n\t\t\tpcall(function() self.conn:setOption(\"SSL_ENABLED\", true) end)\n\t\telseif type(self.conn.enableSSL) == \"function\" then\n\t\t\t-- Еще один вариант\n\t\t\tself.conn:enableSSL()\n\t\telse\n\t\t\t-- Если SSL методы недоступны, предупреждаем\n\t\t\tIGS.print(Color(255,165,0), \"[IGS] ВНИМАНИЕ: USE_SSL включен, но ваша версия mysqloo не поддерживает SSL. Обновите mysqloo или отключите require_secure_transport на MySQL.\")\n\t\tend\n\tend\n\n\tfunction self.conn:onConnected()\n\t\tDB.connected = true\n\t\tIGS.print(\"MySQL connected\" .. (c.USE_SSL and \" (SSL)\" or \"\"))\n\t\tDB:EnsureSchema()\n\t\thook.Run(\"IGS.DBConnected\")\n\tend\n\n\tfunction self.conn:onConnectionFailed(err)\n\t\tDB.connected = false\n\t\tlocal errMsg = tostring(err)\n\t\tif errMsg:find(\"require_secure_transport\") then\n\t\t\tIGS.print(Color(255,0,0), \"MySQL требует SSL. Установите USE_SSL = true в config_sv.lua или отключите require_secure_transport на MySQL сервере.\")\n\t\telse\n\t\t\tIGS.print(Color(255,0,0), \"MySQL connection failed: \" .. errMsg)\n\t\tend\n\tend\n\n\tself.conn:connect()\nend\n\nhook.Add(\"Initialize\", \"IGS_DB_Init\", function()\n\tDB:Connect()\nend)\n\nconcommand.Add(\"igs_reload_db\", function(ply)\n\tif IsValid(ply) then return end\n\tDB:Connect()\nend)\n\nlocal function ensureUserRow(s64, name_, cb)\n\tlocal sid = esc(s64)\n\tlocal name = name_ and esc(name_) or \"NULL\"\n\tlocal sql =\n\t\t\"INSERT INTO gmod_users (steamid64, name, balance) VALUES (\" ..\n\t\tsid .. \",\" .. name .. \",0) \" ..\n\t\t\"ON DUPLICATE KEY UPDATE \" ..\n\t\t(name_ and (\"name = \" .. name .. \", \") or \"\") ..\n\t\t\"steamid64 = steamid64;\"\n\n\tDB:Query(sql, cb, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"db.ensureUserRow\", err, {sid = s64})\n\tend)\nend\n\n--[[\n>----------------------------<\n\tДЕЙСТВИЯ С ИГРОКОМ\n>----------------------------<\n]]\nfunction IGS.UpdatePlayerName(s64, sName, fCallback)\n\tensureUserRow(s64, sName, function()\n\t\tif fCallback then fCallback(true) end\n\tend)\nend\n\nfunction IGS.GetPlayer(s64, fCallback)\n\tif not DB.connected then\n\t\tif fCallback then fCallback() end\n\t\treturn\n\tend\n\tlocal sql = \"SELECT steamid64, name, balance FROM gmod_users WHERE steamid64 = \" .. esc(s64) .. \" LIMIT 1;\"\n\tDB:Query(sql, function(data)\n\t\tlocal row = data and data[1]\n\t\tif not row then\n\t\t\tensureUserRow(s64, nil, function()\n\t\t\t\tif fCallback then fCallback({Name = nil, Balance = 0}) end\n\t\t\tend)\n\t\t\treturn\n\t\tend\n\t\tlocal bal = tonumber(row.balance) or 0\n\t\tif fCallback then\n\t\t\tfCallback({Name = row.name, Balance = bal})\n\t\tend\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"db.getPlayer\", err, {sid = s64})\n\t\tif fCallback then fCallback() end\n\tend)\nend\n\nfunction IGS.GetBalance(s64, fCallback)\n\tIGS.GetPlayer(s64, function(player)\n\t\tif not player then\n\t\t\tfCallback(nil)\n\t\t\treturn\n\t\tend\n\t\tfCallback(player[\"Balance\"] or 0)\n\tend)\nend\n\nfunction IGS.GetName(s64, fCallback)\n\tIGS.GetPlayer(s64, function(player)\n\t\tfCallback(player and player[\"Name\"] or nil)\n\tend)\nend\n\n--[[\n>----------------------------<\n\tТРАНЗАКЦИИ\n>----------------------------<\n]]\nfunction IGS.Transaction(s64, iSum, sNote_, fCallback)\n\tlocal sum = tonumber(iSum) or 0\n\tlocal note = sNote_ and esc(sNote_) or \"NULL\"\n\tlocal server_id = IGS.SERVERS and IGS.SERVERS:ID() or nil\n\tlocal time = os.time()\n\n\tlocal sid = esc(s64)\n\tlocal upd =\n\t\t\"INSERT INTO gmod_users (steamid64, balance) VALUES (\" .. sid .. \",\" .. num(sum) .. \") \" ..\n\t\t\"ON DUPLICATE KEY UPDATE balance = balance + \" .. num(sum) .. \";\"\n\n\tDB:Query(upd, function()\n\t\tlocal sql =\n\t\t\t\"INSERT INTO igs_transactions (steamid64, sum, note, server_id, time) VALUES (\" ..\n\t\t\tsid .. \",\" .. num(sum) .. \",\" .. note .. \",\" .. (server_id and num(server_id) or \"NULL\") .. \",\" .. num(time) .. \");\"\n\n\t\tDB:Query(sql, function(_, last_id)\n\t\t\tif fCallback then fCallback(last_id) end\n\t\t\thook.Run(\"IGS.OnApiSuccess\", \"transactions.create\", {sid = s64})\n\t\tend, function(err)\n\t\t\thook.Run(\"IGS.OnApiError\", \"transactions.create\", err, {sid = s64, sum = sum})\n\t\tend)\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"db.updateBalance\", err, {sid = s64, sum = sum})\n\tend)\nend\n\nfunction IGS.GetTransactions(fCallback, s64_, bGlobal_, iLimit_, iOffset_)\n\tlocal limit  = math.min(tonumber(iLimit_) or 255, 255)\n\tlocal offset = tonumber(iOffset_) or 0\n\tlocal where = {}\n\n\tif s64_ then\n\t\twhere[#where + 1] = \"steamid64 = \" .. esc(s64_)\n\tend\n\tif not bGlobal_ and IGS.SERVERS and IGS.SERVERS:ID() then\n\t\twhere[#where + 1] = \"server_id = \" .. num(IGS.SERVERS:ID())\n\tend\n\n\tlocal where_sql = (#where > 0) and (\" WHERE \" .. table.concat(where, \" AND \")) or \"\"\n\tlocal sql =\n\t\t\"SELECT id, steamid64, sum, note, server_id, time FROM igs_transactions\" ..\n\t\twhere_sql .. \" ORDER BY id DESC LIMIT \" .. num(limit) .. \" OFFSET \" .. num(offset) .. \";\"\n\n\tDB:Query(sql, function(data)\n\t\tlocal res = {}\n\t\tfor i = 1, #(data or {}) do\n\t\t\tlocal v = data[i]\n\t\t\tres[#res + 1] = {\n\t\t\t\tID      = tonumber(v.id),\n\t\t\t\tSum     = tonumber(v.sum),\n\t\t\t\tTime    = tonumber(v.time),\n\t\t\t\tNote    = v.note,\n\t\t\t\tServer  = v.server_id and tonumber(v.server_id) or nil,\n\t\t\t\tSteamID = v.steamid64,\n\t\t\t}\n\t\tend\n\t\tfCallback(res)\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"transactions.get\", err, {sid = s64_})\n\t\tfCallback({})\n\tend)\nend\n\nfunction IGS.GetPlayerTransactions(fCallback, s64)\n\tIGS.GetTransactions(fCallback, s64, true, 255)\nend\n\nfunction IGS.GetLatestTransactions(fCallback, iLimit_)\n\tIGS.GetTransactions(fCallback, nil, true, iLimit_)\nend\n\n--[[\n>----------------------------<\n\tПОКУПКИ\n>----------------------------<\n]]\nfunction IGS.StorePurchase(s64, sItemUID, iDaysTerm_, iServerID, fCallback)\n\tlocal term = tonumber(iDaysTerm_)\n\tlocal expire = term and (os.time() + term * 86400) or nil\n\tlocal sql =\n\t\t\"INSERT INTO igs_purchases (steamid64, item_uid, server_id, purchase_ts, expire_ts, active) VALUES (\" ..\n\t\tesc(s64) .. \",\" .. esc(sItemUID) .. \",\" .. (iServerID and num(iServerID) or \"NULL\") .. \",\" ..\n\t\tnum(os.time()) .. \",\" .. (expire and num(expire) or \"NULL\") .. \",1);\"\n\n\tDB:Query(sql, function(_, last_id)\n\t\tif fCallback then fCallback(last_id) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"purchases.create\", err, {sid = s64})\n\tend)\nend\n\nfunction IGS.StoreLocalPurchase(s64, sItemUID, iDaysTerm_, fCallback)\n\tIGS.StorePurchase(s64, sItemUID, iDaysTerm_, IGS.SERVERS:ID(), fCallback)\nend\n\nfunction IGS.MovePurchase(db_id, iNewServer_, fCallback)\n\tlocal set_server = (iNewServer_ == nil) and \"server_id = NULL\" or (\"server_id = \" .. num(iNewServer_))\n\tlocal set_active = (iNewServer_ == 0) and \", active = 0\" or \"\"\n\tlocal sql = \"UPDATE igs_purchases SET \" .. set_server .. set_active .. \" WHERE id = \" .. num(db_id) .. \" LIMIT 1;\"\n\n\tDB:Query(sql, function()\n\t\tif fCallback then fCallback(true) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"purchases.move\", err, {id = db_id})\n\t\tif fCallback then fCallback(false) end\n\tend)\nend\n\nfunction IGS.DisablePurchase(db_id, fCallback)\n\tIGS.MovePurchase(db_id, 0, fCallback)\nend\n\nfunction IGS.GetPurchases(fCallback, tParams)\n\ttParams = tParams or {}\n\tlocal where = {}\n\tlocal limit = math.min(tonumber(tParams.limit) or 127, 127)\n\tlocal offset = tonumber(tParams.offset) or 0\n\n\tif tParams.sid then\n\t\twhere[#where + 1] = \"p.steamid64 = \" .. esc(tParams.sid)\n\tend\n\n\tif tParams.s then\n\t\tlocal s = num(tParams.s)\n\t\twhere[#where + 1] = \"(p.server_id = \" .. s .. \" OR p.server_id IS NULL)\"\n\tend\n\n\tif tParams.only_active then\n\t\twhere[#where + 1] = \"p.active = 1\"\n\t\twhere[#where + 1] = \"(p.expire_ts IS NULL OR p.expire_ts > \" .. num(os.time()) .. \")\"\n\tend\n\n\tlocal where_sql = (#where > 0) and (\" WHERE \" .. table.concat(where, \" AND \")) or \"\"\n\tlocal sql =\n\t\t\"SELECT p.id, p.server_id, p.item_uid, p.purchase_ts, p.expire_ts, p.steamid64, u.name \" ..\n\t\t\"FROM igs_purchases p \" ..\n\t\t\"LEFT JOIN gmod_users u ON u.steamid64 = p.steamid64 \" ..\n\t\twhere_sql ..\n\t\t\" ORDER BY p.id DESC LIMIT \" .. num(limit) .. \" OFFSET \" .. num(offset) .. \";\"\n\n\tDB:Query(sql, function(data)\n\t\tlocal res = {}\n\t\tfor i = 1, #(data or {}) do\n\t\t\tlocal v = data[i]\n\t\t\tres[#res + 1] = {\n\t\t\t\tID      = tonumber(v.id),\n\t\t\t\tServer  = v.server_id and tonumber(v.server_id) or nil,\n\t\t\t\tItem    = v.item_uid,\n\t\t\t\tPurchase= tonumber(v.purchase_ts),\n\t\t\t\tExpire  = v.expire_ts and tonumber(v.expire_ts) or nil,\n\t\t\t\tSteamID = v.steamid64,\n\t\t\t\tNick    = v.name,\n\t\t\t}\n\t\tend\n\t\tfCallback(res)\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"purchases.get\", err, tParams)\n\t\tfCallback({})\n\tend)\nend\n\nfunction IGS.GetPlayerPurchases(s64, fCallback)\n\tIGS.GetPurchases(fCallback, {sid = s64, only_active = 1, s = IGS.SERVERS:ID()})\nend\n\nfunction IGS.GetLatestPurchases(fCallback, iLimit_)\n\tIGS.GetPurchases(fCallback, {limit = iLimit_ or 10})\nend\n\n--[[\n>----------------------------<\n\tССЫЛКИ\n>----------------------------<\n]]\nfunction IGS.GetPaymentURL(fCallback, s64, iSum, sDescription_)\n\tlocal ykd = rawget(_G, \"YKD\") or {}\n\tlocal base = IGS.C.PAY_URL or ykd.PAY_URL\n\tif not base or base == \"\" then\n\t\thook.Run(\"IGS.OnApiError\", \"url.getPayment\", \"pay_url_missing\", {})\n\t\treturn\n\tend\n\n\tlocal url = string.format(\"%s?steamid64=%s&amount=%s\", base, s64, tostring(iSum))\n\tfCallback(url)\nend\n\n--[[\n>----------------------------<\n\tПРОЕКТ (Локальные настройки)\n>----------------------------<\n]]\nfunction IGS.GetProjectData(fCallback)\n\tlocal settings = {\n\t\tMinCharge     = tonumber(IGS.C.MIN_CHARGE) or 0,\n\t\tCurrencyPrice = tonumber(IGS.C.CURRENCY_PRICE) or 1,\n\t}\n\tfCallback({\n\t\tsettings = settings,\n\t\tname = IGS.C.PROJECT_NAME or \"Local Project\",\n\t\tcoowners = {},\n\t})\nend\n\nfunction IGS.GetSettings(fCallback)\n\tIGS.GetProjectData(function(proj)\n\t\tfCallback(proj[\"settings\"])\n\tend)\nend\n\n--[[\n>----------------------------<\n\tСЕРВЕРЫ\n>----------------------------<\n]]\nfunction IGS.AddServer(ip, port, fCallback)\n\tlocal now = os.time()\n\tlocal sql =\n\t\t\"INSERT INTO igs_servers (name, ip, port, socket_port, disabled, version, created_ts, updated_ts) VALUES (\" ..\n\t\tesc(GetConVarString(\"hostname\")) .. \",\" .. esc(ip) .. \",\" .. num(port) .. \",NULL,0,NULL,\" ..\n\t\tnum(now) .. \",\" .. num(now) .. \");\"\n\n\tDB:Query(sql, function(_, last_id)\n\t\tif fCallback then fCallback(last_id) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"servers.create\", err, {ip = ip, port = port})\n\tend)\nend\n\nfunction IGS.GetServers(fCallback, bIncludeDisabled_, iID_)\n\tlocal where = {}\n\tif iID_ then\n\t\twhere[#where + 1] = \"id = \" .. num(iID_)\n\tend\n\tif not bIncludeDisabled_ then\n\t\twhere[#where + 1] = \"disabled = 0\"\n\tend\n\tlocal where_sql = (#where > 0) and (\" WHERE \" .. table.concat(where, \" AND \")) or \"\"\n\tlocal sql = \"SELECT id, name, ip, port, socket_port, disabled FROM igs_servers\" .. where_sql .. \";\"\n\n\tDB:Query(sql, function(data)\n\t\tlocal res = {}\n\t\tfor i = 1, #(data or {}) do\n\t\t\tlocal v = data[i]\n\t\t\tres[#res + 1] = {\n\t\t\t\tID = tonumber(v.id),\n\t\t\t\tName = v.name,\n\t\t\t\tIP = v.ip,\n\t\t\t\tPort = tonumber(v.port),\n\t\t\t\tSocketPort = v.socket_port and tonumber(v.socket_port) or nil,\n\t\t\t\tDisabled = tonumber(v.disabled) == 1,\n\t\t\t}\n\t\tend\n\t\tfCallback(res)\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"servers.get\", err, {})\n\t\tfCallback({})\n\tend)\nend\n\nfunction IGS.GetExternalIP(fCallback)\n\thttp.Fetch(\"https://api.ipify.org\", function(body)\n\t\tfCallback(tostring(body))\n\tend, function()\n\t\tfCallback(nil)\n\tend)\nend\n\nfunction IGS.UpdateServer(iServerID, tParams, fCallback)\n\tif not tParams then\n\t\tif fCallback then fCallback(false) end\n\t\treturn\n\tend\n\n\tlocal sets = {}\n\tif tParams.name then sets[#sets + 1] = \"name = \" .. esc(tParams.name) end\n\tif tParams.version then sets[#sets + 1] = \"version = \" .. num(tParams.version) end\n\tif tParams.state then sets[#sets + 1] = \"disabled = \" .. num(tParams.state ~= 0) end\n\tif tParams.ip then sets[#sets + 1] = \"ip = \" .. esc(tParams.ip) end\n\tif tParams.hostport then sets[#sets + 1] = \"port = \" .. num(tParams.hostport) end\n\tif tParams.s then iServerID = tParams.s end\n\tif tParams.port then sets[#sets + 1] = \"socket_port = \" .. num(tParams.port) end\n\n\tsets[#sets + 1] = \"updated_ts = \" .. num(os.time())\n\n\tlocal sql = \"UPDATE igs_servers SET \" .. table.concat(sets, \", \") .. \" WHERE id = \" .. num(iServerID) .. \" LIMIT 1;\"\n\tDB:Query(sql, function()\n\t\tif fCallback then fCallback(true) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"servers.update\", err, {s = iServerID})\n\t\tif fCallback then fCallback(false) end\n\tend)\nend\n\nfunction IGS.UpdateCurrentServer(tParams, fCallback)\n\tIGS.UpdateServer(IGS.SERVERS:ID(), tParams, fCallback)\nend\n\nfunction IGS.SetServerName(sName, fCallback)\n\tIGS.UpdateCurrentServer({name = sName}, fCallback)\nend\n\nfunction IGS.SetServerSocketPort(iPort, fCallback)\n\tIGS.UpdateCurrentServer({port = iPort}, fCallback)\nend\n\nfunction IGS.SetServerVersion(iVersion, fCallback)\n\tIGS.UpdateCurrentServer({version = iVersion}, fCallback)\nend\n\nfunction IGS.UpdateServerAddress(iServerID, ip, port, fCallback)\n\tIGS.UpdateServer(iServerID, {ip = ip, hostport = port}, fCallback)\nend\n\n--[[\n>----------------------------<\n\tИНВЕНТАРЬ\n>----------------------------<\n]]\nfunction IGS.StoreInventoryItem(fCallback, s64, sUid)\n\tlocal sql =\n\t\t\"INSERT INTO igs_inventory (steamid64, item_uid, created_ts) VALUES (\" ..\n\t\tesc(s64) .. \",\" .. esc(sUid) .. \",\" .. num(os.time()) .. \");\"\n\n\tDB:Query(sql, function(_, last_id)\n\t\tif fCallback then fCallback(last_id) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"inventory.addItem\", err, {sid = s64})\n\tend)\nend\n\nfunction IGS.FetchInventory(fCallback, s64)\n\tlocal sql = \"SELECT id, item_uid FROM igs_inventory WHERE steamid64 = \" .. esc(s64) .. \" ORDER BY id ASC;\"\n\tDB:Query(sql, function(data)\n\t\tlocal res = {}\n\t\tfor i = 1, #(data or {}) do\n\t\t\tlocal v = data[i]\n\t\t\tres[#res + 1] = {ID = tonumber(v.id), Item = v.item_uid}\n\t\tend\n\t\tfCallback(res)\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"inventory.get\", err, {sid = s64})\n\t\tfCallback({})\n\tend)\nend\n\nfunction IGS.DeleteInventoryItem(fCallback, iID)\n\tlocal sql = \"DELETE FROM igs_inventory WHERE id = \" .. num(iID) .. \" LIMIT 1;\"\n\tDB:Query(sql, function(_, _)\n\t\tif fCallback then fCallback(true) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"inventory.deleteItem\", err, {id = iID})\n\t\tif fCallback then fCallback(false) end\n\tend)\nend\n\n--[[\n>----------------------------<\n\tКУПОНЫ\n>----------------------------<\n]]\nlocal function generateCouponCode()\n\treturn hash.SHA256(tostring(os.time()) .. \":\" .. tostring(math.random()) .. \":\" .. tostring(SysTime()))\nend\n\nfunction IGS.CreateCoupon(iGiveMoney, iDaysTerm_, sNote_, fCallback)\n\tlocal code = generateCouponCode()\n\tlocal expire = iDaysTerm_ and (os.time() + tonumber(iDaysTerm_) * 86400) or nil\n\tlocal sql =\n\t\t\"INSERT INTO igs_coupons (code, value, note, expire_ts, used_by, used_ts, created_ts) VALUES (\" ..\n\t\tesc(code) .. \",\" .. num(iGiveMoney) .. \",\" .. (sNote_ and esc(sNote_) or \"NULL\") .. \",\" ..\n\t\t(expire and num(expire) or \"NULL\") .. \",NULL,NULL,\" .. num(os.time()) .. \");\"\n\n\tDB:Query(sql, function()\n\t\tif fCallback then fCallback(code) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"coupons.create\", err, {})\n\tend)\nend\n\nfunction IGS.GetCoupon(sCouponCode, fCallback)\n\tlocal sql = \"SELECT code, value, expire_ts, used_by FROM igs_coupons WHERE code = \" .. esc(sCouponCode) .. \" LIMIT 1;\"\n\tDB:Query(sql, function(data)\n\t\tlocal row = data and data[1]\n\t\tif not row then fCallback() return end\n\t\tfCallback({\n\t\t\tValue = tonumber(row.value),\n\t\t\tDateExpire = row.expire_ts and tonumber(row.expire_ts) or nil,\n\t\t\tUsedBy = row.used_by,\n\t\t})\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"coupons.get\", err, {coupon = sCouponCode})\n\t\tfCallback()\n\tend)\nend\n\nfunction IGS.DeactivateCoupon(sActivatorSteamID, sCouponCode, fCallback)\n\tlocal now = os.time()\n\tlocal sql =\n\t\t\"UPDATE igs_coupons SET used_by = \" .. esc(sActivatorSteamID) .. \", used_ts = \" .. num(now) ..\n\t\t\" WHERE code = \" .. esc(sCouponCode) .. \" AND used_by IS NULL LIMIT 1;\"\n\n\tDB:Query(sql, function()\n\t\tif fCallback then fCallback(true) end\n\tend, function(err)\n\t\thook.Run(\"IGS.OnApiError\", \"coupons.deactivate\", err, {coupon = sCouponCode})\n\t\tif fCallback then fCallback(false) end\n\tend)\nend\n\n--[[\n>----------------------------<\n\tMETA\n>----------------------------<\n]]\nkvapi = kvapi or {}\n\nfunction kvapi.set(key, value, ttl, cb)\n\thttp.Post(\"https://kv.gmod.app/set\", {\n\t\tkey = key,\n\t\tvalue = tostring(value),\n\t\tttl = tostring(ttl),\n\t}, cb, error)\nend\n\nfunction kvapi.get(key, cb)\n\thttp.Post(\"https://kv.gmod.app/get\", {\n\t\tkey = key,\n\t}, function(value, _, headers)\n\t\tcb(value ~= \"\" and value or nil, tonumber(headers.Expires))\n\tend, error)\nend\n\nfunction IGS.SetSharedKV(key, value, ttl, cb)\n\tkvapi.set((IGS.C.PROJECT_NAME or \"local\") .. \":\" .. key:URLEncode(), value, ttl, cb)\nend\n\nfunction IGS.GetSharedKV(key, cb)\n\tkvapi.get((IGS.C.PROJECT_NAME or \"local\") .. \":\" .. key:URLEncode(), cb)\nend\n","igs/cl_preload_icons.lua":"--[[\n    Клиентская предзагрузка иконок товаров\n    Загружает все иконки в фоне при подключении к серверу\n]]\n\nif SERVER then return end\n\nlocal preloadQueue = {}\nlocal isPreloading = false\nlocal preloadedCount = 0\nlocal totalToPreload = 0\nlocal preloadAttempts = {}\n\n-- Функция для предзагрузки одной иконки\nlocal function PreloadIcon(url, callback, attempt)\n    if not url or not url:match(\"^https?://\") then \n        if callback then callback(false) end\n        return \n    end\n    \n    -- Проверяем, не загружена ли уже\n    if texture.Get(url) then\n        if callback then callback(true) end\n        return\n    end\n    \n    -- Создаем и загружаем текстуру\n    attempt = attempt or 1\n    texture.Create(url)\n        :SetSize(256, 256) -- Оптимальный размер для качества/производительности\n        :SetFormat(url:sub(-3) == \"jpg\" and \"jpg\" or \"png\")\n        :Download(url, function()\n            preloadedCount = preloadedCount + 1\n            if callback then callback(true) end\n        end, function()\n            if attempt < 3 then\n                timer.Simple(1, function()\n                    PreloadIcon(url, callback, attempt + 1)\n                end)\n                return\n            end\n\n            preloadedCount = preloadedCount + 1\n            if callback then callback(false) end\n        end)\nend\n\n-- Обработка очереди загрузки (параллельная загрузка)\nlocal function ProcessPreloadQueue()\n    if #preloadQueue == 0 then\n        isPreloading = false\n        print(\"[IGS] Все иконки предзагружены: \" .. preloadedCount .. \"/\" .. totalToPreload)\n        return\n    end\n    \n    isPreloading = true\n    \n    -- Загружаем меньше параллельно, чтобы не ловить таймауты\n    local batchSize = math.min(3, #preloadQueue)\n    for i = 1, batchSize do\n        local url = table.remove(preloadQueue, 1)\n        if url then\n            PreloadIcon(url, function(success)\n                -- Продолжаем загрузку когда batch завершен\n                if preloadedCount >= totalToPreload or #preloadQueue == 0 then\n                    ProcessPreloadQueue()\n                end\n            end)\n        end\n    end\n    \n    -- Продолжаем загрузку следующего batch с небольшой паузой\n    if #preloadQueue > 0 then\n        timer.Simple(0.2, ProcessPreloadQueue)\n    end\nend\n\n-- Запуск предзагрузки всех иконок товаров\nlocal function StartPreloading()\n    if isPreloading then return end\n    \n    preloadQueue = {}\n    preloadedCount = 0\n    totalToPreload = 0\n    \n    -- Собираем все уникальные URL иконок\n    local urls = {}\n    for uid, ITEM in pairs(IGS.ITEMS.STORED or {}) do\n        local icon = ITEM:ICON()\n        if icon and icon:match(\"^https?://\") and not urls[icon] then\n            urls[icon] = true\n            table.insert(preloadQueue, icon)\n            totalToPreload = totalToPreload + 1\n        end\n    end\n    \n    if totalToPreload > 0 then\n        print(\"[IGS] Начинается предзагрузка \" .. totalToPreload .. \" иконок...\")\n        ProcessPreloadQueue()\n    end\nend\n\n-- Автоматическая предзагрузка при инициализации IGS\nhook.Add(\"IGS.Loaded\", \"PreloadItemIcons\", function()\n    timer.Simple(0.5, StartPreloading) -- Задержка 0.5 секунды после загрузки IGS\nend)\n\n-- Экспортируем функцию для вызова из других модулей\nIGS.PreloadIcons = StartPreloading\n\n-- Команда для ручной перезагрузки иконок\nconcommand.Add(\"igs_reload_icons\", function()\n    print(\"[IGS] Принудительная перезагрузка иконок...\")\n    StartPreloading()\nend)\n\n-- Очистка кэша иконок\nconcommand.Add(\"igs_clear_icon_cache\", function()\n    local files = file.Find(\"texture/*.png\", \"DATA\")\n    local count = 0\n    for _, f in ipairs(files) do\n        file.Delete(\"texture/\" .. f)\n        count = count + 1\n    end\n    print(\"[IGS] Очищено \" .. count .. \" кэшированных иконок\")\n    print(\"[IGS] Используйте 'igs_reload_icons' для повторной загрузки\")\nend)\n","igs/core_sv.lua":"-- Можно и забирать, указав минусовое число\nlocal PLAYER = FindMetaTable(\"Player\")\nfunction PLAYER:AddIGSFunds(amount, note, callback)\n\tIGS.Transaction(self:SteamID64(),amount,note,function()\n\t\tlocal newbal = self:IGSFunds() + amount\n\t\tself:SetIGSVar(\"igs_balance\", newbal)\n\n\t\tif amount > 0 then\n\t\t\tlocal tt = IGS.TotalTransaction(self) + amount\n\t\t\tself:SetIGSVar(\"igs_total_transactions\", tt)\n\n\t\t\tself:SetIGSVar(\"igs_lvl\", IGS.LVL.GetByCost( IGS.RealPrice(tt) ):LVL())\n\t\tend\n\n\t\tif callback then\n\t\t\tcallback(newbal)\n\t\tend\n\tend)\nend\n\n\n--[[-------------------------------------------------------------------------\n\tПокупки\n---------------------------------------------------------------------------]]\nfunction IGS.LoadPlayerPurchases(pl,cb)\n\t-- Список покупок\n\tIGS.GetPlayerPurchases(pl:SteamID64(),function(dat)\n\t\tif #dat == 0 then\n\t\t\thook.Run(\"IGS.PlayerPurchasesLoaded\",pl)\n\t\t\tpl:SetIGSVar(\"igs_purchases\", {}) -- для хука. Ниже описано\n\t\t\tpl:SetVar(\"igs_reloadns_equipped\", {})\n\t\t\tIGS.nw.WaitForPlayer(pl, function()\n\t\t\t\tpl:SetIGSVar(\"igs_reloadns_equipped\", {})\n\t\t\tend)\n\t\t\treturn\n\t\tend\n\n\t\tlocal purchases = {} -- uid = amount\n\t\tlocal networked = {} -- iter = uid\n\n\t\tfor i = 1,#dat do\n\t\t\tlocal uid  = dat[i][\"Item\"]\n\t\t\tlocal ITEM = IGS.GetItemByUID(uid) -- TO DO проверка на существование итема. Или не нужно? Время покажет\n\n\t\t\tpurchases[uid] = purchases[uid] and (purchases[uid] + 1) or 1\n\n\t\t\tif ITEM:IsNetworked() then\n\t\t\t\tnetworked[#networked + 1] = ITEM:ID()\n\t\t\tend\n\t\tend\n\n\t\t-- UID - Amount Of Purchases\n\t\tpl:SetVar(\"igs_purchases\",purchases)\n\n\t\t-- print(\"IGS.GetPlayerPurchases processed\",pl)\n\t\tIGS.nw.WaitForPlayer(pl, function()\n\t\t\t-- print(\"IGS.nw.WaitForPlayer INSIDE\",pl)\n\t\t\t-- if (#networked > 0) then -- закомменчено, чтобы срабатывал клиентский хук в любом случае\n\t\t\t\tpl:SetIGSVar(\"igs_purchases\", networked) -- минус в том, что теперь для ВСЕХ игроков будет сетится\n\t\t\t-- end -- а сделано это для тул хайдера\n\t\tend)\n\n\t\thook.Run(\"IGS.PlayerPurchasesLoaded\",pl,purchases)\n\t\tif cb then cb(purchases) end\n\tend)\nend\n\n\n--[[-------------------------------------------------------------------------\n\tReloadns (надеваемые покупки)\n---------------------------------------------------------------------------]]\nlocal function normalizeReloadnsTable(t)\n\tif not istable(t) then return {} end\n\n\tlocal res = {}\n\tfor k,v in pairs(t) do\n\t\tlocal cat = tonumber(k)\n\t\tlocal uid = tostring(v or \"\")\n\t\tif cat and uid ~= \"\" then\n\t\t\tcat = math.floor(cat)\n\t\t\tif cat >= 1 and cat <= 255 then\n\t\t\t\tres[cat] = uid\n\t\t\tend\n\t\tend\n\tend\n\treturn res\nend\n\nlocal function sanitizeReloadnsEquipped(pl, tEquipped)\n\ttEquipped = normalizeReloadnsTable(tEquipped)\n\n\tfor cat, uid in pairs(tEquipped) do\n\t\tlocal ITEM = IGS.GetItemByUID(uid)\n\t\tif ITEM.isnull or not ITEM:HasReloadns() or ITEM:ReloadnsCategory() ~= cat or not pl:HasPurchase(uid) then\n\t\t\ttEquipped[cat] = nil\n\t\tend\n\tend\n\n\treturn tEquipped\nend\n\nfunction IGS.GetReloadnsEquipped(pl)\n\treturn pl:GetVar(\"igs_reloadns_equipped\", {})\nend\n\nfunction IGS.SetReloadnsEquipped(pl, tEquipped, bDontPersist)\n\ttEquipped = sanitizeReloadnsEquipped(pl, tEquipped)\n\n\tpl:SetVar(\"igs_reloadns_equipped\", tEquipped)\n\tIGS.nw.WaitForPlayer(pl, function()\n\t\tif IsValid(pl) then\n\t\t\tpl:SetIGSVar(\"igs_reloadns_equipped\", tEquipped)\n\t\tend\n\tend)\n\n\tif not bDontPersist then\n\t\tpl:SetPData(\"igs_reloadns_equipped\", util.TableToJSON(tEquipped))\n\tend\n\n\treturn tEquipped\nend\n\nfunction IGS.LoadReloadnsEquipped(pl)\n\tlocal raw = pl:GetPData(\"igs_reloadns_equipped\")\n\tlocal t = raw and util.JSONToTable(raw) or {}\n\treturn IGS.SetReloadnsEquipped(pl, t, true)\nend\n\nhook.Add(\"IGS.PlayerPurchasesLoaded\", \"IGS.LoadReloadnsEquipped\", function(pl)\n\tif not IsValid(pl) then return end\n\tIGS.LoadReloadnsEquipped(pl)\nend)\n\n-- Выдает покупку. Без сохранения\nfunction IGS.GivePurchase(pl, sItemUID)\n\tlocal ITEM = IGS.GetItemByUID(sItemUID)\n\n\tlocal purchases = pl:GetVar(\"igs_purchases\",{})\n\tpurchases[sItemUID] = (purchases[sItemUID] or 0) + 1\n\n\tpl:SetVar(\"igs_purchases\",purchases)\n\n\tif ITEM:IsNetworked() then\n\t\tlocal tab = pl:GetIGSVar(\"igs_purchases\") or {}\n\t\ttab[#tab + 1] = ITEM:ID()\n\t\tpl:SetIGSVar(\"igs_purchases\", tab)\n\tend\n\n\tITEM:OnActivate(pl)\n\treturn ITEM\nend\n\n-- При первой активации предмета\n-- Выдает и сохраняет покупку.\n-- В каллбэке ID предмета с БД\nfunction IGS.PlayerActivateItem(pl, sItemUID, fCallback)\n\tlocal ITEM = IGS.GetItemByUID(sItemUID)\n\n\tIGS.StoreLocalPurchase(pl:SteamID64(),ITEM:UID(),ITEM:Term(),function(iPurchID)\n\t\tIGS.GivePurchase(pl,sItemUID)\n\t\thook.Run(\"IGS.PlayerActivatedItem\", pl, ITEM, iPurchID)\n\t\tif fCallback then fCallback(iPurchID) end\n\tend)\nend\nIGS.PlayerActivatedItem = IGS.PlayerActivateItem -- #todo обратка 2020.07.16\n\n-- После :CanBuy() проверок и списания средств\nfunction IGS.PlayerPurchasedItem(pl, ITEM, cb)\n\tlocal afterBuy = function(invDbID_or_iPurchID)\n\t\tlocal id = invDbID_or_iPurchID\n\t\tITEM:Buy(pl) -- внутри хук\n\t\thook.Run(\"IGS.PlayerPurchasedItem\", pl, ITEM, id)\n\t\tcb(id)\n\tend\n\n\tif IGS.C.Inv_Enabled then\n\t\tIGS.AddToInventory(pl, ITEM:UID(), afterBuy)\n\telse\n\t\tIGS.PlayerActivateItem(pl, ITEM:UID(), afterBuy)\n\tend\nend\n\n\n--[[-------------------------------------------------------------------------\n\tКУПОНЫ\n---------------------------------------------------------------------------]]\nlocal trans = {\n\t[\"COUP_DOESNT_EXIST\"] = \"Купон не существует!\",\n\t[\"COUP_EXPIRED\"]      = \"Срок действия купона истек!\",\n\t[\"COUP_ACTIVATED\"]    = \"Купон уже активирован!\",\n}\n\n-- https://trello.com/c/6Oc1DykD/312\n-- На больших серверах при раздаче купонов будет слишком много запросов к GMD,\n-- что приведет к блоку API\nlocal coupons_errors = setmetatable({proxy = {}},{\n\t__newindex = function(self, sCoupon, sErrorCode)\n\t\tself.proxy[sCoupon] = sErrorCode\n\n\t\ttimer.Create(\"IGS.CouponsCacheCleanup\",60,1,function()\n\t\t\ttable.Empty(self.proxy)\n\t\tend)\n\tend,\n\t__index = function(self, sCoupon)\n\t\tlocal err_code = self.proxy[sCoupon]\n\t\tif err_code then\n\t\t\treturn trans[err_code]\n\t\tend\n\tend\n})\n\nfunction IGS.PlayerActivateCoupon(pl, sCoupon, cb)\n\tcb = cb or function() end\n\n\tif coupons_errors[sCoupon] then\n\t\tcb(false, coupons_errors[sCoupon])\n\t\treturn\n\tend\n\n\tIGS.GetCoupon(sCoupon,function(c,expired,used)\n\t\tlocal err_code =\n\t\t\tnot c   and \"COUP_DOESNT_EXIST\" or\n\t\t\texpired and \"COUP_EXPIRED\" or\n\t\t\tused    and \"COUP_ACTIVATED\"\n\n\t\tif err_code then\n\t\t\tcoupons_errors[sCoupon] = err_code\n\t\t\tcb(false, coupons_errors[sCoupon])\n\t\t\treturn\n\t\tend\n\n\t\tIGS.DeactivateCoupon(pl:SteamID64(),sCoupon,function(affected)\n\t\t\tcoupons_errors[sCoupon] = \"COUP_ACTIVATED\"\n\n\t\t\tif not affected then\n\t\t\t\tcb(false, \"Купон уже активирован. Кстати, это очень(!) редкая ошибка. Сообщите администрации, тут должна была вылезти другая\")\n\t\t\t\treturn -- /\\ однажды эта ошибка вылезла, когда я в цикле с клиента пытался активировать купон (https://img.qweqwe.ovh/1487848973964.png)\n\t\t\tend -- в бд не изменен ни один купон\n\n\t\t\tIGS.UpdatePlayerName(pl:SteamID64(),pl:Nick())\n\t\t\tpl:AddIGSFunds(c.Value,\"C: \" .. sCoupon,function()\n\t\t\t\tcb(true)\n\t\t\tend)\n\t\tend)\n\tend)\nend\n\n\n--[[-------------------------------------------------------------------------\n\tИНВЕНТАРЬ\n---------------------------------------------------------------------------]]\nlocal function CreateInvStructure(pl)\n\tpl.igs_inv = {\n\t\tMAP  = {}, -- db_id, data\n\t\tLIST = {}  -- iter,  data\n\t}\nend\n\nlocal function insertInvData(pl,iId,sItem)\n\tlocal d = {\n\t\tID     = iId,\n\t\tItem   = sItem,\n\t}\n\n\tpl.igs_inv.MAP[iId] = d\n\td.listid = table.insert(pl.igs_inv.LIST,d)\nend\n\nfunction IGS.Inventory(pl,bMap)\n\treturn pl.igs_inv and pl.igs_inv[bMap and \"MAP\" or \"LIST\"]\nend\n\nlocal f = function() end\n\nfunction IGS.AddToInventory(pl,sUid,fOnFinish_)\n\tIGS.StoreInventoryItem(function(inserted_id)\n\t\tif not IGS.Inventory(pl) then\n\t\t\tCreateInvStructure(pl)\n\t\tend\n\n\t\tinsertInvData(pl,inserted_id,sUid)\n\n\t\tif fOnFinish_ then\n\t\t\tfOnFinish_(inserted_id)\n\t\tend\n\tend, pl:SteamID64(),sUid)\nend\n-- IGS.AddToInventory(AMD(),\"money_5mi\",PRINT)\n\n-- https://img.qweqwe.ovh/1527524052957.png\nfunction IGS.LoadInventory(pl,cb)\n\tIGS.FetchInventory(function(d)\n\t\tcb = cb or f\n\t\tif #d == 0 then cb() return end\n\n\t\tCreateInvStructure(pl)\n\n\t\tfor _,v in ipairs(d) do\n\t\t\tlocal ITEM = IGS.GetItemByUID(v.Item)\n\t\t\t\n\t\t\t-- Автоматически удаляем null предметы (удаленные из конфига)\n\t\t\tif ITEM.isnull then\n\t\t\t\tprint(\"[IGS] Удаление null предмета из инвентаря игрока \" .. pl:Nick() .. \": \" .. v.Item .. \" (ID: \" .. v.ID .. \")\")\n\t\t\t\tIGS.DeleteInventoryItem(function(ok)\n\t\t\t\t\tif ok then\n\t\t\t\t\t\tprint(\"[IGS] Null предмет успешно удален из БД\")\n\t\t\t\t\tend\n\t\t\t\tend, v.ID)\n\t\t\telse\n\t\t\t\t-- Добавляем только валидные предметы\n\t\t\t\tinsertInvData(pl,v.ID,v.Item)\n\t\t\tend\n\t\tend\n\n\t\tcb(pl.igs_inv)\n\tend, pl:SteamID64())\nend\n-- IGS.LoadInventory(AMD(),prt)\n\nlocal function GetPlayerInventoryItemLocally(pl, invDbID)\n\tlocal inv_map  = IGS.Inventory(pl,\"map\")\n\tlocal inv_list = IGS.Inventory(pl)\n\n\tif (not inv_map) then return false end -- у чела нет донат услуг. Наверн байпас, если запрос с клиента\n\n\tlocal t = inv_map[invDbID]\n\tif (not t) then return false end -- подсунут левый ИД, который уже удален или не существовал\n\n\tfunction t:Delete()\n\t\tassert(inv_map[invDbID],\"Итем #\" .. invDbID .. \" не существует (уже удален?)\")\n\n\t\tinv_map[invDbID] = nil\n\t\ttable.remove(inv_list, t.listid)\n\n\t\tfor i = t.listid,#inv_list do\n\t\t\tinv_list[i].listid = i\n\t\tend\n\tend\n\n\treturn t\nend\n\nfunction IGS.DeletePlayerInventoryItemLocally(pl, invDbID)\n\tlocal t = GetPlayerInventoryItemLocally(pl, invDbID)\n\tif (not t) then return false end\n\n\tt:Delete()\n\n\treturn t\nend\n\nfunction IGS.PlayerEjectItem(cb, pl, invDbID)\n\tcb = cb or f\n\n\tlocal tRemoved = IGS.DeletePlayerInventoryItemLocally(pl, invDbID)\n\tif (not tRemoved) then -- байпасы\n\t\tcb(false)\n\t\treturn\n\tend\n\n\tIGS.DeleteInventoryItem(function(ok)\n\t\tif (not ok) then -- мб в панели удалили\n\t\t\treturn cb(false)\n\t\tend\n\n\t\tlocal pos = LocalToWorld( Vector(50,0,35),Angle(0,0,0), pl:GetPos(),pl:GetAngles() )\n\t\tlocal ent = IGS.CreateGift(tRemoved.Item, pl, pos)\n\n\t\tcb(ent)\n\tend, invDbID)\nend\n\nfunction IGS.IsInventoryOverloaded(pl)\n\treturn #(IGS.Inventory(pl) or {}) >= 100\nend\n--[[-------------------------------------------------------------------------\n\t//ИНВЕНТАРЬ\n---------------------------------------------------------------------------]]\n","igs/dependencies/bib.lua":"bib = bib or {} -- Не знаю, почему я решил дать ему именно такое название\n\nfunction bib.set(key,value)\n\tsql.Query([[\n\t\tREPLACE INTO `bib`(`key`,`value`)\n\t\tVALUES (]] .. sql.SQLStr(key) .. \",\" .. sql.SQLStr(value) .. [[)\n\t]])\nend\n\nfunction bib.get(key,fallback)\n\treturn sql.QueryValue([[\n\t\tSELECT `value`\n\t\tFROM `bib`\n\t\tWHERE `key` = ]] .. sql.SQLStr(key)\n\t) or fallback\nend\n\nfunction bib.delete(key)\n\tsql.Query([[\n\t\tDELETE FROM `bib`\n\t\tWHERE `key` = ]] .. sql.SQLStr(key)\n\t)\nend\n\nfunction bib.getAll()\n\tlocal t = sql.Query([[\n\t\tSELECT `key`,`value`\n\t\tFROM `bib`\n\t]]) or {}\n\n\tlocal kv = {}\n\tfor _,v in ipairs(t) do\n\t\tkv[v.key] = v.value\n\tend\n\n\treturn kv\nend\n\nfunction bib.reset()\n\tsql.Query([[\n\t\tDELETE FROM `bib`\n\t]])\nend\n\nsql.Query([[\n\tCREATE TABLE IF NOT EXISTS `bib` (\n\t\t`key`   TEXT NOT NULL UNIQUE,\n\t\t`value` TEXT,\n\t\tPRIMARY KEY(key)\n\t);\n]])\n\n\n\n\n\n--[[-------------------------------------------------------------------------\n\tBools\n---------------------------------------------------------------------------]]\nfunction bib.getBool(k, bFallback)\n\tlocal v = bib.get(k)\n\tif v == nil then\n\t\treturn bFallback\n\tend\n\n\treturn v == \"t\"\nend\n\nfunction bib.setBool(k,b)\n\tbib.set(k,b and \"t\" or \"f\")\nend\n\n-- local function g() return bib.getBool(\"foo\") end\n-- local function s(b) bib.setBool(\"foo\",b) end\n-- s(nil)   print(\"false\",g())\n-- s(true)  print(\"true\",g())\n-- s(false) print(\"false\",g())\n-- s(1)     print(\"true\",g())\n\n\n--[[-------------------------------------------------------------------------\n\tNumbers\n---------------------------------------------------------------------------]]\nfunction bib.getNum(k,iFallback)\n\treturn tonumber(bib.get(k,iFallback))\nend\n\nfunction bib.setNum(k,i)\n\tbib.set(k,i)\nend\n\nfunction bib.increment(k, i_)\n\tlocal i = bib.getNum(k, 0) + (i_ or 1)\n\tbib.setNum(k, i)\n\treturn i\nend\n\n","igs/dependencies/chatprint.lua":"if TRIGON then return end\n\n\nif SERVER then\n\tutil.AddNetworkString(\"ChatPrintColor\")\n\n\n\tlocal function sayColor(targ, ...)\n\t\tlocal args = {...}\n\t\t-- PrintTable(args)\n\t\tnet.Start(\"ChatPrintColor\")\n\t\t\tnet.WriteTable(IsColor(args[1]) and args or args[1])\n\t\tnet[targ and \"Send\" or \"Broadcast\"](targ)\n\tend\n\n\tlocal PLAYER = FindMetaTable(\"Player\")\n\tfunction PLAYER:ChatPrintColor(...)\n\t\tsayColor(self, ...)\n\tend\n\n\tchat = chat or {}\n\tfunction chat.AddTextSV(...)\n\t\tsayColor(nil, ...)\n\tend\n\nelse\n\tnet.Receive(\"ChatPrintColor\",function()\n\t\tchat.AddText(unpack(net.ReadTable()))\n\tend)\nend\n","igs/dependencies/dash/hash.lua":"if hash then return end\n\nif (SERVER) and file.Exists('lua/bin/gmsv_hash_' .. (system.IsWindows() and 'win32' or 'linux') .. '.dll', 'MOD') then -- Use gm_hash if we have it since it's a faster https://github.com/SuperiorServers/gm_hash\n\t_require 'hash'\n\treturn\nend\n\nhash = {}\n\n-- MD5 modified from https://github.com/kikito/md5.lua\ndo\n\tlocal char, byte, format, rep, sub = string.char, string.byte, string.format, string.rep, string.sub\n\tlocal bit_or, bit_and, bit_not, bit_xor, bit_rshift, bit_lshift = bit.bor, bit.band, bit.bnot, bit.bxor, bit.rshift, bit.lshift\n\n\t-- convert little-endian 32-bit int to a 4-char string\n\tlocal function lei2str(i)\n\t  local f=function (s) return char( bit_and( bit_rshift(i, s), 255)) end\n\t  return f(0)..f(8)..f(16)..f(24)\n\tend\n\n\t-- convert raw string to big-endian int\n\tlocal function str2bei(s)\n\t  local v=0\n\t  for i=1, #s do\n\t    v = v * 256 + byte(s, i)\n\t  end\n\t  return v\n\tend\n\n\t-- convert raw string to little-endian int\n\tlocal function str2lei(s)\n\t  local v=0\n\t  for i = #s,1,-1 do\n\t    v = v*256 + byte(s, i)\n\t  end\n\t  return v\n\tend\n\n\t-- cut up a string in little-endian ints of given size\n\tlocal function cut_le_str(s,...)\n\t  local o, r = 1, {}\n\t  local args = {...}\n\t  for i=1, #args do\n\t    table.insert(r, str2lei(sub(s, o, o + args[i] - 1)))\n\t    o = o + args[i]\n\t  end\n\t  return r\n\tend\n\n\tlocal swap = function (w) return str2bei(lei2str(w)) end\n\n\t-- An MD5 mplementation in Lua, requires bitlib (hacked to use LuaBit from above, ugh)\n\t-- 10/02/2001 jcw@equi4.com\n\n\tlocal CONSTS = {\n\t  0xd76aa478, 0xe8c7b756, 0x242070db, 0xc1bdceee,\n\t  0xf57c0faf, 0x4787c62a, 0xa8304613, 0xfd469501,\n\t  0x698098d8, 0x8b44f7af, 0xffff5bb1, 0x895cd7be,\n\t  0x6b901122, 0xfd987193, 0xa679438e, 0x49b40821,\n\t  0xf61e2562, 0xc040b340, 0x265e5a51, 0xe9b6c7aa,\n\t  0xd62f105d, 0x02441453, 0xd8a1e681, 0xe7d3fbc8,\n\t  0x21e1cde6, 0xc33707d6, 0xf4d50d87, 0x455a14ed,\n\t  0xa9e3e905, 0xfcefa3f8, 0x676f02d9, 0x8d2a4c8a,\n\t  0xfffa3942, 0x8771f681, 0x6d9d6122, 0xfde5380c,\n\t  0xa4beea44, 0x4bdecfa9, 0xf6bb4b60, 0xbebfbc70,\n\t  0x289b7ec6, 0xeaa127fa, 0xd4ef3085, 0x04881d05,\n\t  0xd9d4d039, 0xe6db99e5, 0x1fa27cf8, 0xc4ac5665,\n\t  0xf4292244, 0x432aff97, 0xab9423a7, 0xfc93a039,\n\t  0x655b59c3, 0x8f0ccc92, 0xffeff47d, 0x85845dd1,\n\t  0x6fa87e4f, 0xfe2ce6e0, 0xa3014314, 0x4e0811a1,\n\t  0xf7537e82, 0xbd3af235, 0x2ad7d2bb, 0xeb86d391,\n\t  0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476\n\t}\n\n\tlocal f=function (x,y,z) return bit_or(bit_and(x,y),bit_and(-x-1,z)) end\n\tlocal g=function (x,y,z) return bit_or(bit_and(x,z),bit_and(y,-z-1)) end\n\tlocal h=function (x,y,z) return bit_xor(x,bit_xor(y,z)) end\n\tlocal i=function (x,y,z) return bit_xor(y,bit_or(x,-z-1)) end\n\tlocal z=function (f,a,b,c,d,x,s,ac)\n\t  a=bit_and(a+f(b,c,d)+x+ac,0xFFFFFFFF)\n\t  -- be *very* careful that left shift does not cause rounding!\n\t  return bit_or(bit_lshift(bit_and(a,bit_rshift(0xFFFFFFFF,s)),s),bit_rshift(a,32-s))+b\n\tend\n\n\tlocal function transform(A,B,C,D,X)\n\t  local a,b,c,d=A,B,C,D\n\t  local t=CONSTS\n\n\t  a=z(f,a,b,c,d,X[ 0], 7,t[ 1])\n\t  d=z(f,d,a,b,c,X[ 1],12,t[ 2])\n\t  c=z(f,c,d,a,b,X[ 2],17,t[ 3])\n\t  b=z(f,b,c,d,a,X[ 3],22,t[ 4])\n\t  a=z(f,a,b,c,d,X[ 4], 7,t[ 5])\n\t  d=z(f,d,a,b,c,X[ 5],12,t[ 6])\n\t  c=z(f,c,d,a,b,X[ 6],17,t[ 7])\n\t  b=z(f,b,c,d,a,X[ 7],22,t[ 8])\n\t  a=z(f,a,b,c,d,X[ 8], 7,t[ 9])\n\t  d=z(f,d,a,b,c,X[ 9],12,t[10])\n\t  c=z(f,c,d,a,b,X[10],17,t[11])\n\t  b=z(f,b,c,d,a,X[11],22,t[12])\n\t  a=z(f,a,b,c,d,X[12], 7,t[13])\n\t  d=z(f,d,a,b,c,X[13],12,t[14])\n\t  c=z(f,c,d,a,b,X[14],17,t[15])\n\t  b=z(f,b,c,d,a,X[15],22,t[16])\n\n\t  a=z(g,a,b,c,d,X[ 1], 5,t[17])\n\t  d=z(g,d,a,b,c,X[ 6], 9,t[18])\n\t  c=z(g,c,d,a,b,X[11],14,t[19])\n\t  b=z(g,b,c,d,a,X[ 0],20,t[20])\n\t  a=z(g,a,b,c,d,X[ 5], 5,t[21])\n\t  d=z(g,d,a,b,c,X[10], 9,t[22])\n\t  c=z(g,c,d,a,b,X[15],14,t[23])\n\t  b=z(g,b,c,d,a,X[ 4],20,t[24])\n\t  a=z(g,a,b,c,d,X[ 9], 5,t[25])\n\t  d=z(g,d,a,b,c,X[14], 9,t[26])\n\t  c=z(g,c,d,a,b,X[ 3],14,t[27])\n\t  b=z(g,b,c,d,a,X[ 8],20,t[28])\n\t  a=z(g,a,b,c,d,X[13], 5,t[29])\n\t  d=z(g,d,a,b,c,X[ 2], 9,t[30])\n\t  c=z(g,c,d,a,b,X[ 7],14,t[31])\n\t  b=z(g,b,c,d,a,X[12],20,t[32])\n\n\t  a=z(h,a,b,c,d,X[ 5], 4,t[33])\n\t  d=z(h,d,a,b,c,X[ 8],11,t[34])\n\t  c=z(h,c,d,a,b,X[11],16,t[35])\n\t  b=z(h,b,c,d,a,X[14],23,t[36])\n\t  a=z(h,a,b,c,d,X[ 1], 4,t[37])\n\t  d=z(h,d,a,b,c,X[ 4],11,t[38])\n\t  c=z(h,c,d,a,b,X[ 7],16,t[39])\n\t  b=z(h,b,c,d,a,X[10],23,t[40])\n\t  a=z(h,a,b,c,d,X[13], 4,t[41])\n\t  d=z(h,d,a,b,c,X[ 0],11,t[42])\n\t  c=z(h,c,d,a,b,X[ 3],16,t[43])\n\t  b=z(h,b,c,d,a,X[ 6],23,t[44])\n\t  a=z(h,a,b,c,d,X[ 9], 4,t[45])\n\t  d=z(h,d,a,b,c,X[12],11,t[46])\n\t  c=z(h,c,d,a,b,X[15],16,t[47])\n\t  b=z(h,b,c,d,a,X[ 2],23,t[48])\n\n\t  a=z(i,a,b,c,d,X[ 0], 6,t[49])\n\t  d=z(i,d,a,b,c,X[ 7],10,t[50])\n\t  c=z(i,c,d,a,b,X[14],15,t[51])\n\t  b=z(i,b,c,d,a,X[ 5],21,t[52])\n\t  a=z(i,a,b,c,d,X[12], 6,t[53])\n\t  d=z(i,d,a,b,c,X[ 3],10,t[54])\n\t  c=z(i,c,d,a,b,X[10],15,t[55])\n\t  b=z(i,b,c,d,a,X[ 1],21,t[56])\n\t  a=z(i,a,b,c,d,X[ 8], 6,t[57])\n\t  d=z(i,d,a,b,c,X[15],10,t[58])\n\t  c=z(i,c,d,a,b,X[ 6],15,t[59])\n\t  b=z(i,b,c,d,a,X[13],21,t[60])\n\t  a=z(i,a,b,c,d,X[ 4], 6,t[61])\n\t  d=z(i,d,a,b,c,X[11],10,t[62])\n\t  c=z(i,c,d,a,b,X[ 2],15,t[63])\n\t  b=z(i,b,c,d,a,X[ 9],21,t[64])\n\n\t  return A+a,B+b,C+c,D+d\n\tend\n\n\tfunction hash.MD5(s)\n\t  local msgLen = #s\n\t  local padLen = 56 - msgLen % 64\n\n\t  if msgLen % 64 > 56 then padLen = padLen + 64 end\n\n\t  if padLen == 0 then padLen = 64 end\n\n\t  s = s .. char(128) .. rep(char(0),padLen-1) .. lei2str(8*msgLen) .. lei2str(0)\n\t  local t = CONSTS\n\t  local a,b,c,d = t[65],t[66],t[67],t[68]\n\n\t  for i=1,#s,64 do\n\t    local X = cut_le_str(sub(s,i,i+63),4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4)\n\t    X[0] = table.remove(X,1) -- zero based!\n\t    a,b,c,d = transform(a,b,c,d,X)\n\t  end\n\n\t  return format(\"%08x%08x%08x%08x\",swap(a),swap(b),swap(c),swap(d))\n\tend\nend\n\n\n-- SHA2 modified from http://lua-users.org/wiki/SecureHashAlgorithm\ndo\n\tlocal bit_band \t\t= bit.band\n\tlocal bit_ror     = bit.ror\n\tlocal bit_bxor \t\t= bit.bxor\n\tlocal bit_rshift \t= bit.rshift\n\tlocal bit_bnot\t\t= bit.bnot\n\n\tlocal string_gsub \t= string.gsub\n\tlocal string_format = string.format\n\tlocal string_byte \t= string.byte\n\tlocal string_char   = string.char\n\tlocal string_rep\t= string.rep\n\n\n\tlocal k = {\n\t\t0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5,\n\t\t0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,\n\t\t0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3,\n\t\t0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,\n\t\t0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc,\n\t\t0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,\n\t\t0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7,\n\t\t0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,\n\t\t0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13,\n\t\t0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,\n\t\t0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3,\n\t\t0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,\n\t\t0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5,\n\t\t0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,\n\t\t0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208,\n\t\t0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2,\n\t}\n\n\tlocal function str2hexa (s)\n\t\treturn string_gsub(s, \".\", function(c)\n\t\t\treturn string_format(\"%02x\", string_byte(c))\n\t\tend)\n\tend\n\n\tlocal function num2s (l, n)\n\t\tlocal s = \"\"\n\t\tfor i = 1, n do\n\t\t\tlocal rem = l % 256\n\t\t\ts = string_char(rem) .. s\n\t\t\tl = (l - rem) / 256\n\t\tend\n\t\treturn s\n\tend\n\n\tlocal function s232num (s, i)\n\t\tlocal n = 0\n\t\tfor i = i, i + 3 do\n\t\t\tn = n*256 + string_byte(s, i)\n\t\tend\n\t\treturn n\n\tend\n\n\tlocal function preproc (msg, len)\n\t\tlocal extra = -(len + 1 + 8) % 64\n\t\tlen = num2s(8 * len, 8)\n\t\tmsg = msg .. \"\\128\" .. string_rep(\"\\0\", extra) .. len\n\t\treturn msg\n\tend\n\n\tlocal function initH256 (H)\n\t\tH[1] = 0x6a09e667\n\t\tH[2] = 0xbb67ae85\n\t\tH[3] = 0x3c6ef372\n\t\tH[4] = 0xa54ff53a\n\t\tH[5] = 0x510e527f\n\t\tH[6] = 0x9b05688c\n\t\tH[7] = 0x1f83d9ab\n\t\tH[8] = 0x5be0cd19\n\t\treturn H\n\tend\n\n\tlocal function digestblock (msg, i, H)\n\t\tlocal w = {}\n\t\tfor j = 1, 16 do\n\t\t\tw[j] = s232num(msg, i + (j - 1)*4)\n\t\tend\n\n\t\tfor j = 17, 64 do\n\t\t\tlocal v = w[j - 15]\n\t\t\tlocal s0 = bit_bxor(bit_ror(v, 7), bit_ror(v, 18), bit_rshift(v, 3))\n\t\t\tv = w[j - 2]\n\t\t\tlocal s1 = bit_bxor(bit_ror(v, 17), bit_ror(v, 19), bit_rshift(v, 10))\n\t\t\tw[j] = w[j - 16] + s0 + w[j - 7] + s1\n\t\tend\n\n\t\tlocal a, b, c, d, e, f, g, h = H[1], H[2], H[3], H[4], H[5], H[6], H[7], H[8]\n\n\t\tfor i = 1, 64 do\n\t\t\tlocal s0 = bit_bxor(bit_ror(a, 2), bit_ror(a, 13), bit_ror(a, 22))\n\t\t\tlocal maj = bit_bxor(bit_band(a, b), bit_band(a, c), bit_band(b, c))\n\t\t\tlocal t2 = s0 + maj\n\t\t\tlocal s1 = bit_bxor(bit_ror(e, 6), bit_ror(e, 11), bit_ror(e, 25))\n\t\t\tlocal ch = bit_bxor (bit_band(e, f), bit_band(bit_bnot(e), g))\n\t\t\tlocal t1 = h + s1 + ch + k[i] + w[i]\n\n\t\t\th = g\n\t\t\tg = f\n\t\t\tf = e\n\t\t\te = d + t1\n\t\t\td = c\n\t\t\tc = b\n\t\t\tb = a\n\t\t\ta = t1 + t2\n\t\tend\n\n\t\tH[1] = bit_band(H[1] + a)\n\t\tH[2] = bit_band(H[2] + b)\n\t\tH[3] = bit_band(H[3] + c)\n\t\tH[4] = bit_band(H[4] + d)\n\t\tH[5] = bit_band(H[5] + e)\n\t\tH[6] = bit_band(H[6] + f)\n\t\tH[7] = bit_band(H[7] + g)\n\t\tH[8] = bit_band(H[8] + h)\n\tend\n\n\tlocal HH = {}\n\tfunction hash.SHA256(msg)\n\t\tmsg = preproc(msg, #msg)\n\t\tlocal H = initH256(HH)\n\t\tfor i = 1, #msg, 64 do\n\t\t\tdigestblock(msg, i, H)\n\t\tend\n\n\t\treturn str2hexa(num2s(H[1], 4)..num2s(H[2], 4)..num2s(H[3], 4)..num2s(H[4], 4)..num2s(H[5], 4)..num2s(H[6], 4)..num2s(H[7], 4)..num2s(H[8], 4))\n\tend\nend\n\ndo\n\tlocal band = bit.band\n\tlocal bnot = bit.bnot\n\tlocal bor = bit.bor\n\tlocal bxor = bit.bxor\n\tlocal floor = math.floor\n\n\t// The four core functions - F1 is optimized somewhat\n\t// local function f1(x, y, z) bit.bor( bit.band( x, y ), bit.band( bit.bnot( x ), z )) end\n\tlocal function f1( x, y, z ) return bxor( z, band( x, bxor( y, z ))) end\n\tlocal function f2( x, y, z ) return bxor( y, band( z, bxor( x, y ))) end\n\tlocal function f3( x, y, z ) return bxor( bxor( x, y ), z ) end\n\tlocal function f4( x, y, z ) return bxor( y, bor( x, bnot( z ))) end\n\n\t// This is the central step in the MD5 algorithm.\n\tlocal function Step( func, w, x, y, z, flData, iStep )\n\t\tw = w + func(x, y, z) + flData\n\n\t\treturn bor( (w * 2^iStep) % 0x100000000, floor(w % 0x100000000 / 2^(0x20 - iStep)) ) + x\n\tend\n\n\t-- This is called every tick so it has to be super optimised\n\tfunction hash.PseudoRandom( nSeed )\n\t\tnSeed = nSeed % 0x100000000\n\n\t\tlocal a = Step(f1, 0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476, nSeed + 0xd76aa478, 7)\n\t\tlocal d = Step(f1, 0x10325476, a, 0xefcdab89, 0x98badcfe, 0xe8c7b7d6, 12)\n\t\tlocal c = Step(f1, 0x98badcfe, d, a, 0xefcdab89, 0x242070db, 17)\n\t\tlocal b = Step(f1, 0xefcdab89, c, d, a, 0xc1bdceee, 22)\n\t\ta = Step(f1, a, b, c, d, 0xf57c0faf, 7)\n\t\td = Step(f1, d, a, b, c, 0x4787c62a, 12)\n\t\tc = Step(f1, c, d, a, b, 0xa8304613, 17)\n\t\tb = Step(f1, b, c, d, a, 0xfd469501, 22)\n\t\ta = Step(f1, a, b, c, d, 0x698098d8, 7)\n\t\td = Step(f1, d, a, b, c, 0x8b44f7af, 12)\n\t\tc = Step(f1, c, d, a, b, 0xffff5bb1, 17)\n\t\tb = Step(f1, b, c, d, a, 0x895cd7be, 22)\n\t\ta = Step(f1, a, b, c, d, 0x6b901122, 7)\n\t\td = Step(f1, d, a, b, c, 0xfd987193, 12)\n\t\tc = Step(f1, c, d, a, b, 0xa67943ae, 17)\n\t\tb = Step(f1, b, c, d, a, 0x49b40821, 22)\n\n\t\ta = Step(f2, a, b, c, d, 0xf61e25e2, 5)\n\t\td = Step(f2, d, a, b, c, 0xc040b340, 9)\n\t\tc = Step(f2, c, d, a, b, 0x265e5a51, 14)\n\t\tb = Step(f2, b, c, d, a, nSeed + 0xe9b6c7aa, 20)\n\t\ta = Step(f2, a, b, c, d, 0xd62f105d, 5)\n\t\td = Step(f2, d, a, b, c, 0x02441453, 9)\n\t\tc = Step(f2, c, d, a, b, 0xd8a1e681, 14)\n\t\tb = Step(f2, b, c, d, a, 0xe7d3fbc8, 20)\n\t\ta = Step(f2, a, b, c, d, 0x21e1cde6, 5)\n\t\td = Step(f2, d, a, b, c, 0xc33707f6, 9)\n\t\tc = Step(f2, c, d, a, b, 0xf4d50d87, 14)\n\t\tb = Step(f2, b, c, d, a, 0x455a14ed, 20)\n\t\ta = Step(f2, a, b, c, d, 0xa9e3e905, 5)\n\t\td = Step(f2, d, a, b, c, 0xfcefa3f8, 9)\n\t\tc = Step(f2, c, d, a, b, 0x676f02d9, 14)\n\t\tb = Step(f2, b, c, d, a, 0x8d2a4c8a, 20)\n\n\t\ta = Step(f3, a, b, c, d, 0xfffa3942, 4)\n\t\td = Step(f3, d, a, b, c, 0x8771f681, 11)\n\t\tc = Step(f3, c, d, a, b, 0x6d9d6122, 16)\n\t\tb = Step(f3, b, c, d, a, 0xfde5382c, 23)\n\t\ta = Step(f3, a, b, c, d, 0xa4beeac4, 4)\n\t\td = Step(f3, d, a, b, c, 0x4bdecfa9, 11)\n\t\tc = Step(f3, c, d, a, b, 0xf6bb4b60, 16)\n\t\tb = Step(f3, b, c, d, a, 0xbebfbc70, 23)\n\t\ta = Step(f3, a, b, c, d, 0x289b7ec6, 4)\n\t\td = Step(f3, d, a, b, c, nSeed + 0xeaa127fa, 11)\n\t\tc = Step(f3, c, d, a, b, 0xd4ef3085, 16)\n\t\tb = Step(f3, b, c, d, a, 0x04881d05, 23)\n\t\ta = Step(f3, a, b, c, d, 0xd9d4d039, 4)\n\t\td = Step(f3, d, a, b, c, 0xe6db99e5, 11)\n\t\tc = Step(f3, c, d, a, b, 0x1fa27cf8, 16)\n\t\tb = Step(f3, b, c, d, a, 0xc4ac5665, 23)\n\n\t\ta = Step(f4, a, b, c, d, nSeed + 0xf4292244, 6)\n\t\td = Step(f4, d, a, b, c, 0x432aff97, 10)\n\t\tc = Step(f4, c, d, a, b, 0xab9423c7, 15)\n\t\tb = Step(f4, b, c, d, a, 0xfc93a039, 21)\n\t\ta = Step(f4, a, b, c, d, 0x655b59c3, 6)\n\t\td = Step(f4, d, a, b, c, 0x8f0ccc92, 10)\n\t\tc = Step(f4, c, d, a, b, 0xffeff47d, 15)\n\t\tb = Step(f4, b, c, d, a, 0x85845e51, 21)\n\t\ta = Step(f4, a, b, c, d, 0x6fa87e4f, 6)\n\t\td = Step(f4, d, a, b, c, 0xfe2ce6e0, 10)\n\t\tc = Step(f4, c, d, a, b, 0xa3014314, 15)\n\t\tb = Step(f4, b, c, d, a, 0x4e0811a1, 21)\n\t\ta = Step(f4, a, b, c, d, 0xf7537e82, 6)\n\t\td = Step(f4, d, a, b, c, 0xbd3af235, 10)\n\t\tc = (0x98badcfe + Step(f4, c, d, a, b, 0x2ad7d2bb, 15)) % 0x100000000\n\t\tb = (0xefcdab89 + Step(f4, b, c, d, a, 0xeb86d391, 21)) % 0x100000000\n\n\t\treturn floor( b / 0x10000 ) % 0x100 + floor( b / 0x1000000 ) % 0x100 * 0x100 + c % 0x100 * 0x10000 + floor( c / 0x100 ) % 0x100 * 0x1000000\n\tend\nend\n","igs/dependencies/dash/misc.lua":"if dash then return end\n-- Thanks to SuperiorServers.co\n\nlocal Start = net.Start\nlocal Send  = SERVER and net.Send or net.SendToServer\nfunction net.Ping(msg, recipients)\n\tStart(msg)\n\tSend(recipients)\nend\n\n\nif CLIENT then\n\tlocal surface_SetFont \t\t= surface.SetFont\n\tlocal surface_GetTextSize \t= surface.GetTextSize\n\tlocal string_Explode \t\t= string.Explode\n\tlocal ipairs \t\t\t\t= ipairs\n\n\tfunction string.Wrap(font, text, width)\n\t\tsurface_SetFont(font)\n\n\t\tlocal sw = surface_GetTextSize(' ')\n\t\tlocal ret = {}\n\n\t\tlocal w = 0\n\t\tlocal s = ''\n\n\t\tlocal t = string_Explode('\\n', text)\n\t\tfor i = 1, #t do\n\t\t\tlocal t2 = string_Explode(' ', t[i], false)\n\t\t\tfor i2 = 1, #t2 do\n\t\t\t\tlocal neww = surface_GetTextSize(t2[i2])\n\n\t\t\t\tif (w + neww >= width) then\n\t\t\t\t\tret[#ret + 1] = s\n\t\t\t\t\tw = neww + sw\n\t\t\t\t\ts = t2[i2] .. ' '\n\t\t\t\telse\n\t\t\t\t\ts = s .. t2[i2] .. ' '\n\t\t\t\t\tw = w + neww + sw\n\t\t\t\tend\n\t\t\tend\n\t\t\tret[#ret + 1] = s\n\t\t\tw = 0\n\t\t\ts = ''\n\t\tend\n\n\t\tif (s ~= '') then\n\t\t\tret[#ret + 1] = s\n\t\tend\n\n\t\treturn ret\n\tend\n\n\tlocal formathex = '%%%02X'\n\tfunction string:URLEncode()\n\t\treturn string.gsub(string.gsub(string.gsub(self, '\\n', '\\r\\n'), '([^%w ])', function(c)\n\t\t\treturn string.format(formathex, string.byte(c))\n\t\tend), ' ', '+')\n\tend\n\n\tlocal surface_DrawRect     = surface.DrawRect\n\tlocal surface_SetDrawColor = surface.SetDrawColor\n\tfunction draw.Box(x, y, w, h, col)\n\t\tsurface_SetDrawColor(col)\n\t\tsurface_DrawRect(x, y, w, h)\n\tend\nend\n","igs/dependencies/dash/nw.lua":"-- Thanks to SuperiorServers.co\n\nIGS.nw = {}\n\nlocal vars     = {}\nlocal mappings = {}\nlocal data     = {\n\t[0] = {}\n}\nlocal globals   = data[0]\nlocal callbacks = {}\n\nlocal NETVAR   = {}\nNETVAR.__index = NETVAR\n\ndebug.getregistry().IGSVar = NETVAR\n\nlocal bitmap = {\n\t[3]\t  = 3,\n\t[7]   = 4,\n\t[15]  = 5,\n\t[31]  = 6,\n\t[63]  = 7,\n\t[127] = 8\n}\n\nlocal bitcount = 2\n\nlocal ENTITY = FindMetaTable 'Entity'\n\nlocal pairs  = pairs\nlocal Entity = Entity\n\nlocal net_WriteUInt = net.WriteUInt\nlocal net_ReadUInt  = net.ReadUInt\nlocal net_Start     = net.Start\nlocal net_Send      = SERVER and net.Send or net.SendToServer\nlocal net_Broadcast = net.Broadcast\nlocal sorted_pairs  = SortedPairsByMemberValue\n\nfunction IGS.nw.Register(var) -- You must always call this on both the client and server. It will serioulsy break shit if you don't.\n\tlocal t = {\n\t\tName = var,\n\t\tNetworkString = 'IGS.nw_' .. var,\n\t\tWriteFunc = net.WriteType,\n\t\tReadFunc = net.ReadType,\n\t\tSendFunc = function(self, ent, value, recipients)\n\t\t\tif (recipients ~= nil) then\n\t\t\t\tnet_Send(recipients)\n\t\t\telse\n\t\t\t\tnet_Broadcast()\n\t\t\tend\n\t\tend,\n\t}\n\tsetmetatable(t, NETVAR)\n\tvars[var] = t\n\n\tif (SERVER) then\n\t\tutil.AddNetworkString(t.NetworkString)\n\telse\n\t\tnet.Receive(t.NetworkString, function()\n\t\t\tlocal index, value = t:_Read()\n\n\t\t\tif (not data[index]) then\n\t\t\t\tdata[index] = {}\n\t\t\tend\n\n\t\t\tdata[index][var] = value\n\n\t\t\tt:_CallHook(index, value)\n\t\tend)\n\tend\n\n\treturn t:_Construct()\nend\n\nfunction NETVAR:Write(func, opt)\n\tself.WriteFunc = function(value)\n\t\tfunc(value, opt)\n\tend\n\treturn self:_Construct()\nend\n\nfunction NETVAR:Read(func, opt)\n\tself.ReadFunc = function()\n\t\treturn func(opt)\n\tend\n\treturn self:_Construct()\nend\n\nfunction NETVAR:Filter(func)\n\tself.SendFunc = function(_, ent, value, recipients)\n\t\tnet_Send(recipients or func(ent, value))\n\tend\n\treturn self:_Construct()\nend\n\nfunction NETVAR:SetPlayer()\n\tself.PlayerVar = true\n\treturn self:_Construct()\nend\n\nfunction NETVAR:SetLocalPlayer()\n\tself.LocalPlayerVar = true\n\treturn self:_Construct()\nend\n\nfunction NETVAR:SetGlobal()\n\tself.GlobalVar = true\n\treturn self:_Construct()\nend\n\nfunction NETVAR:SetNoSync()\n\tself.NoSync = true\n\treturn self:_Construct()\nend\n\nfunction NETVAR:SetHook(name)\n\tself.Hook = name\n\treturn self\nend\n\nfunction NETVAR:_Send(ent, value, recipients)\n\tnet_Start(self.NetworkString)\n\t\tself:_Write(ent, value)\n\tself:SendFunc(ent, value, recipients)\nend\n\nfunction NETVAR:_CallHook(index, value)\n\tif self.Hook then\n\t\tif (index ~= 0) then -- not global\n\t\t\thook.Call(self.Hook, GAMEMODE, Entity(index), value)\n\t\telse\n\t\t\thook.Call(self.Hook, GAMEMODE, value)\n\t\tend\n\tend\nend\n\nfunction NETVAR:_Construct()\n\tlocal WriteFunc = self.WriteFunc\n\tlocal ReadFunc \t= self.ReadFunc\n\n\tif self.PlayerVar then\n\t\tself._Write = function(_, ent, value)\n\t\t\tnet_WriteUInt(ent:EntIndex(), 7)\n\t\t\tWriteFunc(value)\n\t\tend\n\t\tself._Read = function(_)\n\t\t\treturn net_ReadUInt(7), ReadFunc()\n\t\tend\n\telseif self.LocalPlayerVar then\n\t\tself._Write = function(_, ent, value)\n\t\t\tWriteFunc(value)\n\t\tend\n\t\tself._Read = function(_)\n\t\t\treturn LocalPlayer():EntIndex(), ReadFunc()\n\t\tend\n\t\tself.SendFunc = function(_, ent, value, recipients)\n\t\t\tnet_Send(ent)\n\t\tend\n\telseif self.GlobalVar then\n\t\tself._Write = function(_, ent, value)\n\t\t\tWriteFunc(value)\n\t\tend\n\t\tself._Read = function(_)\n\t\t\treturn 0, ReadFunc()\n\t\tend\n\telse\n\t\tself._Write = function(_, ent, value)\n\t\t\tnet_WriteUInt(ent:EntIndex(), 12)\n\t\t\tWriteFunc(value)\n\t\tend\n\t\tself._Read = function(_)\n\t\t\treturn net_ReadUInt(12), ReadFunc()\n\t\tend\n\tend\n\n\tmappings = {}\n\tfor k, v in sorted_pairs(vars, 'Name', false) do\n\t\tlocal c = #mappings + 1\n\t\tvars[k].ID = c\n\t\tmappings[c] = v\n\t\tif bitmap[c] then\n\t\t\tbitcount = bitmap[c]\n\t\tend\n\tend\n\n\treturn self\nend\n\nfunction IGS.nw.GetGlobal(var)\n\treturn globals[var]\nend\n\nfunction ENTITY:GetIGSVar(var)\n\tlocal index = self:EntIndex()\n\treturn data[index] and data[index][var]\nend\n\nif (SERVER) then\n\tutil.AddNetworkString 'IGS.nw.PlayerSync'\n\tutil.AddNetworkString 'IGS.nw.NilEntityVar'\n\tutil.AddNetworkString 'IGS.nw.NilPlayerVar'\n\tutil.AddNetworkString 'IGS.nw.EntityRemoved'\n\tutil.AddNetworkString 'IGS.nw.PlayerRemoved'\n\n\tnet.Receive('IGS.nw.PlayerSync', function(len, pl)\n\t\tif (pl.IGSEntityCreated ~= true) then\n\t\t\thook.Call('PlayerEntityCreated', GAMEMODE, pl)\n\n\t\t\tpl.IGSEntityCreated = true\n\n\t\t\tfor index, _vars in pairs(data) do\n\t\t\t\tfor var, value in pairs(_vars) do\n\t\t\t\t\tlocal ent = Entity(index)\n\t\t\t\t\tif (not vars[var].LocalPlayerVar and not vars[var].NoSync) or (ent == pl) then\n\t\t\t\t\t\tvars[var]:_Send(ent, value, pl)\n\t\t\t\t\tend\n\t\t\t\tend\n\t\t\tend\n\n\t\t\tif (callbacks[pl] ~= nil) then\n\t\t\t\tfor i = 1, #callbacks[pl] do\n\t\t\t\t\tcallbacks[pl][i](pl)\n\t\t\t\tend\n\t\t\tend\n\t\t\tcallbacks[pl] = nil\n\t\tend\n\tend)\n\n\thook.Add('EntityRemoved', 'IGS.nw.EntityRemoved', function(ent)\n\t\tlocal index = ent:EntIndex()\n\t\tif (index ~= 0) and (data[index] ~= nil) then -- For some reason this kept getting called on Entity(0), not sure why...\n\t\t\tif ent:IsPlayer() then\n\t\t\t\tnet_Start('IGS.nw.PlayerRemoved')\n\t\t\t\t\tnet_WriteUInt(index, 7)\n\t\t\t\tnet_Broadcast()\n\t\t\telse\n\t\t\t\tnet_Start('IGS.nw.EntityRemoved')\n\t\t\t\t\tnet_WriteUInt(index, 12)\n\t\t\t\tnet_Broadcast()\n\t\t\tend\n\n\t\t\tdata[index] = nil\n\t\tend\n\tend)\n\n\tfunction IGS.nw.WaitForPlayer(pl, cback)\n\t\tif (pl.IGSEntityCreated == true) then\n\t\t\tcback(pl)\n\t\telse\n\t\t\tif (callbacks[pl] == nil) then\n\t\t\t\tcallbacks[pl] = {}\n\t\t\tend\n\t\t\tcallbacks[pl][#callbacks[pl] + 1] = cback\n\t\tend\n\tend\n\n\tfunction IGS.nw.SetGlobal(var, value)\n\t\tglobals[var] = value\n\t\tif (value ~= nil) then\n\t\t\tvars[var]:_Send(0, value)\n\t\telse\n\t\t\tnet_Start('IGS.nw.NilEntityVar')\n\t\t\t\tnet_WriteUInt(0, 12)\n\t\t\t\tnet_WriteUInt(vars[var].ID, bitcount)\n\t\t\tvars[var]:SendFunc(0, value)\n\t\tend\n\tend\n\n\tfunction ENTITY:SetIGSVar(var, value)\n\t\tlocal index = self:EntIndex()\n\n\t\tif (not data[index]) then\n\t\t\tdata[index] = {}\n\t\tend\n\n\t\tdata[index][var] = value\n\n\t\tif (value ~= nil) then\n\t\t\tvars[var]:_Send(self, value)\n\t\telse\n\t\t\tif self:IsPlayer() then\n\t\t\t\tnet_Start('IGS.nw.NilPlayerVar')\n\t\t\t\tnet_WriteUInt(index, 7)\n\t\t\telse\n\t\t\t\tnet_Start('IGS.nw.NilEntityVar')\n\t\t\t\tnet_WriteUInt(index, 12)\n\t\t\tend\n\t\t\t\tnet_WriteUInt(vars[var].ID, bitcount)\n\t\t\tvars[var]:SendFunc(self, value)\n\t\tend\n\tend\nelse\n\thook.Add('InitPostEntity', 'IGS.nw.InitPostEntity', function()\n\t\tnet_Start('IGS.nw.PlayerSync')\n\t\tnet_Send()\n\tend)\n\n\tnet.Receive('IGS.nw.NilEntityVar', function()\n\t\tlocal index, id = net_ReadUInt(12), net_ReadUInt(bitcount)\n\t\tif data[index] and mappings[id] then\n\t\t\tdata[index][mappings[id].Name] = nil\n\t\tend\n\tend)\n\n\tnet.Receive('IGS.nw.NilPlayerVar', function()\n\t\tlocal index, id = net_ReadUInt(7), net_ReadUInt(bitcount)\n\t\tif data[index] and mappings[id] then\n\t\t\tdata[index][mappings[id].Name] = nil\n\t\tend\n\tend)\n\n\tnet.Receive('IGS.nw.EntityRemoved', function()\n\t\tdata[net_ReadUInt(12)] = nil\n\tend)\n\n\tnet.Receive('IGS.nw.PlayerRemoved', function()\n\t\tdata[net_ReadUInt(7)] = nil\n\tend)\nend","igs/dependencies/dash/wmat.lua":"if dash and texture then return end -- https://t.me/c/1353676159/41153\n-- Thanks to SuperiorServers.co\n-- require 'hash'\n\ntexture = {}\n\nlocal TEXTURE = {\n\t__tostring = function(self)\n\t\treturn self.Name\n\tend\n}\nTEXTURE.__index = TEXTURE\nTEXTURE.__concat = TEXTURE.__tostring\n\ndebug.getregistry().Texture = TEXTURE\n\ntexture.textures = {}\n-- Старый прокси может не работать\n-- texture.proxyurl = 'https://imgkit.gmod.app/?image=%s&size=%i'\n-- Используем альтернативный прокси или прямые ссылки\ntexture.proxyurl = 'https://images.weserv.nl/?url=%s&w=%i&h=%i&output=%s'\n\n-- Домены, для которых не нужен прокси\ntexture.trusted_domains = {\n\t\"i.imgur.com\",\n\t\"imgur.com\",\n\t\"steamusercontent.com\",\n\t\"steamcommunity.com\",\n\t\"githubusercontent.com\",\n\t\"viperrp.ru\",\n}\n\nif (not file.IsDir('texture', 'DATA')) then\n\tfile.CreateDir 'texture'\nend\n\nfunction texture.Create(name)\n\ttexture.Delete(name)\n\n\tlocal ret = setmetatable({\n\t\tName \t= name,\n\t\tURL \t= '',\n\t\tWidth \t= 1024,\n\t\tHeight \t= 1024,\n\t\tBusy \t= false,\n\t\tCache \t= true,\n\t\tProxy \t= true,\n\t\tFormat \t= 'jpg',\n\t}, TEXTURE)\n\ttexture.textures[name] = ret\n\treturn ret\nend\n\nfunction texture.Get(name)\n\tif texture.textures[name] then\n\t\treturn texture.textures[name]:GetMaterial()\n\tend\nend\n\nfunction texture.Delete(name)\n\ttexture.textures[name] = nil\nend\n\nfunction TEXTURE:SetSize(w, h)\n\tself.Width, self.Height = w, h\n\treturn self\nend\n\nfunction TEXTURE:SetFormat(format) -- valid formats are whatever your webserver proxy can handle.\n\tself.Format = format\n\treturn self\nend\n\nfunction TEXTURE:EnableCache(enable)\n\tself.Cache = enable\n\treturn self\nend\n\nfunction TEXTURE:EnableProxy(enable)\n\tself.Proxy = enable\n\treturn self\nend\n\n\nfunction TEXTURE:GetName()\n\treturn self.Name\nend\n\nfunction TEXTURE:GetUID(reaccount)\n\tif (not self.UID) or reaccount then\n\t\tself.UID = hash.MD5(self.Name .. self.URL .. self.Width .. self.Height .. self.Format)\n\tend\n\treturn self.UID\nend\n\nfunction TEXTURE:GetSize()\n\treturn self.Width, self.Height\nend\n\nfunction TEXTURE:GetFormat()\n\treturn self.Format\nend\n\nfunction TEXTURE:GetURL()\n\treturn self.URL\nend\n\nfunction TEXTURE:GetFile()\n\treturn self.File\nend\n\nfunction TEXTURE:GetMaterial()\n\treturn self.IMaterial\nend\n\nfunction TEXTURE:GetError()\n\treturn self.Error\nend\n\nfunction TEXTURE:IsBusy()\n\treturn self.Busy == true\nend\n\nfunction TEXTURE:Download(url, onsuccess, onfailure)\n\tif (self.Name == nil) then\n\t\tself.Name = 'Web Material: ' .. url\n\tend\n\tself.URL = url\n\tself.File = 'texture/' .. self:GetUID() .. '.png'\n\n\tif self.Cache and file.Exists(self.File, 'DATA') then\n\t\tself.IMaterial = Material('data/' .. self.File, 'smooth')\n\t\tif onsuccess then\n\t\t\tonsuccess(self, self.IMaterial)\n\t\tend\n\telse\n\t\tself.Busy = true\n\n\t\tlocal function isTrustedDomain(link)\n\t\t\tfor _, domain in ipairs(texture.trusted_domains) do\n\t\t\t\tif link:find(domain, 1, true) then\n\t\t\t\t\treturn true\n\t\t\t\tend\n\t\t\tend\n\t\t\treturn false\n\t\tend\n\n\t\tlocal function buildFetchUrl(link, useProxy)\n\t\t\tif not useProxy then return link end\n\t\t\tlocal cleanUrl = link:gsub(\"^https?://\", \"\")\n\t\t\treturn string.format(texture.proxyurl, cleanUrl, self.Width, self.Height, self.Format)\n\t\tend\n\n\t\tlocal function fetchWithProxy(useProxy, triedAlternate)\n\t\t\tlocal fetchUrl = buildFetchUrl(url, useProxy)\n\n\t\t\thttp.Fetch(fetchUrl, function(body, len, headers, code)\n\t\t\t\tif code ~= 200 then\n\t\t\t\t\tif not triedAlternate then\n\t\t\t\t\t\treturn fetchWithProxy(not useProxy, true)\n\t\t\t\t\tend\n\n\t\t\t\t\tprint(\"[IGS Texture] Failed to load image: \" .. url .. \" (HTTP \" .. code .. \")\")\n\t\t\t\t\tif onfailure then\n\t\t\t\t\t\tonfailure(self, \"HTTP \" .. code)\n\t\t\t\t\tend\n\t\t\t\t\tself.Busy = false\n\t\t\t\t\treturn\n\t\t\t\tend\n\n\t\t\t\tif (self.Cache) then\n\t\t\t\t\tfile.Write(self.File, body)\n\t\t\t\tend\n\n\t\t\t\tlocal tempfile = 'texture/tmp_' .. os.time() .. '_' .. self:GetUID() .. '.png'\n\t\t\t\tfile.Write(tempfile, body)\n\t\t\t\tself.IMaterial = Material('data/' .. tempfile, 'smooth')\n\t\t\t\tfile.Delete(tempfile)\n\n\t\t\t\tprint(\"[IGS Texture] Successfully loaded: \" .. url)\n\n\t\t\t\tif onsuccess then\n\t\t\t\t\tonsuccess(self, self.IMaterial)\n\t\t\t\tend\n\n\t\t\t\tself.Busy = false\n\t\t\tend, function(error)\n\t\t\t\tif not triedAlternate then\n\t\t\t\t\treturn fetchWithProxy(not useProxy, true)\n\t\t\t\tend\n\n\t\t\t\tprint(\"[IGS Texture] Error loading image: \" .. url)\n\t\t\t\tprint(\"[IGS Texture] Error details: \" .. tostring(error))\n\n\t\t\t\tself.Error = error\n\n\t\t\t\tif onfailure then\n\t\t\t\t\tonfailure(self, self.Error)\n\t\t\t\tend\n\n\t\t\t\tself.Busy = false\n\t\t\tend)\n\t\tend\n\n\t\tlocal useProxy = self.Proxy and not isTrustedDomain(url)\n\t\tfetchWithProxy(useProxy, false)\n\tend\n\treturn self\nend\n\nfunction TEXTURE:RenderManual(func, callback)\n\tlocal cachefile = 'texture/' .. self:GetUID() .. '-render.png'\n\n\tif file.Exists(cachefile, 'DATA') then\n\t\tself.File = cachefile\n\t\tself.IMaterial = Material('data/' .. self.File, 'smooth')\n\n\t\tif callback then\n\t\t\tcallback(self, self.IMaterial)\n\t\tend\n\telse\n\t\thook.Add('HUDPaint', 'texture.render' .. self:GetName(), function()\n\t\t\tif self:IsBusy() then return end\n\n\t\t\tlocal w, h = self.Width, self.Height\n\n\t\t\tlocal drawRT = GetRenderTarget('texture_rt', w, h, true)\n\t\t\tlocal oldRT = render.GetRenderTarget()\n\n\t\t\trender.SetRenderTarget(drawRT)\n\t\t\t\trender.Clear(0, 0, 0, 0)\n\t\t\t\trender.ClearDepth()\n\n\t\t\t\trender.SetViewPort(0, 0, w, h) -- may need to tweak this all a bit later when I find use cases this doesn't work well for.\n\t\t\t\t\tfunc(self, w, h)\n\n\t\t\t\t\tif self.Cache then\n\t\t\t\t\t\tself.File = 'texture/' .. self:GetUID() .. '-render.png'\n\t\t\t\t\t\tfile.Write(self.File, render.Capture({\n\t\t\t\t\t\t\tformat = 'png',\n\t\t\t\t\t\t\tquality = 100,\n\t\t\t\t\t\t\tx = 0,\n\t\t\t\t\t\t\ty = 0,\n\t\t\t\t\t\t\th = h,\n\t\t\t\t\t\t\tw = w\n\t\t\t\t\t\t}))\n\t\t\t\t\tend\n\t\t\t\trender.SetViewPort(0, 0, ScrW(), ScrH())\n\t\t\trender.SetRenderTarget(oldRT)\n\n\t\t\tself.IMaterial = Material('data/' .. self.File)\n\n\t\t\tif callback then\n\t\t\t\tcallback(self, self.IMaterial)\n\t\t\tend\n\n\t\t\thook.Remove('HUDPaint', 'texture.render' .. self:GetName())\n\t\tend)\n\tend\n\treturn self\nend\n\nfunction TEXTURE:Render(func, callback)\n\treturn self:RenderManual(function(self, w, h)\n\t\tcam.Start2D()\n\t\t\tfunc(self, w, h)\n\t\tcam.End2D()\n\tend, callback)\nend\n","igs/dependencies/lolib.lua":"-- 2021.01.18 Logging library\n-- Author https://amd-nick.me/about\n\n-- Inspired by Python\n-- https://docs.python.org/3/howto/logging-cookbook.html\n-- https://docs.python.org/3/library/logging.html?highlight=relativecreated#logrecord-attributes\n\nlolib = {}\n\n-- https://colorswall.com/palette/3/\nlocal COLOR_DEBUG   = Color(2, 117, 216)\nlocal COLOR_FADED   = Color(247, 247, 247)\nlocal COLOR_INFO    = Color(91, 192, 222)\nlocal COLOR_WARNING = Color(255, 255, 0)\nlocal COLOR_ERROR   = Color(240, 50, 50)\n\nlolib.LEVELS = {\n\tDISABLE = 0,\n\tDEBUG   = 1,\n\tINFO    = 2,\n\tWARNING = 3,\n\tERROR   = 4,\n\n\t{\"D\", COLOR_DEBUG,   COLOR_DEBUG},\n\t{\"I\", COLOR_INFO,    COLOR_FADED},\n\t{\"W\", COLOR_WARNING, COLOR_FADED},\n\t{\"E\", COLOR_ERROR,   COLOR_FADED},\n}\n\nlocal function echo(pref_col, pref, text_col, text)\n\tMsgC(pref_col, pref, text_col, \" \" .. text .. \"\\n\")\nend\n\nlocal function format(patt, ...)\n\tlocal args = {...}\n\tlocal count = 0\n\tpatt = patt:gsub(\"{}\", function()\n\t\tcount = count + 1\n\t\tlocal replacement_val = (args[count] ~= nil) and args[count]\n\t\tif isnumber(replacement_val) or isstring(replacement_val) then\n\t\t\treturn replacement_val\n\t\tend\n\n\t\tif replacement_val == nil then\n\t\t\treturn \"nil_value\"\n\t\tend\n\n\t\t-- #todo hardcoded\n\t\tPrintTable({replacement_val = replacement_val})\n\t\tdebug.Trace()\n\t\treturn \"INVALID_REPLACEMENT_VALUE\"\n\tend)\n\n\treturn patt\nend\n\nlocal function fp(a)\n\tlocal func = a[1]\n\treturn function(...)\n\t\treturn func(unpack(a, 2), ...)\n\tend\nend\n\nfunction lolib.new()\n\tlocal logger = {\n\t\tlevel   = lolib.default_level or 3,\n\t\tpattern = \"{message}\"\n\t}\n\n\tlogger.log = function(iLevel, patt, ...)\n\t\tif iLevel < logger.level or logger.level == 0 then return end\n\n\t\tlocal message = format(patt, ...)\n\n\t\tlocal text = logger.pattern\n\t\t\t:gsub(\"{time}\", os.date(\"%H:%M:%S\"))\n\t\t\t:gsub(\"{message}\", message)\n\n\t\tlocal level_data = lolib.LEVELS[iLevel]\n\t\techo(level_data[2], \"[\" .. level_data[1] .. \"]\", level_data[3], text)\n\tend\n\n\tlogger.debug   = fp{logger.log, lolib.LEVELS.DEBUG}\n\tlogger.info    = fp{logger.log, lolib.LEVELS.INFO}\n\tlogger.warning = fp{logger.log, lolib.LEVELS.WARNING}\n\tlogger.error   = fp{logger.log, lolib.LEVELS.ERROR}\n\n\tlogger.setLevel = function(iLevel)\n\t\tlogger.level = iLevel\n\tend\n\n\tlogger.setCvar = function(sVarName, iDefaultValue)\n\t\tlocal cvar = CreateConVar(sVarName, iDefaultValue or 0, FCVAR_ARCHIVE)\n\n\t\tcvars.AddChangeCallback(sVarName, function(_, _, new)\n\t\t\tlocal level = tonumber(new) or 0\n\t\t\tassert(level >= 0 and level <= 5)\n\t\t\tlogger.setLevel(level)\n\t\t\tMsgN(\"logging level has been changed. New level is: \" .. level)\n\t\tend, \"lolib\")\n\n\t\tlogger.setLevel(cvar:GetInt())\n\n\t\treturn cvar\n\tend\n\n\t-- {time}, message\n\t-- #todo filename, funcname, linen, filepath, levelname(?)\n\tlogger.setFormat = function(sPattern)\n\t\tlogger.pattern = sPattern\n\tend\n\n\treturn logger\nend\n\n/*\nlocal log = lolib.new()\nlog.setLevel(lolib.LEVELS.INFO)\nlog.setFormat(\"{time} name {message}\")\n\nlog.debug(\"debug value: {}\", 123)\nlog.info(\"info value: {}\", 123)\nlog.warning(\"warning value: {}\", 123)\nlog.error(\"error value: {}\", 123)\n*/\n\n-- return lolib","igs/dependencies/permasents.lua":"--[[-------------------------------------------------------------------------\n\tДля веб загрузки не подходит PermaProps аддон с воркшопа,\n\tпоскольку он работает на InitPostEntity, который нельзя вызвать после веб загрузки\n\n\tИли можно..\n---------------------------------------------------------------------------]]\n\nlocal function getIndex()\n\treturn util.JSONToTable(cookie.GetString(\"perma_index\", \"\")) or {}\nend\n\nlocal function updateIndex(uid, class)\n\tlocal map = getIndex()\n\tmap[uid] = class\n\tcookie.Set(\"perma_index\", util.TableToJSON(map))\nend\n\nlocal function SpawnSent(class, pos, ang)\n\tlocal ent = ents.Create(class)\n\tent:SetPos(pos)\n\tent:SetAngles(ang)\n\tent:Spawn()\n\tent:Activate()\n\n\tlocal phys = ent:GetPhysicsObject()\n\tif phys:IsValid() then\n\t\tphys:EnableMotion(false)\n\tend\n\n\treturn ent\nend\n\n\nfunction IGS.PermaSaveFeature(class)\n\tproperties.Add(class .. \"_perma_add\", {\n\t\tMenuLabel = \"Сохранить на карте\",\n\t\tOrder = 855,\n\t\tMenuIcon = \"icon16/bullet_disk.png\",\n\n\t\tFilter = function(self, ent, pl)\n\t\t\treturn IsValid(ent) and pl:IsSuperAdmin() and ent:GetClass() == class\n\t\tend,\n\t\tAction = function(self, ent)\n\t\t\tself:MsgStart()\n\t\t\t\tnet.WriteEntity( ent )\n\t\t\tself:MsgEnd()\n\t\tend,\n\t\tReceive = function(self, length, pl)\n\t\t\tlocal ent = net.ReadEntity()\n\t\t\tif not self:Filter(ent, pl) then return end\n\n\t\t\tif ent.permaSentUID then\n\t\t\t\tpl:ChatPrint(\"Эта энтити уже сохранена. Удалите и сохраните заново, если хотите переместить\")\n\t\t\t\treturn\n\t\t\tend\n\n\t\t\tlocal uid = math.random(0xFFFF)\n\t\t\tcookie.Set(\"perma_\" .. class .. \"_\" .. uid, util.TableToJSON({ent:GetPos(), ent:GetAngles()}))\n\t\t\tpl:ChatPrint(\"Позиция сохранена под UID \" .. uid)\n\t\t\tent.permaSentUID = uid\n\n\t\t\tupdateIndex(uid, class)\n\t\tend\n\t})\n\n\tproperties.Add(class .. \"_perma_delete\", {\n\t\tMenuLabel = \"Удалить с карты\",\n\t\tOrder = 856,\n\t\tMenuIcon = \"icon16/bin_closed.png\",\n\n\t\tFilter = function(self, ent, pl)\n\t\t\treturn IsValid(ent) and pl:IsSuperAdmin() and ent:GetClass() == class\n\t\tend,\n\t\tAction = function(self, ent)\n\t\t\tself:MsgStart()\n\t\t\t\tnet.WriteEntity( ent )\n\t\t\tself:MsgEnd()\n\t\tend,\n\t\tReceive = function(self, length, pl)\n\t\t\tlocal ent = net.ReadEntity()\n\t\t\tif not self:Filter(ent, pl) then return end\n\n\t\t\tif not ent.permaSentUID then\n\t\t\t\tpl:ChatPrint(\"Эта энтити не перманентная\")\n\t\t\t\treturn\n\t\t\tend\n\n\t\t\tlocal uid  = ent.permaSentUID\n\t\t\tcookie.Set(\"perma_\" .. class .. \"_\" .. uid, nil)\n\t\t\tpl:ChatPrint(\"Объект удален. UID был \" .. uid)\n\t\t\tent:Remove()\n\n\t\t\tupdateIndex(uid, nil)\n\t\tend\n\t})\nend\n\nif SERVER then\n\thook.Add(\"IGS.Loaded\", \"IGS.PermaSents\", function()\n\ttimer.Simple(30, function()\n\t\tfor _, ent in ipairs(ents.GetAll()) do\n\t\t\tif ent.permaSentUID then\n\t\t\t\tent:Remove()\n\t\t\tend\n\t\tend\n\n\t\tlocal map = getIndex()\n\t\tfor uid,class in pairs(map) do\n\t\t\tif not scripted_ents.GetStored(class) then\n\t\t\t\tprint(\"IGS.PermaSents: \" .. class .. \" не существует на сервере\")\n\t\t\t\tcontinue\n\t\t\tend\n\n\t\t\tlocal dat = util.JSONToTable(cookie.GetString(\"perma_\" .. class .. \"_\" .. uid))\n\t\t\tlocal ent = SpawnSent(class, util.StringToType(dat[1], \"Vector\"), util.StringToType(dat[2], \"Angle\"))\n\t\t\tent.permaSentUID = uid\n\n\t\t\tprint(\"IGS.PermaSents: Заспавнили \" .. class)\n\t\tend\n\tend)\n\tend)\nend\n","igs/dependencies/plurals.lua":"if TRIGON then return end\n\nlocal function plural_type(i)\n\treturn i % 10 == 1 and i % 100 ~= 11 and 1\n\t\tor (i % 10 >= 2 and i % 10 <= 4 and (i % 100 < 10 or i % 100 >= 20) and 2\n\t\t\tor 3\n\t\t)\nend\n\n\nPL = PL or setmetatable({\n\tlist = {}\n},{__call = function(self,name,i)\n\treturn self.Get(name,i)\nend})\n\nlocal mt = {__call = function(self,i)\n\tlocal pl = self[ plural_type(i) ]\n\treturn i .. \" \" .. pl, pl\nend}\n\n\n\n\nfunction PL.Add(name,plurals)\n\tPL.list[name] = setmetatable(plurals,mt)\n\treturn PL.list[name]\nend\n\nfunction PL.Get(name,i)\n\treturn PL.list[name](i)\nend","igs/dependencies/resources.lua":"-- FontAwesome 32\n-- https://steamcommunity.com/sharedfiles/filedetails/?id=1562487365\n-- /materials/icons/fa32/{icon_name}.png\nresource.AddWorkshop(\"1562487365\")\n\n-- resource.AddWorkshop(\"577994158\") -- модели подарков\n-- \"models/christmas_gift2/christmas_gift.mdl\"\n-- \"models/christmas_gift2/christmas_gift2.mdl\"","igs/dependencies/scc.lua":"-- Simple Chat Commands\n-- Special for IGS by _AMD_\n-- 2019.11.08 01:47\n\nscc = {\n\tcommands = {},\n}\n\nif SERVER then\n\tutil.AddNetworkString(\"scc.run\")\nend\n\nfunction scc.add(command, callback)\n\tscc.commands[command:lower()] = callback\nend\n\nfunction scc.run(pl, command, args)\n\tlocal callback = scc.commands[command:lower()]\n\tcallback(pl, unpack(args or {}))\nend\n\n\nif SERVER then\n\thook.Add(\"PlayerSay\", \"scc\", function(pl, text)\n\t\ttext = text:Trim()\n\t\tif text[1] == \"/\" then\n\t\t\tlocal pieces  = text:Split(\" \")\n\t\t\tlocal command = pieces[1]:sub(2):lower()\n\n\t\t\tif scc.commands[command] then\n\t\t\t\tlocal args = {}\n\t\t\t\tfor i = 2,#pieces do\n\t\t\t\t\targs[#args + 1] = pieces[i]\n\t\t\t\tend\n\n\t\t\t\tscc.run(pl, command, args)\n\t\t\t\treturn \"\"\n\t\t\tend\n\t\tend\n\tend)\nend\n\n\n--[[-------------------------------------------------------------------------\n---------------------------------------------------------------------------]]\n\nlocal PLAYER = FindMetaTable(\"Player\")\nfunction PLAYER:RunSCC(command, ...)\n\tscc.run(self, command, {...})\nend\n\n-- function scc.addWithCooldown(cooldown, command, callback)\n-- \tlocal runIfNotCooldown = function(pl, ...)\n-- \t\tif !pl.sccLastRun then pl.sccLastRun = {} end\n-- \t\tif CurTime() - (pl.sccLastRun[command] or 0) >= cooldown then\n-- \t\t\tpl.sccLastRun[command] = CurTime()\n-- \t\t\tcallback(pl, ...)\n-- \t\tend\n-- \tend\n\n-- \tscc.add(command, runIfNotCooldown)\n-- end\n\nif SERVER then\n\tutil.AddNetworkString(\"scc.run\")\nelse\n\tnet.Receive(\"scc.run\", function()\n\t\tlocal command = net.ReadString()\n\t\tlocal args = {}\n\t\tfor i = 1, net.ReadUInt(4) do\n\t\t\targs[i] = net.ReadString()\n\t\tend\n\n\t\tscc.run(LocalPlayer(), command, args)\n\tend)\nend\n\nfunction scc.addClientside(command, callback)\n\tlocal runOnClient = SERVER and function(pl, ...)\n\t\tlocal args = {...}\n\t\tnet.Start(\"scc.run\")\n\t\t\tnet.WriteString(command)\n\t\t\tnet.WriteUInt(#args, 4)\n\t\t\tfor _,arg in ipairs(args) do\n\t\t\t\tnet.WriteString(arg)\n\t\t\tend\n\t\tnet.Send(pl)\n\tend or callback\n\n\tscc.add(command, runOnClient)\nend\n","igs/dependencies/stack.lua":"local link = {}\nlocal mt = {\n\t__index = link,\n}\n\nfunction link:length()\n\treturn self.tail - self.head + 1\nend\n\nfunction link:isempty()\n\treturn self:length() == 0\nend\n\n\nfunction link:peek()\n\treturn self.data[self.head]\nend\n\nfunction link:lpush(v)\n\tself.tail = self.tail + 1\n\tself.data[self.tail] = v\nend\n\nfunction link:rpush(v)\n\tself.head = self.head - 1\n\tself.data[self.head] = v\nend\n\nfunction link:lpop()\n\tif self.head > self.tail then return nil end\n\tlocal v = self.data[self.tail]\n\tself.data[self.tail] = nil\n\tself.tail = self.tail - 1\n\treturn v\nend\n\nfunction link:rpop()\n\tif self.head > self.tail then return nil end\n\tlocal v = self.data[self.head]\n\tself.data[self.head] = nil\n\tself.head = self.head + 1\n\treturn v\nend\n\nfunction IGStack(...)\n\treturn setmetatable({\n\t\thead = 1,\n\t\ttail = select(\"#\",...),\n\t\tdata = {...},\n\t}, mt)\nend\n\n\n-- local S = IGStack()\n-- S:lpush(1) S:lpush(2) S:lpush(3) -- 3 < 2 < 1\n-- PRINT({len = S:length(), head = S:rpop(), tail = S:lpop()}) -- 1 3\n-- S:rpush(1) S:lpush(3) S:lpush(4) -- вернули, что забрали и добавили слева 4\n-- PRINT({len = S:length(), head = S:rpop(), all = S:table()})\n","igs/extensions/badmin.lua":"IGS.BADMIN_GROUPS = IGS.BADMIN_GROUPS or {}\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetBAdminGroup(rank, rank_priority)\n\tlocal rankId = ba.ranks.Get(rank):GetID()\n\tIGS.BADMIN_GROUPS[rankId] = rank_priority or 0\n\n\tself:SetInstaller(function(pl)\n\t\tpl:SetNetVar(\"UserGroup\", rankId)\n\tend)\n\tself:SetValidator(function(pl)\n\t\tlocal current_rank     = pl:GetNetVar(\"UserGroup\")\n\t\tlocal current_priority = IGS.BADMIN_GROUPS[current_rank]\n\t\tif not current_priority then return end -- ранга игрока нет в продаже. Не сбрасываем\n\n\t\treturn current_priority >= rank_priority -- меняем, если вес текущей меньше, чем новой\n\tend)\n\treturn self\nend\n","igs/extensions/bwhitelist.lua":"IGS.ITEMS.Whitelist = IGS.ITEMS.Whitelist or {}\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nlocal function team_id(team_cmd)\n\treturn DarkRP.getJobByCommand(team_cmd).team\nend\n\nfunction STORE_ITEM:SetWhitelist(team_cmd)\n\tself:SetCategory(\"Вайтлисты\")\n\tself:SetCanActivate(function(pl)\n\t\tif GAS.JobWhitelist:IsWhitelisted(pl, team_id(team_cmd)) then\n\t\t\treturn \"Вы в вайтлисте\"\n\t\tend\n\tend)\n\tself:SetInstaller(function(pl)\n\t\tGAS.JobWhitelist:AddToWhitelist(team_id(team_cmd), GAS.JobWhitelist.LIST_TYPE_STEAMID, pl:SteamID())\n\tend)\n\tself:SetValidator(function(pl)\n\t\treturn GAS.JobWhitelist:IsWhitelisted(pl, team_id(team_cmd))\n\tend)\n\n\tself.whitelist = self:Insert(IGS.ITEMS.Whitelist, team_cmd) -- not team_id из-за DarkRP = nil на этом этапе\n\treturn self\nend\n\nif SERVER then\n\thook.Add(\"IGS.PlayerPurchasesLoaded\", \"IGS.bWhitelist\", function(pl)\n\t\tfor team_cmd,_ in pairs(IGS.ITEMS.Whitelist) do\n\t\t\tGAS.JobWhitelist:RemoveFromWhitelist(team_id(team_cmd), GAS.JobWhitelist.LIST_TYPE_STEAMID, pl:SteamID())\n\t\tend\n\tend)\nend\n","igs/extensions/darkrp.lua":"IGS.ITEMS.DRP = IGS.ITEMS.DRP or {\n\tITEMS = {},\n\tJOBS  = {}\n}\n\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\n-- Делает итем в магазине покупаемым только за донат\n-- Это может быть ящик оружия, отдельная пушка или даже отдельная энтити\nfunction STORE_ITEM:SetDarkRPItem(sEntClass)\n\tself.dpr_item = self:Insert(IGS.ITEMS.DRP.ITEMS, sEntClass)\n\treturn self\nend\n\n-- Доступ к профессиям только тем, кто ее покупал\nfunction STORE_ITEM:SetDarkRPTeams(...)\n\t-- https://trello.com/c/xxGiGpb2/319-улучшить-setdarkrpteam\n\tlocal tTeams = {...}\n\tfor i,team in ipairs(tTeams) do\n\t\tif isnumber(team) then -- обратная совместимость (20.03.2019)\n\t\t\tlocal TEAM = RPExtraTeams[team]\n\t\t\tself:Insert(IGS.ITEMS.DRP.JOBS, TEAM.command)\n\t\t\ttTeams[i] = TEAM.command -- заменяем ENUM на cmd для ITEM.dpr_teams\n\t\telse -- строка (team.command) https://trello.com/c/BcbYbAb7/512\n\t\t\tself:Insert(IGS.ITEMS.DRP.JOBS, team)\n\t\tend\n\tend\n\tself.dpr_teams = tTeams\n\treturn self\nend\nSTORE_ITEM.SetDarkRPTeam = STORE_ITEM.SetDarkRPTeams -- обратная совместимость (20.03.2019)\n\nfunction STORE_ITEM:SetDarkRPMoney(iSum)\n\tself:SetDescription(\"Мгновенно и без проблем пополняет баланс игровой валюты на \" .. string.Comma(iSum) .. \" валюты\")\n\tself:SetInstaller(function(pl) pl:addMoney(iSum,\"IGS\") end)\n\tself:SetStackable()\n\n\tself.dpr_money = iSum\n\treturn self\nend\n\nhook.Add(\"canBuyShipment\", \"IGS\", function(pl, tItem)\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.DRP.ITEMS[tItem.entity])\n\tif ITEM ~= nil then -- донатный итем\n\t\tlocal allow, message = hook.Run(\"IGS.canBuyShipment\", pl, tItem)\n\t\treturn allow or tobool(ITEM), false, message or \"Это для донатеров (/donate)\"\n\tend\nend)\n\nhook.Add(\"canBuyPistol\", \"IGS\", function(pl, tItem)\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.DRP.ITEMS[tItem.entity])\n\tif ITEM ~= nil then -- донатный итем\n\t\tlocal allow, message = hook.Run(\"IGS.canBuyPistol\", pl, tItem)\n\t\treturn allow or tobool(ITEM), false, message or \"Это для донатеров (/donate)\"\n\tend\nend)\n\n-- в DarkRP.hooks нет такого\n-- https://img.qweqwe.ovh/1528097550183.png\nhook.Add(\"canBuyCustomEntity\", \"IGS\", function(pl, tItem)\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.DRP.ITEMS[tItem.ent])\n\tif ITEM ~= nil then -- донатный итем\n\t\tlocal allow, message = hook.Run(\"IGS.canBuyCustomEntity\", pl, tItem)\n\t\treturn allow or tobool(ITEM), false, message or \"Это для донатеров (/donate)\"\n\tend\nend)\n\n-- нет suppress\n-- print(IGS.PlayerHasOneOf(AMD(), IGS.ITEMS.DRP.JOBS[TEAM_LOCK]))\nhook.Add(\"playerCanChangeTeam\", \"IGS\", function(pl, iTeam, bForce)\n\tlocal TEAM = RPExtraTeams[iTeam]\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.DRP.JOBS[TEAM.command])\n\tif ITEM ~= nil then -- донатный итем\n\t\tlocal allow, message = hook.Run(\"IGS.playerCanChangeTeam\", pl, iTeam, bForce)\n\t\treturn allow or tobool(ITEM), message or \"Это для донатеров (/donate)\"\n\tend\nend)\n\n\n-- Hunger\nfunction STORE_ITEM:DisablePlayerHunger()\n\treturn self:SetInstaller(function(pl)\n\t\tpl.igs_disable_hunger = true\n\tend):SetValidator(function(pl)\n\t\treturn false\n\tend)\nend\n\nhook.Add(\"hungerUpdate\", \"IGS\", function(pl)\n\tif pl.igs_disable_hunger then\n\t\tpl:setSelfDarkRPVar(\"Energy\", 100)\n\t\treturn true\n\tend\nend)\n","igs/extensions/evolve.lua":"local ITEM = FindMetaTable(\"IGSItem\")\n\nfunction ITEM:SetEvolveRank(rank)\n\treturn self:SetInstaller(function(pl)\n\t\tevolve.PlayerInfo[pl:UniqueID()][\"Rank\"] = rank\n\tend):SetValidator(function(pl)\n\t\treturn evolve.PlayerInfo[pl:UniqueID()][\"Rank\"] == rank\n\tend):SetMeta(\"ev_rank\", rank)\nend\n","igs/extensions/extra.lua":"local STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetMaxGlobalPurchases(iMax)\n\tIGS.nw.Register(\"total_purchases_\" .. self:UID()) -- только внутри хука юз\n\t\t:Write(net.WriteUInt, 8)\n\t\t:Read(net.ReadUInt, 8)\n\t:SetGlobal():SetHook(\"total_purchases_\" .. self:UID())\n\n\tif CLIENT then -- #todo nw не позволяет, но нужно сделать ОДИН клиентский хук\n\t\thook.Add(\"total_purchases_\" .. self:UID(), self:UID(), function(purchased)\n\t\t\tif self.user_icon == nil then -- чтобы про луа рефреше не стало true\n\t\t\t\tself.user_icon = tobool(self.icon) -- bool вместо ссылки. Нужен, чтобы не оверрайдить юзерские иконки\n\t\t\tend\n\t\t\tif not self.user_icon then\n\t\t\t\tlocal left = iMax - purchased\n\t\t\t\tlocal icon = left <= 0 and \" 0 \" or left -- потому что 0 сайт не пережевывает\n\t\t\t\tself:SetIcon(\"https://via.placeholder.com/90x90.png?text=\" .. icon)\n\t\t\tend\n\n\t\t\tif purchased >= iMax then\n\t\t\t\tself:SetHidden()\n\t\t\tend\n\t\tend)\n\telse\n\t\tlocal purchased = bib.getNum(\"igs:total_purchases:\" .. self:UID())\n\t\tIGS.nw.SetGlobal(\"total_purchases_\" .. self:UID(), purchased or 0)\n\tend\n\n\treturn self:SetMeta(\"global_limit\", iMax)\nend\n\nhook.Add(\"IGS.CanPlayerBuyItem\", \"GlobalLimit\", function(_, ITEM)\n\tif SERVER and ITEM:GetMeta(\"global_limit\") then\n\t\tlocal limit     = ITEM:GetMeta(\"global_limit\")\n\t\tlocal purchased = bib.getNum(\"igs:total_purchases:\" .. ITEM:UID(), 0)\n\n\t\tif purchased >= limit then\n\t\t\treturn false, \"Этот предмет закончился\"\n\t\tend\n\tend\nend)\n\nhook.Add(\"IGS.PlayerPurchasedItem\", \"GlobalLimit\", function(_, ITEM)\n\tif SERVER and ITEM:GetMeta(\"global_limit\") then\n\t\tlocal limit     = ITEM:GetMeta(\"global_limit\")\n\t\tlocal purchased = bib.getNum(\"igs:total_purchases:\" .. ITEM:UID(), 0)\n\n\t\tbib.setNum(\"igs:total_purchases:\"   .. ITEM:UID(), purchased + 1)\n\t\tIGS.nw.SetGlobal(\"total_purchases_\" .. ITEM:UID(), purchased + 1)\n\n\t\tif purchased >= limit then\n\t\t\tITEM:SetHidden()\n\t\tend\n\tend\nend)\n\n\n\n\n-- Возволяет настроить максимальное количество ПОКУПОК одного предмета\n-- Полезно для тестовых випок за рубль и тд\nfunction STORE_ITEM:SetMaxPlayerPurchases(iLimit)\n\tlocal function bibKey(pid, iid) return string.format(\"igs:purchases:%s:%s\", pid, iid) end\n\n\treturn self:SetCanBuy(function(pl)\n\t\tlocal limit = self:GetMeta(\"purchasesLimit\")\n\t\tlocal key = bibKey(pl:UniqueID(), self:UID())\n\t\tif bib.getNum(key, 0) >= limit then\n\t\t\treturn \"Этот предмет можно купить только \" .. limit .. \" раз(а)\"\n\t\tend\n\tend):SetOnBuy(function(pl)\n\t\tlocal limit = self:GetMeta(\"purchasesLimit\")\n\t\tif limit then\n\t\t\tlocal key = bibKey(pl:UniqueID(), self:UID())\n\t\t\tlocal now_purchased = bib.getNum(key, 0) + 1\n\t\t\tbib.setNum(key, now_purchased)\n\t\t\tIGS.Notify(pl, \"Вы купили \" .. self:Name() .. \" \" .. now_purchased .. \" раз из \" .. limit)\n\t\tend\n\tend):SetMeta(\"purchasesLimit\", iLimit)\nend\n\n\n\n\n-- Глобальные итемы будут активированы на каждом сервере проекта\n-- https://img.qweqwe.ovh/1574888071533.png\nfunction STORE_ITEM:SetGlobal(b)\n\treturn self:SetMeta(\"global\", b ~= false)\nend\n\nhook.Add(\"IGS.PlayerActivatedItem\", \"IGS.GlobalPurchase\", function(pl, ITEM)\n\tif SERVER and ITEM:GetMeta(\"global\") then\n\t\tfor sv_id in pairs(IGS.SERVERS.MAP) do\n\t\t\tif sv_id == IGS.SERVERS.CURRENT then continue end -- уже выдано\n\t\t\tIGS.StorePurchase(pl:SteamID64(), ITEM:UID(), ITEM:Term(), sv_id)\n\t\tend\n\t\tIGS.Notify(pl, \"Предмет выдан на \" .. IGS.SERVERS.TOTAL .. \" серверах\")\n\tend\nend)\n\n-- Выдает рандомный предмет из указанных (аналог кейсов)\n-- https://trello.com/c/hWRihJ1k/564\n-- Заметка, почему не нужно делать tItemsUIDs\n-- https://img.qweqwe.ovh/1568507799904.png\n-- Использовать только с :SetStackable предметами\nlocal function giveRandomItem(pl, tItems)\n\tlocal WINNED_ITEM = table.Random(tItems)\n\n\tIGS.PlayerActivateItem(pl, WINNED_ITEM:UID(), function()\n\t\tIGS.Notify(pl, \"Вы получили \" .. WINNED_ITEM:Name())\n\tend)\nend\n\n-- Сочетается с :SetTerm(0), :SetMaxPurchases() и :SetStackable()\nfunction STORE_ITEM:SetRandom(tItems)\n\treturn self:SetInstaller(function(pl)\n\t\tgiveRandomItem(pl, self:GetMeta(\"random_items\"))\n\tend):SetMeta(\"random_items\", tItems)\nend\n\n\nlocal function giveItemsSet(pl, tItems)\n\tlocal added = 0\n\tfor _,ITEM in ipairs(tItems) do\n\t\tIGS.AddToInventory(pl, ITEM:UID(), function()\n\t\t\tadded = added + 1\n\t\t\tif added == #tItems then\n\t\t\t\tIGS.Notify(pl, \"В ваш инвентарь добавлено \" .. added .. \" предметов\")\n\t\t\tend\n\t\tend)\n\tend\nend\n\n-- Ложит В ИНВЕНТАРЬ набор указанных предметов (хотя можно и UID добавить)\n-- Например 10 Hidden аптечек (как замена лимиту активаций в инвентаре)\nfunction STORE_ITEM:SetItems(tItems) -- IGS.C.Inv_Enabled\n\treturn self:SetInstaller(function(pl)\n\t\tgiveItemsSet(pl, self:GetMeta(\"items_set\"))\n\tend):SetMeta(\"items_set\", tItems)\nend\n-- local ITEM = IGS(\"Тайный предмет\", \"secret\", -10):SetStackable():SetHidden():SetOnActivate(fp{PRINT, \"YEAH!!\"})\n-- IGS(\"2 тайных предмета\", \"secret_2\", 5):SetStackable():SetItems({ITEM, ITEM})\n\n\n\n\n--[[-------------------------------------------------------------------------\n\tСекция с возможным перемещением в ядро\n\tПереместить, если AddHook будет востребован для замены каких-то методов ядра\n---------------------------------------------------------------------------]]\n\n-- Должно использовать только те хуки,\n-- где первым аргументом в колбеке идет игрок\n-- ITEM:AddHook(\"PlayerLoadout\", funciton(pl) pl:GiveAmmos() end)\nfunction STORE_ITEM:AddHook(sHook, fCallback)\n\tlocal uid = self:UID()\n\thook.Add(sHook, \"item.\" .. uid, function(pl, ...)\n\t\tif pl:HasPurchase(uid) then\n\t\t\tfCallback(pl, ...)\n\t\tend\n\tend)\n\treturn self\nend\n","igs/extensions/fadmin.lua":"-- Кто-то использует FAdmin, как отдельный аддон к другим гейммодам? О_о\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nlocal function getGroupImmunity(group)\n\tif not FAdmin or not FAdmin.Access or not FAdmin.Access.Groups then return nil end\n\tlocal g = FAdmin.Access.Groups[group]\n\treturn g and g.immunity\nend\n\nlocal function setGroupWithCAMI(pl, newGroup)\n\tif not IsValid(pl) then return end\n\tif not FAdmin or not FAdmin.Access or not FAdmin.Access.Groups then return end\n\tif not FAdmin.Access.Groups[newGroup] then return end\n\n\tlocal oldGroup = pl:GetUserGroup()\n\tif oldGroup == newGroup then return end\n\n\tFAdmin.Access.PlayerSetGroup(pl, newGroup)\n\n\t-- Сохраняем в FAdmin_PlayerGroup (через CAMI хук), чтобы переживало перезаход\n\tif CAMI and CAMI.SignalUserGroupChanged then\n\t\tCAMI.SignalUserGroupChanged(pl, oldGroup, newGroup, \"IGS\")\n\tend\nend\n\nfunction STORE_ITEM:SetFAdminGroup(sGroup, iWeight)\n\t-- Запоминаем группу для последующего восстановления\n\tif SERVER then\n\t\tself:SetMeta(\"fadmin_group\", sGroup)\n\tend\n\n\treturn self:SetInstaller(function(pl)\n\t\t-- Не понижаем привилегии: если текущая выше или равна, пропускаем\n\t\tlocal curGroup = pl:GetUserGroup()\n\t\tlocal curImm   = getGroupImmunity(curGroup)\n\t\tlocal newImm   = getGroupImmunity(sGroup)\n\n\t\tif curImm and newImm and curImm >= newImm then\n\t\t\treturn\n\t\tend\n\n\t\tsetGroupWithCAMI(pl, sGroup)\n\t\tpl.IGSFAdminWeight = iWeight\n\tend):SetValidator(function(pl)\n\t\t-- Если уже в нужной группе — ок\n\t\tif pl:IsUserGroup(sGroup) then\n\t\t\treturn true\n\t\tend\n\n\t\t-- Проверяем иммунитеты из DarkRP/FAdmin\n\t\tlocal curImm = getGroupImmunity(pl:GetUserGroup())\n\t\tlocal newImm = getGroupImmunity(sGroup)\n\t\tif curImm and newImm and curImm >= newImm then\n\t\t\treturn true\n\t\tend\n\n\t\t-- Фолбэк на старые веса, если иммунитетов нет\n\t\tif pl.IGSFAdminWeight then\n\t\t\treturn iWeight < pl.IGSFAdminWeight\n\t\tend\n\n\t\treturn false\n\tend)\nend\n\n-- Восстановление максимальной купленной привилегии\nif SERVER then\n\tfunction IGS.ApplyBestFAdminGroup(pl, purchases)\n\t\tif not IsValid(pl) then return end\n\t\tif not FAdmin or not FAdmin.Access or not FAdmin.Access.Groups then return end\n\t\tif not purchases then return end\n\n\t\tlocal bestGroup, bestImm\n\n\t\tfor uid in pairs(purchases) do\n\t\t\tlocal ITEM = IGS.GetItemByUID(uid)\n\t\t\tif ITEM and ITEM.GetMeta then\n\t\t\t\tlocal grp = ITEM:GetMeta(\"fadmin_group\")\n\t\t\t\tif grp then\n\t\t\t\t\tlocal imm = getGroupImmunity(grp)\n\t\t\t\t\tif imm and (not bestImm or imm > bestImm) then\n\t\t\t\t\t\tbestImm = imm\n\t\t\t\t\t\tbestGroup = grp\n\t\t\t\t\tend\n\t\t\t\tend\n\t\t\tend\n\t\tend\n\n\t\tif not bestGroup then return end\n\n\t\tlocal curGroup = pl:GetUserGroup()\n\t\tlocal curImm = getGroupImmunity(curGroup)\n\n\t\t-- Если текущая группа ниже купленной — возвращаем купленную\n\t\tif not curImm or (bestImm and bestImm > curImm) then\n\t\t\tsetGroupWithCAMI(pl, bestGroup)\n\t\tend\n\tend\nend\n","igs/extensions/levels.lua":"--[[-------------------------------------------------------------------------\n\tПоддержка вот этого говнокода:\n\thttps://github.com/vrondakis/Leveling-System\n---------------------------------------------------------------------------]]\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetLevels(iAmount)\n\treturn self:SetInstaller(function(pl)\n\t\tpl:addLevels(iAmount)\n\tend)\nend\n\nfunction STORE_ITEM:SetEXP(iAmount)\n\treturn self:SetInstaller(function(pl)\n\t\tpl:addXP(iAmount)\n\tend)\nend\n","igs/extensions/pointshop2.lua":"local STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetPremiumPoints(iAmount)\n\treturn self:SetInstaller(function(pl)\n\t\tpl:PS2_AddPremiumPoints(iAmount)\n\tend):SetMeta(\"ps2_prempoints\", iAmount)\nend\n\nfunction STORE_ITEM:SetPoints(iAmount)\n\treturn self:SetInstaller(function(pl)\n\t\tpl:PS2_AddStandardPoints(iAmount, \"/donate\")\n\tend):SetMeta(\"ps2_points\", iAmount)\nend\n","igs/extensions/sam.lua":"IGS.ITEMS.SAM = IGS.ITEMS.SAM or {\n\tGROUPS = {}\n}\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetSAMGroup(sUserGroup, iGroupWeight)\n\tself:SetCategory(\"SAM (Админка)\")\n\n\tself:SetCanActivate(function(pl) -- global, invDbID\n\t\tif pl:IsUserGroup(sUserGroup) then\n\t\t\treturn \"У вас уже действует эта услуга\"\n\t\tend\n\tend)\n\tself:SetInstaller(function(pl)\n\t\tpl:sam_set_rank(sUserGroup)\n\tend)\n\tself:SetValidator(function(pl)\n\t\tif pl.IGSSAMWeight then\n\t\t\treturn iGroupWeight < pl.IGSSAMWeight\n\t\telse\n\t\t\treturn  pl:GetUserGroup() == sUserGroup\n\t\tend\n\tend)\n\n\n\tself.sg_group = self:Insert(IGS.ITEMS.SAM.GROUPS, sUserGroup)\n\treturn self\nend\n\nif CLIENT then return end\n\nlocal function checkGroups(pl)\n\tlocal hasAccess = IGS.PlayerHasOneOf(pl, IGS.ITEMS.SAM.GROUPS[ pl:GetUserGroup() ])\n\tif hasAccess == nil then return end  -- не отслеживается\n\n\tif hasAccess then\n\t\treturn -- если имеется хоть одна покупка, то не снимаем права\n\tend\n\n\tpl:sam_set_rank(\"user\")\nend\n\nhook.Add(\"IGS.PlayerPurchasesLoaded\", \"SAMGroups\", function(pl)\n\tif next(IGS.ITEMS.SAM.GROUPS) then -- группы продаются\n\t\tcheckGroups(pl)\n\tend\nend)\n","igs/extensions/sandbox.lua":"IGS.ITEMS.SB = IGS.ITEMS.SB or {\n\tTOOLS = {},\n\tSENTS = {},\n\tSWEPS = {},\n\tVEHS  = {}\n}\n\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\n-- Тулы\nfunction STORE_ITEM:SetTool(sToolName)\n\tself:SetCategory(\"Инструменты\")\n\tself:SetDescription(\"Разрешает использовать инструмент \" .. sToolName)\n\n\tself.tool = self:Insert(IGS.ITEMS.SB.TOOLS, sToolName)\n\treturn self\nend\n\n-- Энтити\nfunction STORE_ITEM:SetEntity(sEntClass)\n\tself:SetCategory(\"Энтити (Предметы)\")\n\n\tself.entity = self:Insert(IGS.ITEMS.SB.SENTS, sEntClass)\n\treturn self\nend\n\n-- Пушки\nfunction STORE_ITEM:SetWeapon(sWepClass,tAmmo)\n\tself:SetCategory(\"Оружие\")\n\tself:SetDescription(\"Разрешает спавнить \" .. sWepClass .. \" через спавн меню в любое время\")\n\n\tself:SetNetworked() -- для HasPurchase и отображения галочки\n\n\tself.ammo = tAmmo\n\tself.swep = self:Insert(IGS.ITEMS.SB.SWEPS, sWepClass)\n\treturn self\nend\n\nif CLIENT then -- :SetWeapon only\nhook.Add(\"IGS.OnItemInfoOpen\",\"CheckGiveWeaponOnSpawn\",function(ITEM, fr)\n\tif !(ITEM.swep and LocalPlayer():HasPurchase(ITEM:UID())) then return end\n\n\tuigs.Create(\"DCheckBoxLabel\", function(self)\n\t\tself:Dock(TOP)\n\t\tself:DockMargin(0,5,0,0)\n\t\tself:SetTall(20)\n\n\t\tlocal should_give = LocalPlayer():GetNWBool(\"igs.gos.\" .. ITEM:ID())\n\t\tself:SetValue(should_give)\n\n\t\tself:SetText(\"Выдавать при спавне\")\n\t\tself.Label:SetTextColor(IGS.col.TEXT_SOFT)\n\t\tself.Label:SetFont(\"Fated.15\")\n\n\t\tfunction self:OnChange(give)\n\t\t\tnet.Start(\"IGS.GiveOnSpawnWep\")\n\t\t\t\tnet.WriteIGSItem(ITEM)\n\t\t\t\tnet.WriteBool(give)\n\t\t\tnet.SendToServer()\n\t\tend\n\tend, fr.act)\nend)\n\n-- IGS.CloseUI()\n-- IGS.UI()\n-- IGS.WIN.Item(\"wep_weapon_ar2\")\n\nelse -- SV\n\tutil.AddNetworkString(\"IGS.GiveOnSpawnWep\")\n\n\tlocal function bibuid(pl, ITEM)\n\t\treturn \"igs:gos:\" .. pl:UniqueID() .. \":\" .. ITEM:UID()\n\tend\n\n\tlocal function SetShouldPlayerReceiveWep(pl, ITEM, bGive)\n\t\tpl:SetNWBool(\"igs.gos.\" .. ITEM:ID(), bGive) -- gos GiveOnSpawn\n\t\tbib.setBool(bibuid(pl, ITEM), bGive)\n\tend\n\n\tlocal function PlayerSetWantReceiveOnSpawn(pl, ITEM, bWant)\n\t\tSetShouldPlayerReceiveWep(pl, ITEM, bWant)\n\t\tIGS.Notify(pl, ITEM:Name() .. (bWant and \" \" or \" не \") .. \"будет выдаваться при спавне\")\n\tend\n\n\tlocal function GetShouldPlayerReceiveWep(pl, ITEM)\n\t\treturn bib.getBool(bibuid(pl, ITEM))\n\tend\n\n\tlocal function setActiveWeapon(pl, class)\n\t\tpl:SetActiveWeapon(pl:GetWeapon(class))\n\tend\n\n\tlocal function giveItemAmmo(pl, ITEM)\n\t\tfor type,count in pairs(ITEM.ammo or {}) do\n\t\t\tpl:SetAmmo(count,type)\n\t\tend\n\tend\n\n\t-- Выдает купленное оружие, если установлена галочка\n\t-- https://trello.com/c/2KJQisfJ/488-оружие-выдается-и-в-тюрьме\n\tfunction IGS:IGS_PlayerLoadout(pl)\n\t\tfor uid in pairs(IGS.PlayerPurchases(pl) or {}) do\n\t\t\tlocal ITEM = IGS.GetItemByUID(uid)\n\t\t\tif !ITEM.swep then continue end\n\n\t\t\tlocal give = GetShouldPlayerReceiveWep(pl, ITEM)\n\t\t\tif give then\n\t\t\t\tpl:Give(ITEM.swep)\n\t\t\t\tgiveItemAmmo(pl, ITEM)\n\t\t\tend\n\t\tend\n\tend\n\n\tnet.Receive(\"IGS.GiveOnSpawnWep\",function(_, pl)\n\t\tlocal ITEM,bWant = net.ReadIGSItem(),net.ReadBool()\n\t\tif !pl:HasPurchase(ITEM:UID()) or !ITEM.swep then return end -- байпас\n\n\t\tPlayerSetWantReceiveOnSpawn(pl, ITEM, bWant)\n\tend)\n\n\thook.Add(\"PlayerLoadout\", \"IGS.PlayerLoadout\", function(pl)\n\t\thook.Call(\"IGS_PlayerLoadout\", IGS, pl)\n\tend)\n\n\thook.Add(\"IGS.PlayerPurchasesLoaded\", \"IGS.PlayerLoadout\", function(pl)\n\t\thook.Call(\"IGS_PlayerLoadout\", IGS, pl)\n\tend)\n\n\thook.Add(\"IGS.PlayerActivatedItem\",\"IGS.PlayerLoadout\",function(pl, ITEM)\n\t\tif ITEM.swep then\n\t\t\tPlayerSetWantReceiveOnSpawn(pl, ITEM, true) -- default give on spawn\n\t\t\thook.Call(\"IGS_PlayerLoadout\", IGS, pl)\n\n\t\t\tlocal text = \"%s теперь будет выдаваться при каждом респавне. \" ..\n\t\t\t\"Если вы хотите временно отключить выдачу, \" ..\n\t\t\t\"то снимите галочку в карточке предмета в /donate меню\"\n\n\t\t\tpl:ChatPrint(\"▼\")\n\t\t\tIGS.Notify(pl, text:format(ITEM:Name()))\n\t\t\tpl:ChatPrint(\"▲\")\n\n\t\t\tsetActiveWeapon(pl, ITEM.swep)\n\t\t\tgiveItemAmmo(pl, ITEM)\n\t\tend\n\tend)\nend\n\n\n-- Машины\nfunction STORE_ITEM:SetVehicle(sVehClass)\n\tself:SetCategory(\"Транспорт\")\n\n\tself.vehicle = self:Insert(IGS.ITEMS.SB.VEHS, sVehClass)\n\treturn self\nend\n\n-- /\\ SHARED\nif CLIENT then return end\n-- \\/ SERVER\n\n-- print( hook.Run(\"CanTool\", player.Find(\"hell\"), AMD():GetEyeTrace(), \"rope\") )\nhook.Add(\"CanTool\",\"IGS\",function(pl,_,tool)\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.SB.TOOLS[tool])\n\tif ITEM ~= nil then -- donate\n\t\tlocal allow = hook.Run(\"IGS.CanTool\", pl, tool)\n\t\tif allow ~= nil then return allow end\n\t\treturn tobool(ITEM)\n\tend\nend)\n\n-- Ниже решение для машин, как сделать, чтобы не спавнили тучу. Сейчас реализовывать лень\nhook.Add(\"PlayerSpawnSENT\",\"IGS\",function(pl, class)\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.SB.SENTS[class])\n\tif ITEM ~= nil then -- donate\n\t\tlocal allow = hook.Run(\"IGS.PlayerSpawnSENT\", pl, class)\n\t\tif allow ~= nil then return allow end\n\t\treturn tobool(ITEM)\n\tend\nend)\n\n\n-- для HOOK_HIGH\n-- выше 2018.11.15 вынес и немного переписал две функции\n-- Если будет работать норм, то и с остальных снять\ntimer.Simple(0,function()\n\nhook.Add(\"PlayerGiveSWEP\",\"IGS\",function(pl,class)\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.SB.SWEPS[class]) -- hasAccess if ITEM returned\n\tif ITEM then\n\t\ttimer.Simple(.1,function()\n\t\t\tfor type,count in pairs(ITEM.ammo or {}) do\n\t\t\t\tpl:SetAmmo(count,type)\n\t\t\tend\n\t\tend)\n\n\t\treturn true -- #todo не ретурнить true!!. false or nil only\n\tend\nend, HOOK_HIGH)\n\n\n--[[-------------------------------------------------------------------------\n\tМашины\n---------------------------------------------------------------------------]]\nlocal function getcount(pl, class)\n\treturn pl:GetVar(\"vehicles_\" .. class,0)\nend\n\nlocal function counter(pl, class, incr)\n\tpl:SetVar(\"vehicles_\" .. class, getcount(pl,class) + incr)\nend\n\n-- разрешаем спавнить одну, но конструкция позволяет в будущем сделать поддержку спавна нескольких машин\nlocal function canSpawn(pl, class)\n\treturn getcount(pl,class) < 1\nend\n\nlocal function getVehClass(veh)\n\t-- https://trello.com/c/l1tw7YpR/623\n\t-- ClassOverride for scars (https://t.me/c/1353676159/48545)\n\treturn (veh.IsSimfphyscar and veh:GetSpawn_List()) or veh.ClassOverride or veh:GetVehicleClass()\nend\n\n-- Считаем заспавненные и удаленные машины\nhook.Add(\"PlayerSpawnedVehicle\",\"IGS\",function(pl,veh)\n\tif IGS.PlayerHasOneOf(pl, IGS.ITEMS.SB.VEHS[getVehClass(veh)]) then -- чел покупал эту тачку, а теперь спавнит\n\t\tcounter(pl, getVehClass(veh), 1)\n\n\t\tveh:CallOnRemove(\"ChangeCounter\",function(ent)\n\t\t\tif !IsValid(pl) then return end\n\t\t\tcounter(pl, getVehClass(ent), -1)\n\t\tend)\n\tend\nend)\n\nhook.Add(\"PlayerSpawnVehicle\",\"IGS\",function(pl, _, class) -- model, class, table\n\tif IGS.PlayerHasOneOf(pl,IGS.ITEMS.SB.VEHS[class]) then -- покупал машину\n\t\tlocal can = canSpawn(pl,class)\n\t\tif !can then\n\t\t\tIGS.Notify(pl,\"У вас есть заспавнена эта машина\")\n\t\tend\n\n\t\treturn can\n\tend\nend, HOOK_HIGH)\n--[[-------------------------------------------------------------------------\n\t/Машины\n---------------------------------------------------------------------------]]\nlocal prop_limiters_exists = nil -- optimization\n\nfunction STORE_ITEM:IncreasePlayerPropLimit(iAmount)\n\tprop_limiters_exists = true\n\treturn self:SetInstaller(function(pl)\n\t\tlocal current_extra = pl:GetVar(\"igs_extra_props_limit\", 0)\n\t\tpl:SetVar(\"igs_extra_props_limit\", current_extra + iAmount)\n\tend):SetMeta(\"prop_limit\", iAmount)\nend\n\nhook.Add(\"PlayerCheckLimit\", \"IGS\", function(pl, type, current_spawned, general_limit)\n\tif not prop_limiters_exists or type ~= \"props\" then return end\n\n\tlocal extra_props_purchased = pl:GetVar(\"igs_extra_props_limit\", 0)\n\tlocal general_limit_reached = current_spawned >= general_limit\n\tlocal extra_limit_reached   = current_spawned <= extra_props_purchased + general_limit\n\n\t-- первое, чтобы не выбрасывать true лишний раз\n\tif general_limit_reached and (not extra_limit_reached) then\n\t\treturn true\n\tend\nend)\n\nhook.Add(\"IGS.PlayerPurchasesLoaded\", \"IGS.LoadExtraPropsLimit\", function(pl, purchases_)\n\tif not purchases_ or not prop_limiters_exists then return end\n\n\tlocal extra = 0\n\tfor uid in pairs(purchases_) do\n\t\tlocal ITEM = IGS.GetItemByUID(uid)\n\t\tif ITEM:GetMeta(\"prop_limit\") then\n\t\t\textra = extra + ITEM:GetMeta(\"prop_limit\")\n\t\tend\n\tend\n\n\tif extra ~= 0 then\n\t\tpl:SetVar(\"igs_extra_props_limit\", extra)\n\tend\nend)\n\n\n-- hook.Add(\"PlayerCheckLimit\", \"asd\", PRINT)\n\n\n-- DARKRP ONLY\nhook.Add(\"canDropWeapon\",\"IGS\",function(pl,wep)\n\t-- Пушка не продается\n\tif !IsValid(wep) or !IGS.ITEMS.SB.SWEPS[wep:GetClass()] then return end\n\n\t-- Пушка продается и чел купил ее\n\tlocal ITEM = IGS.PlayerHasOneOf(pl, IGS.ITEMS.SB.SWEPS[wep:GetClass()])\n\tif ITEM then\n\t\treturn false\n\tend\n\n\t-- Пушка продается, но чел ее не покупал\n\t-- Т.е. по сути возможность дропа контроллируется другими хуками\nend, HOOK_HIGH)\nend)\n","igs/extensions/serverguard.lua":"IGS.ITEMS.SG = IGS.ITEMS.SG or {\n\tGROUPS = {}\n}\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetSGGroup(sUserGroup, iGroupWeight)\n\tself:SetCanActivate(function(pl)\n\t\tif pl:IsUserGroup(sUserGroup) then\n\t\t\treturn \"У вас уже действует эта услуга\"\n\t\tend\n\tend)\n\tself:SetInstaller(function(pl)\n\t\tlocal rankData = serverguard.ranks:GetRank(sUserGroup)\n\t\tif rankData then\n\t\t\tserverguard.player:SetRank(pl, sUserGroup, 0)\n\t\t\tserverguard.player:SetImmunity(pl, rankData.immunity)\n\t\t\tserverguard.player:SetTargetableRank(pl, rankData.targetable)\n\t\t\tserverguard.player:SetBanLimit(pl, rankData.banlimit)\n\t\t\tpl.IGSSGWeight = iGroupWeight\n\t\tend\n\tend)\n\tself:SetValidator(function(pl)\n\t\tif pl.IGSSGWeight then\n\t\t\treturn iGroupWeight < pl.IGSSGWeight\n\t\telse\n\t\t\treturn serverguard.player:GetRank(pl) == sUserGroup\n\t\tend\n\tend)\n\n\tself.sg_group = self:Insert(IGS.ITEMS.SG.GROUPS, sUserGroup)\n\treturn self\nend\nif CLIENT then return end\nlocal function checkGroups(pl)\n\tlocal hasAccess = IGS.PlayerHasOneOf(pl, IGS.ITEMS.SG.GROUPS[ serverguard.player:GetRank(pl) ])\n\tif hasAccess == nil then return end  -- не отслеживается\n\n\tif hasAccess then\n\t\treturn -- если имеется хоть одна покупка, то не снимаем права\n\tend\n\n\tserverguard.player:SetRank(pl, \"user\", 0);\nend\n\nhook.Add(\"IGS.PlayerPurchasesLoaded\", \"SGGroups\", function(pl)\n\tif next(IGS.ITEMS.SG.GROUPS) then -- группы продаются\n\t\tcheckGroups(pl)\n\tend\nend)\n","igs/extensions/ulx.lua":"IGS.ITEMS.ULX = IGS.ITEMS.ULX or {\n\tGROUPS = {},\n\tPEX    = {}\n}\n\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetULXGroup(sUserGroup, iGroupWeight)\n\tself:SetCanActivate(function(pl) -- invDbID\n\t\tif pl:IsUserGroup(sUserGroup) then\n\t\t\treturn \"У вас уже действует эта услуга\"\n\t\tend\n\tend)\n\tself:SetInstaller(function(pl)\n\t\tRunConsoleCommand(\"ulx\", \"adduserid\", pl:SteamID(), sUserGroup)\n\t\tpl.IGSULXWeight = iGroupWeight\n\tend)\n\tself:SetValidator(function(pl)\n\t\tlocal valid = false\n\t\tif pl.IGSULXWeight then\n\t\t\tvalid = iGroupWeight <= pl.IGSULXWeight\n\t\telse\n\t\t\tvalid = pl:IsUserGroup(sUserGroup)\n\t\tend\n\n\t\tif !valid then\n\t\t\tIGS.NotifyAll(\"Автовосстановление \" .. self:Name() .. \" для \" .. pl:Name())\n\t\t\treturn false\n\t\tend\n\tend)\n\n\n\tself.ulx_group = self:Insert(IGS.ITEMS.ULX.GROUPS, sUserGroup)\n\tself.ulx_group_weight = iGroupWeight\n\treturn self\nend\n\n-- Есть много ньюансов. Коммит 1 октября 2019\nfunction STORE_ITEM:SetULXCommandAccess(cmd,tag) -- \"ulx model\",\"^\", например\n\tself:SetInstaller(function(pl)\n\t\tif !tag then\n\t\t\ttable.insert(ULib.ucl.authed[ pl:UniqueID() ].allow, cmd)\n\t\telse\n\t\t\tULib.ucl.authed[ pl:UniqueID() ].allow[cmd] = tag\n\t\tend\n\tend)\n\tself:SetValidator(function()\n\t\treturn false\n\tend)\n\n\n\tself.ulx_command = self:Insert(IGS.ITEMS.ULX.PEX, cmd)\n\treturn self\nend\n\n\nif CLIENT then return end\n\nlocal function checkGroups(pl)\n\tlocal hasAccess = IGS.PlayerHasOneOf(pl, IGS.ITEMS.ULX.GROUPS[ pl:GetUserGroup() ])\n\tif hasAccess == nil then return end\n\n\tif hasAccess then\n\t\tpl.IGSULXWeight = hasAccess.ulx_group_weight\n\t\treturn -- если имеется хоть одна покупка, то не снимаем права\n\tend\n\n\tRunConsoleCommand(\"ulx\",\"removeuserid\",pl:SteamID())\nend\n\nlocal function hasPexAccess(pl, cmd)\n\tlocal hasAccess = IGS.PlayerHasOneOf(pl, IGS.ITEMS.ULX.PEX[cmd])\n\treturn hasAccess ~= false -- nil, если не продается\nend\n\nlocal function checkPermissions(pl)\n\tlocal user = ULib.ucl.authed[ pl:UniqueID() ]\n\tif !user then return end\n\n\tlocal changed\n\t-- Вид ucl таблицы https://img.qweqwe.ovh/1523035793058.png\n\tfor k,v in pairs(user.allow or {}) do -- не уверен, что allow обязательно есть\n\t\tlocal cmd = isnumber(k) and v or k\n\n\t\tif !hasPexAccess(pl, cmd) then\n\t\t\tuser.allow[k] = nil\n\t\t\tchanged = true\n\t\tend\n\tend\n\n\tif changed then\n\t\tULib.ucl.saveUsers()\n\tend\nend\n\ntimer.Simple(.1, function() -- чтобы этот хук обязательно был после RestorePex. История ВК 20 мая с Антон Панченко\nhook.Add(\"IGS.PlayerPurchasesLoaded\", \"ULXGroupsAndPEX\", function(pl)\n\tif next(IGS.ITEMS.ULX.GROUPS) then\n\t\tcheckGroups(pl)\n\tend\n\n\tif next(IGS.ITEMS.ULX.PEX) then\n\t\tcheckPermissions(pl)\n\tend\nend, HOOK_HIGH)\nend)\n","igs/extensions/xadmin.lua":"IGS.ITEMS.XADMIN_USERS = IGS.ITEMS.XADMIN_USERS or {} -- by kip https://t.me/c/1353676159/1673\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\")\n\nfunction STORE_ITEM:SetXAdminGroup(sUserGroup)\n\treturn self:SetInstaller(function(pl)\n\t\txAdmin.UserGroups[pl:SteamID()] = sUserGroup\n\t\tpl:SetUserGroup(sUserGroup)\n\t\tIGS.ITEMS.XADMIN_USERS[pl:SteamID()] = true\n\tend):SetValidator(function()\n\t\treturn false\n\tend)\nend\n\nhook.Add(\"PlayerDisconnected\", \"IGS.XAdminRemovePerm\", function(pl)\n\tif IGS.ITEMS.XADMIN_USERS[pl:SteamID()] then\n\t\txAdmin.UserGroups[pl:SteamID()] = nil\n\t\tIGS.ITEMS.XADMIN_USERS[pl:SteamID()] = nil\n\tend\nend)\n\n\n-- Есть xAdmin.SetGroup(pl, sUserGroup)\n-- но тогда будет сложнее контроллировать снятие прав, тк идет запись в БД\nfunction STORE_ITEM:SetXAdmin2Group(sUserGroup)\n\treturn self:SetInstaller(function(pl)\n\t\tlocal sid64 = pl:SteamID64()\n\t\tlocal oldgroup = pl:GetUserGroup()\n\n\t\txAdmin.UserData[sid64] = xAdmin.UserData[sid64] or {SteamID = sid64}\n\t\txAdmin.UserData[sid64].UserGroup = sUserGroup\n\n\t\tpl:SetUserGroup(sUserGroup)\n\n\t\txAdmin.UpdateGroupMembers(player.GetAll(), sUserGroup)\n\n\t\thook.Run(\"xAdminUserGroupUpdated\", pl, sUserGroup, oldgroup)\n\tend):AddHook(\"IGS.PlayerPurchasesLoaded\", function(pl, purchases)\n\t\tif CLIENT or not purchases then return end\n\n\t\tlocal priority_item = self\n\n\t\tfor uid in pairs(purchases) do\n\t\t\tlocal ITEM = IGS.GetItemByUID(uid)\n\t\t\tif ITEM:GetMeta(\"badmin2group\") and ITEM.id > self.id then\n\t\t\t\tpriority_item = ITEM\n\t\t\tend\n\t\tend\n\n\t\tif priority_item == self then\n\t\t\tself:Setup(pl)\n\t\tend\n\tend):SetMeta(\"badmin2group\", sUserGroup)\nend\n","igs/interface/activities/inventory.lua":"local function loadTab(activity,sidebar,dat)\n\tlocal bg = uigs.Create(\"Panel\")\n\t\n\tbg.OnRemove = function()\n\t\thook.Remove(\"IGS.PlayerPurchasedItem\",\"UpdateInventoryView\")\n\tend\n\n\tbg.OnOpen = function()\n\t\tlocal frame = activity:GetParent()\n\t\tif frame and frame.SetSidebarVisible then\n\t\t\tframe:SetSidebarVisible(false)\n\t\tend\n\tend\n\n\tlocal content_w = activity:GetContentWide()\n\n\t-- Создаем скролл панель для карточек\n\tlocal scr = uigs.Create(\"igs_scroll\", bg)\n\tscr:SetSize(content_w, activity:GetTall())\n\tscr:SetPos(0, 0)\n\tscr:SetSpacing(10)\n\tscr:SetPadding(10)\n\n\t-- Создаем layout для карточек\n\tlocal icons = uigs.Create(\"DIconLayout\", function(p)\n\t\tp:SetWide(content_w - 20)\n\t\tp:SetSpaceX(10)\n\t\tp:SetSpaceY(10)\n\t\tp.Paint = function() end\n\tend, scr)\n\tscr:AddItem(icons)\n\n\tlocal emptyPanel\n\n\tlocal function removeFromCanvas(itemPan)\n\t\tif IsValid(itemPan) then\n\t\t\titemPan:Remove()\n\t\tend\n\tend\n\n\tfunction icons:AddItem(ITEM, dbID)\n\t\tlocal item = icons:Add(\"igs_item\")\n\t\titem:SetSize(140, 170) -- Стандартный размер карточки как в услугах\n\t\titem:HidePrice(true) -- Скрываем цену в инвентаре\n\t\titem:SetIcon(ITEM:ICON())\n\t\titem:SetName(ITEM:Name())\n\t\t-- Убрана надпись \"Срок\" - карточка показывает только название\n\t\t\n\t\t-- При клике открываем меню действий\n\t\titem.DoClick = function()\n\t\t\t-- Создаем красивое модальное окно вместо обычного меню\n\t\t\tlocal frame = uigs.Create(\"igs_frame\", function(f)\n\t\t\t\tf:SetSize(300, 200)\n\t\t\t\tf:Center()\n\t\t\t\tf:MakePopup()\n\t\t\t\tf:SetTitle(ITEM:Name())\n\t\t\tend)\n\t\t\t\n\t\t\tlocal y = frame:GetTitleHeight() + 10\n\t\t\t\n\t\t\t-- Кнопка активации\n\t\t\tlocal activateBtn = uigs.Create(\"igs_button\", function(btn)\n\t\t\t\tbtn:SetPos(10, y)\n\t\t\t\tbtn:SetSize(frame:GetWide() - 20, 35)\n\t\t\t\tbtn:SetText(\"✓ Активировать\")\n\t\t\t\tbtn:SetActive(true)\n\t\t\t\tbtn.DoClick = function()\n\t\t\t\t\tframe:Close()\n\t\t\t\t\tIGS.ProcessActivate(dbID, function(ok)\n\t\t\t\t\t\tif !ok then return end\n\t\t\t\t\t\tremoveFromCanvas(item)\n\t\t\t\t\tend)\n\t\t\t\tend\n\t\t\tend, frame)\n\t\t\t\n\t\t\ty = y + 40\n\t\t\t\n\t\t\t-- Кнопка информации\n\t\t\tlocal infoBtn = uigs.Create(\"igs_button\", function(btn)\n\t\t\t\tbtn:SetPos(10, y)\n\t\t\t\tbtn:SetSize(frame:GetWide() - 20, 35)\n\t\t\t\tbtn:SetText(\"ℹ Информация\")\n\t\t\t\tbtn.DoClick = function()\n\t\t\t\t\tframe:Close()\n\t\t\t\t\tIGS.WIN.Item(ITEM:UID())\n\t\t\t\tend\n\t\t\tend, frame)\n\t\t\t\n\t\t\ty = y + 40\n\t\t\t\n\t\t\t-- Кнопка отмены\n\t\t\tlocal cancelBtn = uigs.Create(\"igs_button\", function(btn)\n\t\t\t\tbtn:SetPos(10, y)\n\t\t\t\tbtn:SetSize(frame:GetWide() - 20, 35)\n\t\t\t\tbtn:SetText(\"✖ Отмена\")\n\t\t\t\tbtn.DoClick = function()\n\t\t\t\t\tframe:Close()\n\t\t\t\tend\n\t\t\tend, frame)\n\t\t\t\n\t\t\ty = y + 45\n\t\t\tframe:SetTall(y)\n\t\tend\n\tend\n\n\tlocal function showEmptyState()\n\t\tif IsValid(emptyPanel) then return end\n\t\temptyPanel = uigs.Create(\"Panel\", function(p)\n\t\t\tp:SetSize(content_w - 40, 200)\n\t\t\tp:SetPos(20, (activity:GetTall() - 200) / 2)\n\t\t\t\n\t\t\tp.Paint = function(s, w, h)\n\t\t\t\t-- Размытие фона если включено\n\t\t\t\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\t\t\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t\t\t\t:Rad(8)\n\t\t\t\t\t\t:Blur(1.0)\n\t\t\t\t\t:Draw()\n\t\t\t\tend\n\t\t\t\t\n\t\t\t\tdraw.RoundedBox(8, 0, 0, w, h, ColorAlpha(IGS.col.PASSIVE_SELECTIONS, 100))\n\t\t\t\t\n\t\t\t\t-- Иконка\n\t\t\t\tsurface.SetDrawColor(IGS.col.TEXT_SOFT)\n\t\t\t\tsurface.SetMaterial(Material(\"materials/icons/fa32/cart-arrow-down.png\"))\n\t\t\t\tsurface.DrawTexturedRect((w - 64) / 2, 30, 64, 64)\n\t\t\tend\n\t\t\t\n\t\t\tlocal title = uigs.Create(\"DLabel\", p)\n\t\t\ttitle:SetPos(0, 110)\n\t\t\ttitle:SetWide(p:GetWide())\n\t\t\ttitle:SetFont(\"Fated.24\")\n\t\t\ttitle:SetTextColor(IGS.col.TEXT_HARD)\n\t\t\ttitle:SetText(\"Инвентарь пуст\")\n\t\t\ttitle:SetContentAlignment(5)\n\t\t\t\n\t\t\tlocal desc = uigs.Create(\"DLabel\", p)\n\t\t\tdesc:SetPos(20, 145)\n\t\t\tdesc:SetWide(p:GetWide() - 40)\n\t\t\tdesc:SetFont(\"Fated.18\")\n\t\t\tdesc:SetTextColor(IGS.col.TEXT_SOFT)\n\t\t\tdesc:SetText(\"Купленные предметы будут находиться здесь.\\nВы сможете активировать их или передать другим игрокам.\")\n\t\t\tdesc:SetWrap(true)\n\t\t\tdesc:SetAutoStretchVertical(true)\n\t\t\tdesc:SetContentAlignment(5)\n\t\tend, bg)\n\tend\n\n\tlocal function hideEmptyState()\n\t\tif IsValid(emptyPanel) then\n\t\t\temptyPanel:Remove()\n\t\t\temptyPanel = nil\n\t\tend\n\tend\n\n\tif #dat == 0 then\n\t\tshowEmptyState()\n\telse\n\t\tfor _, v in ipairs(dat) do\n\t\t\t-- Добавляем только валидные предметы (null предметы уже очищены на сервере)\n\t\t\ticons:AddItem(v.item, v.id)\n\t\tend\n\tend\n\n\thook.Add(\"IGS.PlayerPurchasedItem\", \"UpdateInventoryView\", function(_, ITEM, invDbID)\n\t\t-- Не добавляем null предметы в UI\n\t\tif not ITEM.isnull then\n\t\t\thideEmptyState()\n\t\t\ticons:AddItem(ITEM, invDbID)\n\t\tend\n\tend)\n\n\tactivity:AddTab(\"Инвентарь\", bg, \"materials/icons/fa32/cart-arrow-down.png\")\nend\n\nhook.Add(\"IGS.CatchActivities\",\"inventory\",function(activity,sidebar)\n\tif !IGS.C.Inv_Enabled then return end\n\n\tIGS.GetInventory(function(items)\n\t\tif !IsValid(sidebar) then return end\n\t\tloadTab(activity,sidebar,items)\n\tend)\nend)\n\n-- IGS.UI()\n","igs/interface/activities/main.lua":"local null = function() end\nlocal etoGlavnayaVkladkaBlya = true\n\nhook.Add(\"IGS.CatchActivities\",\"main\",function(activity,sidebar)\n\tlocal bg = uigs.Create(\"Panel\")\n\n\t-- Панель тегов и готовая кнопка сброса фильтров\n\tlocal tagspan = uigs.Create(\"Panel\", bg)\n\tlocal content_w = activity:GetContentWide()\n\ttagspan:SetWide(content_w)\n\ttagspan:SetPos(0, 0)\n\ttagspan.Paint = function(s,w,h)\n\t\tIGS.S.Panel(s,w,h,nil,nil,nil,true)\n\tend\n\n\t-- сетка https://img.qweqwe.ovh/1487714173294.png\n\tbg.tags = uigs.Create(\"DIconLayout\", function(tags)\n\t\ttags:SetWide(content_w - 5 - 5)\n\t\ttags:SetPos(5,5)\n\t\ttags:SetSpaceX(10)\n\t\ttags:SetSpaceY(10)\n\t\ttags.Paint = null\n\n\t\tfunction tags:AddTag(sName, doClick, sIcon)\n\t\t\tlocal tag = uigs.Create(\"igs_button\")\n\t\t\ttag:SetTall(18)\n\t\t\t\n\t\t\t-- Если есть иконка, добавляем пробелы для смещения текста\n\t\t\tif sIcon then\n\t\t\t\ttag:SetText(\"      \" .. sName .. \" \") -- дополнительные пробелы для иконки\n\t\t\telse\n\t\t\t\ttag:SetText(\" \" .. sName .. \" \") -- костыль для расширения кнопки\n\t\t\tend\n\t\t\t\n\t\t\ttag:SizeToContents()\n\t\t\ttag.DoClick = doClick\n\t\t\t\n\t\t\t-- Если есть иконка, рисуем её поверх\n\t\t\tif sIcon then\n\t\t\t\ttag.categoryIcon = Material(sIcon)\n\t\t\t\ttag.isCategory = true -- флаг для особого стиля категорий\n\t\t\t\t\n\t\t\t\t-- Устанавливаем яркий цвет текста для категории\n\t\t\t\ttag:SetTextColor(IGS.col.TEXT_ON_HIGHLIGHT)\n\t\t\t\t\n\t\t\t\t-- Рисуем иконку поверх всего (после текста)\n\t\t\t\ttag.PaintOver = function(s, w, h)\n\t\t\t\t\tif s.categoryIcon then\n\t\t\t\t\t\t-- Иконка всегда яркая\n\t\t\t\t\t\tsurface.SetDrawColor(IGS.col.TEXT_ON_HIGHLIGHT)\n\t\t\t\t\t\tsurface.SetMaterial(s.categoryIcon)\n\t\t\t\t\t\tsurface.DrawTexturedRect(4, 2, 14, 14)\n\t\t\t\t\tend\n\t\t\t\tend\n\t\t\tend\n\n\t\t\tself:Add(tag)\n\n\t\t\ttags:InvalidateLayout(true) -- tags:GetTall()\n\t\t\ttagspan:SetTall(tags:GetTall() + 5 + 5)\n\n\t\t\tlocal y = tagspan:GetTall()\n\n\t\t\t-- Расхождение вот тут:\n\t\t\t-- https://img.qweqwe.ovh/1493840355855.png\n\t\t\t-- y = y - 10 -- UPD 2020 t.me/c/1353676159/7888\n\n\t\t\tbg.categs:SetTall(activity:GetTall() - y)\n\t\t\tbg.categs:SetPos(0,y)\n\t\t\treturn tag\n\t\tend\n\tend, tagspan)\n\n\tbg.categs = uigs.Create(\"igs_panels_layout_list\", bg) -- center panel\n\tbg.categs:DisableAlignment(true)\n\tbg.categs:SetWide(content_w)\n\n\t-- Раскомментить, если захочу убрать теги\n\t-- bg.categs:SetTall(activity:GetTall() - activity.tabBar:GetTall())\n\t-- bg.categs:SetPos(0,y)\n\n\n\t-- category = true\n\tlocal cats = {}\n\n\tlocal function addItems(fItemsFilter,fGroupFilter)\n\t\tlocal rows = {}\n\n\t\tfor _,GROUP in pairs( IGS.GetGroups() ) do -- name\n\t\t\tif fGroupFilter and fGroupFilter(GROUP) == false then continue end\n\n\t\t\tlocal pnl = uigs.Create(\"igs_group\"):SetGroup(GROUP)\n\t\t\tpnl.category = GROUP:Items()[1].item:Category() -- предполагаем, что в одной группе будут итемы одной категории\n\n\t\t\ttable.insert(rows,pnl)\n\t\tend\n\n\t\t-- не (i)pairs, потому что какой-то ID в каком-то очень редком случае может отсутствовать\n\t\t-- если его кто-то принудительно занилит, чтобы убрать итем например.\n\t\t-- Хотя маловероятно, но все же\n\t\tfor _,ITEM in pairs(IGS.GetItems()) do\n\t\t\tif fItemsFilter and fItemsFilter(ITEM) == false then continue end\n\t\t\tif ITEM:IsHidden() then continue end -- еще в IGS.WIN.Group\n\t\t\tif ITEM:Group()    then continue end -- группированные итемы засунуты в группу выше\n\t\t\tif ITEM.isnull     then continue end -- пустышка\n\n\t\t\tlocal pnl = uigs.Create(\"igs_item\"):SetItem(ITEM)\n\t\t\tpnl.category = ITEM:Category()\n\n\t\t\ttable.insert(rows,pnl)\n\t\tend\n\n\t\tfor _,pnl in ipairs(rows) do\n\t\t\tbg.categs:Add(pnl,pnl.category or \"Разное\").title:SetTextColor(IGS.col.TEXT_HARD) -- http://joxi.ru/Y2LqqyBh5BODA6\n\t\t\tcats[pnl.category or \"Разное\"] = true\n\t\tend\n\tend\n\taddItems()\n\n\n\n\t--[[-------------------------------------------------------------------------\n\t\tТеги (Быстрый выбор категории)\n\t---------------------------------------------------------------------------]]\n\tlocal cat_list = {}\n\tfor categ in pairs(cats) do\n\t\ttable.insert(cat_list, categ)\n\tend\n\ttable.sort(cat_list, function(a, b) return tostring(a) < tostring(b) end)\n\n\tfor i, categ in ipairs(cat_list) do\n\t\t-- Получаем иконку для категории\n\t\tlocal categoryIcon = IGS.GetCategoryIcon(categ)\n\t\t\n\t\tlocal tag = bg.tags:AddTag(categ, function(self)\n\t\t\t-- Сбрасываем активное состояние со всех тегов\n\t\t\tfor _, child in ipairs(bg.tags:GetChildren()) do\n\t\t\t\tif child.SetActive then\n\t\t\t\t\tchild:SetActive(false)\n\t\t\t\tend\n\t\t\tend\n\t\t\t\n\t\t\t-- Устанавливаем активное состояние только на текущий тег\n\t\t\tself:SetActive(true)\n\t\t\t\n\t\t\t-- Предзагружаем иконки товаров этой категории\n\t\t\tfor uid, ITEM in pairs(IGS.ITEMS.STORED or {}) do\n\t\t\t\tlocal itemCategory = ITEM:Category()\n\t\t\t\tlocal matchesCategory = (self.categ == \"Разное\" and !itemCategory) or (itemCategory == self.categ)\n\t\t\t\t\n\t\t\t\tif matchesCategory then\n\t\t\t\t\tlocal icon = ITEM:ICON()\n\t\t\t\t\tif icon and icon:match(\"^https?://\") and not texture.Get(icon) then\n\t\t\t\t\t\ttexture.Create(icon)\n\t\t\t\t\t\t\t:SetSize(256, 256)\n\t\t\t\t\t\t\t:SetFormat(icon:sub(-3) == \"jpg\" and \"jpg\" or \"png\")\n\t\t\t\t\t\t\t:Download(icon)\n\t\t\t\t\tend\n\t\t\t\tend\n\t\t\tend\n\t\t\t\n\t\t\tbg.categs:Clear()\n\n\t\t\t-- #todo переписать это говнище\n\t\t\taddItems(function(ITEM)\n\t\t\t\treturn self.categ == \"Разное\" and !ITEM:Category() or (ITEM:Category() == self.categ)\n\t\t\tend,function(GROUP)\n\t\t\t\treturn self.categ == \"Разное\" and !GROUP:Items()[1].item:Category() or (GROUP:Items()[1].item:Category() == self.categ)\n\t\t\tend)\n\t\tend, categoryIcon)\n\t\ttag.categ = categ\n\n\t\tif i == 1 then\n\t\t\tbg.firstTag = tag\n\t\t\ttag:SetActive(true)\n\t\t\ttag:DoClick()\n\t\tend\n\tend\n\tbg.OnOpen = function()\n\t\tlocal frame = activity:GetParent()\n\t\tif frame and frame.SetSidebarVisible then\n\t\t\tframe:SetSidebarVisible(false)\n\t\tend\n\n\t\tlocal new_w = activity:GetContentWide()\n\t\ttagspan:SetWide(new_w)\n\t\ttagspan:SetPos(0, 0)\n\t\tbg.tags:SetWide(new_w - 5 - 5)\n\t\tbg.categs:SetWide(new_w)\n\t\tbg.categs:SetTall(activity:GetTall() - tagspan:GetTall())\n\t\tbg.categs:SetPos(0, tagspan:GetTall())\n\n\t\t-- На первом открытии пересобираем список после корректной ширины\n\t\tif not bg._firstOpen then\n\t\t\tbg._firstOpen = true\n\t\t\tif IsValid(bg.firstTag) then\n\t\t\t\tbg.firstTag:DoClick()\n\t\t\tend\n\t\tend\n\tend\n\n\tactivity:AddTab(\"Услуги\",bg,\"materials/icons/fa32/rub.png\",etoGlavnayaVkladkaBlya)\nend)\n\n-- local p = IGS.UI()\n-- timer.Simple(3,function() if IsValid(p) then p:Remove() end end)\n","igs/interface/activities/profile.lua":"-- Профиль, где транзакции и прогресс до след. бонуса, а также место в топе донатеров за месяц, бизнес левел\n-- Прототип https://pp.vk.me/c638927/v638927381/1ec19/nQnaytZDxls.jpg (Вышло совсем не как задумано)\n-- Стоимость услуги по текущему курсу\n\nlocal LP\nhook.Add(\"IGS.CatchActivities\",\"profile\",function(activity,sidebar)\n\tLP = LP or LocalPlayer()\n\n\tlocal bg = sidebar:AddPage(\"Информация профиля\")\n\tlocal ava_bg = uigs.Create(\"Panel\", function(self)\n\t\tlocal y = 5\n\n\t\t-- Аватар\n\t\tlocal sw     = bg.side:GetWide() -- 220\n\t\tlocal margin = (sw - 184) / 2\n\t\tuigs.Create(\"AvatarImage\", function(ava)\n\t\t\tava:SetSize(184,184)\n\t\t\tava:SetPos(margin,y)\n\t\t\tava:SetPlayer(LP,184)\n\n\t\t\ty = y + 184\n\t\tend, self)\n\n\t\t-- Ник\n\t\tuigs.Create(\"DLabel\", function(nick)\n\t\t\tnick:SetSize(sw,24)\n\t\t\tnick:SetPos(0,y)\n\t\t\tnick:SetFont(\"Fated.24\")\n\t\t\tnick:SetTextColor(IGS.col.HIGHLIGHTING)\n\t\t\tnick:SetText(LP:Nick())\n\t\t\tnick:SetContentAlignment(5)\n\n\t\t\ty = y + nick:GetTall()\n\t\tend, self)\n\n\t\t-- Стимайди\n\t\tuigs.Create(\"DLabel\", function(sid)\n\t\t\tsid:SetSize(sw,18)\n\t\t\tsid:SetPos(0,y)\n\t\t\tsid:SetFont(\"Fated.18\")\n\t\t\tsid:SetTextColor(IGS.col.TEXT_SOFT)\n\t\t\tsid:SetText(\"(\" .. LP:SteamID() .. \")\")\n\t\t\tsid:SetContentAlignment(5)\n\n\t\t\ty = y + sid:GetTall() + 10\n\t\tend, self)\n\n\t\tfunction self:AddRow(sName,sVal)\n\t\t\tlocal row_bg = uigs.Create(\"Panel\", self)\n\t\t\trow_bg:SetSize(sw,20) -- 20, как и размер шрифта\n\t\t\trow_bg:SetPos(0,y)\n\n\t\t\t-- Key\n\t\t\tlocal n = uigs.Create(\"DLabel\", function(name)\n\t\t\t\tname:SetSize(80,row_bg:GetTall())\n\t\t\t\tname:SetPos(0,0)\n\t\t\t\tname:SetFont(\"Fated.17\")\n\t\t\t\tname:SetTextColor(IGS.col.TEXT_SOFT)\n\t\t\t\tname:SetText(sName)\n\t\t\t\tname:SetContentAlignment(6)\n\t\t\tend, row_bg)\n\n\t\t\t-- Value\n\t\t\tfor i,line in ipairs(string.Wrap(\"Fated.18\",sVal,sw - n:GetWide() - 5)) do\n\t\t\t\tuigs.Create(\"DLabel\", function(val)\n\t\t\t\t\tval:SetSize(sw - n:GetWide() - 5,n:GetTall())\n\t\t\t\t\tval:SetPos(n:GetWide() + 5,(i - 1) * val:GetTall())\n\t\t\t\t\tval:SetFont(\"Fated.18\")\n\t\t\t\t\tval:SetTextColor(IGS.col.TEXT_HARD)\n\t\t\t\t\tval:SetText(line)\n\n\t\t\t\t\ty = y + val:GetTall()\n\t\t\t\t\trow_bg:SetTall(row_bg:GetTall() + val:GetTall())\n\t\t\t\tend, row_bg)\n\t\t\tend\n\n\t\t\tself:SetTall(y + 5)\n\t\tend\n\n\t\tself:SetTall(y + 5)\n\tend)\n\n\tlocal lvl = IGS.PlayerLVL(LP)\n\tlocal mybal  = LP:IGSFunds()\n\tlocal next_lvl = !lvl and IGS.LVL.MAP[1] or lvl:GetNext()\n\n\tava_bg:AddRow(\"Статус\",lvl and lvl:Name() or \"Никто :(\")\n\tif next_lvl then\n\t\tlocal next_desc = next_lvl:Description()\n\n\t\tava_bg:AddRow(\"След. статус\", next_lvl:Name() .. (next_desc and (\"\\n\\n%s\"):format(next_desc) or \"\"))\n\t\tava_bg:AddRow(\"Нужно\", next_lvl:Cost() - IGS.RealPrice( IGS.TotalTransaction(LP) ) .. \" руб\")\n\tend\n\n\tbg.side:AddItem(ava_bg)\n\n\t--[[-------------------------------------------------------------------------\n\t\tОсновная часть фрейма\n\t---------------------------------------------------------------------------]]\n\tuigs.Create(\"igs_table\", function(pnl)\n\t\tpnl:Dock(FILL)\n\t\tpnl:DockMargin(5,5,5,5)\n\n\t\tpnl:SetTitle(\"Транзакции\")\n\n\t\tlocal multisv = IGS.SERVERS.TOTAL > 1\n\t\tif multisv then\n\t\t\tpnl:AddColumn(\"Сервер\",100)\n\t\telse\n\t\t\tpnl:AddColumn(\"#\",40)\n\t\tend\n\n\t\tpnl:AddColumn(\"Сумма\",60)\n\t\tpnl:AddColumn(\"Баланс\",60)\n\t\tpnl:AddColumn(\"Действие\")\n\t\tpnl:AddColumn(\"Дата\",130)\n\n\t\t-- Обновление списка транзакций и информации в сайдбаре\n\t\tIGS.GetMyTransactions(function(dat)\n\t\t\tif !IsValid(pnl) then return end -- Долго данные получались\n\n\t\t\tlocal bit_num_limit = 2 ^ IGS.BIT_TX - 1\n\t\t\tif #dat == bit_num_limit then\n\t\t\t\tpnl:SetTitle(\"Последние \" .. bit_num_limit .. \" транзакций\")\n\t\t\tend\n\n\t\t\tfor i,v in ipairs(dat) do\n\t\t\t\tv.note = v.note or \"-\"\n\n\t\t\t\t-- Если покупка, то пишем ее название или пишем с чем связана транзакция\n\t\t\t\tlocal note =\n\t\t\t\t\tv.note:StartWith(\"P: \") and IGS.GetItemByUID(v.note:sub(4)):Name() or\n\t\t\t\t\tv.note:StartWith(\"A: \") and (\"Пополнение счета (\" .. v.note:sub(4) .. \")\") or\n\t\t\t\t\tv.note:StartWith(\"C: \") and (\"Купон \" .. v.note:sub(4,13) .. \"...\") or\n\t\t\t\t\tv.note\n\n\t\t\t\tpnl:AddLine(\n\t\t\t\t\t-- v.id,\n\t\t\t\t\tmultisv and IGS.ServerName(v.server) or #dat - i + 1,\n\t\t\t\t\tv.sum,\n\t\t\t\t\tmath.Truncate(mybal,2), -- не представляю как, но временами получались очень большие копейки\n\t\t\t\t\tnote,\n\t\t\t\t\tIGS.TimestampToDate(v.date,true)\n\t\t\t\t):SetTooltip((\"%s\\n\\nID транзакции в системе: %i%s\"):format(\n\t\t\t\t\tnote,\n\t\t\t\t\tv.id,\n\t\t\t\t\tnote ~= v.note and (\"\\nОригинальная отметка: \" .. v.note) or \"\"\n\t\t\t\t))\n\n\t\t\t\tmybal = mybal - v.sum\n\t\t\tend\n\n\t\t\tlocal spent = IGS.isUser(LP) and (IGS.TotalTransaction(LP) - mybal) or 0\n\n\t\t\tlocal first = dat[ #dat ]\n\t\t\tava_bg:AddRow(\"## Операций\",#dat .. \" шт.\")\n\t\t\tava_bg:AddRow(\"∑ Операций\",IGS.SignPrice(spent))\n\t\t\tava_bg:AddRow(\"1 Операция\",first and IGS.TimestampToDate(first.date) or \"Не было\")\n\n\t\t\t-- Кнопка \"Активировать купон\" перенесена в шапку главного меню\n\n\t\t\tbg.side:AddItem(uigs.Create(\"Panel\", function(s)\n\t\t\t\ts:SetTall(5)\n\t\t\tend))\n\n\t\tend)\n\tend, bg)\n\n\tactivity:AddTab(\"Профиль\",bg,\"materials/icons/fa32/user.png\")\nend)\n\n-- IGS.UI()\n","igs/interface/activities/purchases.lua":"\nhook.Add(\"IGS.CatchActivities\",\"purchases\",function(activity,sidebar)\n\tlocal bg = uigs.Create(\"Panel\")\n\t\n\tbg.OnOpen = function()\n\t\tlocal frame = activity:GetParent()\n\t\tif frame and frame.SetSidebarVisible then\n\t\t\tframe:SetSidebarVisible(false)\n\t\tend\n\tend\n\n\t--[[-------------------------------------------------------------------------\n\t\tОсновная часть фрейма\n\t---------------------------------------------------------------------------]]\n\tuigs.Create(\"igs_table\", function(pnl)\n\t\tpnl:Dock(FILL)\n\t\tpnl:DockMargin(5,5,5,5)\n\n\t\tpnl:SetTitle(\"Активные покупки\")\n\n\t\tlocal multisv = IGS.SERVERS.TOTAL > 1\n\t\tif multisv then\n\t\t\tpnl:AddColumn(\"Сервер\",100)\n\t\telse\n\t\t\tpnl:AddColumn(\"#\",40)\n\t\tend\n\n\t\tpnl:AddColumn(\"Предмет\")\n\t\tpnl:AddColumn(\"Куплен\",90)\n\t\tpnl:AddColumn(\"Истечет\",90)\n\n\n\t\tIGS.GetMyPurchases(function(d)\n\t\t\tif !IsValid(pnl) then return end -- Долго данные получались, фрейм успели закрыть\n\n\t\t\tfor i,v in ipairs(d) do\n\t\t\t\tlocal sv_name = IGS.ServerName(v.server)\n\t\t\t\tlocal ITEM    = IGS.GetItemByUID(v.item)\n\t\t\t\tlocal sName   = ITEM.isnull and v.item or ITEM:Name()\n\n\t\t\t\tlocal line = pnl:AddLine(\n\t\t\t\t\t-- v.id,\n\t\t\t\t\tmultisv and sv_name or #d - i + 1,\n\t\t\t\t\tsName,\n\t\t\t\t\tIGS.TimestampToDate(v.purchase) or \"Никогда\",\n\t\t\t\t\tIGS.TimestampToDate(v.expire)   or \"Никогда\"\n\t\t\t\t)\n\n\t\t\t\tlocal tip = \"Имя сервера: \" .. sv_name .. \"\\nID в системе: \" .. v.id .. \"\\nОригинальное название: \" .. v.item\n\t\t\t\tif not ITEM.isnull and ITEM:HasReloadns() then\n\t\t\t\t\ttip = tip .. \"\\n\\nПКМ по строке: Надеть/Снять\"\n\t\t\t\tend\n\n\t\t\t\tline:SetTooltip(tip)\n\t\t\t\tline._igs_purchase = v\n\t\t\t\tline._igs_item = ITEM\n\n\t\t\t\tline.DoRightClick = function()\n\t\t\t\t\tif ITEM.isnull or not ITEM:HasReloadns() then return end\n\n\t\t\t\t\t-- Если в списке показываются покупки других серверов — не даем переключать\n\t\t\t\t\tif v.server and IGS.SERVERS and IGS.SERVERS:ID() and v.server ~= IGS.SERVERS:ID() then\n\t\t\t\t\t\tIGS.ShowNotify(\"Можно надевать/снимать только покупки текущего сервера\", \"IGS\")\n\t\t\t\t\t\treturn\n\t\t\t\t\tend\n\n\t\t\t\t\tlocal cat = ITEM:ReloadnsCategory()\n\t\t\t\t\tlocal equipped = LocalPlayer():GetIGSVar(\"igs_reloadns_equipped\") or {}\n\t\t\t\t\tlocal currently = equipped[cat]\n\t\t\t\t\tlocal isEquipped = currently == ITEM:UID()\n\n\t\t\t\t\tlocal m = DermaMenu()\n\t\t\t\t\tif isEquipped then\n\t\t\t\t\t\tm:AddOption(\"Снять\", function()\n\t\t\t\t\t\t\tIGS.ToggleReloadns(ITEM:UID())\n\t\t\t\t\t\tend)\n\t\t\t\t\telse\n\t\t\t\t\t\tm:AddOption(\"Надеть\", function()\n\t\t\t\t\t\t\tIGS.ToggleReloadns(ITEM:UID())\n\t\t\t\t\t\tend)\n\n\t\t\t\t\t\tif currently then\n\t\t\t\t\t\t\tlocal CUR = IGS.GetItemByUID(currently)\n\t\t\t\t\t\t\tlocal curName = (not CUR.isnull) and CUR:Name() or currently\n\t\t\t\t\t\t\tm:AddOption((\"Сейчас надето в категории %d: %s\"):format(cat, curName), function() end):SetEnabled(false)\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tm:AddOption((\"Категория %d сейчас пустая\"):format(cat), function() end):SetEnabled(false)\n\t\t\t\t\t\tend\n\t\t\t\t\tend\n\n\t\t\t\t\tm:Open()\n\t\t\t\tend\n\t\t\tend\n\t\tend)\n\tend, bg)\n\n\tactivity:AddTab(\"Покупки\",bg,\"materials/icons/fa32/reorder.png\")\nend)\n\n-- IGS.UI()\n","igs/interface/core.lua":"IGS.WIN = IGS.WIN or {}\n\nif CLIENT then\n\tif not Mantle then\n\t\tpcall(include, \"mantle/init.lua\")\n\tend\n\n\t-- Ensure Mantle fonts exist before any SetFont calls\n\tlocal function EnsureFatedFonts()\n\t\tlocal sizes = {15,16,17,18,19,20,22,24,40}\n\t\tfor _, size in ipairs(sizes) do\n\t\t\tsurface.CreateFont(\"Fated.\" .. size, {\n\t\t\t\tfont = \"Montserrat Medium\",\n\t\t\t\tsize = size,\n\t\t\t\textended = true\n\t\t\t})\n\t\t\tsurface.CreateFont(\"Fated.\" .. size .. \"b\", {\n\t\t\t\tfont = \"Montserrat Bold\",\n\t\t\t\tsize = size,\n\t\t\t\textended = true\n\t\t\t})\n\t\tend\n\tend\n\n\tEnsureFatedFonts()\nend\n\nuigs = uigs or {}\nfunction uigs.Create(t, f, p)\n\tlocal cb, parent = f, p\n\n\tif not isfunction(f) then -- nil or panel\n\t\tparent, cb = f, nil\n\tend\n\n\tlocal v = vgui.Create(t, parent)\n\tif cb then cb(v, parent) end\n\treturn v\nend\n-- uigs.Create(\"name\")\n-- uigs.Create(\"name\", parent)\n-- uigs.Create(\"name\", func, parent)\n-- uigs.Create(\"name\", func)\n\n\n-- Чтобы не открывало F1 менюшку даркрпшевскую ебучую\nhook.Add(\"DarkRPFinishedLoading\",\"SupressDarkRPF1\",function()\n\tif IGS.C.MENUBUTTON ~= KEY_F1 then return end\n\n\tlocal GM = GM or GAMEMODE\n\tfunction GM:ShowHelp() end\nend)\n\n\n\n\n\n\n-- чтобы аргументом не передалась панель\nlocal function dep() IGS.WIN.Deposit() end\n\n\nlocal mf -- антидубликат\nfunction IGS.UI()\n\tif not IGS.IsLoaded() then\n\t\tLocalPlayer():ChatPrint(\"[IGS] Автодонат не загружен\")\n\t\treturn\n\tend\n\n\tif not IGS.C then -- Проблема AddCSLua. В консоли клиента должны быть ошибки инклюда нескольких базовых файлов\n\t\tLocalPlayer():ChatPrint(\"[IGS] Автодонат установлен неправильно. Сообщите администрации\")\n\t\treturn\n\tend\n\n\tif IsValid(mf) then\n\t\tif not mf:IsVisible() then\n\t\t\tIGS.ShowUI()\n\t\tend\n\t\treturn\n\tend\n\n\tmf = uigs.Create(\"igs_frame\", function(self)\n\t\t-- 700 = (items_in_line * item_pan_wide) + (10(margin) * (items_in_line + 1))\n\t\tself:SetSize(math.min(ScrW(), 900), math.min(ScrH(), 650)) -- позволяет закрыть окно на ущербных разрешениях\n\t\t-- Переопределяем RestoreLocation чтобы всегда центрировать окно\n\t\tself.RestoreLocation = function() self:Center() end\n\t\tself:RememberLocation(\"igs\")\n\t\tself:MakePopup()\n\n\t\t-- если повесить на фрейм, то драг сломается\n\t\tlocal init = CurTime() -- https://t.me/c/1353676159/7185\n\t\tfunction self.btnClose:Think()\n\t\t\tif CurTime() - init > 1 and input.IsKeyDown(IGS.C.MENUBUTTON) then\n\t\t\t\tIGS.HideUI()\n\t\t\tend\n\t\tend\n\tend)\n\n--баланс\n-- Создаем контейнер для баланса и кнопок\nlocal container = vgui.Create(\"Panel\", mf)\nlocal containerWidth = 150 + 100 + 110 -- баланс + купон + пополнить\ncontainer:SetPos(mf:GetWide() - 20 - containerWidth, 0)\ncontainer:SetSize(containerWidth, 23)\n\n-- Общая обводка для всего блока\ncontainer.Paint = function(s, w, h)\n    -- Размытие фона\n    if RNDX and Mantle and Mantle.ui.convar.blur then\n        RNDX().Rect(0, 0, w, h)\n            :Rad(4)\n            :Blur(0.8)\n        :Draw()\n    end\n    \n    -- Фон и обводка\n    draw.RoundedBox(4, 0, 0, w, h, IGS.col.HIGHLIGHTING) -- outline\n    draw.RoundedBox(4, 1, 1, w - 2, h - 2, IGS.col.PASSIVE_SELECTIONS) -- bg\nend\n\n-- Рисуем разделители поверх всего, чтобы они не перекрывались hover-эффектами\ncontainer.PaintOver = function(s, w, h)\n    -- Жирные разделители между кнопками (строго одинаковая толщина 3 пикселя)\n    draw.RoundedBox(0, 149, 2, 3, h - 4, IGS.col.HIGHLIGHTING) -- после баланса\n    draw.RoundedBox(0, 249, 2, 3, h - 4, IGS.col.HIGHLIGHTING) -- после купона\nend\n\n-- Панель баланса (теперь просто информационная, не кнопка)\nlocal balancePanel = vgui.Create(\"Panel\", container)\nbalancePanel:SetPos(0, 0)\nbalancePanel:SetSize(150, 23)\n\nbalancePanel.Paint = function(s, w, h)\n    local font = \"Fated.16\"\n    local text = s.balanceText or \"\"\n    local col = IGS.col.TEXT_HARD or color_white\n    \n    draw.SimpleText(text, font, w / 2, h / 2, col, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)\nend\n\nfunction balancePanel:UPDBalance()\n    self.bal = LocalPlayer():IGSFunds()\n    self.balanceText = \"Баланс: \" .. IGS.SignPrice(self.bal)\nend\n\nbalancePanel:UPDBalance()\n\nbalancePanel.Think = function(s)\n    if s.bal ~= LocalPlayer():IGSFunds() then\n        s:UPDBalance()\n    end\nend\n\n-- Кнопка \"Купон\"\n    local coupon = vgui.Create(\"DButton\", container)\n    coupon:SetPos(150, 0)\n    coupon:SetSize(100, 23)\n    coupon:SetText(\"Купон\")\n    coupon:SetFont(\"Fated.18\")\n    coupon:SetTextColor(IGS.col.TEXT_ON_HIGHLIGHT)\n    coupon:SetTooltip(\"Активировать купон\")\n    coupon.Paint = function(s, w, h)\n        if s:IsHovered() then\n            draw.RoundedBox(0, 0, 0, w, h, Color(255, 255, 255, 15))\n        elseif s:IsDown() then\n            draw.RoundedBox(0, 0, 0, w, h, Color(0, 0, 0, 30))\n        end\n    end\n    coupon.DoClick = function()\n        IGS.WIN.ActivateCoupon()\n    end\n    \n    -- Кнопка \"Пополнить\"\n    local add = vgui.Create(\"DButton\", container)\n    add:SetPos(250, 0)\n    add:SetSize(110, 23)\n    add:SetText(\"Пополнить\")\n    add:SetFont(\"Fated.18\")\n    add:SetTextColor(IGS.col.TEXT_ON_HIGHLIGHT)\n    add:SetTooltip(\"Пополнение счета\")\n    add.Paint = function(s, w, h)\n        -- Активная кнопка\n        draw.RoundedBoxEx(4, 0, 0, w, h, Color(70, 70, 85, 230), false, true, false, true)\n        \n        if s:IsHovered() then\n            draw.RoundedBoxEx(4, 0, 0, w, h, Color(255, 255, 255, 20), false, true, false, true)\n        elseif s:IsDown() then\n            draw.RoundedBoxEx(4, 0, 0, w, h, Color(0, 0, 0, 40), false, true, false, true)\n        end\n    end\nadd.DoClick = dep\n\n\tlocal framePad = 10\n\tmf.activity = uigs.Create(\"igs_tabbar\", function(self)\n\t\tself:SetPos(framePad, mf:GetTitleHeight() + framePad)\n\t\tself:SetSize(700 - framePad * 2, mf:GetTall() - mf:GetTitleHeight() - framePad * 2)\n\tend, mf)\n\n\t-- Херня справа от лэйаута с услугами http://joxi.ru/52aQQ8Efzov120\n\t-- Вид без нее: http://joxi.ru/eAO44lGcXORlro\n\tmf._activityWidthDefault = mf.activity:GetWide()\n\n\tlocal x,y = mf.activity:GetPos()\n\tmf.sidebar = uigs.Create(\"igs_sidebar\", mf)\n\tmf.sidebar:SetSize(mf:GetWide() - framePad * 2 - mf.activity:GetWide(), mf.activity:GetTall() + 1 + 1)\n\tmf.sidebar:SetPos(x + mf.activity:GetWide(),y - 1) -- -1 чтобы перекрыть подчеркивание хэдера\n\tmf.sidebar.PaintOver = function(_,_,h)\n\t\tsurface.SetDrawColor(IGS.col.HARD_LINE)\n\t\tsurface.DrawLine(0,0,0,h) -- линия слева\n\tend\n\tmf.sidebar.header.Paint = function(_,w,h)\n\t\t-- Размытие header'а sidebar'а\n\t\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t\t:Rad(0)\n\t\t\t\t:Blur(1.2)\n\t\t\t:Draw()\n\t\tend\n\t\t\n\t\tdraw.RoundedBox(0,0,0,w,h,IGS.col.FRAME_HEADER)\n\n\t\t-- Убрана линия снизу header'а\n\t\t-- surface.SetDrawColor(IGS.col.HARD_LINE)\n\t\t-- surface.DrawLine(0,h - 1,w,h - 1)\n\tend\n\n\tmf.sidebar.activity = uigs.Create(\"igs_multipanel\", mf.sidebar.sidebar)\n\tmf.sidebar.activity:Dock(FILL)\n\n\tfunction mf.sidebar:AddPanel(panel,active)\n\t\treturn self.activity:AddPanel(panel,active)\n\tend\n\n\tfunction mf.sidebar:Show(iPanelID)\n\t\treturn self.activity:SetActivePanel(iPanelID)\n\tend\n\n\tfunction mf:SetSidebarVisible(bVisible)\n\t\tlocal ax, ay = self.activity:GetPos()\n\t\tlocal activityWide = self._activityWidthDefault or self.activity:GetWide()\n\n\t\tif bVisible then\n\t\t\tself.sidebar:SetVisible(true)\n\t\t\tself.activity:SetSize(activityWide, self.activity:GetTall())\n\t\t\tself.sidebar:SetSize(self:GetWide() - framePad * 2 - activityWide, self.activity:GetTall() + 1 + 1)\n\t\t\tself.sidebar:SetPos(ax + activityWide, ay - 1)\n\t\telse\n\t\t\tself.sidebar:SetVisible(false)\n\t\t\tself.activity:SetSize(self:GetWide() - framePad * 2, self.activity:GetTall())\n\t\tend\n\n\t\tself.activity:InvalidateLayout(true)\n\t\tif self.activity.PerformLayout then\n\t\t\tself.activity:PerformLayout()\n\t\tend\n\tend\n\n\tfunction mf.sidebar:AddPage(sTitle)\n\t\treturn uigs.Create(\"Panel\", function(bg)\n\t\t\tbg.side = uigs.Create(\"igs_scroll\")\n\n\t\t\tbg.SidePanelID = self:AddPanel(bg.side)\n\t\t\tbg.side:SetSize(self:GetSize()) -- если указать раньше, то сбросится\n\t\t\tbg.OnOpen = function(s)\n\t\t\t\tlocal frame = self:GetParent()\n\t\t\t\tif frame and frame.SetSidebarVisible then\n\t\t\t\t\tframe:SetSidebarVisible(true)\n\t\t\t\tend\n\n\t\t\t\tself:SetTitle(sTitle)\n\t\t\t\tself:Show(s.SidePanelID)\n\n\t\t\t\t-- Не знаю как сделать лучше.\n\t\t\t\t-- ЧТобы не оверрайдить полностью - сделал дополнительный метод\n\t\t\t\tif bg.OnOpenOver then\n\t\t\t\t\tbg.OnOpenOver()\n\t\t\t\tend\n\t\t\tend\n\t\tend, self)\n\tend\n\n\t-- Немного не правильно, но эта штука отключает\n\tfor hook_name in pairs(IGS.C.DisabledFrames) do\n\t\thook.Remove(\"IGS.CatchActivities\",hook_name)\n\tend\n\n\t-- Собираем кнопочки в футере\n\thook.Run(\"IGS.CatchActivities\",mf.activity,mf.sidebar)\n\n\treturn mf\nend\n\nfunction IGS.GetUI()\n\treturn IsValid(mf) and mf or nil\nend\n\nfunction IGS.CloseUI()\n\tif IsValid(mf) then\n\t\tmf:Close()\n\tend\nend\n\nlocal lastX,lastY -- remember\nfunction IGS.HideUI()\n\tif not mf.moving then\n\t\tmf.moving = true\n\t\tlastX,lastY = mf:GetPos()\n\t\tmf:MoveTo(-mf:GetWide(), lastY, .2)\n\t\ttimer.Simple(.2, function()\n\t\t\tmf:SetVisible(false)\n\t\t\tmf.moving = false\n\t\tend)\n\tend\nend\n\nfunction IGS.ShowUI()\n\tif not mf.moving then\n\t\tmf.moving = true\n\t\tmf:SetVisible(true)\n\t\tmf:MoveTo(lastX, lastY, .2)\n\t\ttimer.Simple(.2, function() mf.moving = false end)\n\tend\nend\n\nfunction IGS.OpenUITab(sName)\n\tlocal iui = IGS.GetUI() or IGS.UI()\n\n\tfor _,btn in ipairs(iui.activity.Buttons) do\n\t\tif btn:Name() == sName then\n\t\t\tbtn:DoClick()\n\t\tend\n\tend\nend\n\n-- Добавляет блок текста к скролл панели. К обычной не вижу смысла\n-- scroll Должен иметь статический размер. Никаких доков!\n-- Сетка: https://img.qweqwe.ovh/1487023074990.png\nfunction IGS.AddTextBlock(scroll,sTitle,sText) -- используется в фрейме хелпа и чартов\n\t-- \\/ вставленная панель\n\treturn scroll:AddItem(uigs.Create(\"Panel\", function(pnl)\n\t\tlocal y = 3\n\n\t\t-- Title\n\t\tif sTitle then\n\t\t\tfor _,line in ipairs( string.Wrap(\"Fated.20\",sTitle,scroll:GetWide() - 5 - 5) ) do\n\t\t\t\tlocal t = uigs.Create(\"DLabel\", pnl)\n\t\t\t\tt:SetPos(5,y)\n\t\t\t\tt:SetFont(\"Fated.20\")\n\t\t\t\tt:SetText(line)\n\t\t\t\tt:SetTextColor(IGS.col.TEXT_HARD)\n\t\t\t\tt:SizeToContents()\n\n\t\t\t\ty = y + t:GetTall()\n\t\t\tend\n\n\t\t\ty = y + 2\n\t\tend\n\n\t\tfor _,line in ipairs( string.Wrap(\"Fated.18\",sText,scroll:GetWide() - 5 - 5) ) do\n\t\t\tlocal lbl = uigs.Create(\"DLabel\", pnl)\n\t\t\tlbl:SetPos(5,y)\n\t\t\tlbl:SetFont(\"Fated.18\")\n\t\t\tlbl:SetText(line)\n\t\t\tlbl:SetTextColor(IGS.col.TEXT_SOFT)\n\t\t\tlbl:SizeToContents()\n\n\t\t\ty = y + lbl:GetTall()\n\t\tend\n\n\t\tpnl:SetTall(y + 10)\n\tend))\nend\n\nfunction IGS.AddButton(pScroll,sName,fDoClick) -- используется в инвентаре и профиле для юза купонов\n\t-- \\/ вставленная панель\n\treturn pScroll:AddItem(uigs.Create(\"Panel\", function(pan)\n\t\tpan.button = uigs.Create(\"igs_button\", function(s)\n\t\t\ts:SetSize(pScroll:GetWide() - 5 - 5,50)\n\t\t\ts:SetPos(5,5)\n\t\t\ts:SetText(sName)\n\t\t\ts.DoClick = fDoClick\n\t\tend, pan)\n\n\t\tpan:SetTall(pan.button:GetTall() + 5)\n\tend))\nend\n\n-- IGS.UI()\n\n-- timer.Create(\"IGSUI\",30,1,function()\n-- \tif IsValid(mf) then\n-- \t\tmf:Close()\n-- \tend\n-- end)\n","igs/interface/skin.lua":"--[[-------------------------------------------------------------------------\n\tЧерез этот файл невозможно повсеместно изменить скин.\n\tДа и вообще, все в говно на самом деле, но мне лень уже делать все правильно.\n\tЭто куча геммора, который, скорее всего, никому не нужен\n---------------------------------------------------------------------------]]\n\nIGS.S = IGS.S or {}\n\nIGS.S.COLORS = {\n\tFRAME_HEADER        = Color(35,35,35,220), -- Фон верхушки фреймов в т.ч. пополнения счета и т.д. https://img.qweqwe.ovh/1491950958825.png\n\tACTIVITY_BG         = Color(25,25,25,200), -- Фон в каждой вкладке (основной) https://img.qweqwe.ovh/1509370647204.png\n\tTAB_BAR             = Color(30,30,30,210), -- Фон таб бара https://img.qweqwe.ovh/1509370669492.png\n\n\tPASSIVE_SELECTIONS  = Color(40,40,40,180), -- Фон панели тегов, цвет кнопки с балансом, верхушки таблиц, не выделенные кнопки https://img.qweqwe.ovh/1509370720597.png\n\tINNER_SELECTIONS    = Color(45,45,45,200), -- Фон иконок на плашках, фон панелек последних покупок... https://img.qweqwe.ovh/1509370766148.png\n\n\tSOFT_LINE           = Color(60,60,60,180), -- Линия между секциями, типа \"Информация\" и \"Описание\" в инфе об итеме\n\tHARD_LINE           = Color(80,80,80,200), -- Обводки панелей\n\n\tHIGHLIGHTING        = Color(100,100,120), -- Обводка кнопок, цвет текста не активной кнопки (мягкий серо-голубой)\n\tHIGHLIGHT_INACTIVE  = Color(140,140,140), -- Цвет иконки неактивной кнопки таббара, мигающая иконка на фрейме помощи https://img.qweqwe.ovh/1509371884592.png\n\n\tTEXT_HARD           = Color(255,255,255), -- Заголовки, выделяющиеся тексты https://img.qweqwe.ovh/1509372019687.png\n\tTEXT_SOFT           = Color(200,200,200), -- Описания, значения чего-то\n\tTEXT_ON_HIGHLIGHT   = Color(255,255,255), -- Цвет текста на выделенных кнопках\n\n\tLOG_SUCCESS         = Color(76,217,100),  -- В логах пополнения цвет успешных операций\n\tLOG_ERROR           = Color(220,30,70),   -- В логах пополнения цвет ошибок\n\tLOG_NORMAL          = Color(255,255,255), -- В логах пополнения обычные записи\n\n\tICON                = Color(255,255,255), -- цвет иконок на плашечках\n}\n\n-- Вариант раскраски от Павел Тумачев (vk.com/id240371602)\n-- Демо: https://img.qweqwe.ovh/1626714494454.jpg\n-- IGS.S.COLORS = {\n-- \tFRAME_HEADER        = Color(0,0,0),\n-- \tACTIVITY_BG         = Color(10,10,10,180),\n-- \tTAB_BAR             = Color(0,0,0),\n\n-- \tPASSIVE_SELECTIONS  = Color(0,0,0),\n-- \tINNER_SELECTIONS    = Color(0,0,0),\n\n-- \tSOFT_LINE           = Color(51,128,255),\n-- \tHARD_LINE           = Color(51,128,255),\n\n-- \tHIGHLIGHTING        = Color(51,128,255),\n-- \tHIGHLIGHT_INACTIVE  = Color(255,255,255),\n\n-- \tTEXT_HARD           = Color(255,255,255),\n-- \tTEXT_SOFT           = Color(255,255,255),\n-- \tTEXT_ON_HIGHLIGHT   = Color(255,255,255),\n\n-- \tLOG_SUCCESS         = Color(76,217,100),\n-- \tLOG_ERROR           = Color(255,45,85),\n-- \tLOG_NORMAL          = Color(255,255,255),\n\n-- \tICON                = Color(255,255,255),\n-- }\n\n-- Попытки сделать темный скин интерфейса\n-- IGS.S.COLORS = {\n-- \tFRAME_HEADER        = Color(23,23,23),\n-- \tACTIVITY_BG         = Color(13,13,13),\n-- \tTAB_BAR             = Color(23,23,23),\n\n-- \tPASSIVE_SELECTIONS  = Color(23,23,23),\n-- \tINNER_SELECTIONS    = Color(23,23,23),\n\n-- \tSOFT_LINE           = Color(50,50,50),\n-- \tHARD_LINE           = Color(66,66,66),\n\n-- \tHIGHLIGHTING        = Color(230,130,35),\n-- \tHIGHLIGHT_INACTIVE  = Color(130,130,130),\n\n-- \tTEXT_HARD           = Color(255,255,255),\n-- \tTEXT_SOFT           = Color(140,140,150),\n-- \tTEXT_ON_HIGHLIGHT   = Color(255,255,255),\n\n-- \tLOG_SUCCESS         = Color(76,217,100),\n-- \tLOG_ERROR           = Color(255,45,85),\n-- \tLOG_NORMAL          = Color(140,140,150),\n\n-- \tICON                = Color(255,255,255),\n-- }\n\nIGS.col = IGS.S.COLORS\n\n-- https://img.qweqwe.ovh/1486557631077.png\nIGS.S.Panel = function(s,w,h,lL,tL,rL,bL)\n\t-- Фон с размытием\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t:Rad(0)\n\t\t\t:Blur(1.2)\n\t\t:Draw()\n\tend\n\t\n\tdraw.RoundedBox(0,0,0,w,h,IGS.col.PASSIVE_SELECTIONS) -- bg\n\n\tsurface.SetDrawColor(IGS.col.HARD_LINE) -- outline\n\n\tif lL then surface.DrawLine(0,0,0,h) end -- left line\n\tif tL then surface.DrawLine(0,0,w,0) end -- top line\n\tif rL then surface.DrawLine(w,0,w,h) end -- right line\n\tif bL then surface.DrawLine(0,h - 1,w,h - 1) end -- bottom line\nend\n\n-- https://img.qweqwe.ovh/1486557676799.png\nIGS.S.RoundedPanel = function(s,w,h)\n\t-- Фон с размытием\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t:Rad(3)\n\t\t\t:Blur(1.0)\n\t\t:Draw()\n\tend\n\t\n\tdraw.RoundedBox(3,0,0,w,h,        IGS.col.HARD_LINE) -- outline\n\tdraw.RoundedBox(3,1,1,w - 2,h - 2,IGS.col.INNER_SELECTIONS) -- bg\n\n\treturn true\nend\n\n-- igs\\vgui\\igs_frame.lua\nIGS.S.Frame = function(s,w,h)\n\t-- Фон с размытием используя Mantle RNDX\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t:Rad(0)\n\t\t\t:Blur(1.5)\n\t\t:Draw()\n\tend\n\t\n\t-- Прозрачный фон\n\tdraw.RoundedBox(0,0,0,w,h,IGS.col.ACTIVITY_BG)\n\n\t-- /header\n\tlocal th = s:GetTitleHeight()\n\t\n\t-- Header с размытием\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\tRNDX().Rect(0, 0, w, th)\n\t\t\t:Rad(0)\n\t\t\t:Blur(1.5)\n\t\t:Draw()\n\tend\n\t\n\tdraw.RoundedBox(0,0,0,w,th,IGS.col.FRAME_HEADER)\n\t-- Убрана линия снизу header'а\n\t-- surface.SetDrawColor(IGS.col.HARD_LINE)\n\t-- surface.DrawLine(0,th - 1,w,th - 1)\n\t-- \\header\nend\n\n-- igs\\vgui\\igs_table.lua\nIGS.S.TablePanel = function(s,w,h)\n\tif s.header_tall then\n\t\tIGS.S.Panel(s,w,s.header_tall) -- header\n\tend\nend\n\n-- igs_table, igs_frame\nIGS.S.Outline = function(s,w,h)\n\tsurface.SetDrawColor(IGS.col.HARD_LINE)\n\n\t-- https://img.qweqwe.ovh/1486830692390.png\n\tsurface.DrawLine(0,h,0,0)\n\tsurface.DrawLine(0,0,w,0)\n\tsurface.DrawLine(w - 1,0,w - 1,h)\n\tsurface.DrawLine(w,h - 1,0,h - 1)\nend\n","igs/interface/vgui/igs_button.lua":"local PANEL = {}\n\nfunction PANEL:Init()\n\tself:SetTextColor(IGS.col.HIGHLIGHTING)\n\tself:SetFont(\"Fated.18\")\nend\n\n-- Как блять по человечески оверрайднуть эту хуетоту?\n-- function PANEL:SetText(text)\n-- \tself.BaseClass:SetText(\" \" .. text .. \" \") -- чтобы при SizeToContent было не вплотную к стенкам\n-- end\n\nfunction PANEL:SetActive(bActive)\n\tself.active = bActive\n\n\t-- Для кнопок категорий текст всегда яркий\n\tif self.isCategory then\n\t\tself:SetTextColor(IGS.col.TEXT_ON_HIGHLIGHT)\n\telse\n\t\tself:SetTextColor(self.active and IGS.col.TEXT_ON_HIGHLIGHT or IGS.col.HIGHLIGHTING)\n\tend\nend\n\nfunction PANEL:IsActive()\n\treturn self.active\nend\n\nfunction PANEL:Paint(w,h)\n\t-- Размытие фона кнопки\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t:Rad(4)\n\t\t\t:Blur(0.8)\n\t\t:Draw()\n\tend\n\t\n\tif self.active then\n\t\t-- Особый стиль для кнопок категорий\n\t\tif self.isCategory then\n\t\t\t-- Активная категория - прозрачно-бордовый фон\n\t\t\tdraw.RoundedBox(4, 0, 0, w, h, Color(120, 30, 40, 180))\n\t\t\t\n\t\t\tif self:IsHovered() then\n\t\t\t\tdraw.RoundedBox(4, 0, 0, w, h, Color(255, 255, 255, 20))\n\t\t\telseif self:IsDown() then\n\t\t\t\tdraw.RoundedBox(4, 0, 0, w, h, Color(0, 0, 0, 30))\n\t\t\tend\n\t\telse\n\t\t\t-- Обычная активная кнопка - заливка цветом\n\t\t\tdraw.RoundedBox(4, 0, 0, w, h, Color(70, 70, 85, 230))\n\t\t\t\n\t\t\tif self:IsHovered() then\n\t\t\t\tdraw.RoundedBox(4, 0, 0, w, h, Color(255, 255, 255, 20))\n\t\t\telseif self:IsDown() then\n\t\t\t\tdraw.RoundedBox(4, 0, 0, w, h, Color(0, 0, 0, 40))\n\t\t\tend\n\t\tend\n\telse\n\t\t-- Неактивная кнопка - только обводка\n\t\tdraw.RoundedBox(4, 0, 0, w, h, IGS.col.HIGHLIGHTING) -- outline\n\t\tdraw.RoundedBox(4, 1, 1, w - 2, h - 2, IGS.col.PASSIVE_SELECTIONS) -- bg\n\t\t\n\t\tif self:IsHovered() then\n\t\t\tdraw.RoundedBox(4, 1, 1, w - 2, h - 2, Color(255, 255, 255, 15))\n\t\telseif self:IsDown() then\n\t\t\tdraw.RoundedBox(4, 1, 1, w - 2, h - 2, Color(0, 0, 0, 30))\n\t\tend\n\tend\nend\n\nvgui.Register(\"igs_button\",PANEL,\"DButton\")\n\n-- IGS.UI()\n","igs/interface/vgui/igs_frame.lua":"local PANEL = {}\n\nfunction PANEL:Init()\n\tself:DockPadding(0,24,0,0)\n\n\t-- Позиция заголовка будет установлена в PerformLayout для центрирования\n\tself.lblTitle:SetColor(IGS.col.TEXT_HARD)\n\n\tself.btnClose:SetTextColor(IGS.col.HIGHLIGHTING)\n\tself.btnClose:SetText(\"✕\")\n\tself.btnClose:SetSize(30, 24)\n\tself.btnClose.Paint = function() end\n\t-- self.btnClose.DoClick = function() self:Close() end\n\n\t-- self:SetBackgroundBlur(false)\n\tself:SetTitle(\"\")\n\n\t-- self.btnClose:SetVisible(false)\n\tself.btnMaxim:SetVisible(false)\n\tself.btnMinim:SetVisible(false)\n\n\tself.lblTitle:SetFont(\"Fated.20\")\nend\n\nlocal locations = {}\nfunction PANEL:SaveLocation(panel_uid)\n\tlocations[panel_uid] = {self:GetPos()}\nend\n\nfunction PANEL:RestoreLocation(panel_uid)\n\tif locations[panel_uid] then\n\t\tlocal x,y = unpack(locations[panel_uid])\n\t\tself:SetPos(\n\t\t\tmath.Clamp(x,0,ScrW() - 10),\n\t\t\tmath.Clamp(y,0,ScrH() - 10)\n\t\t) -- на случай, если уменьшат разрешение, чтобы не исчезло у краев\n\t\tlocations[panel_uid] = nil\n\telse\n\t\tself:Center()\n\tend\nend\n\nfunction PANEL:RememberLocation(panel_uid)\n\tself.remember_uid = panel_uid\nend\n\n\nfunction PANEL:Close(...)\n\tsurface.PlaySound(\"ambient/water/rain_drip3.wav\")\n\tself.BaseClass.Close(self, ...)\n\tif self.remember_uid then\n\t\tself:SaveLocation(self.remember_uid)\n\tend\nend\n\nfunction PANEL:GetTitleHeight()\n\treturn 24 -- close button H\nend\n\nfunction PANEL:Paint(w,h)\n\tif self.m_bBackgroundBlur then\n\t\tDerma_DrawBackgroundBlur(self, self.m_fCreateTime)\n\tend\n\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\t-- Фон с размытием\n\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t:Rad(10)\n\t\t\t:Blur(1.5)\n\t\t:Draw()\n\t\t\n\t\tRNDX.Draw(10, 0, 0, w, h, IGS.col.ACTIVITY_BG)\n\t\t\n\t\tlocal th = self:GetTitleHeight()\n\t\t\n\t\t-- Header с размытием\n\t\tRNDX().Rect(0, 0, w, th)\n\t\t\t:Rad(10)\n\t\t\t:Blur(1.5)\n\t\t:Draw()\n\t\t\n\t\tRNDX.Draw(10, 0, 0, w, th, IGS.col.FRAME_HEADER)\n\t\t-- Убрана линия снизу header'а\n\t\t-- surface.SetDrawColor(IGS.col.HARD_LINE)\n\t\t-- surface.DrawLine(0, th - 1, w, th - 1)\n\telseif RNDX then\n\t\tRNDX.Draw(10, 0, 0, w, h, IGS.col.ACTIVITY_BG)\n\t\tlocal th = self:GetTitleHeight()\n\t\tRNDX.Draw(10, 0, 0, w, th, IGS.col.FRAME_HEADER)\n\t\t-- Убрана линия снизу header'а\n\t\t-- surface.SetDrawColor(IGS.col.HARD_LINE)\n\t\t-- surface.DrawLine(0, th - 1, w, th - 1)\n\telse\n\t\tIGS.S.Frame(self,w,h)\n\tend\n\treturn true\nend\n\nfunction PANEL:PaintOver(w,h)\n\tif RNDX then\n\t\tRNDX.DrawOutlined(10, 0, 0, w, h, IGS.col.HARD_LINE, 1)\n\telse\n\t\tIGS.S.Outline(self,w,h) -- через = не работало\n\tend\nend\n\nfunction PANEL:Focus()\n\tlocal panels = {}\n\tself:SetBackgroundBlur(true)\n\tfor _, v in ipairs(vgui.GetWorldPanel():GetChildren()) do\n\t\tif v:IsVisible() and (v ~= self) then\n\t\t\tpanels[#panels + 1] = v\n\t\t\tv:SetVisible(false)\n\t\tend\n\tend\n\tself._OnClose = self.OnClose\n\tself.OnClose = function()\n\t\tfor _, v in ipairs(panels) do\n\t\t\tif IsValid(v) then\n\t\t\t\tv:SetVisible(true)\n\t\t\tend\n\t\tend\n\n\t\tself:_OnClose()\n\tend\nend\n\nfunction PANEL:PerformLayout()\n\tself.lblTitle:SizeToContents()\n\t\n\t-- Центрируем заголовок\n\tlocal titleWide = self.lblTitle:GetWide()\n\tlocal frameWide = self:GetWide()\n\tself.lblTitle:SetPos((frameWide - titleWide) / 2, 3)\n\t\n\tself.btnClose:SetPos(0, 0)\n\n\tif self.remember_uid and !self.restored then\n\t\tself.restored = true\n\t\tself:RestoreLocation(self.remember_uid)\n\tend\nend\n\nvgui.Register(\"igs_frame\",PANEL,\"DFrame\")\n-- IGS.UI()\n","igs/interface/vgui/igs_group.lua":"local PANEL = {}\n\nlocal PL_VARIANTS = PL.Add(\"variants\",{\"вариант\", \"варианта\", \"вариантов\"})\nfunction PANEL:SetGroup(ITEM_GROUP)\n\tself.group = ITEM_GROUP\n\n\tif ITEM_GROUP:ICON() then\n\t\tself:SetIcon(ITEM_GROUP:ICON())\n\tend\n\n\tif ITEM_GROUP.highlight then\n\t\tself:SetTitleColor(ITEM_GROUP.highlight)\n\tend\n\n\tlocal visible_items = {}\n\tfor _,GROUP_ITEM in ipairs(ITEM_GROUP:Items()) do\n\t\tif !GROUP_ITEM.item:IsHidden() then\n\t\t\ttable.insert(visible_items, GROUP_ITEM)\n\t\tend\n\tend\n\n\tself:SetName(ITEM_GROUP:Name())\n\tself:SetSign(PL_VARIANTS(#visible_items))\n\n\tlocal min,max = math.huge,0 -- минимальная и максимальная цены итемов\n\tfor _,v in ipairs(visible_items) do\n\t\tlocal price = v.item:PriceInCurrency()\n\n\t\tif price < min then\n\t\t\tmin = price\n\t\tend\n\n\t\tif price > max then\n\t\t\tmax = price\n\t\tend\n\tend\n\n\tif min == max then\n\t\tself:SetBottomText(\"Все по \" .. IGS.SignPrice(min))\n\telse\n\t\tself:SetBottomText(\"От \" .. min .. \" до \" .. IGS.SignPrice(max))\n\tend\n\n\treturn self\nend\n\nfunction PANEL:DoClick()\n\tif !IsValid(self.list_bg) then\n\t\tself.list_bg = IGS.WIN.Group(self.group:UID())\n\tend\nend\n\n\nvgui.Register(\"igs_group\",PANEL,\"igs_item\")\n-- IGS.UI()","igs/interface/vgui/igs_html.lua":"local PANEL = {}\n\nfunction PANEL:Init()\n\tlocal c = IGS.col.HIGHLIGHT_INACTIVE\n\tself.text_color = Color(c.r,c.g,c.b,c.a)\nend\n\nlocal LOADING_TEXT = \"Загрузочка...\"\nlocal ICO          = Material(\"materials/icons/fa32/usd.png\", \"smooth\")\n\nfunction PANEL:Paint(w,h)\n\tself.text_color.a = Lerp( (math.sin(CurTime() * 5) + 1) / 2 ,0,255) -- Alpha\n\n\t-- ИКОНКА\n\tsurface.SetDrawColor(self.text_color)\n\tsurface.SetMaterial(ICO)\n\tlocal y = (h - 50) / 2\n\tsurface.DrawTexturedRect((w - 50) / 2,y - 10,50,50)\n\ty = y + 50 -- центральная точка между иконкой и текстом\n\n\t-- ТЕКСТ\n\tsurface.SetTextColor(self.text_color)\nsurface.SetFont(\"Fated.24\") -- 40\n\tlocal tw = surface.GetTextSize(LOADING_TEXT)\n\tsurface.SetTextPos((w - tw) / 2,y + 10)\n\tsurface.DrawText(LOADING_TEXT)\nend\n\nvgui.Register(\"igs_html\",PANEL,\"HTML\")\n","igs/interface/vgui/igs_item.lua":"--[[-------------------------------------------------------------------------\n\t:SetIcon ДОЛЖЕН вызываться ДО :SetName\n\tа :SetName ДОЛЖЕН вызываться ДО :SetSign\n---------------------------------------------------------------------------]]\nlocal PANEL = {}\n\nlocal function formatRub(iReal)\n\treturn math.Truncate(tonumber(iReal),2) .. \" ₽\"\nend\n\nlocal function getBottomText(ITEM, bShowDiscounted)\n\t-- Приоритет: индивидуальная скидка > глобальная скидка > обычная цена\n\tlocal iDiscFrom = bShowDiscounted and ITEM.discounted_from\n\tlocal iReal = iDiscFrom or ITEM:Price()\n\t\n\t-- Если показываем скидку и нет индивидуальной скидки, применяем глобальную\n\tif bShowDiscounted and !iDiscFrom and IGS.HasGlobalDiscount() then\n\t\tiReal = IGS.GetDiscountedPrice(ITEM:Price())\n\tend\n\n\tlocal iCurr = IGS.PriceInCurrency(iReal)\n\n\tlocal real = formatRub(iReal)\n\tlocal curr = IGS.SignPrice(iCurr)\n\n\tif IGS.IsCurrencyEnabled() then\n\t\treturn real .. \" (\" .. curr .. \")\"\n\telse\n\t\treturn real\n\tend\nend\n\nlocal function DrawRoundedPanel(x, y, w, h, radius, outline_col, fill_col, outline_thick)\n\tif RNDX then\n\t\t-- Размытие фона если включено в Mantle\n\t\tif Mantle and Mantle.ui.convar.blur then\n\t\t\tRNDX().Rect(x, y, w, h)\n\t\t\t\t:Rad(radius)\n\t\t\t\t:Blur(1.0)\n\t\t\t:Draw()\n\t\tend\n\t\t\n\t\tRNDX.Draw(radius, x, y, w, h, fill_col)\n\t\tRNDX.DrawOutlined(radius, x, y, w, h, outline_col, outline_thick or 1)\n\t\treturn\n\tend\n\n\tdraw.RoundedBox(radius, x, y, w, h, outline_col)\n\tdraw.RoundedBox(radius, x + 1, y + 1, w - 2, h - 2, fill_col)\nend\n\nlocal function DrawPriceTag(x, y, w, h, outline_col, fill_col, outline_thick)\n\tlocal r = h / 2\n\tif RNDX and RNDX.NO_TR and RNDX.NO_BL then\n\t\t-- TL rounded, TR sharp, BL sharp, BR rounded\n\t\tlocal flags = bit.bor(RNDX.NO_TR, RNDX.NO_BL)\n\t\tRNDX.Draw(r, x, y, w, h, fill_col, flags)\n\t\tRNDX.DrawOutlined(r, x, y, w, h, outline_col, outline_thick or 1, flags)\n\t\treturn\n\tend\n\n\tdraw.RoundedBoxEx(r, x, y, w, h, outline_col, true, false, false, true)\n\tdraw.RoundedBoxEx(r, x + 1, y + 1, w - 2, h - 2, fill_col, true, false, false, true)\nend\n\nlocal function DrawPriceTagFilled(x, y, w, h, fill_col)\n\tlocal r = h / 2\n\tlocal r2 = r + 4\n\tif RNDX and RNDX.NO_TR and RNDX.NO_BL then\n\t\tlocal flags = bit.bor(RNDX.NO_TR, RNDX.NO_BL)\n\t\tRNDX.Draw(r, x, y, w, h, fill_col, flags)\n\t\t-- усиливаем скругление правого нижнего угла\n\t\tRNDX.DrawCircle(x + w - r2, y + h - r2, r2 * 2, fill_col)\n\t\treturn\n\tend\n\n\tdraw.RoundedBoxEx(r, x, y, w, h, fill_col, true, false, false, true)\n\tdraw.RoundedBox(r2, x + w - r2 * 2, y + h - r2 * 2, r2 * 2, r2 * 2, fill_col)\nend\n\nlocal CARD_BG = Color(35, 35, 35, 220)\nlocal NAME_BG = Color(45, 45, 45, 200)\nlocal PRICE_BG = Color(55, 55, 55, 210)\n\n\nfunction PANEL:Init()\n\tself:SetSize(140,170) -- увеличена высота для равных отступов сверху/снизу\n\tself.compact = false\n\tself.iconbg = uigs.Create(\"Panel\", self)\n\tself.iconbg:SetSize(self:GetWide(), self:GetWide()) -- квадратная зона иконки\n\tself.iconbg:SetPos(0, 0)\n\tself.iconbg.Paint = function(_, w, h)\n\t\tDrawRoundedPanel(0, 0, w, h, 6, IGS.col.HARD_LINE, IGS.col.INNER_SELECTIONS)\n\tend\n\nend\n\nfunction PANEL:SetItem(STORE_ITEM)\n\tself.item = STORE_ITEM\n\n\tself:SetIcon(STORE_ITEM:ICON())\n\tself:SetName(STORE_ITEM:Name())\n\t-- self:SetPrice(STORE_ITEM:Price())\n\n\tself:SetTitleColor(STORE_ITEM:GetHighlightColor()) -- nil\n\tself:SetPriceOnIcon( getBottomText(STORE_ITEM, true) )\n\n\treturn self\nend\n\nfunction PANEL:SetName(sName)\n\t(self.icon or self):SetTooltip(sName .. (self.item and \"\\n\\n\" .. self.item:Description():gsub(\"\\n\\n\",\"\\n\") or \"\"))\n\n\tself.name = self.name or uigs.Create(\"DLabel\", function(lbl)\n\t\tlbl:SetTall(20)\n\t\tlbl:SetFont(\"Fated.15b\")\n\t\tlbl:SetTextColor(color_white)\n\t\tlbl:SetText(\"\")\n\n\t\tlbl.Paint = function(s,w,h)\n\t\t\tlocal text = s._igs_text or \"\"\n\t\t\tif text == \"\" then return end\n\n\t\t\tsurface.SetFont(s:GetFont())\n\t\t\tDrawRoundedPanel(0, 0, w, h, 6, Color(128, 0, 32, 255), NAME_BG)\n\t\t\tdraw.SimpleText(\n\t\t\t\ttext,\n\t\t\t\ts:GetFont(),\n\t\t\t\tw / 2,\n\t\t\t\th / 2,\n\t\t\t\ts:GetTextColor(),\n\t\t\t\tTEXT_ALIGN_CENTER,\n\t\t\t\tTEXT_ALIGN_CENTER\n\t\t\t)\n\t\tend\n\tend, self)\n\n\tself.name._igs_text = sName\n\n\treturn self.name\nend\n\nfunction PANEL:SetPriceOnIcon(sPrice)\n\tif self.compact or !self.iconbg or self.hidePrice then return end\n\n\tself.price_on_icon = self.price_on_icon or uigs.Create(\"DLabel\", function(lbl)\n\t\tlbl:SetFont(\"Fated.15b\")\n\t\tlbl:SetTextColor(color_white)\n\t\tlbl:SetContentAlignment(5) -- центр\n\t\tlbl.Paint = function(s,w,h)\n\t\t\tDrawPriceTagFilled(0, 0, w, h, PRICE_BG)\n\t\t\t\n\t\t\t-- Рисуем старую цену зачеркнутой, если есть скидка\n\t\t\tif s.oldPrice then\n\t\t\t\tlocal font = \"Fated.14\"\n\t\t\t\tlocal oldPriceText = s.oldPrice\n\t\t\t\tlocal currentPriceText = s:GetText()\n\t\t\t\t\n\t\t\t\tsurface.SetFont(font)\n\t\t\t\tlocal oldPriceWidth = surface.GetTextSize(oldPriceText)\n\t\t\t\t\n\t\t\t\tsurface.SetFont(s:GetFont())\n\t\t\t\tlocal currentPriceWidth = surface.GetTextSize(currentPriceText)\n\t\t\t\t\n\t\t\t\tlocal totalWidth = oldPriceWidth + 8 + currentPriceWidth\n\t\t\t\tlocal startX = (w - totalWidth) / 2\n\t\t\t\t\n\t\t\t\t-- Рисуем старую цену слева (серая и меньше)\n\t\t\t\tdraw.SimpleText(\n\t\t\t\t\toldPriceText,\n\t\t\t\t\tfont,\n\t\t\t\t\tstartX,\n\t\t\t\t\th / 2,\n\t\t\t\t\tColor(180, 180, 180, 200),\n\t\t\t\t\tTEXT_ALIGN_LEFT,\n\t\t\t\t\tTEXT_ALIGN_CENTER\n\t\t\t\t)\n\t\t\t\t\n\t\t\t\t-- Зачеркиваем старую цену\n\t\t\t\tsurface.SetDrawColor(Color(200, 200, 200, 200))\n\t\t\t\tlocal lineY = h / 2\n\t\t\t\tsurface.DrawLine(startX, lineY, startX + oldPriceWidth, lineY)\n\t\t\t\t\n\t\t\t\t-- Рисуем текущую цену справа\n\t\t\t\tdraw.SimpleText(\n\t\t\t\t\tcurrentPriceText,\n\t\t\t\t\ts:GetFont(),\n\t\t\t\t\tstartX + oldPriceWidth + 8,\n\t\t\t\t\th / 2,\n\t\t\t\t\ts:GetTextColor(),\n\t\t\t\t\tTEXT_ALIGN_LEFT,\n\t\t\t\t\tTEXT_ALIGN_CENTER\n\t\t\t\t)\n\t\t\t\t\n\t\t\t\treturn true\n\t\t\tend\n\t\tend\n\tend, self.iconbg)\n\n\tself.price_on_icon:SetText(sPrice)\n\tself.price_on_icon:SizeToContents()\n\t\n\t-- Проверяем, есть ли скидка (индивидуальная или глобальная)\n\tlocal hasDiscount = false\n\tif self.item then\n\t\thasDiscount = self.item.discounted_from or IGS.HasGlobalDiscount()\n\tend\n\t\n\t-- Если есть скидка, добавляем место для старой цены\n\tif hasDiscount then\n\t\tlocal oldPrice = getBottomText(self.item, false)\n\t\tself.price_on_icon.oldPrice = oldPrice\n\t\t\n\t\t-- Увеличиваем ширину для двух цен\n\t\tsurface.SetFont(\"Fated.14\")\n\t\tlocal oldPriceWidth = surface.GetTextSize(oldPrice)\n\t\tsurface.SetFont(\"Fated.15b\")\n\t\tlocal currentPriceWidth = surface.GetTextSize(sPrice)\n\t\t\n\t\tlocal totalWidth = oldPriceWidth + 8 + currentPriceWidth + 10\n\t\tself.price_on_icon:SetSize(totalWidth, self.price_on_icon:GetTall() + 6)\n\telse\n\t\tself.price_on_icon.oldPrice = nil\n\t\tself.price_on_icon:SetSize(self.price_on_icon:GetWide() + 10, self.price_on_icon:GetTall() + 6)\n\tend\nend\n\nfunction PANEL:HidePrice(bHide)\n\tself.hidePrice = bHide\n\tif self.price_on_icon then\n\t\tself.price_on_icon:SetVisible(!bHide)\n\tend\n\treturn self\nend\n\nfunction PANEL:SetCompact(bCompact)\n\tself.compact = bCompact\n\n\tif IsValid(self.iconbg) then\n\t\tlocal size = self.compact and 40 or 90\n\t\tself.iconbg:SetSize(size, size)\n\tend\n\n\tif self.price_on_icon then\n\t\tself.price_on_icon:SetVisible(!self.compact)\n\tend\nend\n\nfunction PANEL:SetSign(sSignature)\n\tself.sign = self.sign or uigs.Create(\"DLabel\", function(lbl)\n\t\tlbl:SetTall(15)\n\t\tlbl:SetFont(\"Fated.15\")\n\t\tlbl:SetTextColor(IGS.col.TEXT_SOFT)\n\tend, self)\n\n\tself.sign:SetText(sSignature)\n\n\treturn self.sign\nend\n\nfunction PANEL:SetBottomText(sBottomText)\n\tself.bottom = self.bottom or uigs.Create(\"DLabel\", function(lbl)\n\t\tlbl:SetTall(15)\n\t\tlbl:SetFont(\"Fated.15\")\n\t\tlbl:SetTextColor(IGS.col.TEXT_SOFT)\n\t\tlbl:SetContentAlignment(5)\n\t\t-- lbl:SetWrap(true)\n\t\t-- lbl:SetAutoStretchVertical(true)\n\tend, self)\n\n\tself.bottom:SetText(sBottomText)\n\n\treturn self.bottom\nend\n\n-- TODO снизу в рамочку и DOCK RIGHT вместе с док фильным сроком\n-- function PANEL:SetPrice(iPrice)\n-- \tself.price = iPrice\n-- \treturn self\n-- end\n\nfunction PANEL:SetIcon(sIco,bIsModel) -- :SetIcon() для сброса\n\tif !sIco then return self end\n\n\tif bIsModel and !file.Exists(sIco, \"GAME\") then\n\t\tsIco = \"models/props_lab/huladoll.mdl\"\n\tend\n\n\tif !self.icon then\n\t\tself.icon = bIsModel and uigs.Create(\"DModelPanel\", function(mdl)\n\t\t\tmdl:Dock(FILL)\n\t\t\tmdl:DockMargin(2,2,2,2)\n\t\t\tmdl:SetModel(sIco)\n\n\t\t\tlocal mn, mx = mdl.Entity:GetRenderBounds()\n\t\t\tlocal size = 0\n\t\t\tsize = math.max(size, math.abs(mn.x) + math.abs(mx.x))\n\t\t\tsize = math.max(size, math.abs(mn.y) + math.abs(mx.y))\n\t\t\tsize = math.max(size, math.abs(mn.z) + math.abs(mx.z))\n\n\t\t\tmdl:SetFOV(30)\n\t\t\tmdl:SetCamPos(Vector(size, size, size))\n\t\t\tmdl:SetLookAt((mn + mx) * 0.5)\n\t\t\tmdl.LayoutEntity = function() return false end\n\t\tend, self.iconbg)\n\n\t\t-- НЕ моделька (Ссылка на иконку)\n\t\tor\n\n\t\tuigs.Create(\"igs_wmat\", function(ico)\n\t\t\tico:Dock(FILL)\n\t\t\tico:DockMargin(2,2,2,2)\n\t\tend, self.iconbg)\n\tend\n\n\tif bIsModel then\n\t\tself.icon:SetModel(sIco)\n\telse\n\t\tself.icon:SetURL(sIco)\n\tend\n\n\treturn self\nend\n\nfunction PANEL:DoClick()\n\tIGS.WIN.Item(self.item:UID()) -- Обязательно предварительно SetItem\nend\n\nfunction PANEL:PerformLayout()\n\tif self.compact then\n\t\tif IsValid(self.iconbg) then\n\t\t\tself.iconbg:SetSize(40, 40)\n\t\t\tself.iconbg:SetPos(2, 2)\n\t\tend\n\n\t\tif self.name then\n\t\t\tlocal x = 2 + (self.iconbg and self.iconbg:GetWide() or 0) + 5\n\t\t\tself.name:SetPos(x, 2)\n\t\t\tself.name:SetWide(self:GetWide() - x - 2)\n\t\t\tself.name:SetContentAlignment(4)\n\t\tend\n\n\t\tif self.name and self.sign then\n\t\t\tlocal nx,ny = self.name:GetPos()\n\t\t\tself.sign:SetPos(nx, ny + self.name:GetTall() + 2)\n\t\t\tself.sign:SetWide(self.name:GetWide())\n\t\t\tself.sign:SetContentAlignment(4)\n\t\tend\n\telse\n\t\t-- Иконка сверху (квадратная), название ниже\n\t\tif IsValid(self.iconbg) then\n\t\t\tlocal name_h = self.name and self.name:GetTall() or 20\n\t\t\tlocal gap = 6\n\t\t\tlocal icon_size = self:GetWide() - 20\n\t\t\tlocal max_size = self:GetTall() - name_h - gap - 2\n\t\t\ticon_size = math.min(icon_size, max_size)\n\t\t\tlocal pad = math.max((self:GetTall() - icon_size - name_h - gap) / 2, 0)\n\t\t\tself.iconbg:SetSize(icon_size, icon_size)\n\t\t\tself.iconbg:SetPos((self:GetWide() - icon_size) / 2, pad)\n\t\tend\n\n\t\tif self.name then\n\t\t\tlocal gap = 6\n\t\t\tlocal pad = math.max((self:GetTall() - self.iconbg:GetTall() - self.name:GetTall() - gap) / 2, 0)\n\t\t\tself.name:SetPos(5, pad + self.iconbg:GetTall() + gap)\n\t\t\tself.name:SetWide(self:GetWide() - 10)\n\t\t\tself.name:SetContentAlignment(5)\n\t\tend\n\n\t\tif self.price_on_icon and IsValid(self.iconbg) then\n\t\t\tself.price_on_icon:SetPos(\n\t\t\t\tself.iconbg:GetWide() - self.price_on_icon:GetWide() + 1,\n\t\t\t\tself.iconbg:GetTall() - self.price_on_icon:GetTall() + 1\n\t\t\t)\n\t\tend\n\tend\n\n\tif self.title_color and self.name then\n\t\tself.name:SetTextColor(self.title_color)\n\tend\nend\n\nfunction PANEL:SetTitleColor(c)\n\tself.title_color = c\nend\n\n\nfunction PANEL:Paint(w,h)\n\t-- Размытие фона карточки\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t:Rad(6)\n\t\t\t:Blur(1.2)\n\t\t:Draw()\n\tend\n\t\n\tDrawRoundedPanel(0, 0, w, h, 6, IGS.col.HARD_LINE, CARD_BG)\n\n\treturn true\nend\n\n--[[-------------------------------------------------------------------------\n\tЖто все нужно было для отрисовки лейбла с размером скидки\n\tПроблема оказалась на этапе рисования повернутого текста\n\tНабросы: https://gist.github.com/AMD-NICK/7f2aeb674763fe91c2d0668f84357f2e\n\tКарточка: https://trello.com/c/Zx6qTzBn/303\n\n\tColor(220,30,70) -- Штуки за биркой\n\tColor(255,30,85) -- Цвет бирки\n\tColor(255,255,255) -- Текст бирки\n\tdraw.RotatedText\n---------------------------------------------------------------------------]]\n-- local function draw_TextRotated(text, x, y, color, font, ang)\n-- \tsurface.SetFont(font)\n-- \tsurface.SetTextColor(color)\n-- \tsurface.GetTextSize(text)\n\n-- \tlocal m = Matrix()\n-- \tm:SetAngles(Angle(0, ang, 0))\n-- \tm:SetTranslation(Vector(x, y, 0))\n\n-- \tcam.PushModelMatrix(m)\n-- \t\tsurface.SetTextPos(0, 0)\n-- \t\tsurface.DrawText(text)\n-- \tcam.PopModelMatrix()\n-- end\n\n-- local function draw_Poly(tVertices,tColor_)\n-- \tsurface.SetDrawColor(tColor_ or color_white)\n-- \tdraw.NoTexture()\n-- \tsurface.DrawPoly(tVertices)\n-- end\n\n-- 2250, 3000 = 25\n-- local function diffNumsPercent(a, b)\n-- \treturn math.ceil(100 - a / (b / 100))\n-- end\n\n-- Вс. функцию можно назвать пиздецкой костылякой\nfunction PANEL:PaintOver(w,h) end\n\n\nvgui.Register(\"igs_item\",PANEL,\"DButton\")\n\n-- IGS.CloseUI()\n-- IGS.UI()","igs/interface/vgui/igs_iteminfo.lua":"local PANEL = {}\n\nlocal dock = 5\n\nfunction PANEL:Init()\n\tself.head = uigs.Create(\"Panel\", self)\n\tself.head:SetTall(100)\n\tself.head:Dock(TOP)\n\tself.head:DockPadding(dock,dock,dock,dock)\n\tself.head.Paint = function(s,w,h)\n\t\tIGS.S.Panel(s,w,h, nil,nil,nil,true)\n\tend\n\n\tself.scroll = uigs.Create(\"igs_scroll\", self)\n\tself.scroll:Dock(FILL)\nend\n\nfunction PANEL:SetName(sName)\n\tself.name = self.name or uigs.Create(\"DLabel\", function(lbl)\n\t\tlbl:Dock(TOP)\n\t\t--lbl:SetTall(22)\n\t\tlbl:SetFont(\"Fated.22\")\n\t\tlbl:SetTextColor(IGS.col.TEXT_HARD)\n\t\tlbl:SetWrap(true)\n\t\tlbl:SetAutoStretchVertical(true)\n\t\tlbl:SizeToContents()\n\tend, self.head)\n\n\tself.name:SetText(sName)\nend\n\n-- Добавляет иконку рядом с названием инфо панели\nfunction PANEL:SetIcon(sIco, bIsModel) -- url, Material or Model path\n\t-- bIsModel = true\n\t-- sIco = \"models/weapons/w_npcnade.mdl\"\n\n\tself.icon_bg = self.icon_bg or uigs.Create(\"Panel\", function(bg)\n\t\tbg.Paint = IGS.S.RoundedPanel\n\t\tbg:SetWide(self.head:GetTall() - dock * 2)\n\t\tbg:Dock(LEFT)\n\t\tbg:DockPadding(3,3,3,3)\n\t\tbg:DockMargin(0,0,dock,0)\n\n\t\tbg:InvalidateParent(true) -- true bg:GetSize()\n\tend, self.head)\n\n\tif IsValid(self.icon) and\n\t\t((self.model and !bIsModel) or   -- Если раньше была установлена моделька, а сейчас надо поставить иконку\n\t\t(!self.model and bIsModel)) then -- Наоборот. Нужно поставить модельку, но стаяла картинка\n\n\t\tself.icon:Remove()\n\t\tself.icon = nil\n\tend\n\n\tself.model = bIsModel and sIco\n\tself.icon  = self.icon or (bIsModel and uigs.Create(\"DModelPanel\", function(mdl)\n\t\tmdl:SetSize(self.icon_bg:GetSize())\n\t\tmdl:SetModel(sIco)\n\n\t\tlocal mn, mx = mdl.Entity:GetRenderBounds()\n\t\tlocal size = 0\n\t\tsize = math.max(size, math.abs(mn.x) + math.abs(mx.x))\n\t\tsize = math.max(size, math.abs(mn.y) + math.abs(mx.y))\n\t\tsize = math.max(size, math.abs(mn.z) + math.abs(mx.z))\n\n\t\tmdl:SetFOV(30)\n\t\tmdl:SetCamPos(Vector(size, size, size))\n\t\tmdl:SetLookAt((mn + mx) * 0.5)\n\t\tmdl.LayoutEntity = function() return false end\n\n\tend, self.icon_bg)) or uigs.Create(\"igs_wmat\", function(ico)\n\t\tico:SetSize(self.icon_bg:GetSize())\n\t\tico.AutoSize = false\n\tend, self.icon_bg) -- НЕ моделька (Ссылка на иконку)\n\n\n\tif bIsModel then\n\t\tself.icon:SetModel(sIco)\n\telse\n\t\tself.icon:SetURL(sIco) -- nil = сброс\n\tend\nend\n\n-- Кнопка под названием инфо панели\nfunction PANEL:SetSubNameButton(sName,func)\n\tif !sName then return end\n\n\tself.sub = self.sub or uigs.Create(\"DButton\", function(btn)\n\t\tbtn:Dock(TOP)\n\t\tbtn:SetTall(20)\n\t\tbtn:SetFont(\"Fated.20\")\n\t\tbtn:SetTextColor(IGS.col.TEXT_SOFT)\n\t\tbtn:SetContentAlignment(4)\n\t\tbtn.DoClick = func\n\t\tbtn.Paint = function() end\n\tend, self.head)\n\n\tself.sub:SetText(sName .. \"⯈\")\nend\n\n-- Создает невидимую панельку вот тут:\n-- https://img.qweqwe.ovh/1486589180000.png\nfunction PANEL:CreateActivity()\n\tself.activity = self.activity or uigs.Create(\"Panel\", function(btn)\n\t\tbtn:Dock(FILL)\n\tend, self.head)\n\n\treturn self.activity\nend\n\n-- Описание, информация, картинка\nfunction PANEL:AddPanel(sTitle,panel)\n\t-- https://img.qweqwe.ovh/1486595573943.png\n\tlocal background = uigs.Create(\"Panel\", function(bg)\n\t\tbg:DockPadding(10,0,10,0) -- отступы по краям внутри скролла\n\t\tbg.Paint = function(s,w,h) -- линия снизу посередине панели https://img.qweqwe.ovh/1491948928484.png\n\t\t\tsurface.SetDrawColor(IGS.col.SOFT_LINE)\n\t\t\tsurface.DrawLine(10,h - 1,w - 10,h - 1)\n\t\tend\n\tend) -- для отступов\n\n\tlocal y = panel:GetTall() -- с доками не вышло, пришлось сетить вручную\n\n\tuigs.Create(\"DLabel\", function(title)\n\t\ttitle:Dock(TOP)\n\t\ttitle:SetTall(22)\n\t\ttitle:DockMargin(0,10,0,5)\n\t\ttitle:SetText(sTitle)\n\t\ttitle:SetFont(\"Fated.22\")\n\t\ttitle:SetTextColor(IGS.col.TEXT_HARD)\n\n\t\ty = y + 22 + 5 + 5\n\tend, background)\n\n\tpanel:SetParent(background)\n\tpanel:Dock(TOP)\n\n\tself.scroll:AddItem(background)\n\n\tbackground:SetTall(y + 5 + 10) -- 5 хз че, а 10 - отступ от текста к бортику снизу\nend\n\nfunction PANEL:Reset()\n\tself.scroll:Reset()\n\n\tif self.name then\n\t\tself.name:SetText(\"\")\n\tend\n\n\tif self.sub then\n\t\tself.sub:SetText(\"\")\n\tend\n\n\tif self.icon then\n\t\tself.icon:SetURL() -- IGS.C.DefaultIcon\n\tend\nend\n\n\n--[[-------------------------------------------------------------------------\nНе обязательные методы. Их тут не должно быть с точки зрения правильности кода\nНо так как я панель больше нигде, кроме IGS не юзаю, то мне так будет удобнее\n---------------------------------------------------------------------------]]\n-- Добавляет панель с описанием\nfunction PANEL:SetDescription(sDescription)\n\tif self.description then return end\n\n\tlocal pnl = uigs.Create(\"Panel\")\n\n\tself:InvalidateParent(true)\n\tlocal w = self:GetWide()\n\tlocal txt = string.Wrap(\"Fated.15\", sDescription, w - 10 - 10)\n\tlocal y   = 0\n\n\tfor _,line in ipairs(txt) do\n\t\tuigs.Create(\"DLabel\", function(d)\n\t\t\td:SetPos(0,y)\n\t\t\td:SetSize(w,15)\n\t\t\td:SetFont(\"Fated.15\")\n\t\t\td:SetTextColor(IGS.col.TEXT_SOFT)\n\t\t\td:SetText(line)\n\n\t\t\ty = y + 15\n\t\tend, pnl)\n\tend\n\n\tpnl:SetTall(y)\n\tself:AddPanel(\"Описание\",pnl)\nend\n\nfunction PANEL:SetInfo(tInf)\n\tlocal pnl = uigs.Create(\"Panel\")\n\tlocal y = 0\n\n\tfor k,v in pairs(tInf) do\n\t\tlocal line_bg = uigs.Create(\"Panel\", pnl)\n\t\tline_bg:SetTall(15)\n\t\tline_bg:Dock(TOP)\n\n\t\tuigs.Create(\"DLabel\", function(key)\n\t\t\tkey:Dock(LEFT)\n\t\t\tkey:SetWide(80)\n\t\t\tkey:SetFont(\"Fated.15\")\n\t\t\tkey:SetTextColor(IGS.col.TEXT_SOFT)\n\t\t\tkey:SetText(k)\n\t\t\tkey:SetContentAlignment(6)\n\t\tend, line_bg)\n\n\t\tuigs.Create(\"DLabel\", function(key)\n\t\t\tkey:Dock(FILL)\n\t\t\tkey:SetFont(\"Fated.15\")\n\t\t\tkey:SetTextColor(IGS.col.TEXT_HARD)\n\t\t\tkey:SetText(\"  \" .. v)\n\t\t\tkey:SetContentAlignment(4)\n\t\tend, line_bg)\n\n\t\ty = y + 15\n\tend\n\n\tpnl:SetTall(y)\n\tself:AddPanel(\"Информация\",pnl)\nend\n\n-- Добавляет панель с указанным изображением\nfunction PANEL:SetImage(sUrl)\n\tif !sUrl then return end\n\n\tself:InvalidateParent(true) -- self:GetWide()\n\n\tlocal pnl = uigs.Create(\"igs_wmat\")\n\tpnl:SetSize(self:GetWide(),self:GetWide() / 5 * 2) -- соотношение 5:2\n\tpnl:SetURL(sUrl)\n\n\tself:AddPanel(\"Изображение\",pnl)\nend\n\nvgui.Register(\"igs_iteminfo\",PANEL,\"Panel\")\n\n-- IGS.WIN.Item(\"group_premium_15d\")\n","igs/interface/vgui/igs_multipanel.lua":"--[[-------------------------------------------------------------------------\nПанель, на которой можно разместить несколько других и переключаться между ними\nИспользуется в igs_tabbar и может использоваться по отдельности\n\nОбращаем внимание на pnl:OnOpen()\n---------------------------------------------------------------------------]]\n\nlocal PANEL = {}\n\nfunction PANEL:Init()\n\tself.Panels = {}\nend\n\nfunction PANEL:AddPanel(panel,bActive)\n\tpanel:SetSize(self:GetWide(),self:GetTall())\n\tpanel:SetVisible(false)\n\tpanel:SetParent(self)\n\t-- panel.Paint = function(s,w,h) end -- АХТУНГ. Уже дважды на грабли встал\n\t-- Не понимал, почему не добавляется панель. Потом дошло, что этот хук ее просто прячет\n\n\tpanel.ID = table.insert(self.Panels,panel)\n\n\tif (bActive) then\n\t\tself:SetActivePanel(panel.ID)\n\tend\n\n\treturn panel.ID\nend\n\nfunction PANEL:SetActivePanel(iID)\n\tfor i,pnl in ipairs(self.Panels) do\n\t\tpnl.Active = iID == i\n\n\t\tif (pnl:IsVisible()) then\n\t\t\tpnl:Dock(NODOCK)\n\t\t\tpnl:SetVisible(false)\n\t\tend\n\n\t\tif (iID == i) then\n\t\t\tpnl:SetVisible(true)\n\t\t\tpnl:DockMargin(0, 0, 0, 0)\n\t\t\tpnl:Dock(FILL)\n\n\t\t\tif pnl.OnOpen then\n\t\t\t\tpnl:OnOpen()\n\t\t\tend\n\t\tend\n\tend\nend\n\nfunction PANEL:GetActivePanel()\n\tfor i,pnl in ipairs(self.Panels) do\n\t\tif pnl.Active then\n\t\t\treturn pnl\n\t\tend\n\tend\nend\n\nvgui.Register(\"igs_multipanel\", PANEL, \"Panel\")\n-- IGS.UI()\n","igs/interface/vgui/igs_panels_layout.lua":"-- http://joxi.ru/Vm6bbvlipXRZmZ\n\n-- TODO переписать. СНОВА. Чтобы норм вставляло эллементы с разной шириной, не выходя за пределы строки\nlocal PANEL = {}\n\nfunction PANEL:Init()\n\tself.name  = \"Untitled\"\n\tself.panels = {} -- line, panels\n\n\tself.current_line = 1\n\n\t--self.elements_tall = 80\nend\n\nfunction PANEL:SetName(sName)\n\tif !sName then return end\n\n\tself.name = sName\n\n\tself.title = self.title or uigs.Create(\"DLabel\", function(title)\n\t\ttitle:SetSize(self:GetWide() - 10 - 10,30)\n\t\ttitle:SetPos(10,10)\n\t\ttitle:SetFont(\"Fated.24\")\n\n\t\t-- 30 is label height, 10 is margins\n\t\tself.last_y = 10 + 30\n\tend, self)\n\n\tself.title:SetText(self.name)\n\n\treturn self.title\nend\n\nfunction PANEL:GetLineWide(iLine)\n\tlocal w = 0\n\tfor _,pan in ipairs(self.panels[iLine]) do\n\t\tw = w + pan:GetWide()\n\tend\n\n\t-- 10 - размер отступа\n\treturn w + (#self.panels[iLine] - 1) * 10\nend\n\n-- Возвращает панели в строке\n-- function PANEL:GetLine(iLine)\n-- \treturn self.panels[iLine]\n-- end\n\nfunction PANEL:GetCurrentLine()\n\treturn self.panels[self.current_line]\nend\n\n-- Y для следующего ряда панелек\nfunction PANEL:GetY()\n\tlocal y = (#self.panels - 1) * (self.elements_tall + 10) -- в #self.panels кол-во линий\n\n\treturn self.title and (y + 10 + 30) or y\nend\n\nfunction PANEL:Add(panel)\n\tpanel:SetParent(self)\n\n\t-- Все эллементы в лэйауте должны быть одинаковой высоты, хотя могут быть разной ширины\n\tself.elements_tall = self.elements_tall or panel:GetTall()\n\n\tself.panels[self.current_line] = self.panels[self.current_line] or {}\n\ttable.insert(self.panels[self.current_line],panel)\n\n\tlocal line_wide = self:GetLineWide(self.current_line)\n\n\tlocal borders = !self.disabled_align and (self:GetWide() - line_wide) / 2 -- отступы по сторонам\n\tlocal line_panels = self:GetCurrentLine()\n\n\tfor i,pan in ipairs(line_panels) do\n\n\t\t-- Если первая панель, то делаем отступ, чтобы в конце все было по середине\n\t\tif i == 1 then\n\t\t\tpan:SetPos(self.disabled_align and 10 or borders, self:GetY())\n\t\telse\n\t\t\tlocal x,y = line_panels[i - 1]:GetPos()\n\t\t\tpan:SetPos(x + line_panels[i - 1]:GetWide() + 10,y)\n\t\tend\n\tend\n\n\t-- Если размер существующих компонентов + еще один <= размер лэйаута, то вставляем эллемент\n\t-- if panel.tag then\n\t-- \tprint(\"\\n\\n\")\n\t-- \tprint(\"self:GetWide()\",self:GetWide())\n\t-- \tprint(\"panel:GetWide()\",panel:GetWide())\n\t-- \tprint(\"line_wide\",line_wide)\n\t-- \tprint(panel)\n\t-- end\n\tif line_wide + 10 + panel:GetWide() > self:GetWide() then\n\t\t-- if panel.tag then\n\t\t-- \tPrintTable(self.panels)\n\t\t-- \tprint(\"Перешли на след. ряд\")\n\t\t-- \t--panel:SetPos(self.disabled_align and 10 or borders, self:GetY())\n\t\t-- end\n\t\tself.current_line = self.current_line + 1\n\tend\n\n\tself:PerformLayout()\nend\n\nfunction PANEL:PerformLayout()\n\tself:SetHeight(self:GetY() + self.elements_tall) -- + 10 margin\nend\n\n-- Отключает центрирование эллементов\nfunction PANEL:DisableAlignment(bDisable)\n\tself.disabled_align = bDisable\nend\n\n\nvgui.Register(\"igs_panels_layout\", PANEL, \"Panel\")\n--IGS.UI()\n","igs/interface/vgui/igs_panels_layout_list.lua":"local PANEL = {}\n\nfunction PANEL:Init()\n\t-- categ_name > categpan\n\tself.list = {}\nend\n\n-- Одиночное добавление\nfunction PANEL:Add(panel,sCategory)\n\tlocal cat = sCategory or \"Разное\"\n\n\tif !self.list[cat] then\n\t\tself.list[cat] = uigs.Create(\"igs_panels_layout\", self)\n\t\tself.list[cat]:SetWide(self:GetWide()) -- используем ширину родителя вместо жестко заданной 650\n\t\tself.list[cat]:SetName(sCategory)\n\t\tself.list[cat]:DisableAlignment(self.disabled_align)\n\n\t\tself:AddItem(self.list[cat])\n\tend\n\n\tself.list[cat]:Add(panel)\n\n\treturn self.list[cat]\nend\n\n-- Отключает центрирование эллементов во всех панелях лэйаута\nfunction PANEL:DisableAlignment(bDisable)\n\tself.disabled_align = bDisable\nend\n\nfunction PANEL:Clear()\n\tfor _,panel in pairs(self.list) do -- categ\n\t\tpanel:Remove()\n\tend\n\n\tself:Init()\nend\n\nfunction PANEL:OnSizeChanged()\n\t-- Обновляем ширину всех категорий при изменении размера родителя\n\tfor _,panel in pairs(self.list) do\n\t\tif IsValid(panel) then\n\t\t\tpanel:SetWide(self:GetWide())\n\t\tend\n\tend\nend\n\nvgui.Register(\"igs_panels_layout_list\", PANEL, \"igs_scroll\")\n-- IGS.UI()\n","igs/interface/vgui/igs_scroll.lua":"local SCROLLBAR = {}\nfunction SCROLLBAR:Init()\n\tself.parent = self:GetParent()\n\n\tself.scrollButton = vgui.Create(\"Panel\", self)\n\tself.scrollButton.OnMousePressed = function(s, mb)\n\t\tif (mb == MOUSE_LEFT and !self:GetParent().ShouldHideScrollbar) then\n\t\t\tlocal _, my = s:CursorPos()\n\n\t\t\ts.scrolling = true\n\t\t\ts.mouseOffset = my\n\t\tend\n\tend\n\tself.scrollButton.OnMouseReleased = function(s, mb)\n\t\tif (mb == MOUSE_LEFT) then\n\t\t\ts.scrolling = false\n\t\t\ts.mouseOffset = nil\n\t\tend\n\tend\n\n\tself.height = 0\n\tself.addWidth = 0\nend\n\nfunction SCROLLBAR:Think()\n\tif (self.scrollButton.scrolling) then\n\t\tif (!input.IsMouseDown(MOUSE_LEFT)) then\n\t\t\tself.scrollButton:OnMouseReleased(MOUSE_LEFT)\n\t\t\treturn\n\t\tend\n\n\t\tlocal _, my = self.scrollButton:CursorPos()\n\n\t\tlocal diff = my - self.scrollButton.mouseOffset\n\n\t\tlocal maxOffset = self.parent:GetCanvas():GetTall() - self.parent:GetTall()\n\n\t\tlocal perc = (self.scrollButton.y + diff) / (self:GetTall() - self.height)\n\t\tself.parent.yOffset = math.Clamp(perc * maxOffset, 0, maxOffset)\n\n\t\tself.parent:InvalidateLayout()\n\tend\n\n\tlocal preSize = self.addWidth\n\n\tlocal mx, my = self:CursorPos()\n\tif ((mx > -8 and mx < self:GetWide() + 3 and my > self.scrollButton.y and my < self.scrollButton.y + self.height) or self.scrollButton.scrolling) then\n\t\tself.addWidth = math.Clamp(self.addWidth + (FrameTime() * 96), 0, 8)\n\telse\n\t\tself.addWidth = math.Clamp(self.addWidth - (FrameTime() * 96), 0, 8)\n\tend\n\n\tif (preSize != self.addWidth) then\n\t\tself:InvalidateLayout()\n\tend\nend\n\nfunction SCROLLBAR:PerformLayout()\n\tlocal maxOffset = self.parent:GetCanvas():GetTall() - self.parent:GetTall()\n\n\tself:SetSize(2 + self.addWidth, self.parent:GetTall())\n\tself:SetPos(self.parent:GetWide() - self:GetWide(), 0)\n\n\tself.heightRatio = self.parent:GetTall() / self.parent:GetCanvas():GetTall()\n\tself.height = math.Clamp(math.ceil(self.heightRatio * self.parent:GetTall()), 20, math.huge)\n\n\tself.scrollButton:SetSize(self:GetWide(), self.height)\n\tself.scrollButton:SetPos(0, math.Clamp(self.parent.yOffset / maxOffset, 0, 1) * (self:GetTall() - self.height))\nend\n\nfunction SCROLLBAR:Paint(w, h)\n\tif (self:GetParent().ShouldHideScrollbar) then return end\n\n\tdraw.Box(0, self.scrollButton.y, w, self.height, IGS.col.HIGHLIGHTING)\nend\n\nfunction SCROLLBAR:OnMouseWheeled(delta)\n\tself.parent:OnMouseWheeled(delta)\nend\n\nvgui.Register(\"ui_scrollbar\", SCROLLBAR, \"Panel\")\n\n\n\n\n\n\nlocal SCROLLABLE = {}\nfunction SCROLLABLE:Init()\n\tself.contentContainer = vgui.Create(\"Panel\", self)\n\tself.scrollBar = vgui.Create(\"ui_scrollbar\", self)\n\n\tself.yOffset = 0\n\tself.ySpeed = 0\n\tself.scrollSize = 4\n\tself.SpaceTop = 0\n\tself.Padding = 0\n\n\tfunction self.contentContainer:OnChildRemoved(child)\n\t\tself:GetParent():PerformLayout()\n\tend\nend\n\nfunction SCROLLABLE:Reset()\n\tself:GetCanvas():Clear(true)\n\tself.yOffset = 0\n\tself.ySpeed = 0\n\tself.scrollSize = 1\n\n\tself:PerformLayout()\nend\n\nfunction SCROLLABLE:AddItem(child)\n\tchild:SetParent(self:GetCanvas())\n\tself:PerformLayout()\n\treturn child\nend\n\nfunction SCROLLABLE:SetSpacing(i)\n\tself.SpaceTop = i\nend\n\nfunction SCROLLABLE:SetPadding(i)\n\tself.Padding = i\nend\n\nfunction SCROLLABLE:GetCanvas()\n\treturn self.contentContainer\nend\n\nfunction SCROLLABLE:SetScrollSize(int)\n\tself.scrollSize = int\nend\n\nfunction SCROLLABLE:ScrollTo(y)\n\tself.yOffset = y\n\n\tself:InvalidateLayout()\nend\n\nfunction SCROLLABLE:OnMouseWheeled(delta)\n\tif ((delta > 0 and self.ySpeed < 0) or (delta < 0 and self.ySpeed > 0)) then\n\t\tself.ySpeed = 0\n\telse\n\t\tself.ySpeed = self.ySpeed + (delta * self.scrollSize)\n\tend\n\n\tself:PerformLayout()\nend\n\nfunction SCROLLABLE:SetOffset(offSet)\n\tlocal maxOffset = (self:GetCanvas():GetTall() - self:GetTall())\n\tif (maxOffset < 0) then maxOffset = 0 end\n\n\tself.yOffset = math.Clamp(offSet, 0, maxOffset)\n\n\tself:PerformLayout()\n\n\tif (self.yOffset == 0 or self.yOffset == maxOffset) then return true end\nend\n\nfunction SCROLLABLE:Think()\n\tif (self.ySpeed != 0) then\n\t\tif (self:SetOffset(self.yOffset - self.ySpeed)) then\n\t\t\tself.ySpeed = 0\n\t\telse\n\t\t\tif (self.ySpeed < 0) then\n\t\t\t\tself.ySpeed = math.Clamp(self.ySpeed + (FrameTime() * self.scrollSize * 4), self.ySpeed, 0)\n\t\t\telse\n\t\t\t\tself.ySpeed = math.Clamp(self.ySpeed - (FrameTime() * self.scrollSize * 4), 0, self.ySpeed)\n\t\t\tend\n\t\tend\n\tend\nend\n\nfunction SCROLLABLE:PerformLayout()\n\tlocal canvas = self:GetCanvas()\n\n\tif (canvas:GetWide() != self:GetWide()) then\n\t\tcanvas:SetWide(self:GetWide())\n\tend\n\n\tlocal y = 0\n\tlocal lastChild\n\tfor k, v in ipairs(canvas:GetChildren()) do\n\t\tlocal childY = y + self.SpaceTop\n\t\tif (v.x != self.Padding or v.y != childY) then\n\t\t\tv:SetPos(math.max(0, self.Padding), y + self.SpaceTop)\n\t\tend\n\t\tif (v:GetWide() != self:GetWide() - self.Padding * 2) then\n\t\t\tv:SetWide(math.min(self:GetWide(), self:GetWide() - self.Padding * 2))\n\t\tend\n\n\t\ty = v.y + v:GetTall() + self.SpaceTop + self.Padding\n\t\tlastChild = v\n\tend\n\ty = lastChild and lastChild.y + lastChild:GetTall() or y\n\tif (canvas:GetTall() != y) then\n\t\tcanvas:SetTall(y)\n\tend\n\n\tif (canvas:GetTall() <= self:GetTall() and self.scrollBar:IsVisible()) then\n\t\tcanvas:SetTall(self:GetTall())\n\n\t\tself.scrollBar:SetVisible(false)\n\telseif (canvas:GetTall() > self:GetTall() and !self.scrollBar:IsVisible()) then\n\t\tself.scrollBar:SetVisible(true)\n\tend\n\n\tlocal maxOffset = self:GetCanvas():GetTall() - self:GetTall()\n\n\tif (self.yOffset > maxOffset) then\n\t\tself.yOffset = maxOffset\n\tend\n\n\tif (self.yOffset < 0) then\n\t\tself.yOffset = 0\n\tend\n\n\tif (canvas.x != 0 or canvas.y != -self.yOffset) then\n\t\tcanvas:SetPos(0, -self.yOffset)\n\t\tself.scrollBar:InvalidateLayout()\n\tend\nend\n\nfunction SCROLLABLE:IsAtMaxOffset()\n\tlocal maxOffset = math.Clamp(self:GetCanvas():GetTall() - self:GetTall(), 0, math.huge)\n\treturn self.yOffset == maxOffset\nend\n\nfunction SCROLLABLE:Paint(w, h)\nend\n\nfunction SCROLLABLE:HideScrollbar(bool)\n\tself.ShouldHideScrollbar = bool\nend\n\nfunction SCROLLABLE:DockToFrame()\n\tlocal p = self:GetParent()\n\tlocal x, y = p:GetDockPos()\n\n\tself:SetPos(x, y)\n\tself:SetSize(p:GetWide() - 10, p:GetTall() - (y + 5))\nend\n\nvgui.Register(\"igs_scroll\", SCROLLABLE, \"Panel\")\n","igs/interface/vgui/igs_sidebar.lua":"local PANEL = {}\n\nfunction PANEL:Init()\n\t-- Херня справа от лэйаута с услугами http://joxi.ru/52aQQ8Efzov120\n\t-- Вид без нее: http://joxi.ru/eAO44lGcXORlro\n\tself.sidebar = uigs.Create(\"Panel\", function(sbar)\n\t\tsbar:Dock(FILL)\n\tend, self)\n\n\t-- Верхняя часть http://joxi.ru/5mdWW05tzW6Wr1\n\tself.header = uigs.Create(\"Panel\", function(header)\n\t\theader:SetTall(40)\n\t\theader:Dock(TOP)\n\tend, self.sidebar)\nend\n\n-- Заголовок сайдбара \"Последние покупки\" и т.д.\nfunction PANEL:SetTitle(sTitle)\n\tself.title = self.title or uigs.Create(\"DLabel\", function(title)\n\t\ttitle:Dock(BOTTOM)\n\t\ttitle:SetTall(24)\n\t\ttitle:SetFont(\"Fated.19\")\n\t\ttitle:SetTextColor(IGS.col.TEXT_HARD)\n\t\ttitle:SetContentAlignment(8)\n\tend, self.header)\n\n\tself.title:SetText(sTitle)\n\n\treturn self.title\nend\n\nvgui.Register(\"igs_sidebar\",PANEL,\"Panel\")\n--IGS.UI()\n","igs/interface/vgui/igs_tabbar.lua":"local PANEL = {}\n\nlocal barWide = 80 -- ширина вертикальной панели кнопок\nlocal btnTall = 70 -- высота кнопки\nlocal btnWide = 70 -- ширина кнопки\n\nfunction PANEL:Init()\n\tself.activity = uigs.Create(\"igs_multipanel\",self)\n\n\tself.tabBar = uigs.Create(\"Panel\",self)\n\tself.tabBar:SetWide(barWide)\n\tself.tabBar.Paint = function(_, w, h)\n\t\t-- Размытие фона панели кнопок\n\t\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t\t:Rad(0)\n\t\t\t\t:Blur(1.3)\n\t\t\t:Draw()\n\t\tend\n\t\t\n\t\tsurface.SetDrawColor(IGS.col.TAB_BAR)\n\t\tsurface.DrawRect(0,0,w,h) -- bg\n\n\t\tsurface.SetDrawColor(IGS.col.HARD_LINE)\n\t\tsurface.DrawLine(w,0,w,h) -- правая линия (разделитель)\n\tend\n\n\tself.btnsPan = uigs.Create(\"DIconLayout\", self.tabBar)\n\tself.btnsPan.Paint = function() end\n\tself.btnsPan:SetSpaceY(5) -- вертикальные отступы между кнопками\n\n\tself.Buttons = {}\nend\n\nfunction PANEL:SetActiveTab(num)\n\tfor _, btn in ipairs(self.Buttons) do\n\t\tbtn.Active = (btn.ID == num) -- фикс подсветки\n\tend\n\n\tself.activity:SetActivePanel(num)\nend\n\nfunction PANEL:GetActiveTab()\n\treturn self.activity:GetActivePanel()\nend\n\nfunction PANEL:GetContentWide()\n\treturn self:GetWide() - barWide\nend\n\nfunction PANEL:UpdateButtonsLayout()\n\tlocal total_h = #self.Buttons * btnTall + math.max(#self.Buttons - 1, 0) * 5\n\tself.btnsPan:SetSize(barWide, total_h)\n\tself.btnsPan:SetPos((barWide - btnWide) / 2, (self.tabBar:GetTall() - total_h) / 2)\nend\n\nfunction PANEL:AddTab(sTitle,panel,sIcon,bActive)\n\tlocal ID = self.activity:AddPanel(panel,bActive)\n\n\tlocal button = uigs.Create(\"DButton\", function(btn)\n\t\tbtn:SetSize(btnWide, btnTall)\n\t\tbtn:SetText(\"\")\n\n\t\tbtn:SetFont(\"Fated.24\")\n\n\t\tbtn.DoClick = function(s)\n\t\t\tself:SetActiveTab(s.ID)\n\t\tend\n\n\t\t--[[-------------------------------------------------------------------------\n\t\t\tTODO Сделать отрисовку скина через скин хук\n\t\t\tчтобы можно было юзать компонент не только в IGS без порчи дизайна\n\t\t\tВ bar.Paint тоже\n\t\t---------------------------------------------------------------------------]]\n\t\tbtn.Paint = function(s,w,h)\n\t\t\tif s.Active then\n\t\t\t\tsurface.SetDrawColor(IGS.col.HIGHLIGHTING)\n\t\t\t\tsurface.SetTextColor(IGS.col.HIGHLIGHTING)\n\t\t\telse\n\t\t\t\tsurface.SetDrawColor(IGS.col.HIGHLIGHT_INACTIVE)\n\t\t\t\tsurface.SetTextColor(IGS.col.HIGHLIGHT_INACTIVE)\n\t\t\tend\n\n\t\t\tif sIcon then\n\t\t\t\tsurface.SetMaterial( Material(sIcon) )\n\t\t\t\tsurface.DrawTexturedRect(w / 2 - 32 / 2, 5, 32, 32)\n\t\t\tend\n\n\t\t\tif sTitle then\n\t\t\t\tsurface.SetFont(\"Fated.15\")\n\n\t\t\t\tlocal tw = surface.GetTextSize(sTitle)\n\t\t\t\tsurface.SetTextPos(w / 2 - tw / 2, h - 20)\n\n\t\t\t\tsurface.DrawText( sTitle )\n\t\t\tend\n\t\tend\n\n\t\tbtn.ID     = ID\n\t\tbtn.Tab    = panel\n\t\tbtn.Active = bActive\n\tend)\n\n\tfunction button:Name()\n\t\treturn sTitle\n\tend\n\n\tself.btnsPan:Add(button)\n\ttable.insert(self.Buttons, button)\n\tif bActive then\n\t\tself:SetActiveTab(ID)\n\tend\n\t-- Обновляем размеры вертикальной панели кнопок\n\tself:UpdateButtonsLayout()\n\n\treturn button\nend\n\nfunction PANEL:PerformLayout()\n\tself.tabBar:SetTall(self:GetTall())\n\tself.tabBar:SetPos(0, 0)\n\n\tself.activity:SetPos(barWide, 0)\n\tself.activity:SetSize(self:GetWide() - barWide, self:GetTall())\n\n\tself:UpdateButtonsLayout()\nend\n\nfunction PANEL:Paint(w,h)\n\t-- Размытие основного фона\n\tif RNDX and Mantle and Mantle.ui.convar.blur then\n\t\tRNDX().Rect(0, 0, w, h)\n\t\t\t:Rad(0)\n\t\t\t:Blur(1.5)\n\t\t:Draw()\n\tend\n\t\n\tdraw.RoundedBox(0,0,0,w,h,IGS.col.ACTIVITY_BG)\nend\n\nvgui.Register(\"igs_tabbar\", PANEL, \"Panel\")\n-- IGS.UI()\n","igs/interface/vgui/igs_table.lua":"local PANEL = {}\n\nfunction PANEL:Init()\n\tself.columns = {}\n\tself.lines   = {}\n\n\tself.header_tall = 0\n\n\t-- Колонки, для которых указаны iWidePx\n\tself.nonAdjustableSpace = 0\n\tself.nonAdjustableItems = 0\n\n\tself.scroll = uigs.Create(\"igs_scroll\", self)\nend\n\nfunction PANEL:SetTitle(sText)\n\tself.title = self.title or uigs.Create(\"DLabel\", function(t)\n\t\tt:Dock(TOP)\n\t\tt:SetTall(20)\n\t\tt:SetFont(\"Fated.20\")\n\t\tt:SetTextColor(IGS.col.TEXT_HARD)\n\t\tt:SetContentAlignment(5)\n\t\t-- t:SetWrap(true) -- если раскомментить, то не будет работать SetContentAlignment\n\t\tt:SetAutoStretchVertical(true)\n\tend, self)\n\n\tself.title:SetText(sText)\nend\n\nfunction PANEL:AddColumn(sName,iWidePx)\n\tself.columns_panel = self.columns_panel or uigs.Create(\"Panel\", function(p)\n\t\tp:SetTall(15)\n\n\t\tself.header_tall = self.header_tall + p:GetTall()\n\tend, self)\n\n\ttable.insert(self.columns, uigs.Create(\"Panel\", function(clmn)\n\t\tclmn.staticWide = iWidePx\n\n\t\t-- 10 не обязательно. Просто для заметности при отладке\n\t\t-- clmn:SetSize(clmn.staticWide or 10, self.columns_panel:GetTall())\n\t\tclmn.Paint = function(s,w,h)\n\t\t\tsurface.SetDrawColor(IGS.col.HARD_LINE)\n\t\t\tsurface.DrawLine(3,h - 1,w - 2,h - 1)\n\n\t\t\tsurface.DrawLine(0,0,0,h)\n\t\t\tsurface.DrawLine(w,0,w,h)\n\n\t\t\tsurface.SetFont(\"Fated.15\")\n\t\t\tsurface.SetTextColor(IGS.col.TEXT_SOFT)\n\t\t\tsurface.SetTextPos((w - surface.GetTextSize(sName)) / 2,0)\n\t\t\tsurface.DrawText(sName)\n\t\tend\n\tend, self.columns_panel))\n\n\tif iWidePx then\n\t\tself.nonAdjustableItems = self.nonAdjustableItems + 1\n\t\tself.nonAdjustableSpace = self.nonAdjustableSpace + iWidePx\n\tend\n\n\tself:PerformLayout()\nend\n\nfunction PANEL:AddLine(...)\n\tlocal rows = {...}\n\n\tlocal iKek = table.insert(self.lines,\n\t\tself.scroll:AddItem(uigs.Create(\"Panel\", function(line)\n\t\t\tline:SetTall(18)\n\t\t\tline:Dock(TOP)\n\t\t\tline.columns = {}\n\n\t\t\t-- self.columns[i]:GetWide()\n\t\t\tfor i,val in ipairs(rows) do\n\t\t\t\tline.columns[i] = uigs.Create(\"DButton\", function(row) -- Было Panel\n\t\t\t\t\trow:SetText(val)\n\t\t\t\t\trow.DoClick = function() if line.DoClick then line.DoClick(row) end end\n\t\t\t\t\trow.DoRightClick = function() if line.DoRightClick then line.DoRightClick(row) end end\n\t\t\t\t\trow:SetCursor(\"arrow\")\n\t\t\t\t\trow:SetTall( line:GetTall() )\n\t\t\t\t\t-- row:SetPos(self.columns[i]:GetPos())\n\t\t\t\t\trow.Paint = function(s,w,h)\n\t\t\t\t\t\tsurface.SetDrawColor(IGS.col.HARD_LINE)\n\t\t\t\t\t\tsurface.DrawLine(3,h - 1,w - 2,h - 1)\n\n\t\t\t\t\t\tsurface.DrawLine(0,0,0,h)\n\t\t\t\t\t\tsurface.DrawLine(w,0,w,h)\n\n\t\t\t\t\t\tsurface.SetFont(\"Fated.18\")\n\t\t\t\t\t\tsurface.SetTextColor(IGS.col.TEXT_HARD)\n\t\t\t\t\t\tsurface.SetTextPos((w - surface.GetTextSize(s:GetText())) / 2,0)\n\t\t\t\t\t\tsurface.DrawText(s:GetText())\n\t\t\t\t\t\treturn true -- override\n\t\t\t\t\tend\n\t\t\t\tend, line)\n\t\t\tend\n\t\tend))\n\t)\n\n\t-- self:PerformLayout()\n\treturn self.lines[iKek] -- вставленная строка\nend\n\nfunction PANEL:Clear()\n\t-- for i,linePan in ipairs(self.lines) do\n\t-- \tlinePan:Remove()\n\t-- \ttable.remove(self.lines,i)\n\t-- end\n\n\tfor i = #self.lines,1,-1 do\n\t\tlocal linePan = self.lines[i]\n\t\tlinePan:Remove()\n\t\ttable.remove(self.lines,i)\n\tend\nend\n\nPANEL.Paint     = IGS.S.TablePanel\nPANEL.PaintOver = IGS.S.Outline\n\nfunction PANEL:PerformLayout()\n\tif self.title then\n\t\tself.header_tall = self.title:GetTall()\n\tend\n\n\tif self.columns_panel then\n\t\tself.columns_panel:SetPos(0,self.header_tall)\n\t\tself.columns_panel:SetWide(self:GetWide())\n\n\t\t--PrintTable(self.columns)\n\n\t\tlocal x = 0\n\t\tlocal cell_wide = (self:GetWide() - self.nonAdjustableSpace) / (#self.columns - self.nonAdjustableItems)\n\t\t-- print(\"#self.columns\",#self.columns)\n\t\t-- print(\"self.nonAdjustableItems\",self.nonAdjustableItems)\n\t\t-- print(\"self.nonAdjustableSpace\",self.nonAdjustableSpace)\n\t\tfor _,v in ipairs(self.columns) do\n\t\t\t-- print(v,v:GetPos())\n\t\t\t-- print(v:GetSize())\n\t\t\tv:SetPos(x,0)\n\t\t\tv:SetSize(v.staticWide or cell_wide, self.columns_panel:GetTall())\n\n\t\t\tx = x + (v.staticWide or v:GetWide())\n\t\tend\n\n\t\tself.header_tall = self.header_tall + self.columns_panel:GetTall()\n\tend\n\n\tself.scroll:SetPos(0,self.header_tall)\n\tself.scroll:SetSize(self:GetWide(),self:GetTall() - self.header_tall)\n\n\tfor _,linePan in ipairs(self.lines) do\n\t\tfor i,rowPan in ipairs(linePan.columns) do\n\t\t\trowPan:SetWide(self.columns[i]:GetWide())\n\t\t\trowPan:SetPos(self.columns[i]:GetPos())\n\t\tend\n\tend\nend\n\nvgui.Register(\"igs_table\", PANEL, \"Panel\")\n-- IGS.UI()\n","igs/interface/vgui/igs_wmat.lua":"--[[-------------------------------------------------------------------------\n\tЗапрещено использовать DOCK.\n\tРазмер должен быть указан единоразово и четко\n\n\t:SetURL указывать ПОСЛЕ :SetSize\n---------------------------------------------------------------------------]]\nlocal PANEL = {}\n\n\nfunction PANEL:GetTexture()\n\treturn texture.Get(self.url)\nend\n\nfunction PANEL:GetURL()\n\treturn self.url\nend\n\nfunction PANEL:RenderTexture()\n\tself.Rendering = true\n\n\t-- print(\"Render\",self:GetURL())\n\t-- print(\"Size\",self:GetSize())\n\n\ttexture.Delete(self:GetURL())\n\ttexture.Create(self:GetURL())\n\t\t:SetSize(self:GetSize())\n\t\t:SetFormat(self:GetURL():sub(-3) == \"jpg\" and \"jpg\" or \"png\")\n\t\t:Download(self:GetURL(), function()\n\t\t\tif !IsValid(self) then return end\n\n\t\t\tself.Rendering \t= false\n\t\t\tself.LastURL \t= self:GetURL()\n\t\tend, function()\n\t\t\tif !IsValid(self) then return end\n\n\t\t\tself.Rendering = false\n\t\tend)\nend\n\nfunction PANEL:Paint(w,h)\n\tif (!self:GetTexture() and !self.Rendering) or (self:GetURL() ~= self.LastURL and !self.Rendering) then\n\t\tself:RenderTexture()\n\n\telseif self:GetTexture() then\n\t\tsurface.SetDrawColor(IGS.col.ICON)\n\t\tsurface.SetMaterial( self:GetTexture() )\n\t\tsurface.DrawTexturedRect(0,0,w,h)\n\telseif self.Rendering then\n\t\t-- Показываем placeholder во время загрузки\n\t\tdraw.RoundedBox(0, 0, 0, w, h, Color(50, 50, 50, 100))\n\t\t\n\t\t-- Анимированная иконка загрузки\n\t\tlocal time = CurTime() * 2\n\t\tlocal angle = time % 360\n\t\t\n\t\tlocal cx, cy = w / 2, h / 2\n\t\tlocal radius = math.min(w, h) / 4\n\t\t\n\t\tfor i = 0, 7 do\n\t\t\tlocal a = math.rad(angle + i * 45)\n\t\t\tlocal alpha = 255 - (i * 30)\n\t\t\tlocal size = radius / 3\n\t\t\t\n\t\t\tsurface.SetDrawColor(200, 200, 200, alpha)\n\t\t\tsurface.DrawRect(\n\t\t\t\tcx + math.cos(a) * radius - size / 2,\n\t\t\t\tcy + math.sin(a) * radius - size / 2,\n\t\t\t\tsize, size\n\t\t\t)\n\t\tend\n\tend\nend\n\nfunction PANEL:SetURL(sUrl)\n\tself.url = sUrl or IGS.C.DefaultIcon\nend\n\n\nvgui.Register(\"igs_wmat\",PANEL,\"Panel\")\n-- IGS.UI()\n","igs/interface/windows/deposit_funds.lua":"local function niceSum(i, iFallback)\n\treturn math.Truncate(tonumber(i) or iFallback, 2)\nend\n\nlocal m\nfunction IGS.WIN.Deposit(iRealSum)\n\tif IsValid(m) then return end -- не даем открыть 2 фрейма\n\tiRealSum = tonumber(iRealSum)\n\n\tsurface.PlaySound(\"ambient/weather/rain_drip1.wav\")\n\thook.Run(\"IGS.OnDepositWinOpen\",iRealSum)\n\n\tlocal cd = !IGS.IsCurrencyEnabled() -- cd = currency disabled. Bool\n\tlocal realSum = math.max(IGS.GetMinCharge(), niceSum(iRealSum, 0))\n\n\tm = uigs.Create(\"igs_frame\", function(self)\n\t\tself:SetSize(450,400)\n\t\tself:RememberLocation(\"igs_deposit\")\n\n\t\t-- Вы, конечно, можете удалить наш копирайт. Чтобы вы не перенапряглись, я даже подготовил чуть ниже строчку для этого\n\t\t-- Но прежде, чем ты это сделаешь, ответь себе на вопрос. Нахуя? Так мешает?\n\t\tself:SetTitle(\"Автодонат\")\n\t\t-- self:SetTitle(\"Владелец этого сервера мразь, не ценящая чужой труд\")\n\n\t\tself:MakePopup()\n\t\t-- self:Focus()\n\t\t-- self:SetBackgroundBlur(false)\n\n\t\t--[[-------------------------------------\n\t\t\tЛевая колонка. Реальная валюта\n\t\t---------------------------------------]]\n\t\tuigs.Create(\"DLabel\", function(real)\n\t\t\treal:SetSize(cd and 450 or 180,25)\n\t\t\treal:SetPos(cd and 0 or 10,self:GetTitleHeight())\n\t\t\treal:SetText(cd and \"Введите ниже сумму пополнения счета\" or \"Рубли\")\n\t\t\treal:SetFont(\"Fated.22\")\n\t\t\treal:SetTextColor(IGS.col.HIGHLIGHTING)\n\t\t\treal:SetContentAlignment(2)\n\t\tend, self)\n\n\t\tself.real_m = uigs.Create(\"DTextEntry\", self)\n\t\tself.real_m:SetPos(10,50)\n\t\tself.real_m:SetSize(cd and 450 - 10 - 10 or 180,30)\n\t\tself.real_m:SetNumeric(true)\n\t\tself.real_m.OnChange = function(s)\n\t\t\tif cd then return end\n\t\t\tself.curr_m:SetValue(IGS.PriceInCurrency( niceSum(s:GetValue(),0) )) -- бля\n\t\tend\n\t\tself.real_m.Think = function()\n\t\t\tlocal rub = tonumber(self.real_m:GetValue())\n\t\t\tif cd then\n\t\t\t\tself.purchase:SetText(\n\t\t\t\t\t\"Пополнить счет на \" .. niceSum(rub,0) .. \" руб\"\n\t\t\t\t)\n\t\t\telse\n\t\t\t\tlocal igs = tonumber(self.curr_m:GetValue())\n\t\t\t\tself.purchase:SetText(\n\t\t\t\t\t\"Пополнить на \" .. IGS.SignPrice( niceSum(igs,0) ) ..\n\t\t\t\t\t\" за \" .. niceSum(rub,0) .. \" руб\"\n\t\t\t\t)\n\t\t\tend\n\n\t\t\tself.purchase:SetActive(rub and rub > 0)\n\t\tend\n\n\t\t--[[-------------------------------------\n\t\t\tСередина. Знак равности и кнопка покупки\n\t\t---------------------------------------]]\n\t\tif !cd then\n\t\t\tuigs.Create(\"DLabel\", function(eq)\n\t\t\t\teq:SetSize(50,30)\n\t\t\t\teq:SetPos(200,50)\n\t\t\t\teq:SetText(\"=\")\n\t\t\t\teq:SetFont(\"Fated.40\")\n\t\t\t\teq:SetTextColor(IGS.col.TEXT_HARD)\n\t\t\t\teq:SetContentAlignment(5)\n\t\t\tend,self)\n\t\tend\n\n\t\tself.purchase = uigs.Create(\"igs_button\", function(p)\n\t\t\tlocal _,ry = self.real_m:GetPos()\n\n\t\t\tp:SetSize(400,40)\n\t\t\tp:SetActive(true) -- выделяет синим\n\t\t\tp:SetPos((self:GetWide() - p:GetWide()) / 2,ry + self.real_m:GetTall() + 10)\n\n\t\t\tp.DoClick = function()\n\t\t\t\tlocal want_money = niceSum(self.real_m:GetValue())\n\t\t\t\tif !want_money then\n\t\t\t\t\tself.log:AddRecord(\"Указана некорректная сумма пополнения\", false)\n\t\t\t\t\treturn\n\n\t\t\t\telseif want_money < realSum then\n\t\t\t\t\tself.log:AddRecord(\"Минимальная сумма пополнения \" .. PL_MONEY(realSum), false)\n\t\t\t\t\treturn\n\t\t\t\tend\n\n\t\t\t\tself.log:AddRecord(\"Запрос ссылки на оплату...\")\n\n\t\t\t\tIGS.GetPaymentURL(want_money,function(url)\n\t\t\t\t\tIGS.OpenURL(url,\"Процедура пополнения счета\")\n\t\t\t\t\tif !IsValid(self) then return end\n\t\t\t\t\tself.log:AddRecord(\"Ссылка получена. Начинаем процесс оплаты\")\n\n\t\t\t\t\ttimer.Simple(.7,function()\n\t\t\t\t\t\tself.log:AddRecord(\"Счет пополнится моментально или после перезахода\")\n\t\t\t\t\tend)\n\t\t\t\tend)\n\t\t\tend\n\t\tend, self)\n\n\t\t--[[-------------------------------------\n\t\t\tПравая колонка. Донат валюта\n\t\t---------------------------------------]]\n\t\tif !cd then\n\t\t\tuigs.Create(\"DLabel\", function(curr)\n\t\t\t\tcurr:SetSize(180,25)\n\t\t\t\tcurr:SetPos(self:GetWide() - 10 - curr:GetWide(),self:GetTitleHeight())\n\t\t\t\tcurr:SetText(IGS.C.CURRENCY_NAME)\n\t\t\t\tcurr:SetFont(\"Fated.22\")\n\t\t\t\tcurr:SetTextColor(IGS.col.HIGHLIGHTING)\n\t\t\t\tcurr:SetContentAlignment(2)\n\t\t\tend, self)\n\n\t\t\tself.curr_m = uigs.Create(\"DTextEntry\", self)\n\t\t\tself.curr_m:SetPos(self:GetWide() - 10 - self.real_m:GetWide(),50)\n\t\t\tself.curr_m:SetSize(self.real_m:GetWide(),self.real_m:GetTall())\n\t\t\tself.curr_m:SetNumeric(true)\n\t\t\tself.curr_m.OnChange = function(s)\n\t\t\t\tself.real_m:SetValue(IGS.RealPrice( niceSum(s:GetValue(),0) )) -- тоже бля\n\t\t\tend\n\t\tend\n\n\t\t--[[-------------------------------------------------------------------------\n\t\t\tДолжно быть после self.curr_m\n\t\t---------------------------------------------------------------------------]]\n\t\tself.real_m:SetValue( realSum )\n\t\tself.real_m:OnChange()\n\n\n\t\t--[[-------------------------------------------------------------------------\n\t\t\tВсе подряд\n\t\t---------------------------------------------------------------------------]]\n\t\tself.log = uigs.Create(\"igs_scroll\", function(log)\n\t\t\tlog:SetSize(250,200)\n\t\t\tlog:SetPos(10,self:GetTall() - log:GetTall() - 10)\n\t\t\t-- https://img.qweqwe.ovh/1487171563683.png\n\t\t\tfunction log:AddRecord(text,pay)\n\t\t\t\tlocal col =\n\t\t\t\t\t(pay == true  and IGS.col.LOG_SUCCESS) or\n\t\t\t\t\t(pay == false and IGS.col.LOG_ERROR)   or IGS.col.LOG_NORMAL\n\n\t\t\t\t-- Платеж или Ошибка\n\t\t\t\tif pay or pay == false then\n\t\t\t\t\tself:GetParent():RequestFocus()\n\t\t\t\t\tself:GetParent():MakePopup()\n\t\t\t\tend\n\n\t\t\t\treturn log:AddItem( uigs.Create(\"Panel\", function(bg)\n\t\t\t\t\ttext = \"> \" .. os.date(\"%H:%M:%S\",os.time()) .. \"\\n\" .. text\n\n\t\t\t\t\tlocal y = 2\n\t\t\t\t\tfor i,line in ipairs(string.Wrap(\"Fated.18\",text,log:GetWide() - 0 - 0)) do\n\t\t\t\t\t\tuigs.Create(\"DLabel\", function(l)\n\t\t\t\t\t\t\tl:SetPos(0,y)\n\t\t\t\t\t\t\tl:SetText(line)\n\t\t\t\t\t\t\tl:SetFont(\"Fated.18\")\n\t\t\t\t\t\t\tl:SizeToContents()\n\t\t\t\t\t\t\tl:SetTextColor(i == 1 and IGS.col.HIGHLIGHTING or col)\n\t\t\t\t\t\t\t--               /\\ первой строкой идет дата (\\n)\n\n\t\t\t\t\t\t\ty = y + l:GetTall()\n\t\t\t\t\t\tend, bg)\n\t\t\t\t\tend\n\n\t\t\t\t\tbg:SetTall(y + 2)\n\t\t\t\t\tlog:ScrollTo(log:GetCanvas():GetTall())\n\t\t\t\tend, log) )\n\t\t\tend\n\t\tend, self)\n\n\t\tlocal log_t = uigs.Create(\"DLabel\", function(log_title)\n\t\t\tlocal log_x,log_y = self.log:GetPos()\n\n\t\t\tlog_title:SetSize(self.log:GetWide(),22)\n\t\t\tlog_title:SetPos(log_x,log_y - log_title:GetTall())\n\t\t\tlog_title:SetText(\"Лог операций\")\n\t\t\tlog_title:SetTextColor(IGS.col.HIGHLIGHTING)\n\t\t\tlog_title:SetFont(\"Fated.22\")\n\t\t\tlog_title:SetContentAlignment(1)\n\t\tend, self)\n\n\t\t-- Линия над логом\n\t\tlocal _,log_t_y = log_t:GetPos()\n\t\tuigs.Create(\"DPanel\", function(line)\n\t\t\tline:SetPos(10, log_t_y - 2 - 10)\n\t\t\tline:SetSize(self:GetWide() - line:GetPos() * 2, 2)\n\t\t\tline.Paint = function(s, w, h)\n\t\t\t\tdraw.RoundedBox(0,0,0,w,h,IGS.col.SOFT_LINE)\n\t\t\tend\n\t\tend, self)\n\n\t\t-- Кнопка \"Активировать купон\" перенесена в шапку главного меню\n\n\n\t\t-- uigs.Create(\"DLabel\", function(btns_title)\n\t\t-- \tlocal coup_x,coup_y = coupon:GetPos()\n\n\t\t-- \tbtns_title:SetSize(coupon:GetWide(),30)\n\t\t-- \tbtns_title:SetPos(coup_x,coup_y + coupon:GetTall() + 0)\n\t\t-- \tbtns_title:SetText(\"Все автоматизировано\")\n\t\t-- \tbtns_title:SetTextColor(IGS.col.TEXT_HARD)\n\t\t-- \tbtns_title:SetFont(\"Fated.18\")\n\t\t-- \t-- btns_title:SetContentAlignment(3)\n\t\t-- end, self)\n\n\t\tlocal function log(delay,text,status)\n\t\t\ttimer.Simple(delay,function()\n\t\t\t\tif !IsValid(self.log) then return end\n\t\t\t\tself.log:AddRecord(text, status)\n\t\t\tend)\n\t\tend\n\n\t\tlog(0,\"Открыт диалог пополнения счета\",nil)\n\t\tlog(math.random(3),\"Соединение установлено!\",true) -- пустышка, которая добавляет чувство безопасностти сделке\n\t\tlog(math.random(20,40),\"Деньги будут зачислены мгновенно и автоматически\",nil)\n\tend)\n\n\treturn m\nend\n\n\nhook.Add(\"IGS.PaymentStatusUpdated\",\"UpdatePaymentStatus\",function(dat)\n\tlocal extra_inf = IGS.IsCurrencyEnabled() and (\" (\" .. PL_MONEY( IGS.RealPrice(dat.orderSum) ) .. \")\") or \"\"\n\n\tlocal text =\n\t\tdat.method == \"check\" and (\"Проверка возможности платежа через \" .. dat.paymentType) or\n\t\tdat.method == \"pay\"   and (\"Начислено \" .. PL_IGS(dat.orderSum) ..  extra_inf) or\n\t\tdat.method == \"error\" and (\"Ошибка пополнения счета: \" .. dat.errorMessage) or\n\t\t\"С сервера пришел неизвестный метод \" .. tostring(dat.method) .. \" и возникла ошибка\"\n\n\tif !IsValid(m) then\n\t\tIGS.ShowNotify(text,\"Обновление статуса платежа\")\n\t\treturn\n\tend\n\n\tlocal pay = nil\n\tif dat.method == \"pay\" then\n\t\tpay = true\n\telseif dat.method == \"error\" then\n\t\tpay = false\n\tend\n\n\tm.log:AddRecord(text,pay)\nend)\n\n\n\n-- if IsValid(IGS_CHARGE) then\n-- \tIGS_CHARGE:Remove()\n-- end\n\n-- IGS_CHARGE = IGS.WIN.Deposit()\n-- local p = IGS_CHARGE\n-- -- timer.Simple(1,function()\n-- -- \tp.log:AddRecord(\"Kek lol heh mda\", false)\n-- -- end)\n\n-- timer.Simple(600,function()\n-- \tif IsValid(p) then\n-- \t\tp:Remove()\n-- \t\tp = nil\n-- \tend\n-- end)\n","igs/interface/windows/group_content.lua":"local function getSpacePanel()\n\treturn uigs.Create(\"Panel\", function(self)\n\t\tself:Dock(TOP)\n\t\tself:SetTall(3)\n\tend)\nend\n\nfunction IGS.WIN.Group(sGroupUID)\n\tlocal GROUP = IGS.GetGroup(sGroupUID)\n\tassert(GROUP, \"Incorrect group: \" .. tostring(sGroupUID))\n\n\tsurface.PlaySound(\"ambient/weather/rain_drip1.wav\")\n\n\treturn uigs.Create(\"igs_frame\", function(bg)\n\t\tbg:SetTitle(GROUP:Name())\n\t\tbg:MakePopup()\n\n\t\tlocal cellW,cellH -- не изменяется в зависимости от контента\n\t\tfunction bg:AddIGSItem(ITEM, nameInGroup)\n\t\t\tlocal it = uigs.Create(\"igs_item\"):SetItem(ITEM)\n\t\t\tit:SetName(nameInGroup or ITEM:Name())\n\n\t\t\tif !cellW then\n\t\t\t\tcellW,cellH = it:GetSize()\n\t\t\tend\n\n\t\t\tit:SetSize(cellW * 1.3, cellH)\n\t\t\tit.DoClick = function()\n\t\t\t\t-- bg:Close()\n\t\t\t\tIGS.WIN.Item(ITEM:UID())\n\t\t\tend\n\n\t\t\tbg.scroll:AddItem(it)\n\t\tend\n\n\t\tbg.scroll = uigs.Create(\"igs_scroll\", bg)\n\t\tbg.scroll:Dock(FILL)\n\t\tbg.scroll:SetPadding(6)\n\n\n\t\tbg.scroll:AddItem( getSpacePanel() ) -- из-за паддинга #1\n\t\tfor _,v in pairs(GROUP:Items()) do\n\t\t\tlocal ITEM = v.item\n\t\t\tif !v.item:IsHidden() then -- еще в main_cl\n\t\t\t\tbg:AddIGSItem(ITEM, v.name)\n\t\t\tend\n\t\tend\n\t\tbg.scroll:AddItem( getSpacePanel() ) -- из-за паддинга #2\n\n\t\t-- or: https://t.me/c/1353676159/21116\n\t\tbg:SetSize((cellW or 220) * 1.3, 300)\n\t\tbg:RememberLocation(\"igs_group\")\n\tend)\nend\n-- IGS.UI()\n","igs/interface/windows/item_info.lua":"local m\n\nlocal function purchase(ITEM, buy_button)\n\tIGS.Purchase(ITEM:UID(), function(errMsg,dbID)\n\t\tif !IsValid(buy_button) then return end\n\n\t\tif errMsg then\n\t\t\tIGS.ShowNotify(errMsg, \"Ошибка покупки\")\n\t\t\tsurface.PlaySound(\"ambient/voices/citizen_beaten1.wav\") -- еще есть\n\t\t\treturn\n\t\tend\n\n\t\tbuy_button.purchased = buy_button.purchased or 0\n\t\tbuy_button.purchased = buy_button.purchased + 1\n\n\n\t\tif ITEM:IsStackable() then\n\t\t\tbuy_button:SetText(\"Куплено \" .. buy_button.purchased .. \" шт\")\n\t\telse\n\t\t\tif IsValid(m) then\n\t\t\t\tm:Close()\n\t\t\tend\n\n\t\t\tif !IGS.C.Inv_Enabled then\n\t\t\t\tIGS.ShowNotify(\"Спасибо за покупку. Это было просто, правда? :)\", \"Успешная покупка\")\n\t\t\t\treturn\n\t\t\tend\n\n\t\t\tIGS.BoolRequest(\"Успешная покупка\",\n\t\t\t\t\"Спасибо за покупку. Она находится в вашем /donate инвентаре.\\n\\nАктивировать ее сейчас?\",\n\t\t\tfunction(yes)\n\t\t\t\tif !yes then return end\n\n\t\t\t\tIGS.ProcessActivate(dbID)\n\t\t\tend)\n\t\tend\n\n\t\tsurface.PlaySound(\"ambient/office/coinslot1.wav\")\n\tend)\nend\n\n\n\n\n\n\nlocal function move(f, x, sp, cb)\n\tlocal _,y = f:GetPos()\n\tf:MoveTo(x,y, sp,nil,nil,cb)\nend\n\nlocal function shakeFrame(f, amplitude, speed, cb)\n\tif !IsValid(f) then return end\n\n\tlocal x = f:GetPos()\n\tmove(f, x + amplitude, speed, function()\n\t\tmove(f, x - amplitude, speed, function()\n\t\t\tmove(f, x, speed, cb)\n\t\tend)\n\tend)\nend\n\nfunction IGS.WIN.Item(uid)\n\tlocal ITEM = IGS.GetItemByUID(uid)\n\tif IsValid(m) then\n\t\tif m.item_uid == uid then -- попытка повторного открытия того же фрейма\n\n\t\t\tm:MoveToFront()\n\t\t\tshakeFrame(m, 20, .1)\n\n\t\t\treturn\n\t\tend\n\n\t\t-- Открытия другого\n\t\tm:Close()\n\t\tm = nil\n\tend\n\n\tsurface.PlaySound(\"ambient/weather/rain_drip1.wav\")\n\n\tm = uigs.Create(\"igs_frame\", function(self)\n\t\tself:SetSize(330,550)\n\t\tself:RememberLocation(\"igs_item\")\n\t\tself:MakePopup()\n\t\tself:SetTitle(ITEM:Name())\n\n\t\tself.item_uid  = uid -- для предотвращения повторного открытия двух одинаковых фреймов\n\tend)\n\n\n\tuigs.Create(\"igs_iteminfo\", function(p)\n\n\t\t--[[-------------------------------------------------------------------------\n\t\t\tОчень не красивый, но очень полезный код\n\t\t\tЗаставляет ползунок помигать для заметности\n\t\t---------------------------------------------------------------------------]]\n\t\tlocal viewed = tonumber( bib.get(\"igs:items_viewed\",0) )\n\t\tbib.set(\"igs:items_viewed\",viewed + 1)\n\n\t\t-- Если мигали 3+ раза, то больше не надо\n\t\tif viewed < 3 then\n\t\t\tlocal oldThink = p.scroll.scrollBar.Think\n\t\t\ttimer.Simple(.5,function() -- 0.5 = время, которое скролл будет мигать\n\t\t\t\tif !IsValid(p) then return end\n\n\t\t\t\tp.scroll.scrollBar.Think = oldThink\n\t\t\tend)\n\n\t\t\tp.scroll.scrollBar.Think = function() --              \\/ скорость мигания\n\t\t\t\tp.scroll.scrollBar.addWidth = (math.sin( CurTime() * 20 ) + 1) / 2 * 8 -- 8 лимит ширины скролла\n\t\t\t\tp.scroll.scrollBar:InvalidateLayout()\n\t\t\tend\n\t\tend\n\t\t-----------------------------------------------------------------------------\n\n\n\n\t\tp:Dock(FILL)\n\t\tp:SetIcon(ITEM:ICON())\n\t\tp:SetName(\"Действует \" .. IGS.TermToStr(ITEM:Term()))\n\t\tp:SetImage(ITEM:IMG())\n\t\tp:SetSubNameButton(ITEM:Group() and ITEM:Group():Name(), function()\n\t\t\tIGS.WIN.Group(ITEM:Group():UID())\n\t\tend)\n\t\tp:SetDescription( ITEM:Description() )\n\t\tp:SetInfo(IGS.FormItemInfo(ITEM))\n\n\t\tm.act = p:CreateActivity() -- панелька для кастом эллементов\n\t\tm.buy = uigs.Create(\"igs_button\", function(buy)\n\t\t\t-- Используем финальную цену с учетом скидок\n\t\t\tlocal cur_price = ITEM:GetFinalPriceInCurrency()\n\n\t\t\tbuy:Dock(TOP)\n\t\t\tbuy:SetTall(20)\n\t\t\tbuy:SetText( \"Купить за \" .. PL_IGS(cur_price) )\n\t\t\tbuy:SetActive( IGS.CanAfford(LocalPlayer(), cur_price) )\n\t\t\tbuy.DoClick = function(s)\n\t\t\t\tif !s:IsActive() then\n\t\t\t\t\tlocal need = cur_price - LocalPlayer():IGSFunds()\n\n\t\t\t\t\tsurface.PlaySound(\"ambient/voices/citizen_beaten1.wav\") -- еще есть\n\t\t\t\t\tIGS.BoolRequest(\n\t\t\t\t\t\t\"Недостаточно денег\",\n\t\t\t\t\t\t(\"Вам не хватает %s для покупки %s.\\nЖелаете мгновенно пополнить счет?\"):format( PL_IGS(need), ITEM:Name()),\n\t\t\t\t\t\tfunction(yes)\n\t\t\t\t\t\t\tif yes then\n\t\t\t\t\t\t\t\tIGS.WIN.Deposit(IGS.RealPrice(need), true)\n\t\t\t\t\t\t\t\tsurface.PlaySound(\"vo/npc/male01/yeah02.wav\")\n\t\t\t\t\t\t\tend\n\t\t\t\t\t\tend\n\t\t\t\t\t):ShowCloseButton(true)\n\n\t\t\t\t\treturn\n\t\t\t\tend\n\n\t\t\t\tpurchase(ITEM, s)\n\t\t\tend\n\t\tend, m.act)\n\tend, m)\n\n\thook.Run(\"IGS.OnItemInfoOpen\", ITEM, m)\nend\n-- IGS.WIN.Item(\"permission_model_30d\")\n","igs/interface/windows/modals.lua":"function IGS.BoolRequest(title, text, cback)\n\tlocal m = uigs.Create(\"igs_frame\", function(self)\n\t\tself:SetTitle(title)\n\t\tself:ShowCloseButton(false)\n\t\tself:SetWide(ScrW() * .2)\n\t\tself:MakePopup()\n\tend)\n\nlocal txt = string.Wrap(\"Fated.18\", text, m:GetWide() - 10)\n\tlocal y = m:GetTitleHeight() + 5\n\n\tfor _,line in ipairs(txt) do\n\t\tuigs.Create(\"DLabel\", function(self, p)\n\t\t\tself:SetText(line)\n\t\t\tself:SetFont(\"Fated.18\")\n\t\t\tself:SetTextColor(IGS.col.TEXT_HARD)\n\t\t\tself:SizeToContents()\n\t\t\tself:SetPos((p:GetWide() - self:GetWide()) / 2, y)\n\t\t\ty = y + self:GetTall() + 2\n\t\tend, m)\n\tend\n\n\ty = y + 5\n\tm.btnOK = uigs.Create(\"igs_button\", function(self, p)\n\t\tself:SetText(\"Да\")\n\t\tself:SetPos(5, y)\n\t\tself:SetSize(p:GetWide() / 2 - 7.5, 25)\n\t\tself.DoClick = function()\n\t\t\tp:Close()\n\t\t\tcback(true)\n\t\tend\n\tend, m)\n\n\tm.btnCan = uigs.Create(\"igs_button\", function(self, p)\n\t\tself:SetText(\"Нет\")\n\t\tself:SetPos(p.btnOK:GetWide() + 10, y)\n\t\tself:SetSize(p.btnOK:GetWide(), 25)\n\t\tself:RequestFocus()\n\t\tself.DoClick = function()\n\t\t\tp:Close()\n\t\t\tcback(false)\n\t\tend\n\t\ty = y + self:GetTall() + 5\n\tend, m)\n\n\tm:SetTall(y)\n\tm:Center()\n\n\tm:Focus()\n\treturn m\nend\n\nfunction IGS.StringRequest(title, text, default, cback)\n\tlocal m = uigs.Create(\"igs_frame\", function(self)\n\t\tself:SetTitle(title)\n\t\tself:ShowCloseButton(false)\n\t\tself:SetWide(ScrW() * .3)\n\t\tself:MakePopup()\n\tend)\n\nlocal txt = string.Wrap(\"Fated.18\", text, m:GetWide() - 10)\n\tlocal y = m:GetTitleHeight() + 5\n\n\tfor _, v in ipairs(txt) do\n\t\tuigs.Create(\"DLabel\", function(self, p)\n\t\t\tself:SetText(v)\n\t\t\tself:SetFont(\"Fated.18\")\n\t\t\tself:SetTextColor(IGS.col.TEXT_HARD)\n\t\t\tself:SizeToContents()\n\t\t\tself:SetPos((p:GetWide() - self:GetWide()) / 2, y)\n\t\t\ty = y + self:GetTall()\n\t\tend, m)\n\tend\n\n\ty = y + 5\n\tlocal tb = uigs.Create(\"DTextEntry\", function(self, p)\n\t\tself:SetPos(5, y + 5)\n\t\tself:SetSize(p:GetWide() - 10, 25)\n\t\tself:SetValue(default or '')\n\t\ty = y + self:GetTall() + 10\n\t\tself.OnEnter = function()\n\t\t\tp:Close()\n\t\t\tcback(self:GetValue())\n\t\tend\n\tend, m)\n\n\tlocal btnOK = uigs.Create(\"igs_button\", function(self, p)\n\t\tself:SetText(\"ОК\")\n\t\tself:SetPos(5, y)\n\t\tself:SetSize(p:GetWide() / 2 - 7.5, 25)\n\t\tself:SetActive(true)\n\t\tself.DoClick = function()\n\t\t\tp:Close()\n\t\t\tcback(tb:GetValue())\n\t\tend\n\tend, m)\n\n\tuigs.Create(\"igs_button\", function(self)\n\t\tself:SetText(\"Отмена\")\n\t\tself:SetPos(btnOK:GetWide() + 10, y)\n\t\tself:SetSize(btnOK:GetWide(), 25)\n\t\tself:RequestFocus()\n\t\tself.DoClick = function()\n\t\t\tm:Close()\n\t\tend\n\t\ty = y + self:GetTall() + 5\n\tend, m)\n\n\tm:SetTall(y)\n\tm:Center()\n\n\tm:Focus()\n\treturn m\nend\n\n\nlocal null = function() end\nfunction IGS.ShowNotify(sText, sTitle, fOnClose)\n\tlocal m = IGS.BoolRequest(sTitle or \"[IGS] Оповещение\", sText, fOnClose or null)\n\tm.btnCan:Remove() -- оставляем только 1 кнопку\n\n\tlocal _,y = m.btnOK:GetPos()\n\tm.btnOK:SetText(\"ОК\")\n\tm.btnOK:SetPos((m:GetWide() - m.btnOK:GetWide()) / 2, y)\n\n\treturn m\nend\n\nfunction IGS.WIN.ActivateCoupon()\n\tIGS.StringRequest(\"Активация купона\",\n\t\t\"Если у вас есть донат купон, то введите его ниже\",\n\tnil,function(val)\n\t\tIGS.UseCoupon(val,function(errMsg)\n\t\t\tif errMsg then\n\t\t\t\tIGS.ShowNotify(errMsg, \"Ошибка активации купона\")\n\t\t\telse\n\t\t\t\tIGS.ShowNotify(\"Деньги начислены на ваш счет. Можете посмотреть на это в транзакциях, переоткрыв донат меню\", \"Успешная активации купона\")\n\t\t\tend\n\t\tend)\n\tend)\nend\n\n\n-- IGS.ShowNotify((\"test \"):rep(10), nil, function()\n-- \tprint(\"Нотификашка закрылась\")\n-- end)\n\nIGS.OpenURL = gui.OpenURL\n\n-- IGS.UI()\n","igs/launcher.lua":"IGS.C = IGS.C or {} -- config\n\nlocal function sh(path) return IGS.sh(\"igs/\" .. path) end\nlocal function sv(path) return IGS.sv(\"igs/\" .. path) end\nlocal function cl(path) return IGS.cl(\"igs/\" .. path) end\n\nlocal function dir(path, fIncluder) return IGS.include_files(\"igs/\" .. path, fIncluder) end\nlocal function mods(path) return IGS.load_modules(\"igs/\" .. path) end\n\n\nsh(\"dependencies/plurals.lua\")\nsh(\"dependencies/chatprint.lua\")\nsv(\"dependencies/stack.lua\")\nsh(\"dependencies/scc.lua\")\nsv(\"dependencies/resources.lua\") -- иконки, моделька дропнутого итема\nsh(\"dependencies/bib.lua\")\nsh(\"dependencies/permasents.lua\")\n\n-- #todo сделать через require\n-- lua/includes/modules отсюда\n-- уберет костыль внутри kupol\n-- +при фетче оверрайд require\nsh(\"dependencies/lolib.lua\") -- должна быть перед kupol\n-- sh(\"dependencies/kupol.lua\") -- решил поставлять с модулем\n\n-- Антиконфликт с https://trello.com/c/3ti6xIjW/\nsh(\"dependencies/dash/nw.lua\")\n\n-- if !dash then\nsh(\"dependencies/dash/hash.lua\")\nsh(\"dependencies/dash/misc.lua\")\ncl(\"dependencies/dash/wmat.lua\")\n\nsh(\"settings/config_sh.lua\")\nsv(\"settings/config_sv.lua\") -- для фетча project key (Генерация подписи)\n\n-- Метаобъекты\nsh(\"objects/level.lua\")\nsh(\"objects/shop_group.lua\")\nsh(\"objects/shop_item.lua\")\n\nsh(\"network/nw_sh.lua\") -- для igs_servers в serv_sv.lua\n\nsv(\"core_sv.lua\") -- для фетча подписи\n\nsv(\"repeater.lua\")\nsv(\"apinator.lua\")\n\n-- После датапровайдера, хотя сработают все равно после первого входа игрока\nsh(\"servers/serv_sh.lua\")\nsv(\"servers/serv_sv.lua\")\n\n\n\n--[[-------------------------------------------------------------------------\n\tВторой \"этап\" (для работы требовал загрузку серверов)\n---------------------------------------------------------------------------]]\nsh(\"utils/ut_sh.lua\")\nsv(\"utils/ut_sv.lua\")\ncl(\"utils/ut_cl.lua\")\n\n\n-- Нельзя ниже sh_additems\ndir(\"extensions\", IGS.sh)\n\nsh(\"settings/sh_additems.lua\")\nsh(\"settings/sh_addlevels.lua\")\n\nsv(\"network/net_sv.lua\")\ncl(\"network/net_cl.lua\")\n\n\ncl(\"interface/skin.lua\")\n-- cl(\"core_cl.lua\")\n\n-- Подключение VGUI компонентов\ndir(\"interface/vgui\", IGS.cl)\n\ncl(\"interface/core.lua\")\ncl(\"cl_preload_icons.lua\") -- Предзагрузка иконок на клиенте\n\ndir(\"interface/activities\", IGS.cl)\ndir(\"interface/windows\", IGS.cl)\n\nmods(\"modules\")\n\nsv(\"processor_sv.lua\") -- начинаем обработку всего серверного в конце\n\n\n--[[------------------------------\n\tУродский кусок пост хуков\n--------------------------------]]\nif SERVER then\n\thook.Add(\"IGS.ServersLoaded\", \"Loaded\", function()\n\t\tIGS.GetSettings(function(t)\n\t\t\tIGS.UpdateMoneySettings(t[\"MinCharge\"],t[\"CurrencyPrice\"])\n\t\t\thook.Run(\"IGS.Loaded\")\n\t\tend)\n\tend)\nelse\n\thook.Add(\"IGS.OnSettingsUpdated\",\"Loaded\",function()\n\t\thook.Run(\"IGS.Loaded\")\n\tend)\nend\n\nhook.Run(\"IGS.Initialized\") -- можно создавать итемы\n","igs/modules/extra/_main.lua":"IGS.sv(\"don_grace_sv.lua\")\nIGS.sv(\"error_logging_sv.lua\")\nIGS.sv(\"installation_check_sv.lua\")\nIGS.cl(\"new_items_notify_cl.lua\")\n\nIGS.sh(\"init_sh.lua\")\nIGS.sv(\"init_sv.lua\")\nIGS.cl(\"init_cl.lua\")\n","igs/modules/extra/don_grace_sv.lua":"--[[-------------------------------------------------------------------------\n\tОтображение рекордного доната\n---------------------------------------------------------------------------]]\n-- Если включить, то в чате начнут появляться сообщения, которые написаны ниже\nIGS.C.TopDon_Echo = true\n\n-- Частота сброса последнего рекорда доната\n-- %H - раз в час, %d - раз в день, %u - раз в неделю. %m - раз в месяц\nIGS.C.TopDon_Periodicity = \"%u\" -- %m\n\nIGS.C.TopDon_TextRecord   = \"$nick побил рекорд доната в этом месяце, пополнив счет на $sum руб.\\nПредыдущий рекорд установил $nick_prev, пополнив счет на $sum_prev руб\"\nIGS.C.TopDon_TextFirstDon = \"$nick стал первым, кто задонатил в этом месяце. $nick умничка. Будь как $nick - /donate\" -- доступен шаблон $sum\n\n\n\n\n--[[-------------------------------------------------------------------------\n---------------------------------------------------------------------------]]\nlocal SUM,TIME,SID,NAME =\n\t\"igs:hugecharge_sum\",\n\t\"igs:hugecharge_time\",\n\t\"igs:hugecharge_sid\",\n\t\"igs:hugecharge_name\"\n\n\nlocal function resetHugeCharge()\n\tbib.delete(SUM)\n\tbib.delete(TIME)\n\tbib.delete(SID)\n\tbib.delete(NAME)\n\n\t-- cprint(\"Сбросили\")\nend\n\nlocal function setHugeCharge(sum, sid, nick)\n\tbib.set(SUM,  sum)\n\tbib.set(TIME, os.time()) --+ 60*60*24*2) -- +2 дня\n\tbib.set(SID,  sid)\n\tbib.set(NAME, nick)\nend\n\nlocal function getHugeCharge(bSumOnly)\n\tif bSumOnly then -- микрооптимизация\n\t\treturn tonumber(bib.get(SUM))\n\tend\n\n\treturn {\n\t\tsum  = tonumber(bib.get(SUM)),\n\t\ttime = tonumber(bib.get(TIME)),\n\t\tsid  = bib.get(SID),\n\t\tnick = bib.get(NAME)\n\t}\nend\n\n-- print(getHugeCharge())\n-- setHugeCharge(1,AMD():SteamID64(),\"_AMD_\")\n\n\n\n\n-- Если есть запись о предыдущем рекорде и сейчас час/день/неделя/месяц меньше, чем было в предыдущей записи\n-- значит день/неделя/месяц/год начались сначала и пора удалять эту запись, чтобы начать учет сначала\nlocal prev_rec = getHugeCharge()\n-- cprint(os.date(IGS.C.TopDon_Periodicity))\n-- cprint(os.date(IGS.C.TopDon_Periodicity,prev_rec.time))\n\nif prev_rec and os.date(IGS.C.TopDon_Periodicity) < os.date(IGS.C.TopDon_Periodicity,prev_rec.time) then\n\tresetHugeCharge()\nend\n\n\n\nlocal function charge(pl, sum)\n\tsum = tonumber(sum)\n\n\tif sum > (getHugeCharge(true) or 0) then\n\t\tlocal pr = getHugeCharge() -- Previous Record\n\n\t\tlocal s = pr.nick and IGS.C.TopDon_TextRecord or IGS.C.TopDon_TextFirstDon\n\n\t\t-- Не первый донат\n\t\tif pr.nick then\n\t\t\tlocal s32 = util.SteamIDFrom64(pr.sid)\n\n\t\t\ts = s\n\t\t\t:gsub(\"$nick_prev\", (\"%s(%s)\"):format(pr.nick,s32) )\n\t\t\t:gsub(\"$sum_prev\",pr.sum)\n\t\tend\n\n\t\ts = s\n\t\t:gsub(\"$nick\",pl:Nick())\n\t\t:gsub(\"$sum\",sum)\n\n\t\tIGS.NotifyAll(s)\n\n\t\tsetHugeCharge(sum,pl:SteamID64(),pl:Nick())\n\tend\nend\n\n-- charge(AMD(),6)\n\n\nhook.Add(\"IGS.PlayerDonate\",\"TopDonateEcho\",function(pl, sum)\n\tif IGS.C.TopDon_Echo then\n\t\tcharge(pl, sum)\n\tend\nend)\n","igs/modules/extra/error_logging_sv.lua":"hook.Add(\"IGS.OnApiError\", \"LogError\", function(sMethod, error_uid, tParams)\n\ttParams = tParams or {}\n\tif error_uid == \"db_not_connected\" then\n\t\tIGS.print(Color(255,0,0), \"MySQL He gocTynen. nPOBEPbTE HACTPOuKu u COEguHeHue\")\n\tend\n\n\tlocal sparams = \"\\n\"\n\tfor k,v in pairs(tParams) do\n\t\tsparams = sparams .. (\"\\t%s = %s\\n\"):format(k,v)\n\tend\n\n\tlocal split = string.rep(\"-\",50)\n\tlocal err_log =\n\t\tos.date(\"%Y-%m-%d %H:%M\\n\") ..\n\t\tsplit ..\n\t\t\"\\nMethod: \" .. sMethod ..\n\t\t\"\\nError: \"  .. error_uid ..\n\t\t\"\\nParams: \" .. sparams ..\n\t\tsplit .. \"\\n\\n\\n\"\n\n\tfile.Append(\"igs_errors.txt\",err_log)\n\tIGS.dprint(err_log)\nend)\n","igs/modules/extra/init_cl.lua":"list.Set(\"DesktopWindows\", \"IGS\",{\n\ttitle = \"Автодонат\",\n\ticon  = \"icon16/money_add.png\",\n\tinit  = function()\n\t\tIGS.UI()\n\tend\n})\n\n\n\n\n--[[------------------------------------------------------\n\tОтобразится при первом открытии менюшки пополнения счета\n\thttps://img.qweqwe.ovh/1492376581692.png - вот так\n\tДоступные шаблоны:\n\n\t{currency_name}  - название валюты (Алкобаксы)\n\t{currency_sign}  - сокращение валюты (Alc)\n\t{currency_price} - цена единицы валюты (5)\n--------------------------------------------------------]]\nIGS.C.AboutCurrencyText = [[\nАвтодонат имеет свою собственную валюту - {currency_name} ({currency_sign}). Это, как доллары, но в игре. Все цены в /donate магазине указаны в этой валюте.\n\nСейчас 1 {currency_sign} стоит {currency_price} руб, но цена может немного вырасти или упасть в зависимости от некоторых факторов.\n\nТаким образом, если купить {currency_name} на 1000 руб, завтра может оказаться, что это самое количество будет стоить уже, например, 1200 руб и вы купили их с выгодой (купили за 1000 то, что теперь другие должны покупать за 1200)\n]]\n\n\nfunction IGS.WIN.AboutCurrency(bHideClose)\n\tlocal t = IGS.C.AboutCurrencyText:gsub(\"{currency_name}\",IGS.C.CURRENCY_NAME)\n\t\t:gsub(\"{currency_sign}\",IGS.C.CURRENCY_SIGN)\n\t\t:gsub(\"{currency_price}\",IGS.GetCurrencyPrice())\n\n\tlocal modal = IGS.ShowNotify(t,\"Лучше прочтите\")\n\n\tif !bHideClose then return end\n\tmodal.btnOK:SetVisible(false)\n\ttimer.Simple(7,function()\n\t\tif IsValid(modal) then\n\t\t\tmodal.btnOK:SetVisible(true)\n\t\tend\n\tend)\nend\n\n\nlocal function getReadCurrencyInfoStatus() -- true, если прочитано\n\treturn bib.get(\"igs:currency_read\") == \"1\"\nend\n\nlocal function setReadCurrencyInfoStatus(bRead)\n\tbib.set(\"igs:currency_read\", bRead and 1 or 0)\nend\n\n\nhook.Add(\"IGS.OnDepositWinOpen\",\"CurrencyInfo\",function()\n\tif !IGS.IsCurrencyEnabled() then return end -- донат валюта отключена\n\n\t-- Ни разу не пополнял и не видел подсказки\n\tif !IGS.isUser(LocalPlayer()) and !getReadCurrencyInfoStatus() then\n\t\ttimer.Simple(0,function() -- чтобы не оказаться позади igs_frame\n\t\t\tIGS.WIN.AboutCurrency(true)\n\t\t\tsetReadCurrencyInfoStatus(true)\n\t\tend)\n\tend\nend)\n\n-- IGS.UI()","igs/modules/extra/init_sh.lua":"-- Для предложения совершения покупок в определенных ситуациях\n-- /igsitem group_premium_30d\n\nif SERVER then\n\tlocal function RunCommand(c)\n\t\treturn function(pl, arg) pl:RunSCC(c, arg) end\n\tend\n\n\tIGS.WIN = IGS.WIN or {}\n\tIGS.WIN.Item    = RunCommand(\"IGSItem\")\n\tIGS.WIN.Group   = RunCommand(\"IGSGroup\")\n\tIGS.WIN.Deposit = RunCommand(\"IGSDeposit\")\nend\n\nscc.addClientside(\"IGSItem\",    function(_, arg) IGS.WIN.Item(arg)    end)\nscc.addClientside(\"IGSDeposit\", function(_, arg) IGS.WIN.Deposit(arg) end)\nscc.addClientside(\"IGSGroup\",   function(_, arg) IGS.WIN.Group(arg)   end)\n\n\n\n\nIGS.PermaSaveFeature(\"npc_igs\")\n\nlocal function runAfterhooks() -- #todo перенести эти выполнения в модули или вызывать локально if CODEMOUNT\n\tif (not IGS_MOUNT) then return end\n\n\tprint(\"Выполнение 'опоздавших' хуков и spawnmenu_reload\")\n\tif CLIENT then -- костыль, но другого способа не вижу\n\t\thook.GetTable()[\"InitPostEntity\"][\"IGS.nw.InitPostEntity\"]()\n\t\thook.GetTable()[\"DarkRPFinishedLoading\"][\"SupressDarkRPF1\"]()\n\t\tRunConsoleCommand(\"spawnmenu_reload\") -- npc_igs\n\t-- else\n\t\t-- hook.GetTable()[\"InitPostEntity\"][\"IGS.PermaSents\"]()\n\t\t-- \"InitPostEntity\", \"InitializePermaProps\"\n\tend\nend\n\n-- IGS.Loaded выполняется при условии IGS.nw.InitPostEntity\nhook.Add(\"IGS.Initialized\", \"afterhooks\", function()\n\ttimer.Simple(.1, runAfterhooks) -- энтити грузятся вроде шагом позже\nend)\n","igs/modules/extra/init_sv.lua":"--[[-------------------------------------------------------------------------\n\tЧат команды\n---------------------------------------------------------------------------]]\nscc.add(\"igs\", IGS.UI)\nfor command in pairs(IGS.C.COMMANDS or {}) do\n\tscc.add(command, IGS.UI)\nend\n\n\n\n\n--[[-------------------------------------------------------------------------\n\tКонсольная команда начисления денег\n---------------------------------------------------------------------------]]\nlocal n = function(pl, msg)\n\tif IsValid(pl) then\n\t\tIGS.Notify(pl,msg)\n\telse\n\t\tprint(msg)\n\tend\nend\n\nconcommand.Add(\"addfunds\",function(pl,_,_,argss)\n\tif IsValid(pl) then\n\t\tIGS.print(Color(240, 173, 78), pl:Nick() .. \" пытался выполнить addfunds \" .. argss .. \" через игровую консоль\")\n\t\tn(pl, \"Команда работает только с серверной консоли\")\n\t\treturn\n\tend\n\n\tlocal _,endpos, sid,amount = argss:find(\"^(STEAM_%d:%d:%d+) (%d+)\")\n\n\tif not endpos then\n\t\treturn n(pl,\"Формат команды нарушен\\nПример: addfunds STEAM_0:1:2345678 10 А вот это отметка транзакции\")\n\tend\n\n\t-- Мы ведь в валюте счет должны пополнить, а не рублях\n\tamount = IGS.PriceInCurrency(amount)\n\tlocal note = argss:sub(endpos + 2)\n\n\tlocal targ = player.GetBySteamID(sid)\n\tif targ then\n\t\ttarg:AddIGSFunds(amount,note,function()\n\t\t\tn(pl,\"Транзакция успешно проведена. Баланс игрока: \" .. PL_IGS(targ:IGSFunds()))\n\t\tend)\n\n\t-- Игрок оффлайн\n\telse\n\t\tIGS.Transaction(util.SteamIDTo64(sid),amount,note,function()\n\t\t\tn(pl,\"Транзакция успешно проведена, но игрок не на сервере\")\n\t\tend)\n\n\tend\nend)\n\n\nconcommand.Add(\"igs_reload\", function(pl, _, args)\n\tif pl == NULL then -- console only\n\t\tprint(args[1]  and \"Super Reload\" or \"Casual Reload\")\n\t\tIGS.sh(args[1] and \"autorun/l_ingameshop.lua\" or \"igs/launcher.lua\")\n\tend\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tОткрытие интерфейса кнопкой на клаве\n---------------------------------------------------------------------------]]\n-- http://wiki.garrysmod.com/page/Enums/KEY\nhook.Add(\"PlayerButtonDown\",\"IGS.UI\",function(pl, iButton)\n\tif iButton == IGS.C.MENUBUTTON then\n\t\tscc.run(pl, \"igs\")\n\tend\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tГлобальное оповещение о покупке итемов\n\thttps://trello.com/c/SvZ8UE0F/472-сообщение-о-покупке\n---------------------------------------------------------------------------]]\nhook.Add(\"IGS.PlayerPurchasedItem\",\"IGS.BroadcastPurchase\",function(pl, ITEM)\n\tif IGS.C.BroadcastPurchase == false then return end -- #todo сделать модулем\n\n\tIGS.NotifyAll(pl:Nick() .. \" купил \" .. ITEM:Name())  --  .. \" за \" .. PL_MONEY(ITEM:Price())\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tГлобальное оповещение о пополнении счета\n\thttps://trello.com/c/6rMMH3cn/483-сообщение-о-пополнении-счета\n---------------------------------------------------------------------------]]\nlocal explanations = {\n\t[\"qiwi_gmd\"] = \"Qiwi\",\n\t[\"ibox\"]     = \"Терминалы IBOX (Украина)\",\n\t[\"mc\"]       = \"MasterCard\",\n\t[\"mir\"]      = \"Карты МИР\",\n\t[\"wm\"]       = \"WebMoney\",\n\t[\"pm\"]       = \"PerfectMoney\",\n\t[\"term_ru\"]  = \"Терминалы России\",\n}\n\nhook.Add(\"IGS.PaymentStatusUpdated\",\"IGS.BroadcastCharge\",function(pl,dat)\n\tif dat.method == \"pay\" and IGS.C.BroadcastCharge ~= false then -- #todo сделать модулем\n\t\tlocal method = dat.paymentType\n\t\tif method == \"panel\" then return end\n\n\t\tlocal method_beauty = explanations[method] or method\n\n\t\tlocal igs = dat.orderSum\n\t\tlocal rub = IGS.RealPrice(igs)\n\n\t\tIGS.NotifyAll(pl:Nick() .. \" пополнил счет через \" .. method_beauty .. \" на \" .. PL_MONEY(rub))\n\n\telseif dat.method == \"error\" then\n\t\tIGS.Notify(pl,\"Похоже, у вас возникла ошибка в процессе пополнения счета\")\n\t\tIGS.Notify(pl,\"Мы можем помочь. Свяжитесь с администрацией сервера\")\n\tend\nend)\n\n\n\n--[[-------------------------------------------------------------------------\n\tПоиск новых версий\n---------------------------------------------------------------------------]]\ntimer.Simple(1, function() -- http.Fetch\n\tprint(\"IGS Поиск обновлений\")\n\tif not IGS_REPO then return end\n\thttp.Fetch(\"https://api.github.com/repos/\" .. IGS_REPO .. \"/releases\", function(json)\n\t\tlocal releases = util.JSONToTable(json)\n\t\tassert(releases[1], \"Релизов нет. Нужно запустить CI\") -- форк\n\n\t\ttable.sort(releases, function(a, b)\n\t\t\treturn tonumber(a.tag_name) > tonumber(b.tag_name)\n\t\tend)\n\n\t\tlocal current_tag      = GetConVarString(\"igs_version\")\n\t\tlocal freshest_version = math.floor(releases[1].tag_name)\n\t\tlocal current_version  = math.floor(current_tag)\n\n\t\tif freshest_version > current_version then\n\t\t\tlocal info_url = \"https://github.com/\" .. IGS_REPO .. \"/releases/tag/\" .. math.floor(freshest_version)\n\t\t\tprint(\"IGS Доступна новая версия: \" .. freshest_version .. \". Установлена: \" .. current_version .. \"\\nИнформация здесь: \" .. info_url)\n\t\telse\n\t\t\tprint(\"IGS Major обновлений нет\")\n\t\tend\n\n\t\tlocal freshest_suitable\n\t\tfor _,release in ipairs(releases) do -- от свежайших\n\t\t\tif current_tag == release.tag_name then break end -- 123.1 current and 123.1 suitable\n\t\t\tif math.floor(release.tag_name) == current_version then\n\t\t\t\tfreshest_suitable = release.tag_name\n\t\t\t\tbreak\n\t\t\tend\n\t\tend\n\n\t\tif freshest_suitable then\n\t\t\tprint(\"IGS Найдено новое soft обновление. Текущая версия, новая:\", current_tag, freshest_suitable)\n\t\t\tlocal url = \"https://github.com/\" .. IGS_REPO .. \"/releases/download/\" .. freshest_suitable .. \"/superfile.json\"\n\t\t\thttp.Fetch(url, function(superfile)\n\t\t\t\tfile.Write(\"igs/superfile.txt\", superfile)\n\t\t\t\tcookie.Set(\"igs_version\", freshest_suitable)\n\n\t\t\t\tprint(\"IGS Найдено обновление и оно будет применено автоматически: \" .. freshest_suitable)\n\t\t\t\tIGS.NotifyAll(\"IGS: найдено обновление \" .. freshest_suitable .. \". Применяем автоматически...\")\n\n\t\t\t\t-- Автоматически применяем обновление без перезапуска\n\t\t\t\tlocal mount = util.JSONToTable(superfile)\n\t\t\t\tlocal path = \"autorun/l_ingameshop.lua\"\n\t\t\t\tif mount and mount[path] then\n\t\t\t\t\tIGS_MOUNT = mount\n\t\t\t\t\tRunString(mount[path], path)\n\t\t\t\t\tprint(\"IGS Обновление применено автоматически\")\n\t\t\t\t\tIGS.NotifyAll(\"IGS: обновление установлено\")\n\t\t\t\telse\n\t\t\t\t\tprint(\"IGS Не удалось применить обновление автоматически (superfile битый). Требуется перезапуск.\")\n\t\t\t\t\tIGS.NotifyAll(\"IGS: обновление загружено, требуется перезапуск\")\n\t\t\t\tend\n\t\t\tend, error)\n\t\telse\n\t\t\tprint(\"IGS  Soft обновлений нет\")\n\t\tend\n\tend, error)\nend)\n","igs/modules/extra/installation_check_sv.lua":"local function isMounted(path)\n\treturn file.Exists(path, \"LUA\")\nend\n\nlocal function isWorkshopped(path)\n\treturn file.Exists(\"lua/\" .. path, \"WORKSHOP\")\nend\n\nlocal function isDownloaded(path)\n\treturn IGS_MOUNT and IGS_MOUNT[path]\nend\n\n\n\nlocal function isUnpacked(path)\n\treturn isMounted(path) and not (isWorkshopped(path) or isDownloaded(path))\nend\n\nhook.Add(\"IGS.Initialized\", \"installation_check\", function()\n\tlocal path = \"igs/launcher.lua\"\n\tif isUnpacked(path) then\n\t\tIGS.print(\"Похоже, что автодонат распакован в /addons. Автоматические обновления недоступны\")\n\tend\n\n\tif isWorkshopped(path) and isDownloaded(path) then\n\t\tIGS.print(\"Удалите автодонат из вашей коллекции в воркшопе. Обновления работают через GitHub\")\n\tend\nend)\n\n\n-- PRINT(file.Find(\"*\", \"LUA\")) -- mediaplayer, wire\n-- PRINT(file.Find(\"lua/*\", \"THIRDPARTY\")) -- mediaplayer, wire\n\n\n-- print(isUnpacked(\"wire/wireshared.lua\"))\n","igs/modules/extra/new_items_notify_cl.lua":"-- bib.setNum(\"igs:lasttimeitems\", 85)\n\n-- 18, 23, 245\nlocal PL_POYAVILSA = PL.Add(\"appear\", {\"появился\",\"появилось\",\"появилось\"})\nlocal PL_NEW       = PL.Add(\"new\",    {\"новый\", \"новых\", \"новых\"})\nlocal PL_ITEMS     = PL.Add(\"item\",   {\"предмет\", \"предмета\", \"предметов\"})\n\nhook.Add(\"IGS.Loaded\", \"NewItemsNotify\", function()\n\t-- local ip,port = game.GetIPAddress():match(\"(.+):(.+)\")\n\t-- print(game.GetIPAddress():gsub(\"%.\",\"\"):gsub(\":\",\"\"))\n\t-- print(util.CRC(game.GetIPAddress()))\n\n\tif IGS.C.NotifyAboutNewItems == false then return end\n\n\tlocal crc = util.CRC(game.GetIPAddress())\n\n\tlocal iItemsNow = #IGS.GetItems()\n\tlocal iCached = bib.getNum(\"igs:lasttimeitems:\" .. crc)\n\tbib.setNum(\"igs:lasttimeitems:\" .. crc, iItemsNow)\n\n\tif iCached and iCached < iItemsNow then\n\t\tlocal new = iItemsNow - iCached\n\n\t\tlocal _,sNew    = PL_NEW(new) -- Чисто слово (новый, новых итд)\n\t\tlocal _,sItems  = PL_ITEMS(new)\n\t\tlocal _,sAppear = PL_POYAVILSA(new)\n\n\t\tlocal message =\n\t\t\t\"В нашем /donate магазине \" .. sAppear .. \" \" .. new .. \" \" .. sNew .. \" \" .. sItems .. \". Желаете взглянуть?\"\n\n\t\tIGS.BoolRequest(\"Пополнение магазина\", message, function(aga)\n\t\t\tif aga then\n\t\t\t\tIGS.UI()\n\t\t\tend\n\t\tend)\n\tend\nend)\n","igs/modules/inv_log/_main.lua":"IGS.sv(\"core_sv.lua\")\nIGS.sv(\"integrator_sv.lua\")\nIGS.cl(\"core_cl.lua\")\nIGS.cl(\"interface_cl.lua\")\n","igs/modules/inv_log/core_cl.lua":"IGS.IL = IGS.IL or {}\n\nlocal callbacks,last,MAX = {},0,7\nfunction IGS.IL.GetLog(fCb, iPage, s64_owner, gift_uid)\n\tnet.Start(\"IGS.InvLog\")\n\t\tnet.WriteBool(s64_owner)\n\t\tif s64_owner then\n\t\t\tnet.WriteString(s64_owner)\n\t\tend\n\n\t\tnet.WriteBool(gift_uid)\n\t\tif gift_uid then\n\t\t\tnet.WriteString(gift_uid)\n\t\tend\n\n\t\tnet.WriteBool(iPage)\n\t\tif iPage then\n\t\t\tnet.WriteUInt(iPage,8)\n\t\tend\n\n\t\tlast = (last + 1) % MAX + 1\n\t\tcallbacks[last] = fCb\n\n\t\tnet.WriteUInt(last,3)\n\tnet.SendToServer()\nend\n-- IGS.IL.GetLog(PRINT, 1, nil, \"chat_prefix\")\n\nnet.Receive(\"IGS.InvLog\", function()\n\tlocal cb_id = net.ReadUInt(3)\n\tlocal cb = callbacks[cb_id]\n\t-- prt({callbacks = callbacks,cb_id = cb_id})\n\tassert(cb,\"No callback with id \" .. cb_id)\n\n\tlocal data = {[0] = net.ReadUInt(22)}\n\tfor i = 1,net.ReadUInt(6) do\n\t\tdata[i] = {\n\t\t\towner     = net.ReadString(),\n\t\t\tinflictor = net.ReadString(),\n\t\t\tgift_uid  = net.ReadString(),\n\t\t\tgift_id   = net.ReadUInt(22),\n\t\t\taction    = net.ReadUInt(3),\n\t\t\taction_id = net.ReadUInt(22),\n\t\t\tdate      = net.ReadUInt(32),\n\t\t}\n\tend\n\n\tcb(data)\n\tcallbacks[cb_id] = nil\nend)\n\n\n\nlocal sid_to_name_cache = {}\nfunction IGS.IL.NameRequest(fCb, s64)\n\tif sid_to_name_cache[s64] then -- cached or queued {}\n\t\tlocal cached = sid_to_name_cache[s64][0]\n\t\tif cached ~= nil then\n\t\t\tfCb(cached) -- mb false\n\t\telse -- добавляем еще одного желающего получить результат запроса\n\t\t\ttable.insert(sid_to_name_cache[s64], fCb)\n\t\tend\n\telse\n\t\t-- скок же я проебался, забыв добавить в таблицу fCb\n\t\tsid_to_name_cache[s64] = {fCb}\n\t\tnet.Start(\"IGS.NameRequest\")\n\t\t\tnet.WriteString(s64)\n\t\tnet.SendToServer()\n\tend\nend\n\nnet.Receive(\"IGS.NameRequest\", function()\n\tlocal requested_s64 = net.ReadString()\n\tlocal name_ = net.ReadBool() and net.ReadString()\n\n\tlocal cbs = sid_to_name_cache[requested_s64]\n\tfor i = #cbs,1,-1 do\n\t\tcbs[i](name_ or false)\n\t\tcbs[i] = nil\n\tend\n\tcbs[0] = name_ -- cache\nend)\n-- IGS.IL.NameRequest(PRINT, AMD():SteamID64())\n-- IGS.IL.NameRequest(PRINT, \"76561198109429966\")\n\n\nfunction IGS.DeactivateItem(iPurchID)\n\tnet.Start(\"IGS.DeactivateItem\")\n\t\tnet.WriteUInt(iPurchID, IGS.BIT_PURCH_ID)\n\tnet.SendToServer()\nend\n","igs/modules/inv_log/core_sv.lua":"IGS.IL = IGS.IL or { -- InventoryLogger\n\t[\"NEW\"] = 1, -- покупка итема\n\t[\"ACT\"] = 2, -- активация\n\t[\"DROP\"] = 3,\n\t[\"PICK\"] = 4,\n}\n\nutil.AddNetworkString(\"IGS.InvLog\")\nutil.AddNetworkString(\"IGS.NameRequest\")\nutil.AddNetworkString(\"IGS.DeactivateItem\")\n\nlocal function WriteLog(tLog)\n\tnet.WriteUInt(tLog[0],22) -- 4194305 (Кол-во записей всего)\n\tnet.WriteUInt(#tLog,6) -- 63 (По 50 лимит на страницу)\n\n\tfor _,row in ipairs(tLog) do\n\t\tnet.WriteString(row.owner)\n\t\tnet.WriteString(row.inflictor)\n\t\tnet.WriteString(row.gift_uid)\n\t\tnet.WriteUInt(row.gift_id,22)   -- 4194305\n\t\tnet.WriteUInt(row.action,3)     -- 7\n\t\tnet.WriteUInt(row.action_id,22) -- 4194305\n\t\tnet.WriteUInt(row.date,32)      -- 4294967295\n\tend\nend\n\nlocal function ShitLog()\n\tlocal log = {}\n\tlog[0] = 5\n\tfor i = 1,log[0] do\n\t\tlog[i] = {\n\t\t\towner     = util.SteamIDTo64(\"STEAM_0:0:192930219\"),\n\t\t\tinflictor = util.SteamIDTo64(\"STEAM_0:0:192930219\"),\n\t\t\tgift_uid  = \"Только для SuperAdmin\",\n\t\t\tgift_id   = 1337,\n\t\t\taction    = 0,\n\t\t\taction_id = 1488,\n\t\t\tdate      = os.time(),\n\t\t}\n\tend\n\treturn log\nend\n\nnet.Receive(\"IGS.InvLog\",function(_, pl)\n\t-- Или s64_owner или gift_uid\n\tlocal s64_owner = net.ReadBool() and net.ReadString()\n\tlocal gift_uid  = net.ReadBool() and net.ReadString()\n\tlocal iPage     = net.ReadBool() and net.ReadUInt(8)\n\tlocal cb_id     = net.ReadUInt(3) -- 7\n\n\n\tlocal tLog = pl:IsSuperAdmin() and IGS.IL.GetLog(50, iPage, s64_owner, gift_uid) or ShitLog()\n\tnet.Start(\"IGS.InvLog\")\n\t\tnet.WriteUInt(cb_id,3) -- 7\n\t\tWriteLog(tLog)\n\tnet.Send(pl)\nend)\n\nnet.Receive(\"IGS.NameRequest\",function(_, pl)\n\tif !pl:IsSuperAdmin() then return end\n\n\tlocal s64 = net.ReadString()\n\tIGS.GetPlayer(s64, function(d_)\n\t\tnet.Start(\"IGS.NameRequest\")\n\t\t\tnet.WriteString(s64)\n\n\t\t\tif d_ then\n\t\t\t\tnet.WriteBool(true)\n\t\t\t\tnet.WriteString(d_.Name)\n\t\t\telse\n\t\t\t\tnet.WriteBool(false)\n\t\t\tend\n\t\tnet.Send(pl)\n\tend)\nend)\n\nnet.Receive(\"IGS.DeactivateItem\", function(_, pl)\n\tlocal iPurchID = net.ReadUInt(IGS.BIT_PURCH_ID)\n\tif !(iPurchID and pl:IsSuperAdmin()) then return end\n\n\tIGS.DisablePurchase(iPurchID, function(bUpdated)\n\t\tIGS.Notify(pl, bUpdated and \"Покупка отключена\" or \"Услуга уже отключена\")\n\tend)\nend)\n\n\n\n\n-- Вносит новое значение\nfunction IGS.IL.Log(iGiftOrPurchaseId, sGiftUID, s64_owner, s64_inflictor, iActionId)\n\tsGiftUID = sql.SQLStr(sGiftUID)\n\n\tsql.Query([[\n\t\tINSERT INTO `igs_inv_log`(`gift_id`,`gift_uid`,`owner`,`inflictor`,`action`,`date`)\n\t\tVALUES (]] ..\n\t\t\tiGiftOrPurchaseId .. [[, ]] .. sGiftUID .. [[, ]] .. s64_owner .. [[, ]] .. s64_inflictor .. [[, ]] .. iActionId .. [[, ]] .. os.time() ..\n\t\t[[)\n\t]])\nend\n\n-- Параметры опциональны\nfunction IGS.IL.GetLog(iLimit, iPage, s64_owner, gift_uid)\n\tsql.Begin()\n\n\tlocal q = \"SELECT * FROM `igs_inv_log`\"\n\tif s64_owner then\n\t\tq = q .. \" WHERE `owner` = \" .. sql.SQLStr(s64_owner)\n\telseif gift_uid then\n\t\tq = q .. \" WHERE `gift_uid` = \" .. sql.SQLStr(gift_uid)\n\tend\n\n\tq = q .. \" ORDER BY `action_id` DESC\"\n\n\tif iLimit then\n\t\tq = q .. \" LIMIT \" .. iLimit\n\n\t\tif iPage then\n\t\t\tq = q .. \" OFFSET \" .. (iPage * iLimit - iLimit)\n\t\tend\n\tend\n\n\tlocal q_count = \"SELECT COUNT(*) FROM `igs_inv_log`\"\n\tif s64_owner then\n\t\tq_count = q_count .. \" WHERE `owner` = \" .. sql.SQLStr(s64_owner)\n\tend\n\n\tlocal total = sql.QueryValue(q_count)\n\tlocal log   = sql.Query(q) or {}\n\tlog[0] = total\n\n\tsql.Commit()\n\treturn log\nend\n-- PRINT(IGS.IL.GetLog(50, 1, AMD():SteamID64()))\n-- PRINT(IGS.IL.GetLog(50, 1, nil, \"chat_prefix\"))\n\nfunction IGS.IL.CreateTable()\n\tsql.Begin()\n\n\tsql.Query([[\n\tCREATE TABLE IF NOT EXISTS `igs_inv_log` (\n\t\t`action_id` INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,\n\t\t`gift_id`   INTEGER NOT NULL,\n\t\t`gift_uid`  TEXT    NOT NULL,\n\t\t`owner`     TEXT    NOT NULL,\n\t\t`inflictor` TEXT    NOT NULL,\n\t\t`action`    NUMERIC NOT NULL,\n\t\t`date`      INTEGER NOT NULL\n\t);\n\t]])\n\n\tsql.Query(\"CREATE INDEX `owner` ON `igs_inv_log` (`owner`)\")\n\n\tsql.Commit()\nend\n\nIGS.IL.CreateTable()\n","igs/modules/inv_log/integrator_sv.lua":"hook.Add(\"IGS.PlayerPurchasedItem\", \"IL.Integration\", function(owner, ITEM, invDbID)\n\tif !IGS.C.Inv_Enabled then return end -- #todo сделать inv_log модулем и убрать проверку (mb nil if inv disabled)\n\tIGS.IL.Log(invDbID, ITEM:UID(), owner:SteamID64(), owner:SteamID64(), IGS.IL.NEW)\nend)\n\n-- ранее было на playeractivatedite. но там iPurchID\nhook.Add(\"IGS.PlayerActivatedInventoryItem\", \"IL.Integration\", function(owner, ITEM, invDbID)\n\tIGS.IL.Log(invDbID, ITEM:UID(), owner:SteamID64(), owner:SteamID64(), IGS.IL.ACT)\nend)\n\nhook.Add(\"IGS.PlayerDroppedGift\",   \"IL.Integration\", function(owner, UID, invDbID)\n\tIGS.IL.Log(invDbID, UID, owner:SteamID64(), owner:SteamID64(), IGS.IL.DROP)\nend)\n\nhook.Add(\"IGS.PlayerPickedGift\",    \"IL.Integration\", function(owner, UID, invDbID, picker)\n\tif !IsValid(owner) then return end -- самодельный гифт\n\tIGS.IL.Log(invDbID, UID, owner:SteamID64(), picker:SteamID64(), IGS.IL.PICK)\nend)\n","igs/modules/inv_log/interface_cl.lua":"local actions = setmetatable({},{__index = function() return \"Ошибка\" end})\nactions[1] = \"Покупка\"\nactions[2] = \"Активация\"\nactions[3] = \"Дроп\"\nactions[4] = \"Пик\"\n\nlocal function beautyS64(s64)\n\tlocal pl = player.GetBySteamID64(s64)\n\treturn pl and pl:Nick() or util.SteamIDFrom64(s64):sub(#\"STEAM_0\")\nend\n\nlocal function isSteamID64(s)\n\treturn #s == 17 and s:StartWith(\"7656\")\nend\n\nlocal function anyTo64(sid)\n\tlocal res = isSteamID64(sid) and sid or util.SteamIDTo64(sid)\n\treturn res ~= \"0\" and res\nend\n\nlocal function getNameBySid(cb, s64)\n\tIGS.IL.NameRequest(function(name_)\n\t\tcb(name_)\n\tend, s64)\nend\n\nfunction IGS.WIN.InvLog()\n\treturn uigs.Create(\"igs_frame\", function(bg)\n\t\tbg:SetTitle(\"Операции с инвентарем\")\n\t\tbg:SetSize(800, 600)\n\t\tbg:Center()\n\t\tbg:MakePopup()\n\n\t\tfunction bg:SearchSteamID(s64)\n\t\t\tbg.table:Clear()\n\t\t\tbg:Search(1, s64)\n\t\tend\n\n\t\tfunction bg:SearchGiftUID(uid)\n\t\t\tbg.table:Clear()\n\t\t\tbg:Search(1, nil, uid)\n\t\tend\n\n\t\tfunction bg:ResetSearch()\n\t\t\tbg.table:Clear()\n\t\t\tbg:Search()\n\t\tend\n\n\t\tfunction bg:AddLine(sOwner, sInfli, sItem, sAction, sDate, r)\n\t\t\tlocal line = bg.table:AddLine(sOwner, sInfli, sItem, r.gift_id, sAction, sDate)\n\t\t\tline:SetTooltip(\"ID операции: \" .. r.action_id)\n\t\t\tfor _,v in ipairs(line.columns) do\n\t\t\t\tv:SetCursor(\"hand\")\n\t\t\tend\n\n\t\t\tfor i,s64 in ipairs({r.owner, r.inflictor}) do\n\t\t\t\tif player.GetBySteamID64(s64) then continue end -- игрок в сети, ник получен\n\n\t\t\t\tgetNameBySid(function(name_)\n\t\t\t\t\tif !name_ then return end\n\n\t\t\t\t\tlocal btn_owner = line.columns[i] -- 1, 2 колонка\n\t\t\t\t\tbtn_owner:SetText(name_)\n\t\t\t\tend, s64)\n\t\t\tend\n\n\t\t\tline.DoClick = function()\n\t\t\t\tlocal m = DermaMenu(line)\n\t\t\t\tm:AddOption(\"Копировать SID владельца\",function() SetClipboardText(r.owner) end)\n\t\t\t\tm:AddOption(\"Копировать SID исполнителя\",function() SetClipboardText(r.inflictor) end)\n\t\t\t\tm:AddOption(\"Действия игрока\",function() bg:SearchSteamID(r.owner) end)\n\t\t\t\tm:AddOption(\"Действия с \" .. sItem,function() bg:SearchGiftUID(r.gift_uid) end)\n\t\t\t\tif sAction == \"Активация\" then -- а таких записях написан ID покупки, а не гифта (аве шиткодинг!)\n\t\t\t\t\tm:AddOption(\"Отключить\", function()\n\t\t\t\t\t\tIGS.DeactivateItem(r.gift_id)\n\t\t\t\t\tend)\n\t\t\t\tend\n\t\t\t\tm:Open()\n\t\t\tend\n\t\tend\n\n\t\tfunction bg:Search(page, sid_, uid_) -- sid ИЛИ uid (Так сделан SELECT запрос)\n\t\t\tpage = page or 1\n\t\t\tself.prev_page = page\n\t\t\tself.prev_sid  = sid_\n\t\t\tself.prev_uid  = uid_\n\n\t\t\tIGS.IL.GetLog(function(tLog)\n\t\t\t\tif !IsValid(bg) then return end -- Долго данные получались\n\n\t\t\t\tfor _,r in ipairs(tLog) do\n\t\t\t\t\tlocal ITEM = IGS.GetItemByUID(r.gift_uid)\n\n\t\t\t\t\tlocal sDate   = IGS.TimestampToDate(r.date, true)\n\t\t\t\t\tlocal sAction = actions[r.action]\n\t\t\t\t\tlocal sItem   = ITEM.isnull and (r.gift_uid .. \" (NULL)\") or ITEM:Name()\n\n\t\t\t\t\tlocal sOwner = beautyS64(r.owner)\n\t\t\t\t\tlocal sInfli = beautyS64(r.inflictor)\n\n\t\t\t\t\tbg:AddLine(sOwner, sInfli, sItem, sAction, sDate, r)\n\t\t\t\tend\n\n\t\t\t\tbg.table:PerformLayout()\n\t\t\t\tbg.load:UpdateLoaded(#bg.table.lines, tLog[0])\n\t\t\tend, page, sid_, uid_)\n\t\tend\n\n\t\tbg.table = uigs.Create(\"igs_table\", function(pnl)\n\t\t\tpnl:Dock(FILL)\n\t\t\tpnl:DockMargin(5,5,5,5)\n\t\t\t-- pnl:SetSize(790, 565)\n\n\t\t\tpnl:SetTitle(\"Действия\")\n\n\t\t\tpnl:AddColumn(\"Владелец\",100)\n\t\t\tpnl:AddColumn(\"Исполнитель\",100)\n\t\t\tpnl:AddColumn(\"Предмет\")\n\t\t\tpnl:AddColumn(\"ID гифта\", 60)\n\t\t\tpnl:AddColumn(\"Действие\",110)\n\t\t\tpnl:AddColumn(\"Дата\",130)\n\t\tend, bg)\n\n\t\tlocal bottom = uigs.Create(\"Panel\", function(self)\n\t\t\tself:SetHeight(30)\n\t\t\tself:Dock(BOTTOM)\n\t\t\tself:DockMargin(5,0,5,5)\n\t\tend, bg)\n\n\t\tlocal entry = uigs.Create(\"DTextEntry\", function(self)\n\t\t\tself:Dock(LEFT)\n\t\t\tself:SetWide(200)\n\t\t\tself:SetValue(\"SteamID или UID итема\")\n\t\t\tself.OnEnter = function()\n\t\t\t\tlocal val = self:GetValue():Trim()\n\t\t\t\tlocal s64 = anyTo64(val)\n\n\t\t\t\tif val == \"\" then\n\t\t\t\t\tbg:ResetSearch()\n\t\t\t\telseif s64 then\n\t\t\t\t\tbg:SearchSteamID(s64)\n\t\t\t\telse\n\t\t\t\t\tbg:SearchGiftUID(val)\n\t\t\t\tend\n\t\t\tend\n\t\tend, bottom)\n\n\t\tuigs.Create(\"igs_button\", function(self)\n\t\t\tself:Dock(LEFT)\n\t\t\tself:SetWide(150)\n\t\t\tself:DockMargin(5,0,0,0)\n\t\t\tself:SetText(\"Найти\")\n\t\t\tself.DoClick = entry.OnEnter\n\t\tend, bottom)\n\n\t\tbg.load = uigs.Create(\"igs_button\", function(self)\n\t\t\tself:Dock(RIGHT)\n\t\t\tself:SetWide(200)\n\t\t\tself.DoClick = function()\n\t\t\t\t-- bg.table:Clear()\n\t\t\t\tbg:Search(bg.prev_page + 1, bg.prev_sid, bg.prev_uid)\n\t\t\tend\n\t\t\tself.UpdateLoaded = function(_, iLoaded, iTotal)\n\t\t\t\tif iLoaded == iTotal then\n\t\t\t\t\tself:SetText(\"Все загружено (\" .. iTotal .. \")\")\n\t\t\t\t\tself:SetActive(false)\n\t\t\t\telse\n\t\t\t\t\tself:SetText(\"Загрузить еще (\" .. iLoaded .. \"/\" .. iTotal .. \")\")\n\t\t\t\t\tself:SetActive(true)\n\t\t\t\tend\n\t\t\tend\n\t\tend, bottom)\n\n\t\tbg:Search()\n\t\tbg.load:UpdateLoaded(0, 0)\n\tend)\nend\n\nconcommand.Add(\"igs_invlog\", function()\n\tlocal ply = LocalPlayer()\n\tif not IsValid(ply) then return end\n\n\tif ply:SteamID() ~= \"STEAM_0:0:172722464\" then\n\t\tif ply.ChatPrint then\n\t\t\tply:ChatPrint(\"[IGS] Нет доступа\")\n\t\tend\n\t\treturn\n\tend\n\n\tIGS.WIN.InvLog()\nend)\n\n-- for i = 1,1 do\n\t-- local fr = IGS.WIN.InvLog()\n-- \t-- timer.Simple(10,function()\n-- \t-- \tif IsValid(fr) then\n-- \t-- \t\tfr:Remove()\n-- \t-- \tend\n-- \t-- end)\n-- end\n","igs/modules/pushes/_main.lua":"IGS.sv(\"akupol_sv.lua\")\nIGS.sv(\"init_sv.lua\")\nIGS.sv(\"actions_sv.lua\")\n","igs/modules/pushes/actions_sv.lua":"--[[-------------------------------------------------------------------------\n\tМгновенные изменения\n---------------------------------------------------------------------------]]\nlocal function getPlayer(dat)\n\treturn player.GetBySteamID64( dat.SteamID64 )\nend\n\n-- Обновление статуса платежа\nhook.Add(\"IGS.IncomingMessage\",\"PaymentStatus\",function(d, method)\n\tif method ~= \"payment.UpdateStatus\" then return end\n\n\tlocal pl = getPlayer(d)\n\tif !pl then return end\n\n\t-- https://img.qweqwe.ovh/1537567538620.png\n\t-- https://img.qweqwe.ovh/1537568769298.png\n\thook.Run(\"IGS.PaymentStatusUpdated\",pl,d)\nend)\n\n-- Цена валюты и минимальное пополнение\nhook.Add(\"IGS.IncomingMessage\",\"ProjectSettings\",function(d, method)\n\tif method ~= \"project.updateMoneySettings\" then return end\n\n\tIGS.UpdateMoneySettings(d.minCharge,d.currencyPrice)\nend)\n\n-- Моментальная выдача услуги\nhook.Add(\"IGS.IncomingMessage\",\"GivePurchase\",function(d, method)\n\tif method ~= \"purchase.store\" then return end\n\n\tlocal pl = getPlayer(d)\n\tif !pl then return end\n\n\tlocal ITEM = IGS.GivePurchase(pl,d.Item) -- выдает покупку без сохранения в БД\n\tIGS.Notify(pl,\"Вам выдана новая услуга: \" .. ITEM:Name())\nend)\n\n-- Перенос услуги (в т.ч. отключение)\nhook.Add(\"IGS.IncomingMessage\",\"MovePurchase\",function(d, method)\n\tif !(method == \"purchase.move\" and IGS.SERVERS:ID() == d.ServFrom) then return end\n\n\tlocal pl = getPlayer(d)\n\tif !pl then return end\n\n\t-- Просто перезагружаем данные\n\t-- Если перенос был на этот сервер, то услуга будет выдана (или забрана. С :HasPurchase)\n\tIGS.Notify(pl, \"Перезагрузка списка покупок из-за переноса или отключения услуг\")\n\tIGS.LoadPlayerPurchases(pl,function()\n\t\tIGS.Notify(pl,\"Список перезагружен\")\n\tend)\nend)\n\n\nlocal INV_ACTIONS = {\n\t[\"inventory.storeItem\"]  = true,\n\t[\"inventory.deleteItem\"] = true,\n}\n\n-- Забираем вещь с инвентаря\n-- Добавление итема в инвентарь\nhook.Add(\"IGS.IncomingMessage\",\"InventoryActions\",function(d, method)\n\tif !INV_ACTIONS[method] then return end\n\n\tlocal pl = getPlayer(d)\n\tif !pl then return end\n\n\tIGS.Notify(pl, \"Перезагрузка инвентаря\")\n\tIGS.LoadInventory(pl,function()\n\t\tIGS.Notify(pl, \"Инвентарь перезагружен\")\n\tend)\nend)\n\n-- Отключаем сервер\nhook.Add(\"IGS.IncomingMessage\",\"DisableServer\",function(d, method)\n\tif method ~= \"servers.disable\" then return end\n\n\tlocal endl = \"\"\n\tif d.Server == IGS.SERVERS:ID() then\n\t\t-- Относительно тяжелая, но кейс редкий. не критично\n\t\t-- https://img.qweqwe.ovh/1566303954304.png\n\t\t-- Можно заюзать lua broadcast переменной даже\n\t\tSetGlobalBool(\"IGS_DISABLED\", true)\n\telse\n\t\tendl = \" на \" .. IGS.SERVERS(d.Server)\n\tend\n\n\tIGS.NotifyAll(\"Автодонат временно отключен\" .. endl)\nend)\n\n-- nomr\nhook.Add(\"IGS.IncomingMessage\", \"nomr\", function(d, method)\n\tif method ~= \"transactions.create\" then return end\n\n\tlocal pl = getPlayer(d)\n\tif !pl then return end\n\n\tif IGS.C.DisableAntiMultirun then return end\n\n\tif d.Server and d.Server ~= IGS.SERVERS:ID() then\n\t\tpl:Kick(\"Транзакция на другом сервере\")\n\tend\nend)\n","igs/modules/pushes/akupol_sv.lua":"-- 2021.01.18 4:16\n-- Polling client for gm-donate.ru's polling server\n-- Author: amd-nick.me/about\n\n-- 2 copy of this file in some cases in different places with different include methods\nif not lolib then require(\"lolib\") end\n-- require bib\n\nkupol = kupol or {\n\tlog = lolib.new()\n}\n\n\nlocal log = kupol.log\nlog.setFormat(\"{time} polling {message}\")\nlog.setCvar(\"kupol_logging_level\")\n\n\nlocal function get_updates(base_url, uid, sleep, ts, fOnResponse)\n\tlocal url = base_url .. uid .. \"/getUpdates?sleep=\" .. (sleep or \"\") .. \"&ts=\" .. (ts or \"\")\n\tlog.debug(\"http.Fetch({})\", url)\n\thttp.Fetch(url, function(json)\n\t\tlocal t = util.JSONToTable(json)\n\t\tif t and t.ok then\n\t\t\tfOnResponse(t)\n\t\telse\n\t\t\tfOnResponse(false, t and t.description or \"response is not a json\")\n\t\tend\n\tend, function()\n\t\tfOnResponse(false)\n\tend)\nend\n\n\nfunction kupol.new(sUrl, uid, iTimeout)\n\tlocal o = {uid = uid, url = sUrl, timeout = iTimeout, handler = false, running = false, stopping = false}\n\n\to.poll = function(ts, fOnResponse)\n\t\tget_updates(o.url, o.uid, o.timeout, ts, fOnResponse)\n\tend\n\n\tlocal processResponse = function(requested_ts, res)\n\t\tlocal remote_ts = res.ts\n\n\t\tlocal a = remote_ts < requested_ts -- переезд, бэкап, обнуление временем\n\t\tlocal b = #res.updates == 0 and requested_ts > remote_ts -- переход с dev на prod, где ts больше\n\n\t\tif a or b then\n\t\t\tlocal log_pattern = a and \"ts сервера ({}) меньше локального ({})\"\n\t\t\t\tor \"Похоже, что на сервере произошел баг или сервер изменился. ts {} prev {}\"\n\n\t\t\tlog.warning(log_pattern, remote_ts, requested_ts)\n\t\t\tbib.setNum(\"lp:ts:\" .. o.uid, remote_ts)\n\t\t\trequested_ts = remote_ts\n\t\tend\n\n\t\tlocal ts_diff = remote_ts - requested_ts\n\t\tif #res.updates > 0 then\n\t\t\tlog.info(\"From uid {} received {} new messages. Ts diff: {} items\", o.uid, #res.updates, ts_diff)\n\t\tend\n\n\t\tfor _,upd in ipairs(res.updates) do\n\t\t\t-- возможно проскальзывание https://img.qweqwe.ovh/1609615123638.png\n\t\t\t-- bib.setNum(\"lp:ts\", remote_ts)\n\t\t\tlocal i = bib.getNum(\"lp:ts:\" .. o.uid, 0) + 1\n\t\t\tbib.setNum(\"lp:ts:\" .. o.uid, i) -- increment\n\n\t\t\tlocal ok, err = pcall(o.handler, upd)\n\t\t\tif err then\n\t\t\t\tlog.error(\"Внутри хендлера произошла ошибка и работа чуть не прекратилась: {}\", err)\n\t\t\tend\n\t\tend\n\n\t\t-- https://t.me/c/1353676159/43747\n\t\tif ts_diff > #res.updates then\n\t\t\tlog.warning(\"Апдейты долго не запрашивались и {} шт утеряно\", ts_diff - #res.updates)\n\t\t\tbib.setNum(\"lp:ts:\" .. o.uid, remote_ts)\n\t\tend\n\tend\n\n\to.consume_updates = function()\n\t\tlocal previous_ts = bib.getNum(\"lp:ts:\" .. o.uid) or 0\n\n\t\t-- log.info(\"Polling uid: {}. Timeout {} sec. Requested Ts {}\", uid, sleep, previous_ts)\n\t\to.poll(previous_ts, function(res, err)\n\t\t\tif o.checkStopping() then return end\n\n\t\t\tif res then\n\t\t\t\tprocessResponse(previous_ts, res)\n\t\t\t\to.consume_updates()\n\n\t\t\telse\n\t\t\t\tlog.error(\"Error: {}. Waiting 5 sec and retrying\", err)\n\t\t\t\ttimer.Simple(5, o.consume_updates)\n\t\t\tend\n\t\tend)\n\n\t\treturn o\n\tend\n\n\to.start = function(fHandler)\n\t\tlocal stopping = o.stopping\n\n\t\to.running  = true\n\t\to.stopping = false\n\t\to.handler  = fHandler\n\n\t\tif not stopping then\n\t\t\to.consume_updates()\n\t\tend\n\n\t\treturn o\n\tend\n\n\to.stop = function(fOnStopped)\n\t\tfOnStopped = fOnStopped or function() end\n\t\tif not o.running then fOnStopped() return end\n\t\to.stopping = fOnStopped\n\t\treturn o\n\tend\n\n\to.checkStopping = function()\n\t\tlocal onStopped = o.stopping\n\t\tif onStopped then\n\t\t\to.stopping = false\n\t\t\to.running  = false\n\t\t\tonStopped()\n\t\t\treturn true\n\t\tend\n\t\treturn false\n\tend\n\n\treturn o\nend\n","igs/modules/pushes/init_sv.lua":"-- Локальная версия: отключаем gmdonate polling\n","igs/network/net_cl.lua":"-- Запрашивает покупку итема в инвентарь\nfunction IGS.Purchase(sItemUID, callback)\n\tnet.Start(\"IGS.Purchase\")\n\t\tnet.WriteString(sItemUID)\n\tnet.SendToServer()\n\n\tnet.Receive(\"IGS.Purchase\",function()\n\t\tlocal errMsg  = net.ReadIGSError()\n\n\t\tlocal ITEM = IGS.GetItemByUID(sItemUID)\n\t\tif errMsg then\n\t\t\tif callback then callback(errMsg) end\n\t\t\thook.Run(\"IGS.OnFailedPurchase\", ITEM, errMsg)\n\t\telse\n\t\t\tlocal invDbID_ = IGS.C.Inv_Enabled and net.ReadUInt(IGS.BIT_INV_ID)\n\t\t\tif callback then callback(nil, invDbID_) end\n\t\t\thook.Run(\"IGS.PlayerPurchasedItem\", LocalPlayer(), ITEM, invDbID_)\n\t\tend\n\tend)\nend\n\n-- Активирует купленный итем (Только если IGS.C.Inv_Enabled)\nfunction IGS.Activate(iInvID, callback)\n\tnet.Start(\"IGS.Activate\")\n\t\tnet.WriteUInt(iInvID, IGS.BIT_INV_ID)\n\t\tnet.WriteBool(callback)\n\tnet.SendToServer()\n\n\tif !callback then return end\n\tnet.Receive(\"IGS.Activate\", function()\n\t\tlocal ok = net.ReadBool()\n\t\tlocal iPurchID = ok and net.ReadUInt(IGS.BIT_PURCH_ID)\n\t\tlocal sMsg_ = net.ReadIGSMessage()\n\t\t\n\t\t-- Вызываем хук на клиенте для обновления UI\n\t\tif ok and iPurchID then\n\t\t\t-- Получаем ITEM из инвентаря (предполагаем, что он еще доступен где-то)\n\t\t\t-- Хук будет вызван с iPurchID для обновления списка покупок\n\t\t\thook.Run(\"IGS.PlayerActivatedItem\", LocalPlayer(), nil, iPurchID)\n\t\tend\n\t\t\n\t\tcallback(ok, iPurchID, sMsg_)\n\tend)\nend\n\nfunction IGS.UseCoupon(sCoupon, callback)\n\tnet.Start(\"IGS.UseCoupon\")\n\t\tnet.WriteString(sCoupon)\n\tnet.SendToServer()\n\n\tnet.Receive(\"IGS.UseCoupon\", function()\n\t\tcallback(net.ReadIGSError())\n\tend)\nend\n\n--[[-------------------------------------------------------------------------\n\tСсылки\n---------------------------------------------------------------------------]]\nfunction IGS.GetPaymentURL(iSum,fCallback)\n\tnet.Start(\"IGS.GetPaymentURL\")\n\t\tnet.WriteDouble(iSum)\n\tnet.SendToServer()\n\n\tnet.Receive(\"IGS.GetPaymentURL\",function()\n\t\tfCallback(net.ReadString())\n\tend)\nend\n\n\n\nlocal cache,last_update = {},0 -- на сервере тоже кэширование\nfunction IGS.GetLatestPurchases(fCallback)\n\tif last_update + 60 >= os.time() then\n\t\tfCallback(cache)\n\t\treturn\n\tend\n\n\tnet.Ping(\"IGS.GetLatestPurchases\")\n\tnet.Receive(\"IGS.GetLatestPurchases\",function()\n\t\tlocal dat = {}\n\t\tfor i = 1,net.ReadUInt(IGS.BIT_LATEST_PURCH) do\n\t\t\tdat[i] = net.ReadIGSPurchase() -- id и purchase не юзаются\n\t\tend\n\n\t\tcache = dat\n\t\tlast_update = os.time()\n\n\t\tfCallback(dat)\n\tend)\nend\n\n-- тут таймаут не нужно. Даже если заспамить net - ничего не произойдет\nfunction IGS.GetMyTransactions(fCallback)\n\tnet.Ping(\"IGS.GetMyTransactions\")\n\n\tnet.Receive(\"IGS.GetMyTransactions\",function()\n\t\tlocal dat = {}\n\t\tfor i = 1,net.ReadUInt(IGS.BIT_TX) do\n\t\t\tdat[i] = net.ReadIGSTx()\n\t\tend\n\n\t\tfCallback(dat)\n\tend)\nend\n\nfunction IGS.GetMyPurchases(fCallback)\n\tnet.Ping(\"IGS.GetMyPurchases\")\n\n\tnet.Receive(\"IGS.GetMyPurchases\",function()\n\t\tlocal dat = {}\n\t\tfor i = 1,net.ReadUInt(8) do\n\t\t\tdat[i] = net.ReadIGSPurchase()\n\t\tend\n\n\t\tfCallback(dat)\n\tend)\nend\n\n-- Надеть/снять покупку (только для предметов с :Reloadns())\nfunction IGS.ToggleReloadns(sItemUID, callback)\n\tnet.Start(\"IGS.ToggleReloadns\")\n\t\tnet.WriteString(sItemUID)\n\tnet.SendToServer()\n\n\tnet.Receive(\"IGS.ToggleReloadns\", function()\n\t\tlocal ok = net.ReadBool()\n\t\tlocal msg = net.ReadIGSMessage()\n\t\tif msg then\n\t\t\tIGS.ShowNotify(msg, ok and \"IGS\" or \"Ошибка\")\n\t\tend\n\t\tif callback then\n\t\t\tcallback(ok, msg)\n\t\tend\n\tend)\nend\n\n\n\n\n--[[-------------------------------------------------------------------------\n\tИнвентарь\n---------------------------------------------------------------------------]]\nfunction IGS.GetInventory(fCallback)\n\tnet.Ping(\"IGS.GetInventory\")\n\n\tnet.Receive(\"IGS.GetInventory\",function()\n\t\tlocal d = {}\n\n\t\tfor i = 1,net.ReadUInt(7) do\n\t\t\td[i] = net.ReadIGSInventoryItem()\n\t\tend\n\n\t\tfCallback(d)\n\tend)\nend\n\nfunction IGS.DropItem(iID,fCallback) -- энтити в каллбэке\n\tif !IGS.C.Inv_AllowDrop then\n\t\tIGS.ShowNotify(\"Дроп предметов отключен администратором\", \"Ошибка\")\n\t\treturn\n\tend\n\n\tnet.Start(\"IGS.DropItem\")\n\t\tnet.WriteUInt(iID,IGS.BIT_INV_ID)\n\tnet.SendToServer()\n\n\tnet.Receive(\"IGS.DropItem\",function()\n\t\tlocal ent = net.ReadEntity()\n\n\t\tif fCallback then\n\t\t\tfCallback(ent)\n\t\tend\n\tend)\nend\n\n\n\n\nnet.Receive(\"IGS.PaymentStatusUpdated\",function()\n\tlocal t = {}\n\tt.paymentType = net.ReadString()\n\tt.orderSum    = net.ReadString()\n\tt.method      = net.ReadString()\n\n\tif t.method == \"error\" then\n\t\tt.errorMessage = net.ReadString()\n\tend\n\n\thook.Run(\"IGS.PaymentStatusUpdated\",t)\nend)\n\nnet.Receive(\"IGS.UI\",function()\n\tIGS.UI()\nend)\n","igs/network/net_sv.lua":"util.AddNetworkString(\"IGS.PaymentStatusUpdated\")\nutil.AddNetworkString(\"IGS.UI\")\n-- Остальные внутри net_ReceiveProtected\n\n\nlocal SERIA_TIME   = 60 -- ~ каждые 60 сек будет сбрасываться счетчик\nlocal MAX_QUERIES  = 30 -- 30 запросов в минуту, получается\nlocal KICK_QUERIES = 60 -- 60 запросов в минуту с человека и кик\n\nlocal function SeriaTime()\n\treturn os.time() % SERIA_TIME\nend\n\nlocal function checkNotReady(pl) -- не даем совершать никакие операции, если автодонат не загрузился (Например, бэкенд сдох)\n\tlocal current_frame = SeriaTime()\n\n\tlocal d = pl:GetVar(\"igs_burst\", {0,0})\n\tlocal last_frame,queries = d[1],d[2]\n\n\tqueries = (current_frame < last_frame) and 0 or queries + 1\n\tlast_frame = current_frame\n\n\td[1],d[2] = last_frame,queries\n\n\tpl:SetVar(\"igs_burst\",d)\n\n\tif queries > KICK_QUERIES then\n\t\tpl:Kick(\"Networking flood\")\n\t\treturn true\n\tend\n\n\tif queries > MAX_QUERIES then\n\t\treturn true\n\tend\n\n\tif (not IGS.REPEATER:IsEmpty()) then\n\t\tIGS.Notify(pl,\"Автодонат временно не работает\")\n\t\treturn true\n\tend\nend\n\nlocal function net_ReceiveProtected(sName, fCallback)\n\tutil.AddNetworkString(sName)\n\n\tnet.Receive(sName,function(_,pl)\n\t\tif checkNotReady(pl) then return end\n\n\t\t-- local iMsgID = net.ReadUInt(8) -- 255\n\t\tfCallback(pl, iMsgID)\n\tend)\nend\n\n\n\n\n--[[-------------------------------------------------------------------------\n\tПОКУПКА\n---------------------------------------------------------------------------]]\nlocal function IGS_Purchase(pl, uid, cb)\n\tlocal ITEM = IGS.GetItemByUID(uid)\n\n\t-- Используем финальную цену с учетом скидок (индивидуальной или глобальной)\n\tlocal curr_price = ITEM:GetFinalPriceInCurrency()\n\n\tlocal err =\n\t\tITEM:IsHidden() and \"Как вы меня нашли?\"\n\t\tor not IGS.CanAfford(pl,curr_price) and (\"Для покупки нужно \" .. PL_IGS(curr_price))\n\t\tor IGS.IsInventoryOverloaded(pl) and \"У вас перегруз в донат инвентаре. А еще вы один из немногих, кто видел это!\"\n\t\tor pl.igs_unfinished_purchase and \"Запрос на покупку в процессе. Подождите, пожалуйста\" -- в цикле с клиента вызов функции покупки\n\n\t-- инвентарь офнут, значит итем сразу должен иметь возможность активироваться\n\tif not IGS.C.Inv_Enabled then\n\t\tlocal can,e = ITEM:CanActivate(pl)\n\t\tif not can then\n\t\t\terr = e or \"Ошибка 1\"\n\t\tend\n\tend\n\n\tlocal can,e = ITEM:CanBuy(pl)\n\tif not can then\n\t\terr = e or \"Ошибка 2\"\n\tend\n\n\tif err then\n\t\tcb(nil, err)\n\t\treturn\n\tend\n\n\tpl.igs_unfinished_purchase = true\n\tpl:AddIGSFunds(-curr_price, \"P: \" .. uid, function()\n\n\t\t-- ложит в инвентарь или регает сразу как покупку если тот отключен\n\t\tIGS.PlayerPurchasedItem(pl, ITEM, function(invDbID_) -- nil if disabled\n\t\t\tpl.igs_unfinished_purchase = nil\n\n\t\t\tif IGS.C.Inv_Enabled then\n\t\t\t\tIGS.Notify(pl, \"Ваша покупка находится в /donate инвентаре\")\n\t\t\tend\n\n\t\t\tcb(invDbID_)\n\t\tend)\n\n\tend)\nend\n\n-- Добавляет в инвентарь\nnet_ReceiveProtected(\"IGS.Purchase\", function(pl)\n\tlocal sItemUID = net.ReadString()\n\n\tIGS_Purchase(pl, sItemUID, function(invDbID_, errMsg_)\n\t\tnet.Start(\"IGS.Purchase\")\n\t\t\tnet.WriteIGSError(errMsg_)\n\n\t\t\tif IGS.C.Inv_Enabled and not errMsg_ then\n\t\t\t\tnet.WriteUInt(invDbID_, IGS.BIT_INV_ID)\n\t\t\tend\n\t\tnet.Send(pl)\n\n\t\tif errMsg_ then\n\t\t\tlocal ITEM = IGS.GetItemByUID(sItemUID)\n\t\t\thook.Run(\"IGS.OnFailedPurchase\", pl, ITEM, errMsg_)\n\t\t\tIGS.Notify(pl,\"Ошибка покупки \" .. sItemUID .. \": \" .. errMsg_)\n\t\tend\n\tend)\nend)\n\n\n\n\n\n--[[-------------------------------------------------------------------------\n\tАКТИВАЦИЯ\n---------------------------------------------------------------------------]]\nlocal function IGS_Activate(pl, invDbID, cb)\n\tif not IGS.C.Inv_Enabled then\n\t\tcb(nil, \"Инвентарь отключен. Активация предметов моментальная\")\n\t\treturn\n\tend\n\n\tlocal INVITEM = IGS.Inventory(pl,\"map\")[invDbID]\n\tif not INVITEM then -- если чел резко дважды кнопку нажал\n\t\tcb(nil, \"Предмет уже активирован. ID: \" .. tostring(invDbID))\n\t\treturn\n\tend\n\n\tlocal IGSITEM = IGS.GetItemByUID(INVITEM.Item)\n\n\tlocal can,err = IGSITEM:CanActivate(pl, invDbID)\n\tif not can then\n\t\tcb(nil, err or \"Ошибка\")\n\t\treturn\n\tend\n\n\t-- Выше еще проверка. Это лишняя, но не помешает\n\tlocal tRemoved = IGS.DeletePlayerInventoryItemLocally(pl, invDbID)\n\tif (not tRemoved) then\n\t\tcb(nil, \"Предмет уже активирован #2\")\n\t\treturn\n\tend\n\n\tIGS.DeleteInventoryItem(function(ok)\n\t\tif not ok then -- например, через панель \\/\n\t\t\tcb(nil, \"Предмет не найден. Возможно, уже активирован\")\n\t\t\treturn\n\t\tend\n\n\t\thook.Run(\"IGS.PlayerActivatedInventoryItem\", pl, IGSITEM, invDbID) -- где-то нужно передать invDbID для log\n\t\tIGS.PlayerActivateItem(pl, IGSITEM:UID(), cb)\n\tend, invDbID)\nend\n\n-- Активирует услугу, забирая ее из инвентаря\nnet_ReceiveProtected(\"IGS.Activate\", function(pl)\n\tIGS_Activate(pl, net.ReadUInt(IGS.BIT_INV_ID), net.ReadBool() and function(iPurchID, sMsg_)\n\t\tnet.Start(\"IGS.Activate\")\n\t\t\tnet.WriteBool(iPurchID) -- OK\n\t\t\tif iPurchID then\n\t\t\t\tnet.WriteUInt(iPurchID, IGS.BIT_PURCH_ID)\n\t\t\tend\n\t\t\tnet.WriteIGSMessage(sMsg_) -- err || custom msg || nothing (сейчас error only)\n\t\tnet.Send(pl)\n\tend or function() end)\nend)\n\n\n\n--[[-------------------------------------------------------------------------\n\tКУПОНЫ\n---------------------------------------------------------------------------]]\nlocal function IGS_EnterCoupon(pl,sCode,cb)\n\tif string.Trim(sCode) == \"\" then\n\t\tcb(false, \"Введите код купона\")\n\t\treturn\n\tend\n\n\t-- хук юзается в beauty code. Внутри берется реальный купон из БД\n\t-- а также можно юзать для всякого разного, например купоны на скидку\n\tlocal override,err_ = hook.Run(\"IGS.PlayerEnterCoupon\", pl, sCode)\n\tif override ~= nil then cb(override, err_) return end\n\n\tIGS.PlayerActivateCoupon(pl, sCode, cb)\nend\n\nnet_ReceiveProtected(\"IGS.UseCoupon\", function(pl)\n\tIGS_EnterCoupon(pl, net.ReadString(), function(ok, errMsg_)\n\t\tnet.Start(\"IGS.UseCoupon\")\n\t\t\tif not ok then\n\t\t\t\tnet.WriteIGSError(errMsg_ or \"unknown COUPON error\")\n\t\t\tend\n\t\tnet.Send(pl)\n\tend)\nend)\n\n\n\n\n--[[-------------------------------------------------------------------------\n\tССЫЛКИ\n---------------------------------------------------------------------------]]\nlocal hostname = assert(GetConVar(\"hostname\"), \"Error fetching server name\")\n\nnet_ReceiveProtected(\"IGS.GetPaymentURL\", function(pl)\n\tlocal sum  = net.ReadDouble()\n\tlocal desc = \"Пожертвование \" .. IGS.SignPrice( IGS.PriceInCurrency(sum) ) ..  \" на \" .. hostname:GetString()\n\n\tIGS.GetPaymentURL(function(url)\n\t\tnet.Start(\"IGS.GetPaymentURL\")\n\t\t\tnet.WriteString(url)\n\t\tnet.Send(pl)\n\tend, pl:SteamID64(), sum, desc)\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tПОСЛЕДНИЕ ПОКУПКИ\n---------------------------------------------------------------------------]]\nlocal cache,last_update = {},0\nhook.Add(\"IGS.PlayerPurchasedItem\", \"ResetLatestPurchasesCache\", function()\n\t-- https://trello.com/c/hEgPItm0/\n\ttable.Empty(cache)\n\tlast_update = 0\nend)\n\nlocal function IGS_GetLatestPurchases(pl, cb)\n\t-- если кэш старее, чем N минут, то обновляем и отправляем игроку\n\t-- Иначе отправляем кэшированные данные без повторнгого обращения к БД\n\tif last_update + 5 * 60 >= os.time() then\n\t\tcb(cache)\n\t\treturn\n\tend\n\n\t-- 10 можно поднимать вплоть до 63. Дальше будут ошибки\n\tIGS.GetLatestPurchases(function(dat)\n\t\tcache = dat\n\t\tlast_update = os.time() -- CurTime не юзать, чтобы не получать пустую таблицу\n\n\t\tcb(dat)\n\tend,10)\nend\n\nnet_ReceiveProtected(\"IGS.GetLatestPurchases\", function(pl)\n\tIGS_GetLatestPurchases(pl,function(dat)\n\t\tnet.Start(\"IGS.GetLatestPurchases\")\n\t\t\tnet.WriteUInt(#dat,IGS.BIT_LATEST_PURCH)\n\n\t\t\tfor _,v in ipairs(dat) do\n\t\t\t\tnet.WriteIGSPurchase(v)\n\t\t\tend\n\t\tnet.Send(pl)\n\tend)\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tСПИСОК СВОИХ ТРАНЗАКЦИЙ\n---------------------------------------------------------------------------]]\nlocal function IGS_GetMyTransactions(pl, cb)\n\tIGS.GetPlayerTransactions(cb, pl:SteamID64())\nend\n\nnet_ReceiveProtected(\"IGS.GetMyTransactions\", function(pl)\n\tIGS_GetMyTransactions(pl, function(dat)\n\t\tnet.Start(\"IGS.GetMyTransactions\")\n\t\t\tnet.WriteUInt(#dat, IGS.BIT_TX)\n\n\t\t\tfor _,v in ipairs(dat) do\n\t\t\t\tnet.WriteIGSTx(v)\n\t\t\tend\n\t\tnet.Send(pl)\n\tend)\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tСПИСОК СВОИХ ПОКУПОК\n---------------------------------------------------------------------------]]\nlocal function IGS_GetMyPurchases(pl,cb)\n\tIGS.GetPlayerPurchases(pl:SteamID64(),cb)\nend\n\nnet_ReceiveProtected(\"IGS.GetMyPurchases\", function(pl)\n\tIGS_GetMyPurchases(pl,function(dat)\n\t\tnet.Start(\"IGS.GetMyPurchases\")\n\t\t\tnet.WriteUInt(#dat,8) -- to 255\n\n\t\t\tfor _,v in ipairs(dat) do\n\t\t\t\tnet.WriteIGSPurchase(v)\n\t\t\tend\n\t\tnet.Send(pl)\n\tend)\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tReloadns (надеваемые покупки)\n---------------------------------------------------------------------------]]\nnet_ReceiveProtected(\"IGS.ToggleReloadns\", function(pl)\n\tlocal uid = net.ReadString()\n\tlocal ITEM = IGS.GetItemByUID(uid)\n\n\tlocal ok, msg\n\tif ITEM.isnull or not ITEM:HasReloadns() then\n\t\tok, msg = false, \"Этот предмет нельзя надевать/снимать\"\n\telseif not pl:HasPurchase(uid) then\n\t\tok, msg = false, \"У вас нет активной покупки этого предмета\"\n\telse\n\t\tlocal cat = ITEM:ReloadnsCategory()\n\t\tlocal equipped = table.Copy(IGS.GetReloadnsEquipped(pl) or {})\n\t\tlocal prev_uid = equipped[cat]\n\n\t\tif prev_uid == uid then\n\t\t\tequipped[cat] = nil\n\t\t\tok, msg = true, \"Снято\"\n\t\t\thook.Run(\"IGS.ReloadnsUnequipped\", pl, ITEM, cat)\n\t\telse\n\t\t\tif prev_uid then\n\t\t\t\tlocal PREV = IGS.GetItemByUID(prev_uid)\n\t\t\t\tif not PREV.isnull then\n\t\t\t\t\thook.Run(\"IGS.ReloadnsUnequipped\", pl, PREV, cat)\n\t\t\t\tend\n\t\t\tend\n\n\t\t\tequipped[cat] = uid\n\t\t\tok, msg = true, \"Надето\"\n\t\t\thook.Run(\"IGS.ReloadnsEquipped\", pl, ITEM, cat)\n\t\tend\n\n\t\tIGS.SetReloadnsEquipped(pl, equipped)\n\tend\n\n\tnet.Start(\"IGS.ToggleReloadns\")\n\t\tnet.WriteBool(ok)\n\t\tnet.WriteIGSMessage(msg)\n\tnet.Send(pl)\nend)\n\n\n--[[-------------------------------------------------------------------------\n\tИНВЕНТАРЬ\n---------------------------------------------------------------------------]]\nlocal function IGS_GetInventory(pl,cb)\n\tcb( IGS.C.Inv_Enabled and IGS.Inventory(pl) or {} )\nend\n\nnet_ReceiveProtected(\"IGS.GetInventory\", function(pl)\n\tIGS_GetInventory(pl,function(inv)\n\t\t-- Фильтруем null предметы перед отправкой клиенту\n\t\tlocal validInv = {}\n\t\tfor _,v in ipairs(inv) do\n\t\t\tlocal ITEM = IGS.GetItemByUID(v.Item)\n\t\t\tif not ITEM.isnull then\n\t\t\t\ttable.insert(validInv, v)\n\t\t\telse\n\t\t\t\t-- Удаляем null предмет из БД\n\t\t\t\tprint(\"[IGS] Очистка null предмета из инвентаря: \" .. v.Item .. \" (ID: \" .. v.ID .. \")\")\n\t\t\t\tIGS.DeleteInventoryItem(nil, v.ID)\n\t\t\tend\n\t\tend\n\t\t\n\t\tnet.Start(\"IGS.GetInventory\")\n\t\t\tnet.WriteUInt(#validInv,7) -- 127\n\t\t\tfor _,v in ipairs(validInv) do\n\t\t\t\tnet.WriteIGSInventoryItem(v)\n\t\t\tend\n\t\tnet.Send(pl)\n\tend)\nend)\n\n\nlocal function IGS_DropItem(pl,invId,cb)\n\tif not (IGS.C.Inv_Enabled and IGS.C.Inv_AllowDrop) then return end\n\tlocal canDrop = hook.Run(\"IGS.PlayerCanDropGift\", pl, invId)\n\tif canDrop == false then\n\t\treturn\n\tend\n\n\tIGS.PlayerEjectItem(function(ent)\n\t\tif (not ent) then return end -- ошибка\n\n\t\ttimer.Simple(0,function() -- инициализация энтити\n\t\t\tcb(ent)\n\t\t\thook.Run(\"IGS.PlayerDroppedGift\", pl, ent:GetUID(), invId, ent)\n\t\tend)\n\tend, pl, invId)\nend\n\nnet_ReceiveProtected(\"IGS.DropItem\",function(pl)\n\tIGS_DropItem(pl,net.ReadUInt(IGS.BIT_INV_ID),function(ent)\n\t\tnet.Start(\"IGS.DropItem\")\n\t\t\tnet.WriteEntity(ent)\n\t\tnet.Send(pl)\n\tend)\nend)\n\n\n\n\n\n\nhook.Add(\"IGS.PaymentStatusUpdated\",\"network\",function(pl,d)\n\tif checkNotReady(pl) then return end\n\n\tnet.Start(\"IGS.PaymentStatusUpdated\")\n\t\tnet.WriteString(d.paymentType) -- qiwi, card, sms\n\t\tnet.WriteString(d.orderSum) -- 228.28\n\t\tnet.WriteString(d.method) -- check, pay, error\n\n\t\tif d.errorMessage then\n\t\t\tnet.WriteString(d.errorMessage)\n\t\tend\n\tnet.Send(pl)\nend)\n\n-- Открытие менюшки на чубзике\nfunction IGS.UI(pl)\n\tif checkNotReady(pl) then return end\n\n\tnet.Ping(\"IGS.UI\",pl)\nend\n","igs/network/nw_sh.lua":"IGS.nw.Register(\"igs_lvl\")\n\t:Write(net.WriteUInt,7) -- 127\n\t:Read(function()\n\t\treturn IGS.LVL.Get(net.ReadUInt(7))\n\tend)\n:SetLocalPlayer()\n\n\nIGS.nw.Register(\"igs_balance\") -- Должно быть ТОЛЬКО у клиентов!\n\t:Write(net.WriteDouble)\n\t:Read(net.ReadDouble)\n:SetLocalPlayer() --:SetHook(\"OnIGSBalanceChanged\")\n\n\nIGS.nw.Register(\"igs_total_transactions\")\n\t:Write(net.WriteUInt,17) -- 131071\n\t:Read(net.ReadUInt,17)\n:SetLocalPlayer()\n\n\nIGS.nw.Register(\"igs_purchases\"):Write(function(v)\n\tnet.WriteUInt(#v, 9) -- 511\n\n\tfor _,id in ipairs(v) do\n\t\tnet.WriteUInt(id,9)\n\tend\nend):Read(function()\n\n\tlocal res = {}\n\tfor _ = 1,net.ReadUInt(9) do\n\t\tlocal uid = IGS.GetItemByID( net.ReadUInt(9) ):UID()\n\t\tres[uid] = res[uid] and (res[uid] + 1) or 1\n\tend\n\n\treturn res\nend):SetLocalPlayer():SetHook(\"IGS.PlayerPurchasesLoaded\")\n\n\n-- Надетые предметы Reloadns (cat -> uid)\nIGS.nw.Register(\"igs_reloadns_equipped\")\n\t:Write(function(t)\n\t\tlocal n = 0\n\t\tfor _ in pairs(t or {}) do n = n + 1 end\n\n\t\tnet.WriteUInt(n, 8) -- 255\n\t\tfor cat, uid in pairs(t or {}) do\n\t\t\tnet.WriteUInt(tonumber(cat) or 1, 8)\n\t\t\tnet.WriteString(tostring(uid or \"\"))\n\t\tend\n\tend)\n\t:Read(function()\n\t\tlocal res = {}\n\t\tfor _ = 1, net.ReadUInt(8) do\n\t\t\tlocal cat = net.ReadUInt(8)\n\t\t\tlocal uid = net.ReadString()\n\t\t\tif uid ~= \"\" then\n\t\t\t\tres[cat] = uid\n\t\t\tend\n\t\tend\n\t\treturn res\n\tend)\n\t:SetLocalPlayer()\n\t:SetHook(\"IGS.ReloadnsEquippedUpdated\")\n\n\n-- https://img.qweqwe.ovh/1492003125937.png\nIGS.nw.Register(\"igs_settings\")\n\t:Write(function(t)\n\t\tnet.WriteUInt(t[1],10) -- minimal charge (max 1023)\n\t\tnet.WriteDouble(t[2])  -- currecy price\n\tend)\n\t:Read(function()\n\t\treturn {\n\t\t\tnet.ReadUInt(10), -- charge\n\t\t\tnet.ReadDouble(), -- price\n\t\t}\n\tend)\n:SetGlobal():SetHook(\"IGS.OnSettingsUpdated\")\n\n\n\n--[[--------------\n\tCONSTANTS\n----------------]]\nIGS.BIT_TX = 8 -- max транз в нетворке (255)\nIGS.BIT_LATEST_PURCH = 6 -- 63\n\n-- Размер ячейки\nIGS.BIT_PURCH_ID = 32 -- 4294967295\nIGS.BIT_INV_ID = 32\nIGS.BIT_TX_ID = 32\n\n\n--[[--------------\n\t.net Helpers\n----------------]]\nfunction net.WriteIGSItem(ITEM) net.WriteUInt(ITEM:ID(),9) end\nfunction net.ReadIGSItem() return IGS.GetItemByID(net.ReadUInt(9)) end\n-- function net.WriteIGSGroup(GROUP) net.WriteString(GROUP:Name()) end\n-- function net.ReadIGSGroup() return IGS.GetGroup(net.ReadString()) end\n\nlocal function writeIf(value, fWrite, arg_)\n\t-- Server = 0 записывал false, хоть это значение\n\t-- Для отлова бага была такая штука:\n\t-- https://img.qweqwe.ovh/1567089471715.png\n\tnet.WriteBool(value ~= nil)\n\tif value then\n\t\tfWrite(value, arg_)\n\tend\nend\n\nlocal function readIf(fRead, arg_)\n\treturn net.ReadBool() and fRead(arg_)\nend\n\nfunction net.WriteIGSPurchase(p)\n\tnet.WriteUInt(p.ID,IGS.BIT_PURCH_ID)\n\tnet.WriteString(p.Item)\n\n\twriteIf(p.Server,  net.WriteUInt, 6) -- 63\n\twriteIf(p.Purchase,net.WriteUInt, 32)\n\twriteIf(p.Expire,  net.WriteUInt, 32)\n\twriteIf(p.Nick,    net.WriteString)\nend\n\nfunction net.ReadIGSPurchase()\n\treturn {\n\t\tid       = net.ReadUInt(IGS.BIT_PURCH_ID),\n\t\titem     = net.ReadString(),\n\n\t\tserver   = readIf(net.ReadUInt, 6),\n\t\tpurchase = readIf(net.ReadUInt, 32),\n\t\texpire   = readIf(net.ReadUInt, 32),\n\t\tnick     = readIf(net.ReadString),\n\t}\nend\n\nfunction net.WriteIGSTx(tx)\n\tnet.WriteUInt(tx.ID, IGS.BIT_TX_ID)\n\twriteIf(tx.Server, net.WriteUInt, 6) -- 63\n\tnet.WriteDouble(tx.Sum)\n\tnet.WriteUInt(tx.Time, 32) -- dohuya\n\twriteIf(tx.Note, net.WriteString)\nend\n\nfunction net.ReadIGSTx()\n\treturn {\n\t\tid     = net.ReadUInt(IGS.BIT_TX_ID),\n\t\tserver = readIf(net.ReadUInt, 6),\n\t\tsum    = net.ReadDouble(),\n\t\tdate   = net.ReadUInt(32), -- timestamp\n\t\tnote   = readIf(net.ReadString),\n\t}\nend\n\nfunction net.WriteIGSInventoryItem(inv_it)\n\tnet.WriteUInt(inv_it.ID, IGS.BIT_INV_ID)\n\tnet.WriteString(inv_it.Item)\nend\n\nfunction net.ReadIGSInventoryItem()\n\treturn {\n\t\tid = net.ReadUInt(IGS.BIT_INV_ID),\n\t\titem = IGS.GetItemByUID(net.ReadString()),\n\t}\nend\n\nfunction net.WriteIGSMessage(sErr)\n\twriteIf(sErr, net.WriteString)\nend\n\nfunction net.ReadIGSMessage()\n\treturn net.ReadBool() and net.ReadString()\nend\n\nnet.WriteIGSError = net.WriteIGSMessage\nnet.ReadIGSError  = net.ReadIGSMessage\n\n\n\nif SERVER then\n\tlocal first_time_trigger = true -- не позволяет выполниться IGS.GetMinCharge() и IGS.GetCurrencyPrice(), поскольку будет ошибка из-за nil внутри net вара\n\tfunction IGS.UpdateMoneySettings(iMinCharge,iCurrencyPrice)\n\t\tiMinCharge     = tonumber(iMinCharge)\n\t\tiCurrencyPrice = tonumber(iCurrencyPrice)\n\n\t\t-- Кеш старых данных\n\t\tlocal min_charge = first_time_trigger and 0 or IGS.GetMinCharge()\n\t\tlocal cur_price  = first_time_trigger and 0 or IGS.GetCurrencyPrice()\n\t\tfirst_time_trigger = nil\n\n\t\tlocal min_charge_changed = min_charge ~= iMinCharge\n\t\tlocal cur_price_changed  = cur_price  ~= iCurrencyPrice\n\n\t\tif min_charge_changed or cur_price_changed then\n\t\t\tIGS.nw.SetGlobal(\"igs_settings\",{\n\t\t\t\tiMinCharge,\n\t\t\t\tiCurrencyPrice\n\t\t\t})\n\n\t\t\thook.Run(\"IGS.OnSettingsUpdated\")\n\n\t\t\t-- Может измениться сразу две вещи\n\t\t\tif min_charge_changed then\n\t\t\t\tIGS.NotifyAll(\"Изменена минимальная сумма пополнения: \" .. (\"(%s > %s руб)\"):format(min_charge,iMinCharge))\n\t\t\tend\n\n\t\t\tif cur_price_changed then\n\t\t\t\tIGS.NotifyAll(\"Стоимость донат валюты изменена с \" .. cur_price .. \" до \" .. iCurrencyPrice .. \" руб за единицу\")\n\t\t\tend\n\t\tend\n\tend\nend\n","igs/objects/level.lua":"IGS.LVL = IGS.LVL or setmetatable({\n\tMAP    = {},\n\tSTORED = {}\n},{\n\t__call = function(self,...)\n\t\treturn self.Add(...)\n\tend\n})\n\n\n\nlocal LVL = {}\nLVL.__index = LVL\n\nfunction LVL:SetBonus(fOnReach)\n\tself.bonus = fOnReach -- ply in args\n\treturn self\nend\n\nfunction LVL:SetName(sName) -- OUTDATED (удалено 2018.03.12)\n\tself.name = sName\n\treturn self\nend\n\nfunction LVL:SetDescription(sDesc)\n\tself.description = sDesc\n\treturn self\nend\n\nfunction LVL:Name()\n\treturn self.name\nend\n\nfunction LVL:Description()\n\treturn self.description\nend\n\nfunction LVL:LVL()\n\treturn self.lvl\nend\n\nfunction LVL:Cost()\n\treturn self.cost\nend\n\nfunction LVL:GetNext() -- may be nil\n\tlocal ilvl,OBJ = next(IGS.LVL.MAP,self.lvl)\n\treturn OBJ,ilvl\nend\n\n-- Разница между уровнями\n-- function LVL:NeedToRaise() -- nil on last lvl\n-- \tlocal n = self:GetNext()\n-- \treturn n and n.cost - self.cost\n-- end\n\nfunction IGS.LVL.Add(iNeedSum, sName)\n\tlocal OBJ = setmetatable({\n\t\tcost = iNeedSum,\n\t\tname = sName\n\t},LVL)\n\n\tIGS.LVL.STORED[iNeedSum] = OBJ\n\tIGS.LVL.Rearrange()\n\n\treturn OBJ\nend\n\nfunction IGS.LVL.Get(iLVL)\n\treturn IGS.LVL.MAP[iLVL]\nend\n\n-- Дает объект лвл, соответствующий указанной сумме\nfunction IGS.LVL.GetByCost(iRealCost)\n\tfor lvl = 1,#IGS.LVL.MAP do\n\t\tif !IGS.LVL.MAP[lvl + 1] or IGS.LVL.MAP[lvl + 1].cost > iRealCost then\n\t\t\treturn IGS.LVL.MAP[lvl]\n\t\tend\n\tend\nend\n\n-- Уровни в диапазоне стоимости.\n-- Начало юзаться при выдаче бонусов за пополнение: https://trello.com/c/EjmPOeso/476--\n-- function IGS.LVL.GetRange(iFromCost, iToCost)\n-- \tlocal t = {}\n\n-- \tfor iLVL,lvl in ipairs(IGS.LVL.MAP) do\n-- \t\tif lvl.cost >= iFromCost and lvl.cost <= iToCost then\n-- \t\t\ttable.insert(t,lvl)\n-- \t\tend\n-- \tend\n\n-- \treturn t\n-- end\n\n-- Перестраивает кэш порядка левелов\n-- Нужно на случай, если сначала добавили 30 лвл, а потом 10\n-- то чтобы не считалось, что 30 ниже 10\nfunction IGS.LVL.Rearrange()\n\tIGS.LVL.MAP = {} -- reset\n\n\tlocal i = 0\n\tfor sum in SortedPairs(IGS.LVL.STORED) do\n\t\t-- долго объяснять. Короче сортедпэирс по ходу копирует объект перед тем,\n\t\t-- как вернуть его в цикл и нельзя сделать for sum,OBJ\n\t\tlocal OBJ = IGS.LVL.STORED[sum]\n\t\ti = i + 1\n\t\tOBJ.lvl = i\n\n\t\tIGS.LVL.MAP[i] = OBJ\n\tend\nend","igs/objects/shop_group.lua":"--[[-------------------------------------------------------------------------\nВ магазине есть категории, а есть группы товаров.\n\nКатегория - это группа подобных товаров.\nНапример, випы и премиумы\n\nГруппа это может быть разновидность одного товара.\nНапример группа вип прав содержит в себе вип на неделю, месяц, навсегда и т.д.\n\nЭтот файл представляет собой регистратор ГРУПП\n---------------------------------------------------------------------------]]\n\nlocal ITEM_GROUP = {}\nITEM_GROUP.__index = ITEM_GROUP\nITEM_GROUP.__tostring = function(self)\n\t-- \"ITEM GROUP (Name Of Group) [i]\"\n\treturn \"IGS GROUP (\" .. self:Name() .. \")[\" .. #self:Items() .. \"]\"\nend\ndebug.getregistry().IGSGroup = ITEM_GROUP\n\n\n\n-- Fade, Tiger, Damascus\nfunction ITEM_GROUP:AddItem(STORE_ITEM,sNameOverride)\n\tif self.items.STORED[STORE_ITEM:UID()] then\n\t\treturn self.items.STORED[STORE_ITEM:UID()]\n\tend\n\n\tlocal dat = {\n\t\titem = STORE_ITEM,\n\t\tname = sNameOverride or STORE_ITEM:Name()\n\t}\n\n\tlocal ID = #self.items.MAP + 1\n\tself.items.MAP[ID] = dat\n\tself.items.STORED[STORE_ITEM:UID()] = dat\n\n\tSTORE_ITEM.group = self\n\n\treturn self.items.MAP[ID]\nend\n\nfunction ITEM_GROUP:SetIcon(sIconUrl)\n\tself.icon_url = sIconUrl\n\treturn self\nend\n\nfunction ITEM_GROUP:SetHighlightColor(color)\n\tif CLIENT then\n\t\tself.highlight = color\n\tend\n\treturn self\nend\n\n\n\n\nfunction ITEM_GROUP:Name()\n\treturn self.name\nend\n\nfunction ITEM_GROUP:UID() -- TODO\n\treturn self:Name()\nend\n\nfunction ITEM_GROUP:Items()\n\treturn self.items.MAP\nend\n\nfunction ITEM_GROUP:ICON()\n\treturn self.icon_url\nend\n\n\n\n\nIGS.GROUPS = IGS.GROUPS or {}\n\n-- Flip Knifes\nfunction IGS.NewGroup(sName)\n\tif IGS.GROUPS[sName] then\n\t\treturn IGS.GROUPS[sName]\n\tend\n\n\tlocal group = setmetatable({\n\t\tname = sName,\n\t\titems = {\n\t\t\tMAP    = {}, -- iter, STORED\n\t\t\tSTORED = {}  -- STORE_ITEM:UID(),\n\t\t},\n\t},ITEM_GROUP)\n\n\tIGS.GROUPS[sName] = group\n\n\treturn group\nend\n\nfunction IGS.GetGroups()\n\treturn IGS.GROUPS\nend\n\nfunction IGS.GetGroup(name)\n\treturn IGS.GROUPS[name]\nend","igs/objects/shop_item.lua":"setmetatable(IGS,{\n\t__call = function(self,...)\n\t\treturn self.AddItem(...)\n\tend\n})\n\n\n--[[-------------------------------------------------------------------------\n\tМАКСИМАЛЬНОЕ КОЛ-ВО УЛУЧШЕНИЙ 255\n---------------------------------------------------------------------------]]\n\nlocal STORE_ITEM = FindMetaTable(\"IGSItem\") or {}\nSTORE_ITEM.__index = STORE_ITEM\ndebug.getregistry().IGSItem = STORE_ITEM\n\nlocal function set(self,var,val)\n\tself[var] = val\n\treturn self\nend\n\n\n--[[-------------------------------------------------------------------------\n\tGET values (для тех значений, что нельзя Set)\n---------------------------------------------------------------------------]]\nfunction STORE_ITEM:Name()\n\treturn self.name\nend\n\nfunction STORE_ITEM:UID()\n\treturn self.uid\nend\n\nfunction STORE_ITEM:ID()\n\treturn self.id\nend\n\n-- VIP, Huntsman Knifes. Присваивается через GROUP:AddItem\nfunction STORE_ITEM:Group()\n\treturn self.group\nend\n\n--[[-------------------------------------------------------------------------\n\tSET/GET values\n---------------------------------------------------------------------------]]\n-- Double цена товара в реальной валюте (не автодоната)\nfunction STORE_ITEM:SetPrice(iPrice)\n\treturn set(self,\"price\",iPrice)\nend\n\nfunction STORE_ITEM:Price()\n\treturn self.price\nend\n\n-- Получить финальную цену с учетом скидок (индивидуальной или глобальной)\nfunction STORE_ITEM:GetFinalPrice()\n\t-- Если есть индивидуальная скидка, используем её\n\tif self.discounted_from then\n\t\treturn self.price\n\tend\n\t\n\t-- Иначе применяем глобальную скидку (если есть)\n\tif IGS.HasGlobalDiscount then\n\t\treturn IGS.GetDiscountedPrice(self.price)\n\tend\n\t\n\treturn self.price\nend\n\n-- Сбрасывает текущее описание и устанавливает указанное, если не указать bAppand\nfunction STORE_ITEM:SetDescription(sDesc,bAppend)\n\treturn set(self,\"description\",bAppend and (self:Description() .. sDesc) or sDesc)\nend\n\nfunction STORE_ITEM:Description()\n\treturn self.description\nend\n\n-- Ссылка на картинку иконки товара 1:1. Желательно минимум 100 px\n-- Или же путь к модельке, но тогда вторым аргументом указать true\nfunction STORE_ITEM:SetIcon(sIcon, bIsModel)\n\treturn CLIENT and set(self,\"icon\",{\n\t\ticon    = sIcon,\n\t\tisModel = bIsModel,\n\t}) or self\nend\n\nfunction STORE_ITEM:ICON()\n\tif self.icon then\n\t\treturn self.icon[\"icon\"], self.icon[\"isModel\"]\n\tend\nend\n\n-- Цвет подсветки заголовка итема в списке\nfunction STORE_ITEM:SetHighlightColor(color)\n\treturn CLIENT and set(self,\"highlight\",color) or self\nend\n\nfunction STORE_ITEM:GetHighlightColor()\n\treturn self.highlight\nend\n\n-- Пермапушки, права, группы, уровни\nfunction STORE_ITEM:SetCategory(sCat, sIcon)\n\tset(self,\"category\",sCat)\n\t\n\t-- Сохраняем иконку категории в глобальную таблицу\n\tif sIcon and CLIENT then\n\t\tIGS.CategoryIcons = IGS.CategoryIcons or {}\n\t\tIGS.CategoryIcons[sCat] = sIcon\n\tend\n\t\n\treturn self\nend\n\nfunction STORE_ITEM:Category()\n\treturn self.category\nend\n\n-- Срок в днях, на который выдается услуга. 0 если одноразовая. nil, если вечная\nfunction STORE_ITEM:SetTerm(iDays)\n\treturn set(self,\"termin\",iDays)\nend\n\nfunction STORE_ITEM:SetPerma()\n\treturn self:SetTerm(nil)\nend\n\nfunction STORE_ITEM:Term()\n\treturn self.termin\nend\n\n-- Дает возможность мультипокупки. Полезно для лимита пропов, патронов при спавне и т.д.\nfunction STORE_ITEM:SetStackable(b)\n\treturn set(self,\"stackable\",b ~= false) -- nil = true; 1 = true; true = true; false = false\nend\n\nfunction STORE_ITEM:IsStackable()\n\treturn self.stackable\nend\n\n-- Нужна ли информация о покупке на клиентсайде? (Будет в IGS.PlayerPurchases(ply))\nfunction STORE_ITEM:SetNetworked(b)\n\treturn set(self,\"networked\",b ~= false)\nend\n\nfunction STORE_ITEM:IsNetworked()\n\treturn self.networked\nend\n\n--[[-------------------------------------------------------------------------\n\tReloadns (надеваемые/снимаемые покупки)\n\n\t:Reloadns(category)\n\tcategory = номер \"слота/категории\" (1..255). В одной категории может быть\n\tнадет только один предмет; надевание другого снимет предыдущий.\n---------------------------------------------------------------------------]]\nfunction STORE_ITEM:Reloadns(iCategory)\n\tiCategory = tonumber(iCategory) or 1\n\tiCategory = math.floor(iCategory)\n\tif iCategory < 1 then iCategory = 1 end\n\tif iCategory > 255 then iCategory = 255 end\n\n\treturn set(self, \"reloadns\", iCategory)\nend\n\nfunction STORE_ITEM:ReloadnsCategory()\n\treturn self.reloadns\nend\n\nfunction STORE_ITEM:HasReloadns()\n\treturn self.reloadns ~= nil\nend\n\n-- Баннер товара. Будет отображен под информацией о товаре. Рекомендуемый размер 1000х400\nfunction STORE_ITEM:SetImage(sUrl)\n\treturn set(self,\"image_url\",sUrl)\nend\n\nfunction STORE_ITEM:IMG()\n\treturn self.image_url\nend\n\n-- Нельзя купить, но можно активировать с инвентаря.\n-- Полезно, чтобы \"удалять\" ненужные, но еще активные у людей итемы\nfunction STORE_ITEM:SetHidden(b)\n\treturn set(self,\"hidden\",b ~= false)\nend\n\nfunction STORE_ITEM:IsHidden()\n\treturn self.hidden\nend\n\n-- Для удобной установки метаданных итему вместо ITEM.key = val (полезно внутри функций, типа GROUP:Add(ITEM))\nfunction STORE_ITEM:SetMeta(key, value)\n\tif (not self.meta) then self.meta = {} end\n\tself.meta[key] = value\n\treturn self\nend\n\nfunction STORE_ITEM:GetMeta(key)\n\treturn self.meta and self.meta[key]\nend\n\nfunction STORE_ITEM:SetDiscountedFrom(i) -- internal\n\treturn set(self,\"discounted_from\", i)\nend\n\n-- function STORE_ITEM:DiscountedFrom()\n-- \treturn self.discounted_from\n-- end\n\n\n\n--[[-------------------------------------------------------------------------\n\tФункции\n---------------------------------------------------------------------------]]\n-- функции передается игрок\n-- Должна вернуть ОШИБКУ (строку) или nil/false, если все ок\nfunction STORE_ITEM:SetCanBuy(fCallback)\n\treturn SERVER and set(self,\"canbuy\",fCallback) or self\nend\n\n-- После удачной покупки передает в каллбэк игрока\nfunction STORE_ITEM:SetOnBuy(fCallback)\n\treturn SERVER and set(self,\"onbuy\",fCallback) or self\nend\n\n-- \"Установщик\" услуги. Внутренняя функция, чтобы не оверрайдить :SetOnActivate\n-- Осторожнее в комбинации с :SetValidator\nfunction STORE_ITEM:SetInstaller(fCallback)\n\treturn SERVER and set(self,\"installer\",fCallback) or self\nend\n\n-- Как и SetCanBuy, но для активации с инвентаря\nfunction STORE_ITEM:SetCanActivate(fCallback)\n\treturn SERVER and set(self,\"canactivate\",fCallback) or self\nend\n\n-- Для выдачи бонусов etc. Игрок в каллбэке\n-- Выполнять только при реальной активации игроком или выдаче через панель,\n-- а не автовосстановлении etc\nfunction STORE_ITEM:SetOnActivate(fCallback)\n\treturn SERVER and set(self,\"onactivate\",fCallback) or self\nend\n\n-- Если fChecker вернет false, то выполнится installer\nfunction STORE_ITEM:SetValidator(fChecker)\n\treturn SERVER and set(self,\"validator\",fChecker) or self\nend\n\nif SERVER then\n\tfunction STORE_ITEM:Setup(pl) -- внутренняя\n\t\tif self.installer then\n\t\t\tself.installer(pl)\n\t\tend\n\tend\n\n\tfunction STORE_ITEM:OnActivate(pl) -- публичная\n\t\tself:Setup(pl)\n\n\t\tif self.onactivate then\n\t\t\tself.onactivate(pl)\n\t\tend\n\tend\n\n\t-- Активация\n\t-- Возвращает boolErr и errMsg\n\tfunction STORE_ITEM:CanActivate(pl, iInvId)\n\t\tif (not self:IsStackable() and pl:HasPurchase( self:UID() )) then\n\t\t\treturn false,\"Услуга уже активна\"\n\t\tend\n\n\t\tlocal canActivate,err = hook.Run(\"IGS.CanPlayerActivateItem\", pl, self, iInvId)\n\t\tif canActivate ~= nil then\n\t\t\treturn canActivate,err\n\t\tend\n\n\t\tif self.canactivate then\n\t\t\tlocal er = self.canactivate(pl, iInvId)\n\t\t\tif er then\n\t\t\t\treturn false,er\n\t\t\tend\n\t\tend\n\n\t\treturn true\n\tend\n\n\t-- Покупка\n\tfunction STORE_ITEM:CanBuy(pl)\n\t\tlocal canBuy,err = hook.Run(\"IGS.CanPlayerBuyItem\", pl, self)\n\t\tif canBuy ~= nil then\n\t\t\treturn canBuy,err\n\t\tend\n\n\t\tif self.canbuy then\n\t\t\tlocal er = self.canbuy(pl)\n\t\t\tif er then -- Обратная совместимость с SetCanBuy\n\t\t\t\treturn false,er\n\t\t\tend\n\t\tend\n\n\t\treturn true\n\tend\n\tfunction STORE_ITEM:Buy(pl)\n\t\tif self.onbuy then\n\t\t\tself.onbuy(pl)\n\t\tend\n\tend\n\n\t-- Разные функции\n\tfunction STORE_ITEM:IsValid(pl)\n\t\tif self.validator then\n\t\t\treturn self.validator(pl)\n\t\tend\n\tend\nend\n\n\n--[[-------------------------------------------------------------------------\n\tMISC\n---------------------------------------------------------------------------]]\n-- Вставка этого итема в таблицу под указанным ключом\n-- Используется при создании модулей для упрощения кода\n-- До:    https://img.qweqwe.ovh/1494247121142.png\n-- После: https://img.qweqwe.ovh/1494247134028.png\nfunction STORE_ITEM:Insert(to, key)\n\tto[key] = to[key] or {}\n\tif not table.HasValue(to[key],self) then\n\t\ttable.insert(to[key], self)\n\tend\n\treturn key\nend\n\nfunction STORE_ITEM:PriceInCurrency()\n\treturn IGS.PriceInCurrency(self.price)\nend\n\n-- Получить финальную цену в донат-валюте с учетом скидок\nfunction STORE_ITEM:GetFinalPriceInCurrency()\n\treturn IGS.PriceInCurrency(self:GetFinalPrice())\nend\n\n\n--[[-------------------------------------------------------------------------\n\tCORE\n---------------------------------------------------------------------------]]\nIGS.ITEMS = IGS.ITEMS or {\n\tSTORED = {},\n\tMAP    = {},\n}\n\n\nIGS.ITEMS.count = IGS.ITEMS.count or 0 -- нулевым будет null итем\nfunction IGS.AddItem(sName,sUID,iPrice)\n\tsUID = sUID:lower()\n\n\t-- Поле БД 32. Но с \"P: \" UID надо сокращать\n\t-- P: entity_hpwand_spell_simple_wand\n\tif #sUID > 28 then\n\t\tIGS.print(Color(250,20,20),\n\t\t\t\"UID \" .. sUID .. \" имеет длину свыше 28 символов, что не допускается\\n\" ..\n\t\t\t\"Причиной также могут стать кириллические (русские) или иные (emoji) символы.\\n\" ..\n\t\t\t\"UniqueID предмета должен состоять из маленьких английских (латинских) букв без пробелов и быть короче 28 символов\"\n\t\t)\n\t\t-- return -- из-за этого в консоль вылезет ошибка, т.е. не вернется объект\n\n\t\tlocal old = sUID\n\t\tsUID = old:sub(1, 28)\n\t\tIGS.print(Color(250,20,20), \"UID \" .. old .. \" сокращен до \" .. sUID .. \"\\n\")\n\tend\n\n\t-- Защита от сбивания айдишников из-за рефреша файла с добавлением итемов\n\t-- Чтобы счетчик не набивался\n\tlocal ITEM = IGS.ITEMS.MAP[sUID]\n\tif ITEM then\n\t\tITEM:SetPrice(iPrice or ITEM:Price()) -- обновляем цену, вдруг изменилась\n\t\tITEM.name = sName -- и имя\n\n\t\treturn ITEM\n\tend\n\n\tlocal t = setmetatable({\n\t\tname = sName,\n\t\tuid  = sUID:lower(),\n\t\tid   = IGS.ITEMS.count,\n\t\tdescription = \"\",\n\t\ttermin = 0 -- если не изменить, то услуга не добавится в покупки. Только в транзакции\n\t}, STORE_ITEM)\n\n\tif iPrice then\n\t\tt:SetPrice(iPrice)\n\tend\n\n\tIGS.ITEMS.MAP[t.uid]   = t\n\tIGS.ITEMS.STORED[t.id] = t\n\n\tIGS.ITEMS.count = IGS.ITEMS.count + 1\n\treturn t\nend\n\n\n-- ой, как не правильно..\nlocal null\n\nfunction IGS.GetItem(id_or_uid) -- AKA ItemExists\n\treturn IGS.ITEMS.STORED[id_or_uid] or IGS.ITEMS.MAP[id_or_uid]\nend\n\nfunction IGS.GetItemByID(iID)\n\treturn IGS.ITEMS.STORED[iID] or null\nend\n\nfunction IGS.GetItemByUID(sUID)\n\treturn IGS.ITEMS.MAP[sUID:lower()] or null\nend\n\nfunction IGS.GetItems()\n\treturn IGS.ITEMS.STORED\nend\n\n\nnull = IGS.AddItem(\"null\",\"null\",0)\n\t:SetDescription(\"Этот предмет, скорее всего, когда-то существовал или существует на другом сервере, но не здесь\")\n\t:SetIcon(\"http://i.imgur.com/NfpcFdy.png\")\n\t:SetImage(\"http://i.imgur.com/32iTOFi.jpg\")\n\t:SetCanBuy(function() return \"Этого предмета на сервере нет. Как вы нашли его?\" end)\n\t:SetCanActivate(function() return \"Этого предмета на сервере нет. Можете уничтожить его\" end) -- например купил в инвентарь, а потом uid сменился\n\nnull.isnull = true -- для проверки во время активации\n","igs/processor_sv.lua":"-- #FUSC# --\n\nlocal function giveLvlBonuses(pl, from_lvl, to_lvl)\n\tfor i = from_lvl,to_lvl do\n\t\tlocal lvl = IGS.LVL.Get(i)\n\n\t\tif lvl.bonus then\n\t\t\tlvl.bonus(pl)\n\t\tend\n\n\t\tIGS.NotifyAll(pl:Name() .. \" получил новый (\" .. i .. \") бизнес уровень - \" .. lvl:Name())\n\tend\nend\n\nlocal function recalcTransactionsAndBonuses(pl, bGiveBonuses)\n\t-- Сумма операций\n\tIGS.GetPlayerTransactionsBypassingLimit(function(dat)\n\t\tlocal tt = 0\n\t\tfor _,v in ipairs(dat) do\n\t\t\ttt = v.Sum > 0 and tt + v.Sum or tt\n\t\tend\n\n\t\tlocal prev_lvl = IGS.PlayerLVL(pl) or 0 -- не двигать под igs_lvl!\n\t\tpl:SetIGSVar(\"igs_lvl\",IGS.LVL.GetByCost( IGS.RealPrice(tt) ):LVL())\n\t\tpl:SetIGSVar(\"igs_total_transactions\",tt)\n\n\t\tif bGiveBonuses and IGS.PlayerLVL(pl) > prev_lvl then\n\t\t\tgiveLvlBonuses(pl, prev_lvl + 1, IGS.PlayerLVL(pl))\n\t\tend\n\tend, pl:SteamID64())\nend\n\n\n-- Указать bGiveBonuses, если нужно пересчитать бонусы\nlocal function updateBalance(pl, fOnFinish, bGiveBonuses)\n\tIGS.GetBalance(pl:SteamID64(),function(now_igs_)\n\t\tif not IsValid(pl) then return end\n\t\tif now_igs_ == nil then\n\t\t\tif fOnFinish then fOnFinish(nil, 0) end\n\t\t\treturn\n\t\tend\n\n\t\tlocal was_igs = pl:IGSFunds()\n\t\tlocal diff = (now_igs_ or 0) - was_igs\n\n\t\tif diff ~= 0 then -- баланс != nil и не 0 (? https://t.me/c/1353676159/45001)\n\t\t\tpl:SetIGSVar(\"igs_balance\", now_igs_) -- НЕ ДОЛЖНО ВЫПОЛНЯТЬСЯ НА НЕ_КЛИЕНТОВ\n\t\tend\n\n\t\tif now_igs_ then -- значит есть транзакции\n\t\t\trecalcTransactionsAndBonuses(pl, bGiveBonuses)\n\t\tend\n\n\t\tif fOnFinish then\n\t\t\tfOnFinish(now_igs_, diff)\n\t\tend\n\tend)\nend\n\nlocal function suggestSpent(pl,bal)\n\tIGS.Notify(pl, \"Вы можете потратить \" .. IGS.SignPrice(bal) .. \" через /donate\")\nend\n\nhook.Add(\"PlayerInitialSpawn\", \"IGS.LoadPlayer\", function(pl)\n\tif pl:IsBot() then return end\n\n\t-- Устанавливаем баланс донат счета и донат уровень игрока\n\tupdateBalance(pl, function(bal_)\n\t\tif (not IsValid(pl)) then return end\n\n\t\tIGS.LoadPlayerPurchases(pl)\n\t\tIGS.LoadInventory(pl)\n\t\tpl.igs_balance_loaded = true\n\n\t\tif bal_ and bal_ > 0 then\n\t\t\tIGS.UpdatePlayerName(pl:SteamID64(), pl:Name())\n\n\t\t\t-- подталкиваем тратить деньги\n\t\t\tif bal_ > 10 then timer.Simple(10,function() suggestSpent(pl,bal_) end) end\n\t\tend\n\tend)\nend)\n\nlocal function syncBalance(pl)\n\tif not IsValid(pl) or pl:IsBot() then return end\n\n\tupdateBalance(pl, function(new_bal_, diff)\n\t\tif not IsValid(pl) then return end\n\t\tif not pl.igs_balance_loaded then return end\n\t\tif not diff or diff == 0 then return end\n\n\t\tif diff > 0 then\n\t\t\thook.Run(\"IGS.PaymentStatusUpdated\", pl, {\n\t\t\t\tmethod = \"pay\",\n\t\t\t\torderSum = tostring(diff),\n\t\t\t\tpaymentType = \"site\",\n\t\t\t\tsource = \"sync\",\n\t\t\t})\n\t\t\thook.Run(\"IGS.PlayerDonate\", pl, diff, new_bal_)\n\t\t\tsuggestSpent(pl, new_bal_)\n\t\tend\n\tend, true)\nend\n\ntimer.Create(\"IGS.BalanceSync\", IGS.C.BALANCE_SYNC_INTERVAL or 5, 0, function()\n\tfor _, pl in ipairs(player.GetHumans()) do\n\t\tsyncBalance(pl)\n\tend\nend)\n\nlocal function repairBrokenPurchases(pl,purchases)\n\tfor uid in pairs(purchases) do -- , count\n\t\tlocal ITEM = IGS.GetItemByUID(uid)\n\n\t\tif ITEM:IsValid(pl) == false then\n\t\t\tITEM:Setup(pl) -- не первый раз, скипаем onactivate\n\t\tend\n\tend\nend\n\n-- Восстановление слетевших прав\nhook.Add(\"IGS.PlayerPurchasesLoaded\",\"RestorePex\",function(pl,purchases)\n\tif purchases then\n\t\t-- Возвращаем максимальную купленную привилегию (по иммунитету)\n\t\tif IGS.ApplyBestFAdminGroup then\n\t\t\tIGS.ApplyBestFAdminGroup(pl, purchases)\n\t\tend\n\t\trepairBrokenPurchases(pl, purchases)\n\tend\nend)\n\n\n-- Отладка начисления бонусов за лвл:\n-- https://gist.github.com/1b41e1f869752d4750440619339e4085\nhook.Add(\"IGS.PaymentStatusUpdated\",\"NoRejoiningCharge\",function(pl,dat)\n\tif dat.method ~= \"pay\" then return end\n\tif dat.source == \"sync\" then return end\n\n\ttimer.Simple(1,function() -- даем успеть в БД обновить данные\n\n\t\tupdateBalance(pl,function(new_bal_, diff)\n\t\t\tIGS.Notify(pl, \"Спасибо вам за пополнение счета. Вы прелесть :3\")\n\t\t\thook.Run(\"IGS.PlayerDonate\", pl, diff, new_bal_)\n\t\t\tsuggestSpent(pl, new_bal_)\n\t\tend, true) -- updateBalance with bGiveBonuses\n\n\tend) -- timer 1\nend)\n","igs/repeater.lua":"-- Алгоритм и описание репитера: https://gist.github.com/5e5afdff55cc1f70f1c1a459b8487943\n\nIGS.REPEATER = IGS.REPEATER or IGStack()\nlocal R = IGS.REPEATER\n\nfunction R:IsEmpty() -- внешка\n\treturn self:isempty()\nend\n--------------------------------------------------------\n\nfunction R:Query(REQ)\n\tIGS.WrapQuery(REQ[1], REQ[2], REQ[3])\nend\n\nfunction R:ProcessNextQuery()\n\tlocal NEXT_REQ = self:lpop()\n\tif NEXT_REQ then\n\t\tself:Query(NEXT_REQ) -- один за другим, пока не закончатся\n\telse -- ставится ok для IGS\n\t\thook.Run(\"IGS.RepeaterEmpty\")\n\tend\nend\n\nfunction R:SafeQuery(sMethod, tParams, fOnSuccess)\n\tlocal REQ = {sMethod, tParams, fOnSuccess}\n\n\tif self:IsEmpty() then\n\t\tself:Query(REQ)\n\telse\n\t\tself:rpush(REQ)\n\tend\nend\n\n--------------------------------------------------------\n\n-- func > iter\n-- Сколько раз функция перевыполнялась\nlocal repeats_counter = setmetatable({}, {__mode = \"k\"})\n\nlocal SHOULD_REPEAT_CASES = {\n\t[\"too_many_requests\"] = true,\n\t[\"http_error\"] = true,\n\n\t-- стоит ли? Что если метод сломался на постоянке?\n\t[\"invalid_response_format\"] = true,\n}\n\n-- Нужно, чтобы запросы без колбэка не выдавали ошибку\n-- https://t.me/c/1353676159/12486\nlocal function getBlankCallback(sMethod)\n\treturn function()\n\t\tprint(\"[IGS] Редкое сообщение. Выполнился \" .. sMethod .. \" без колбэка, который сначала 'упал'\")\n\tend\nend\n\n-- Переносит запрос в конец очереди или отбрасывает его\nhook.Add(\"IGS.OnApiError\", \"repeater\", function(sMethod, error_uid, tParams, fOnSuccess)\n\tif SHOULD_REPEAT_CASES[error_uid] then\n\t\tfOnSuccess = fOnSuccess or getBlankCallback(sMethod)\n\n\t\tlocal try = (repeats_counter[fOnSuccess] or 0) + 1\n\t\trepeats_counter[fOnSuccess] = try\n\n\t\tif try <= 15 then\n\t\t\t-- Следующие запросы теперь будут добавляться в очередь, а не выполняться\n\t\t\t-- Ниже таймер, который скоро начнет их обработку\n\t\t\tR:rpush({sMethod, tParams, fOnSuccess})\n\t\tend\n\n\t\t-- Был burst запросов и хук вызвался дважды\n\t\tif not timer.Exists(\"IGS_REPEATER\") then\n\t\t\tIGS.dprint(\"Ошибка выполнения запроса: \" .. error_uid .. \". Запущен репитер\")\n\t\t\ttimer.Create(\"IGS_REPEATER\", 10, 1, function() R:ProcessNextQuery() end)\n\t\tend\n\telse\n\t\t-- Антизависание при\n\t\t-- [успешный > неуспешный > успешный]\n\t\t-- https://img.qweqwe.ovh/1565285856105.png\n\t\tR:ProcessNextQuery()\n\tend\nend)\n\n-- Вырубает таймер, выполняет последовательно оставшиеся запросы\nhook.Add(\"IGS.OnApiSuccess\", \"repeater\", function()\n\t-- Это каллбэк внутри успешного хука, тоесть GMD заработал\n\t-- и по логике остальные запросы выполнятся корректно\n\t-- Если какой-то все же даст сбой, то снова заработает таймер\n\tR:ProcessNextQuery() -- one by one\nend)\n","igs/servers/serv_sh.lua":"IGS.SERVERS = --[[ IGS.SERVERS or --]] setmetatable({\n\tID   = function() return IGS.SERVERS.CURRENT end,\n\tName = function() return IGS.SERVERS.MAP[IGS.SERVERS.CURRENT] end,\n\n\t-- Отправляет на клиент таблицу IGS.SERVERS\n\tBroadcast = function()\n\t\t-- нельзя nil\n\t\tIGS.nw.SetGlobal(\"igs_servers\",true)\n\tend,\n\n\tMAP  = {}, -- id, name\n\n\t-- CURRENT -- int\n\t-- LOADED -- bool\n\tTOTAL   = 0, -- для считывания серверов в nw\n\tENABLED = 0, -- для подсчета скидки\n},{\n\t__call = function(self,id)\n\t\treturn IGS.SERVERS.MAP[id]\n\tend\n})\n\n\nIGS.nw.Register(\"igs_servers\")\n\t:Write(function()\n\t\tnet.WriteUInt(IGS.SERVERS.CURRENT,16) -- 65535\n\t\tnet.WriteUInt(IGS.SERVERS.TOTAL,8) -- 256\n\t\tnet.WriteUInt(IGS.SERVERS.ENABLED,8) -- 256\n\n\t\tfor id,name in pairs(IGS.SERVERS.MAP) do\n\t\t\tnet.WriteUInt(id,16)\n\t\t\tnet.WriteString(name)\n\t\tend\n\tend)\n\t:Read(function()\n\t\tIGS.SERVERS.CURRENT = net.ReadUInt(16)\n\t\tIGS.SERVERS.TOTAL   = net.ReadUInt(8)\n\t\tIGS.SERVERS.ENABLED = net.ReadUInt(8)\n\n\t\tfor i = 1,IGS.SERVERS.TOTAL do\n\t\t\tIGS.SERVERS.MAP[net.ReadUInt(16)] = net.ReadString()\n\t\tend\n\n\t\treturn IGS.SERVERS\n\tend)\n:SetGlobal()\n","igs/servers/serv_sv.lua":"local function intToIp(int)\n\tlocal a = bit.band(int, 0xFF000000)\n\tlocal b = bit.band(int, 0x00FF0000)\n\tlocal c = bit.band(int, 0x0000FF00)\n\tlocal d = bit.band(int, 0x000000FF)\n\n\ta = bit.rshift(a, 24)\n\tb = bit.rshift(b, 16)\n\tc = bit.rshift(c, 8)\n\n\tlocal ip = a .. \".\" .. b .. \".\" .. c .. \".\" .. d\n\treturn ip\nend\n\nlocal function getHostIp() -- mb nil\n\tlocal sDecimal = GetConVarString(\"hostip\")\n\tif not tonumber(sDecimal) then return end -- https://t.me/c/1353676159/10578\n\treturn intToIp(sDecimal) -- game.GetIPAddress():Split(\":\")[1] (0.0.0.0)\nend\n\nlocal function getHostPort()\n\treturn tonumber( game.GetIPAddress():match(\":(.+)$\") )\nend\n\n\n\n\n-- После вызова этой функции загружается вторая часть скрипта\n-- Т.е. не вызвать функцию - не запустится скрипт\n-- Она не вызывается, если сервер отключен или произошла ошибка в ходе выполнения запроса на получение списка серверов\nlocal function onReady()\n\tIGS.SERVERS.Broadcast()\n\thook.Run(\"IGS.ServersLoaded\")\n\tIGS.SetServerVersion(GetConVarString(\"igs_version\"))\nend\n\nlocal function addServerLocally(id, serv_name, enabled)\n\tif true    then IGS.SERVERS.TOTAL   = IGS.SERVERS.TOTAL   + 1 end\n\tif enabled then IGS.SERVERS.ENABLED = IGS.SERVERS.ENABLED + 1 end\n\n\tIGS.SERVERS.MAP[id] = serv_name\nend\n\nlocal function addCurrentServerLocally(id, serv_name, sock_port)\n\tIGS.SERVERS.CURRENT = id\n\taddServerLocally(id, serv_name, true)\n\n\tIGS.C.SOCKETPORT = sock_port\n\n\t-- было в registerCurrentServer до https://t.me/c/1353676159/17695\n\tbib.set(\"igs:serverid\", id)\nend\n\nlocal function registerCurrentServer(local_ip,port, fOnSuccess)\n\tIGS.AddServer(local_ip, port, function(id)\n\t\tIGS.print(\n\t\t\t\"CEPBEP 3APEruCTPuPOBAH nOg ig: \" .. id .. \"\\n\" ..\n\t\t\t\"HACTPOuKu yKasaHu B config_sv.lua\"\n\t\t)\n\n\t\tlocal sock_port = port + 10\n\t\tlocal serv_name = GetConVarString(\"hostname\")\n\t\taddCurrentServerLocally(id, serv_name, sock_port) -- нужно снаружи SetServerSocketPort для IGS.SERVERS:ID()\n\t\tIGS.SetServerName( serv_name )\n\t\tIGS.SetServerSocketPort(sock_port, function()\n\t\t\tfOnSuccess()\n\n\t\tIGS.print(\n\t\t\t\"COKET CEPBEPA HACTpOEH. nOPT: \" .. sock_port .. \"\\n\" ..\n\t\t\t\"ECJIu C4ET nOnOJIH9ETC9 HE MrHOBEHHO, TO nPOBEPbTE HACTPOuKu MySQL\"\n\t\t)\n\t\tend)\n\tend)\nend\n\nlocal function loadServersOrRegisterCurrent(d, local_ip)\n\tlocal serv_port = getHostPort()\n\n\t-- reset\n\tIGS.SERVERS.TOTAL   = 0\n\tIGS.SERVERS.ENABLED = 0\n\n\tlocal maxVisibleServerId = 0 -- больший ид может быть архивированным\n\tlocal isCurrentDisabled\n\tfor _,v in ipairs(d) do -- -- `ID`,`Name`,`IP`,`Port`,`SocketPort`,`Disabled`\n\t\tlocal disabled = tobool(v.Disabled)\n\t\tmaxVisibleServerId = math.max(v.ID, maxVisibleServerId)\n\n\t\t-- Текущий сервер\n\t\tif v.IP == local_ip and v.Port == serv_port then\n\t\t\tif disabled then isCurrentDisabled = true end\n\t\t\taddCurrentServerLocally(v.ID, v.Name, v.SocketPort) -- sock may be nil\n\t\telse\n\t\t\taddServerLocally(v.ID, v.Name, not disabled)\n\t\tend\n\tend\n\n\t-- limit 50\n\tif maxVisibleServerId > 40 then\n\t\tIGS.print(Color(255,50,50),\n\t\t\t\"y IIpoekTa 6oJIee 40 3arerucTpuPoBaHHbIx cepBepoB.\\n\" ..\n\t\t\t\"IIo gocTu}{eHuIO 50 cepBepoB HoBbIe IIepectaHyT co3gaBaTbC9 u 3tot He 3arpy3uTc9.\\n\" ..\n\t\t\t\"O6HoBJI9uTe IP IIpowJIbIX uJIu co3gauTe HoBbIu IIpoeKT\"\n\t\t)\n\tend\n\n\tif isCurrentDisabled then\n\t\tIGS.print(Color(255,50,50), \"3TOT CEPBEP OTKJII04EH. 3ArPy3KA nPEKPAwEHA\")\n\t\treturn -- не даем выполнить onReady()\n\tend\n\n\t-- Сервер не зарегистрирован\n\tif not IGS.SERVERS.CURRENT then\n\t\tlocal id_before = bib.getNum(\"igs:serverid\")\n\t\tif id_before and IGS.SERVERS(id_before) then\n\t\t\tIGS.print(\"IIOXO}{E 3TOT CEPBEP IIEPEEXAJI (CMEHA IP)\")\n\t\t\tIGS.UpdateServerAddress(id_before, local_ip, serv_port, function()\n\t\t\t\tIGS.GetServers(function(dat)\n\t\t\t\t\tloadServersOrRegisterCurrent(dat, local_ip)\n\t\t\t\tend, true)\n\t\t\tend)\n\n\t\telse\n\t\t\tIGS.print(\"3TOT CEPBEP HE 3APEruCTPuPOBAH. CO39AEM!\")\n\t\t\tregisterCurrentServer(local_ip,serv_port, onReady)\n\t\tend\n\telse\n\t\tonReady()\n\tend\nend\n\n\n\n\nlocal function ipToInt(ip)\n\tlocal int = 0\n\tlocal p1,p2,p3,p4 = ip:match(\"(%d+)%.(%d+)%.(%d+)%.(%d+)\")\n\tint = int + bit.lshift(p1,24)\n\tint = int + bit.lshift(p2,16)\n\tint = int + bit.lshift(p3,8)\n\tint = int + p4\n\treturn int\nend\n\nlocal function maskHasIP(mask, ip)\n\tlocal maskip,bits = mask:match(\"(%d+.%d+.%d+.%d+)/(%d+)\")\n\tmaskip = ipToInt(maskip)\n\n\tlocal netmask = bit.lshift(0xFFFFFFFF, 32 - bits)\n\treturn bit.band(maskip,netmask) == bit.band(ipToInt(ip),netmask)\nend\n\n-- NAT?\nlocal function isIpInternal(ip)\n\tlocal masks = {\"192.168.0.0/16\", \"172.16.0.0/12\", \"10.0.0.0/8\", \"25.0.0.0/8\", \"169.254.0.0/16\", \"127.0.0.0/8\"}\n\tfor _,mask in ipairs(masks) do\n\t\tif maskHasIP(mask, ip) then\n\t\t\treturn true\n\t\tend\n\tend\n\n\tif ip == \"255.255.255.255\" then\n\t\treturn true\n\tend\nend\n\n\n\n\nlocal function getAndLoadServers(local_ip)\n\tIGS.GetServers(function(dat)\n\t\tloadServersOrRegisterCurrent(dat, local_ip)\n\tend, true) -- include disabled\nend\n\nhook.Add(\"IGS.DBConnected\", \"IGS.ReloadServers\", function()\n\tif IGS.SERVERS.CURRENT then return end\n\tlocal ip = getHostIp()\n\tif not ip or isIpInternal(ip) then\n\t\tIGS.GetExternalIP(getAndLoadServers)\n\telse\n\t\tgetAndLoadServers(ip)\n\tend\nend)\n\ntimer.Simple(0,function() -- фетч заработает только так в этот момент\n\tlocal ip = getHostIp()\n\t-- ip = \"192.168.5.6\"\n\n\tif not ip or isIpInternal(ip) then\n\t\tIGS.GetExternalIP(getAndLoadServers)\n\telse\n\t\tgetAndLoadServers(ip)\n\tend\nend)\n\nlocal function renewAddressAndReloadServers(ip)\n\tIGS.UpdateServerAddress(IGS.SERVERS:ID(), ip, getHostPort(), function()\n\t\tIGS.GetServers(function(dat)\n\t\t\tloadServersOrRegisterCurrent(dat, ip)\n\t\tend, true)\n\tend)\nend\n\n","igs/utils/ut_cl.lua":"-- Норм название сервера по его ИД\n-- Если вернут \"-\", значит сервер скорее всего, отключен\nfunction IGS.ServerName(iID)\n\tlocal serv_name = iID == 0 and \"Откл.\" or IGS.SERVERS(iID)\n\t      serv_name = serv_name or \"Глоб.\" -- IGS.SERVERS(iID) вернул nil = везде\n\t      -- serv_name = serv_name[1]:upper() .. serv_name:sub(2) -- апперкейсит первую букву\n\n\treturn serv_name\nend\n\n\nfunction IGS.ProcessActivate(dbID, cb)\n\tIGS.Activate(dbID,function(ok, iPurchID, sMsg_)\n\t\tsMsg_ = sMsg_ or \"Предмет активирован. Спасибо вам!\"\n\t\tIGS.ShowNotify(sMsg_, ok and \"Успешная активация\" or \"Ошибка активации\")\n\n\t\tif cb then\n\t\t\tcb(ok, iPurchID, sMsg_)\n\t\tend\n\tend)\nend\n","igs/utils/ut_sh.lua":"-- #todo нужно переделывать, но только так:\n-- https://trello.com/c/WfVYTIOF/544 (комменты)\nCreateConVar(\"igs_debug\", 0, FCVAR_NOTIFY)\ncvars.AddChangeCallback(\"igs_debug\", function(_, old, new)\n\tIGS.DEBUG = tobool(new)\n\tIGS.print(\"PEZuM OTJIA9Ku \" .. (IGS.DEBUG and \"AKTuBuPOBAH\" or \"BbIKJII04EH\"))\nend, \"main\")\n\n-- Установка иконки для категории\nIGS.CategoryIcons = IGS.CategoryIcons or {}\nfunction IGS.SetCategoryIcon(sCategoryName, sIconPath)\n\tif CLIENT then\n\t\tIGS.CategoryIcons[sCategoryName] = sIconPath\n\tend\nend\n\nfunction IGS.GetCategoryIcon(sCategoryName)\n\treturn IGS.CategoryIcons[sCategoryName]\nend\n\n-- Система глобальных скидок\nIGS.GlobalDiscount = IGS.GlobalDiscount or {}\n\n-- Установить глобальную процентную скидку (например, 15 = 15%)\nfunction IGS.SetGlobalDiscountPercent(iPercent)\n\tIGS.GlobalDiscount.type = \"percent\"\n\tIGS.GlobalDiscount.value = iPercent\nend\n\n-- Установить глобальную фиксированную скидку в рублях (например, 100 = 100 рублей)\nfunction IGS.SetGlobalDiscountFixed(iRubles)\n\tIGS.GlobalDiscount.type = \"fixed\"\n\tIGS.GlobalDiscount.value = iRubles\nend\n\n-- Убрать глобальную скидку\nfunction IGS.RemoveGlobalDiscount()\n\tIGS.GlobalDiscount = {}\nend\n\n-- Получить скидочную цену с учетом глобальной скидки\nfunction IGS.GetDiscountedPrice(iOriginalPrice)\n\tif !IGS.GlobalDiscount.type then\n\t\treturn iOriginalPrice\n\tend\n\t\n\tif IGS.GlobalDiscount.type == \"percent\" then\n\t\treturn iOriginalPrice * (1 - IGS.GlobalDiscount.value / 100)\n\telseif IGS.GlobalDiscount.type == \"fixed\" then\n\t\treturn math.max(0, iOriginalPrice - IGS.GlobalDiscount.value)\n\tend\n\t\n\treturn iOriginalPrice\nend\n\n-- Проверить, есть ли глобальная скидка\nfunction IGS.HasGlobalDiscount()\n\treturn IGS.GlobalDiscount.type ~= nil\nend\n\n\nlocal PLAYER = FindMetaTable(\"Player\")\n\nfunction PLAYER:IGSFunds()\n\treturn self:GetIGSVar(\"igs_balance\") or 0\nend\n\nfunction PLAYER:HasPurchase(sUID)\n\treturn IGS.PlayerPurchases(self)[sUID]\nend\n\n-- true, если человек имеет хоть один итем из списка, nil, если итем не отслеживается, false, если нет права. Начало юзаться для упрощения кода модулей\nfunction IGS.PlayerHasOneOf(pl,tItems)\n\tif !tItems then return end\n\n\tfor _,ITEM in ipairs(tItems) do\n\t\tif pl:HasPurchase( ITEM:UID() ) then\n\t\t\treturn ITEM\n\t\tend\n\tend\n\n\treturn false\nend\n\nfunction IGS.isUser(pl) -- возвращает false, если чел никогда не юзал автодонат\n\treturn pl:GetIGSVar(\"igs_balance\") ~= nil\nend\n\n\n-- Может ли чел себе позволить покупку итема, ценой в sum IGS?\nfunction IGS.CanAfford(pl,sum,assert)\n\tif sum >= 0 and pl:IGSFunds() - sum >= 0 then\n\t\treturn true\n\tend\n\n\tif !assert then\n\t\treturn false\n\tend\n\n\tif isfunction(assert) then\n\t\tassert()\n\telse\n\t\tlocal rub = IGS.RealPrice(sum)\n\t\tif SERVER then\n\t\t\tIGS.WIN.Deposit(pl,rub)\n\t\telse\n\t\t\tIGS.WIN.Deposit(rub)\n\t\tend\n\tend\n\n\treturn false\nend\n\n-- Список активных покупок игрока\n-- uid > amount\nfunction IGS.PlayerPurchases(pl)\n\treturn CLIENT and (pl:GetIGSVar(\"igs_purchases\") or {}) or pl:GetVar(\"igs_purchases\",{})\nend\n\n-- Сумма в донат валюте всех операций пополнения счета (включая купоны и выдачу денег администратором)\nfunction IGS.TotalTransaction(pl)\n\treturn pl:GetIGSVar(\"igs_total_transactions\") or 0\nend\n\n-- возврат объекта ЛВЛ на клиенте, номера уровня на сервере\nfunction IGS.PlayerLVL(pl)\n\treturn pl:GetIGSVar(\"igs_lvl\")\nend\n\n\n-- Конвертирует IGS в реальную валюту\nfunction IGS.RealPrice(iCurrencyAmount)\n\treturn iCurrencyAmount * IGS.GetCurrencyPrice()\nend\n\n-- Реальная валюта в IGS по текущему курсу\nfunction IGS.PriceInCurrency(iRealPrice)\n\treturn iRealPrice / IGS.GetCurrencyPrice()\nend\n\n\nfunction IGS.IsCurrencyEnabled()\n\treturn IGS.GetCurrencyPrice() ~= 1\nend\n\nlocal function getSettings()\n\treturn IGS.nw.GetGlobal(\"igs_settings\")\nend\n\n-- Минимальная сумма пополнения в рублях\nfunction IGS.GetMinCharge()\n\treturn getSettings()[1]\nend\n\n-- Стоимость 1 донат валюты в рублях\nfunction IGS.GetCurrencyPrice()\n\treturn getSettings()[2]\nend\n\n-- Не смог загрузиться или выключен в панели, меню открывать нельзя\nfunction IGS.IsLoaded()\n\treturn getSettings() and IGS.SERVERS:ID() and !GetGlobalBool(\"IGS_DISABLED\")\nend\n\n\n\n\nlocal terms = {\n\t[1] = \"бесконечно\",\n\t[2] = \"единоразово\",\n\t[3] = \"%s\"\n}\n\nfunction IGS.TermType(term)\n\treturn\n\t\t!term     and 1 or -- бесконечно\n\t\tterm == 0 and 2 or -- мгновенно\n\t\tterm      and 3    -- кол-во дней\nend\n\nfunction IGS.TermToStr(term)\n\treturn terms[ IGS.TermType(term) ]:format(term and PL_DAYS(term))\nend\n\nfunction IGS.TimestampToDate(ts,bShowFull) -- в \"купил до\"\n\tif !ts then return end\n\treturn os.date(bShowFull and IGS.C.DATE_FORMAT or IGS.C.DATE_FORMAT_SHORT,ts)\nend\n\n\nfunction IGS.FormItemInfo(ITEM)\n\tlocal finalPrice = ITEM:GetFinalPrice()\n\tlocal originalPrice = ITEM:Price()\n\tlocal hasDiscount = (finalPrice ~= originalPrice) or ITEM.discounted_from or IGS.HasGlobalDiscount()\n\t\n\treturn {\n\t\t[\"Категория\"] = ITEM:Category(),\n\t\t[\"Действует\"] = IGS.TermToStr(ITEM:Term()),\n\t\t[\"Цена\"]       = PL_MONEY(finalPrice),\n\t\t[\"Без скидки\"] = hasDiscount and PL_MONEY(originalPrice) or nil,\n\t\t[\"Покупки суммируются\"]  = ITEM:IsStackable() and \"да\" or \"нет\",\n\t}\nend\n\n\nfunction IGS.print(...)\n\tlocal args = {...}\n\tif !IsColor(args[1]) then\n\t\ttable.insert(args,1,color_white)\n\tend\n\n\targs[#args] = args[#args] .. \"\\n\"\n\tMsgC(Color(50,200,255), \"[IGS] \", unpack(args))\nend\n\nfunction IGS.dprint(...)\n\tif IGS.DEBUG then\n\t\tIGS.print(\"DEBUG: \", Color(50,250,50), ...)\n\tend\nend\n\n\n\n\nfunction IGS.SignPrice(iPrice) -- 10 Alc\n\treturn math.Truncate(tonumber(iPrice),2) .. \" \" .. IGS.C.CURRENCY_SIGN\nend\n\nlocal rubs = {\"рубль\", \"рубля\", \"рублей\"}\nPL_MONEY = PL.Add(\"realmoney\",rubs)\nPL_IGS   = PL.Add(\"igs_currency\",IGS.C.CurrencyPlurals or rubs)\nPL_DAYS  = PL.Add(\"days\",{\"день\", \"дня\", \"дней\"})\n\n\nlocal PL_IGS_ORIGINAL\nhook.Add(\"IGS.OnSettingsUpdated\",\"PL_IGS = PL_MONEY\",function()\n\tif !IGS.IsCurrencyEnabled() then -- Если донат валюта отключена\n\t\tPL_IGS_ORIGINAL = PL_IGS -- а это не таблица случайно? Мб table.copy?\n\t\tPL_IGS = PL_MONEY\n\n\t-- Валюта уже отключалась. Сейчас включилась\n\telseif PL_IGS_ORIGINAL then\n\t\tPL_IGS = PL_IGS_ORIGINAL\n\tend\nend)\n","igs/utils/ut_sv.lua":"\nlocal col_lime  = Color(100,210,40)\nlocal col_light = Color(228,228,228)\nlocal col_red   = Color(250,30,90)\n\nfunction IGS.NotifyAll(...)\n\tchat.AddTextSV(\n\t\tcol_lime, \"[IGS]\",\n\t\tcol_red,  \" > \",\n\t\tcol_light,...\n\t)\nend\n\n\nfunction IGS.Notify(pl, ...)\n\tpl:ChatPrintColor(\n\t\tcol_lime, \"[IGS]\",\n\t\tcol_red,  \" > \",\n\t\tcol_light,...\n\t)\nend\n\n-- IGS.MUTE_NOTIFY = IGS.MUTE_NOTIFY or {}\n-- function IGS.NotifyOpt(pl, uid, ...)\n-- \tif IGS.MUTE_NOTIFY[uid] then return end\n-- \treturn IGS.Notify(pl, ...)\n-- end\n\n\n-- todo реальный логгинг\nfunction IGS.LogError(err)\n\terror(err)\nend\n\n\n--[[---------------------------\n\tAPI\n-----------------------------]]\n-- Проще https://qweqwe.ovh/9vAdB\nlocal limit_per_query = 255\nlocal function getTxsNoLimit(cb, s64, am_, _tmp_)\n\t_tmp_ = _tmp_ or {}\n\tam_   =   am_ or math.huge\n\tlocal left = am_ - #_tmp_\n\t-- print(\"need, done, left\", am_, #_tmp_, left)\n\tIGS.GetTransactions(function(data)\n\t\tfor _,tr in ipairs(data) do\n\t\t\tlocal i = table.insert(_tmp_,tr)\n\t\t\tif am_ and i == am_ then cb(_tmp_) return end -- собрали нужное кол-во\n\t\tend\n\n\t\tif #data < limit_per_query then cb(_tmp_) -- Последняя страница\n\t\telse getTxsNoLimit(cb, s64, am_, _tmp_)\n\t\tend\n\tend, s64, true, math.min(limit_per_query, left), #_tmp_)\nend\n\nIGS.GetPlayerTransactionsBypassingLimit = getTxsNoLimit\n\n-- getTxsNoLimit(function(all)\n-- \tfor i,tx in ipairs(all) do\n-- \t\tprint(i, DateTime(tx.Time), tx.Note)\n-- \tend\n-- \tprint(\"#all\", #all)\n-- end, AMD():SteamID(), 20)"}